{% load i18n static %}
<div class="container mx-auto p-4" hx-boost="true">
  <form id="filters" class="space-y-4" hx-get="{% url 'financeiro_api:forecast-list' %}" hx-trigger="change,submit" hx-swap="none" hx-on:afterRequest="renderForecast(event.detail.xhr)">
    <div>
      <label for="escopo" class="block text-sm font-medium">{% trans "Escopo" %}</label>
      <select name="escopo" id="escopo" class="mt-1 w-full border p-2 rounded">
        <option value="organizacao">{% trans "Organização" %}</option>
        <option value="nucleo">{% trans "Núcleo" %}</option>
        <option value="centro">{% trans "Centro" %}</option>
        <option value="evento">{% trans "Evento" %}</option>
      </select>
    </div>
    <div>
      <label for="ref" class="block text-sm font-medium">{% trans "Referência" %}</label>
      <input type="text" name="id" id="ref" class="mt-1 w-full border p-2 rounded" />
    </div>
    <div>
      <label for="periodos" class="block text-sm font-medium">{% trans "Meses" %}</label>
      <input type="number" name="periodos" id="periodos" value="6" min="1" max="12" class="mt-1 w-full border p-2 rounded" />
    </div>
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label for="crescimento" class="block text-sm font-medium">{% trans "Crescimento Receita (%)" %}</label>
        <input type="range" name="crescimento_receita" id="crescimento" min="0" max="100" value="0" class="w-full" />
      </div>
      <div>
        <label for="reducao" class="block text-sm font-medium">{% trans "Redução Despesa (%)" %}</label>
        <input type="range" name="reducao_despesa" id="reducao" min="0" max="100" value="0" class="w-full" />
      </div>
    </div>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">{% trans "Atualizar" %}</button>
  </form>
  <div id="forecast-result" class="mt-6">
    <!-- gráfico e tabela serão inseridos aqui -->
  </div>
</div>
<script src="{% static 'js/vendor/chart-4.5.0.min.js' %}"></script>
<script>
let lastParams = null;

function renderForecast(xhr){
  if(xhr.status !== 200) return;
  let data;
  try { data = JSON.parse(xhr.responseText); } catch(e){ return; }
  lastParams = data.parametros;
  const container = document.getElementById('forecast-result');
  container.innerHTML = '';
  const rows = data.historico.concat(data.previsao);
  if(rows.length){
    const table = document.createElement('table');
    table.className = 'min-w-full border';
    table.innerHTML = `<thead><tr>
      <th class="border px-2">{% trans "Mês" %}</th>
      <th class="border px-2">{% trans "Receita" %}</th>
      <th class="border px-2">{% trans "Despesa" %}</th>
      <th class="border px-2">{% trans "Saldo" %}</th>
    </tr></thead>`;
    const tbody = document.createElement('tbody');
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="border px-2">${r.mes}</td>
        <td class="border px-2">${r.receita.toFixed(2)}</td>
        <td class="border px-2">${r.despesa.toFixed(2)}</td>
        <td class="border px-2">${r.saldo.toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.appendChild(table);

    if(window.Chart){
      const canvas = document.createElement('canvas');
      canvas.id = 'forecastChart';
      canvas.className = 'mt-4';
      container.appendChild(canvas);
      const ctx = canvas.getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: rows.map(r => r.mes),
          datasets: [
            {label: '{% trans "Receita" %}', data: rows.map(r => r.receita), borderColor: '#16a34a', backgroundColor: 'rgba(22,163,74,0.2)'},
            {label: '{% trans "Despesa" %}', data: rows.map(r => r.despesa), borderColor: '#dc2626', backgroundColor: 'rgba(220,38,38,0.2)'}
          ]
        },
        options: {responsive: true}
      });
    }
  }
}

</script>
