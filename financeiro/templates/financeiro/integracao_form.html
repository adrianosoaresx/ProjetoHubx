{% load i18n %}
<div class="card max-w-md">
  <div class="card-body">
    <form id="integracao-form"
          {% if integracao %}
            hx-put="/api/financeiro/integracoes/{{ integracao.id }}/"
          {% else %}
            hx-post="/api/financeiro/integracoes/"
          {% endif %}
          hx-target="#integracoes-list"
          hx-on="htmx:afterRequest: htmx.ajax('GET', '/financeiro/integracoes/', '#integracoes-list'); document.getElementById('modal').innerHTML='';"
          class="space-y-4" aria-live="assertive">
      {% csrf_token %}
      {% include '_forms/field.html' with field=form.nome %}
      {% include '_forms/field.html' with field=form.tipo %}
      <div>
        <label for="integracao-organizacao-search" class="block text-sm font-medium">{{ _('Organização') }}</label>
        <input
          type="text"
          id="integracao-organizacao-search"
          name="search"
          class="form-input w-full"
          form="search-organizacao"
          hx-get="/api/organizacoes/"
          hx-trigger="keyup changed delay:500ms"
          hx-target="#id_organizacao"
          hx-swap="none"
          hx-on="htmx:afterRequest: renderOrganizacoes(event)"
        />
        <select id="id_organizacao" name="organizacao" class="form-select w-full mt-2" {% if form and form.organizacao.errors %}aria-invalid="true"{% endif %}>
          {% if integracao and integracao.organizacao %}
          <option value="{{ integracao.organizacao.id }}" selected>{{ integracao.organizacao.nome }}</option>
          {% endif %}
        </select>
        {% if form and form.organizacao.errors %}<p class="text-red-600 text-sm" aria-live="polite">{{ form.organizacao.errors }}</p>{% endif %}
      </div>
      {% include '_forms/field.html' with field=form.base_url %}
      {% include '_forms/field.html' with field=form.autenticacao %}
      {% include '_forms/field.html' with field=form.credenciais %}
      <button type="submit" class="btn btn-primary">{{ _('Salvar') }}</button>
    </form>
  </div>
</div>

<script src="{% url 'javascript-catalog' %}"></script>
<script>
  function renderOrganizacoes(evt) {
    const sel = document.querySelector('#id_organizacao');
    sel.innerHTML = '';
    try {
      const data = JSON.parse(evt.detail.xhr.response);
      const itens = data.results || data;
      sel.innerHTML =
        itens
          .map(o => `<option value="${o.id}">${o.nome}</option>`)
          .join('') || `<option value="">${gettext('Nenhum resultado')}</option>`;
    } catch (err) {
      sel.innerHTML = `<option value="">${gettext('Erro ao carregar')}</option>`;
    }
  }
</script>
