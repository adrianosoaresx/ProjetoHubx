{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Relatórios Financeiros" %}{% endblock %}

{% block content %}
{% include '_components/hero.html' with title=_('Relatórios') %}
<div class="container mx-auto p-6">
  <div class="card">
    <div class="card-body space-y-4">
      <form id="relatorio-form" class="space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          <div>
            <label for="rel-centro" class="block text-sm font-medium text-[var(--text-secondary)]">{% trans "Centro de Custo" %}</label>
            <select id="rel-centro" name="centro" class="mt-1 block w-full border rounded p-2">
              <option value="">{% trans "Todos" %}</option>
              {% for c in centros %}
                <option value="{{ c.id }}">{{ c.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="rel-nucleo" class="block text-sm font-medium text-[var(--text-secondary)]">{% trans "Núcleo" %}</label>
            <select id="rel-nucleo" name="nucleo" class="mt-1 block w-full border rounded p-2">
              <option value="">{% trans "Todos" %}</option>
              {% for n in nucleos %}
                <option value="{{ n.id }}">{{ n.nome }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          <div>
            <label for="rel-periodo-inicial" class="block text-sm font-medium text-[var(--text-secondary)]">{% trans "Período inicial" %}</label>
            <input id="rel-periodo-inicial" type="month" name="periodo_inicial" class="mt-1 block w-full border rounded p-2" />
          </div>
          <div>
            <label for="rel-periodo-final" class="block text-sm font-medium text-[var(--text-secondary)]">{% trans "Período final" %}</label>
            <input id="rel-periodo-final" type="month" name="periodo_final" class="mt-1 block w-full border rounded p-2" />
          </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          <div>
            <label for="rel-tipo" class="block text-sm font-medium text-[var(--text-secondary)]">{% trans "Tipo" %}</label>
            <select id="rel-tipo" name="tipo" class="mt-1 block w-full border rounded p-2">
              <option value="">{% trans "Todos" %}</option>
              <option value="receitas">{% trans "Receitas" %}</option>
              <option value="despesas">{% trans "Despesas" %}</option>
            </select>
          </div>
          <div>
            <label for="rel-status" class="block text-sm font-medium text-[var(--text-secondary)]">{% trans "Status" %}</label>
            <select id="rel-status" name="status" class="mt-1 block w-full border rounded p-2">
              <option value="">{% trans "Todos" %}</option>
              <option value="pendente">{% trans "Pendente" %}</option>
              <option value="pago">{% trans "Pago" %}</option>
              <option value="cancelado">{% trans "Cancelado" %}</option>
            </select>
          </div>
        </div>
        <button type="button" id="gerar-relatorio" class="bg-primary text-white px-4 py-2 rounded"
                hx-get="/api/financeiro/relatorios/"
                hx-target="#relatorio"
                hx-include="#relatorio-form"
                hx-trigger="click"
                hx-on="htmx:afterRequest: renderRelatorio(event)">
          {% trans "Gerar Relatório" %}
        </button>
      </form>

      <div id="relatorio" class="mt-6" aria-live="polite"></div>

      <script src="{% url 'javascript-catalog' %}"></script>
      <script>
        function renderRelatorio(evt) {
          const container = document.getElementById('relatorio');
          container.innerHTML = '';
          try {
            const data = JSON.parse(evt.detail.xhr.response);
            const rows = data.serie
              .map(r => `<tr><td class=\"px-2 py-1\">${r.mes}</td><td class=\"px-2 py-1\">${r.receitas}</td><td class=\"px-2 py-1\">${r.despesas}</td><td class=\"px-2 py-1\">${r.saldo}</td></tr>`)
              .join('');
            container.innerHTML = `
              <p class=\"mb-2 font-medium\">{% trans "Saldo atual" %}: ${data.saldo_atual}</p>
              <p class=\"mb-2 font-medium\">{% trans "Total inadimplentes" %}: ${data.total_inadimplentes}</p>
              <table class=\"min-w-full divide-y divide-[var(--border)]\"><thead><tr><th class=\"px-2 py-1 text-left text-xs font-medium text-[var(--text-secondary)]\">{% trans "Mês" %}</th><th class=\"px-2 py-1 text-left text-xs font-medium text-[var(--text-secondary)]\">{% trans "Receitas" %}</th><th class=\"px-2 py-1 text-left text-xs font-medium text-[var(--text-secondary)]\">{% trans "Despesas" %}</th><th class=\"px-2 py-1 text-left text-xs font-medium text-[var(--text-secondary)]\">{% trans "Saldo" %}</th></tr></thead><tbody>${rows}</tbody></table>`;
          } catch (e) {
            container.textContent = gettext('Erro ao gerar relatório');
          }
        }
      </script>
    </div>
  </div>
</div>
{% endblock %}
