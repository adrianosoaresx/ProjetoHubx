{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Importar Pagamentos" %}{% endblock %}

{% block hero %}
  {% include '_components/hero.html' with title=_('Importar Pagamentos') %}
{% endblock %}

{% block content %}
  <div class="py-12 card px-4">
    <div class="card-body">
      <div class="mb-4">
        <a href="{% url 'financeiro:importacoes' %}" class="link link-hover">{% trans "Ver importações" %}</a>
      </div>
      <form id="upload-form" method="post" enctype="multipart/form-data" class="space-y-4 border p-4 rounded-lg bg-white">
        {% csrf_token %}
        <label for="file" class="block text-sm font-medium text-gray-700">{% trans "Arquivo" %}</label>
        <input id="file" type="file" name="file" accept=".csv,.xlsx" class="block w-full border p-2 rounded" required
               hx-post="/api/financeiro/importar-pagamentos/"
               hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
               hx-target="#preview"
               hx-trigger="change"
               hx-include="#upload-form"
               hx-on="htmx:afterRequest: renderPreview(event)" />
        <p class="text-sm text-gray-500">{% trans "Apenas CSV ou XLSX até 5MB" %}</p>
      </form>
      <button id="preview-btn"
              class="mt-2 bg-primary text-white px-4 py-2 rounded"
              hx-post="/api/financeiro/importar-pagamentos/"
              hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
              hx-target="#preview"
              hx-trigger="click"
              hx-include="#upload-form"
              hx-on="htmx:afterRequest: renderPreview(event)">
        {% trans "Pré-visualizar" %}
      </button>
      <div id="preview" class="mt-6" aria-live="polite"></div>
      <div id="messages" class="mt-4 text-sm" aria-live="polite"></div>
      <div id="reprocess" class="mt-4"></div>
      <form id="confirm-form">
        {% csrf_token %}
        <input type="hidden" id="confirm-id" name="id" />
        <input type="hidden" id="confirm-importacao-id" name="importacao_id" />
      </form>
      <div class="mt-4 flex items-center gap-2">
        <button id="confirm-btn" disabled
                hx-post="/api/financeiro/importar-pagamentos/confirmar/"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                hx-target="#messages"
                hx-include="#confirm-form"
                hx-indicator="#loading"
                class="bg-primary text-white px-4 py-2 rounded">
          {% trans "Confirmar Importação" %}
        </button>
        <span id="loading" class="htmx-indicator text-sm">{% trans "Processando..." %}</span>
      </div>
      <script>
        const csrfToken = "{{ csrf_token }}";
        function renderPreview(evt) {
          const preview = document.getElementById('preview');
          const messages = document.getElementById('messages');
          const reprocess = document.getElementById('reprocess');
          preview.innerHTML = '';
          messages.innerHTML = '';
          reprocess.innerHTML = '';
          try {
            const data = JSON.parse(evt.detail.xhr.response);
            if (data.preview && data.preview.length) {
              const rows = data.preview.map(r => `<tr><td class="px-2 py-1">${r.centro_custo}</td><td class="px-2 py-1">${r.conta_associado || ''}</td><td class="px-2 py-1">${r.tipo}</td><td class="px-2 py-1">${r.valor}</td><td class="px-2 py-1">${r.data_lancamento}</td></tr>`).join('');
              preview.innerHTML = `<table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-2 py-1 text-left text-xs font-medium text-gray-500">{% trans "Centro de Custo" %}</th><th class="px-2 py-1 text-left text-xs font-medium text-gray-500">{% trans "Conta" %}</th><th class="px-2 py-1 text-left text-xs font-medium text-gray-500">{% trans "Tipo" %}</th><th class="px-2 py-1 text-left text-xs font-medium text-gray-500">{% trans "Valor" %}</th><th class="px-2 py-1 text-left text-xs font-medium text-gray-500">{% trans "Data" %}</th></tr></thead><tbody>${rows}</tbody></table>`;
              document.getElementById('confirm-id').value = data.id;
              document.getElementById('confirm-importacao-id').value = data.importacao_id;
              document.getElementById('confirm-btn').disabled = false;
            }
            if (data.erros && data.erros.length) {
              const ul = document.createElement('ul');
              ul.className = 'list-disc text-red-600 pl-5';
              data.erros.forEach((err) => {
                const li = document.createElement('li');
                li.textContent = err;
                ul.appendChild(li);
              });
              messages.appendChild(ul);
              if (!data.preview || !data.preview.length) {
                document.getElementById('confirm-btn').disabled = true;
              }
            }
            if (data.token_erros) {
              const token = data.token_erros;
              reprocess.innerHTML = `<div class="space-y-2"><a href="/media/importacoes/${token}.errors.csv" download class="link link-hover">{% trans "Baixar arquivo de erros" %}</a><form id="reprocess-form" class="space-y-2" enctype="multipart/form-data">{% csrf_token %}<input type="file" name="file" accept=".csv,.xlsx" class="block w-full border p-2 rounded" required /><button type="submit" class="bg-primary text-white px-4 py-2 rounded" hx-post="/api/financeiro/importar-pagamentos/reprocessar/${token}/" hx-target="#messages" hx-include="#reprocess-form" hx-encoding="multipart/form-data" hx-headers='{"X-CSRFToken": "${csrfToken}"}'>{% trans "Reprocessar" %}</button></form></div>`;
            }
          } catch (e) {
            messages.textContent = '{% trans "Erro ao processar pré-visualização" %}';
            document.getElementById('confirm-btn').disabled = true;
          }
        }
      </script>
    </div>
  </div>
{% endblock %}
