{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Importar Pagamentos" %}{% endblock %}

{% block content %}
<main class="max-w-3xl mx-auto p-4">
  <section>
    <h1 class="text-2xl font-semibold mb-4">{% trans "Importar Pagamentos" %}</h1>
    <form id="upload-form" method="post" enctype="multipart/form-data" class="space-y-4 border p-4 rounded-lg bg-white">
      {% csrf_token %}
      <label for="file" class="block text-sm font-medium text-gray-700">{% trans "Arquivo" %}</label>
      <input id="file" type="file" name="file" accept=".csv,.xlsx" class="block w-full border p-2 rounded" required />
    </form>
    <button id="preview-btn"
            class="mt-2 bg-primary text-white px-4 py-2 rounded"
            hx-post="/api/financeiro/importar-pagamentos/"
            hx-target="#preview"
            hx-trigger="change from:#file"
            hx-include="#upload-form"
            hx-on="htmx:afterRequest: renderPreview(event)">
      {% trans "Pré-visualizar" %}
    </button>
    <div id="preview" class="mt-6" aria-live="polite"></div>
    <div id="messages" class="mt-4 text-sm" aria-live="polite"></div>
    <form id="confirm-form">
      {% csrf_token %}
      <input type="hidden" id="confirm-id" name="id" />
    </form>
    <div class="mt-4 flex items-center gap-2">
      <button id="confirm-btn" disabled
              hx-post="/api/financeiro/importar-pagamentos/confirmar/"
              hx-target="#messages"
              hx-include="#confirm-form"
              hx-indicator="#loading"
              class="bg-secondary text-white px-4 py-2 rounded">
        {% trans "Confirmar Importação" %}
      </button>
      <span id="loading" class="htmx-indicator text-sm">{% trans "Processando..." %}</span>
    </div>
  </section>
  <script>
    function renderPreview(evt) {
      const preview = document.getElementById('preview');
      const messages = document.getElementById('messages');
      preview.innerHTML = '';
      messages.innerHTML = '';
      try {
        const data = JSON.parse(evt.detail.xhr.response);
        if (data.preview && data.preview.length) {
          const rows = data.preview.map(r => `<tr><td class="px-2 py-1">${r.centro_custo}</td><td class="px-2 py-1">${r.conta_associado || ''}</td><td class="px-2 py-1">${r.tipo}</td><td class="px-2 py-1">${r.valor}</td><td class="px-2 py-1">${r.data_lancamento}</td></tr>`).join('');
          preview.innerHTML = `<table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-2 py-1 text-left text-xs font-medium text-gray-500">{% trans "Centro de Custo" %}</th><th class="px-2 py-1 text-left text-xs font-medium text-gray-500">{% trans "Conta" %}</th><th class="px-2 py-1 text-left text-xs font-medium text-gray-500">{% trans "Tipo" %}</th><th class="px-2 py-1 text-left text-xs font-medium text-gray-500">{% trans "Valor" %}</th><th class="px-2 py-1 text-left text-xs font-medium text-gray-500">{% trans "Data" %}</th></tr></thead><tbody>${rows}</tbody></table>`;
          document.getElementById('confirm-id').value = data.id;
          document.getElementById('confirm-btn').disabled = false;
        }
        if (data.erros && data.erros.length) {
          messages.innerHTML = `<ul class="list-disc text-red-600 pl-5">${data.erros.map(e => `<li>${e}</li>`).join('')}</ul>`;
          if (!data.preview || !data.preview.length) {
            document.getElementById('confirm-btn').disabled = true;
          }
        }
      } catch (e) {
        messages.textContent = '{% trans "Erro ao processar pré-visualização" %}';
        document.getElementById('confirm-btn').disabled = true;
      }
    }
  </script>
</main>

{% endblock %}

