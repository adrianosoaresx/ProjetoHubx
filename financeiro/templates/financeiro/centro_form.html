{% load i18n widget_tweaks %}
<div class="card max-w-md">
  <div class="card-body">
    <form id="centro-form"
          {% if centro %}
            hx-put="/api/financeiro/centros/{{ centro.id }}/"
          {% else %}
            hx-post="/api/financeiro/centros/"
          {% endif %}
          hx-target="#centros-list"
          hx-on="htmx:afterRequest: htmx.ajax('GET', '/financeiro/centros/', '#centros-list'); document.getElementById('modal').innerHTML='';"
          class="space-y-4" aria-live="assertive">
      {% csrf_token %}
      {% for field in form %}
        {% if field.name == 'organizacao' %}
        <div>
          <label for="organizacao-search" class="block text-sm font-medium">{{ _('Organização') }}</label>
          <input
            type="text"
            id="organizacao-search"
            name="search"
            class="form-input w-full"
            form="search-organizacao"
            hx-get="/api/organizacoes/"
            hx-trigger="keyup changed delay:500ms"
            hx-target="#id_organizacao"
            hx-swap="none"
            hx-on="htmx:afterRequest: renderOrganizacoes(event)"
          />
          {% if field.errors %}
            {% render_field field|attr:"aria-invalid:true" class+="form-select w-full mt-2" %}
          {% else %}
            {% render_field field class+="form-select w-full mt-2" %}
          {% endif %}
          {% if field.errors %}
          <ul class="errorlist">
            {% for error in field.errors %}<li>{{ error }}</li>{% endfor %}
          </ul>
          {% endif %}
        </div>
        {% elif field.name == 'nucleo' %}
        <div>
          <label for="nucleo-search" class="block text-sm font-medium">{{ _('Núcleo') }}</label>
          <input
            type="text"
            id="nucleo-search"
            name="search"
            class="form-input w-full"
            form="search-nucleo"
            hx-get="/api/nucleos/"
            hx-trigger="keyup changed delay:500ms"
            hx-target="#id_nucleo"
            hx-swap="none"
            hx-on="htmx:afterRequest: renderNucleos(event)"
          />
          {% if field.errors %}
            {% render_field field|attr:"aria-invalid:true" class+="form-select w-full mt-2" %}
          {% else %}
            {% render_field field class+="form-select w-full mt-2" %}
          {% endif %}
          {% if field.errors %}
          <ul class="errorlist">
            {% for error in field.errors %}<li>{{ error }}</li>{% endfor %}
          </ul>
          {% endif %}
        </div>
        {% elif field.name == 'evento' %}
        <div>
          <label for="evento-search" class="block text-sm font-medium">{{ _('Evento') }}</label>
          <input
            type="text"
            id="evento-search"
            name="search"
            class="form-input w-full"
            form="search-evento"
            hx-get="/api/eventos/"
            hx-trigger="keyup changed delay:500ms"
            hx-target="#id_evento"
            hx-swap="none"
            hx-on="htmx:afterRequest: renderEventos(event)"
          />
          {% if field.errors %}
            {% render_field field|attr:"aria-invalid:true" class+="form-select w-full mt-2" %}
          {% else %}
            {% render_field field class+="form-select w-full mt-2" %}
          {% endif %}
          {% if field.errors %}
          <ul class="errorlist">
            {% for error in field.errors %}<li>{{ error }}</li>{% endfor %}
          </ul>
          {% endif %}
        </div>
        {% else %}
          {% include '_forms/field.html' with field=field %}
        {% endif %}
      {% endfor %}
      <button type="submit" class="btn btn-primary">{{ _('Salvar') }}</button>
    </form>
  </div>
</div>

<script src="{% url 'javascript-catalog' %}"></script>
<script>
  function renderOrganizacoes(evt) {
    const sel = document.querySelector('#id_organizacao');
    sel.innerHTML = '';
    try {
      const data = JSON.parse(evt.detail.xhr.response);
      const itens = data.results || data;
      sel.innerHTML =
        itens
          .map(o => `<option value="${o.id}">${o.nome}</option>`)
          .join('') || `<option value="">${gettext('Nenhum resultado')}</option>`;
    } catch (err) {
      sel.innerHTML = `<option value="">${gettext('Erro ao carregar')}</option>`;
    }
  }

  function renderNucleos(evt) {
    const sel = document.querySelector('#id_nucleo');
    sel.innerHTML = '';
    try {
      const data = JSON.parse(evt.detail.xhr.response);
      const itens = data.results || data;
      sel.innerHTML =
        itens
          .map(n => `<option value="${n.id}">${n.nome}</option>`)
          .join('') || `<option value="">${gettext('Nenhum resultado')}</option>`;
    } catch (err) {
      sel.innerHTML = `<option value="">${gettext('Erro ao carregar')}</option>`;
    }
  }

  function renderEventos(evt) {
    const sel = document.querySelector('#id_evento');
    sel.innerHTML = '';
    try {
      const data = JSON.parse(evt.detail.xhr.response);
      const itens = data.results || data;
      sel.innerHTML =
        itens
          .map(e => `<option value="${e.id}">${e.titulo}</option>`)
          .join('') || `<option value="">${gettext('Nenhum resultado')}</option>`;
    } catch (err) {
      sel.innerHTML = `<option value="">${gettext('Erro ao carregar')}</option>`;
    }
  }
</script>

