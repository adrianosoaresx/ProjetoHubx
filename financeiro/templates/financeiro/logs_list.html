{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ _('Logs Financeiros') }}{% endblock %}

{% block content %}
<main class="p-4 max-w-6xl mx-auto">
  <h1 class="text-2xl font-semibold mb-2">{{ _('Logs Financeiros') }}</h1>
  <form id="filtros" class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-4"
        hx-get="/api/financeiro/logs/"
        hx-target="#lista"
        hx-swap="none"
        hx-trigger="change from:select,change from:input, submit"
        hx-on="htmx:afterRequest: renderLogs(event)">
    <legend class="sr-only">{{ _('Filtros') }}</legend>
    <div>
      <label for="filtro-acao" class="block text-sm font-medium text-gray-700">{{ _('Ação') }}</label>
      <select name="acao" id="filtro-acao" class="border p-2 rounded">
        <option value="">{{ _('Todas Ações') }}</option>
        {% for value, label in acoes %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="filtro-usuario" class="block text-sm font-medium text-gray-700">{{ _('Usuário') }}</label>
      <select name="usuario" id="filtro-usuario" class="border p-2 rounded">
        <option value="">{{ _('Todos Usuários') }}</option>
        {% for u in usuarios %}
          <option value="{{ u.id }}">{{ u.email }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="filtro-inicio" class="block text-sm font-medium text-gray-700">{{ _('Início') }}</label>
      <input id="filtro-inicio" type="date" name="inicio" class="border p-2 rounded" />
    </div>
    <div>
      <label for="filtro-fim" class="block text-sm font-medium text-gray-700">{{ _('Fim') }}</label>
      <input id="filtro-fim" type="date" name="fim" class="border p-2 rounded" />
    </div>
  </form>
  <div id="lista" aria-live="polite">
    <table class="min-w-full divide-y divide-gray-200">
      <thead>
        <tr class="bg-gray-50">
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">{{ _('ID') }}</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">{{ _('Ação') }}</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">{{ _('Usuário') }}</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">{{ _('Data') }}</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script src="{% url 'javascript-catalog' %}"></script>
  <script>
    function renderLogs(evt) {
      const tbody = document.querySelector('#lista tbody');
      tbody.innerHTML = '';
      try {
        const data = JSON.parse(evt.detail.xhr.response);
        const itens = data.results || data;
        const rows = itens
          .map(l => `
            <tr>
              <td class="px-3 py-2">${l.id}</td>
              <td class="px-3 py-2">${l.acao}</td>
              <td class="px-3 py-2">${l.usuario || ''}</td>
              <td class="px-3 py-2">${l.created_at}</td>
            </tr>
          `)
          .join('');
        tbody.innerHTML = rows || `<tr><td colspan="4" class="px-3 py-2 text-center">${gettext('Nenhum log')}</td></tr>`;
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="4" class="px-3 py-2 text-center">${gettext('Erro ao carregar')}</td></tr>`;
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      htmx.trigger('#filtros', 'submit');
    });
  </script>
</main>
{% endblock %}
