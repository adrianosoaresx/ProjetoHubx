{% extends 'base.html' %}
{% load i18n widget_tweaks %}
{% block title %}{% trans "Editar Evento" %} | Hubx{% endblock %}

{% block hero %}
  {% include '_components/hero.html' with title=_('Editar Evento') %}
{% endblock %}

{% block content %}
<section class="max-w-screen-xl mx-auto pt-8 px-6 lg:px-8">
  <h1 class="text-2xl font-bold text-[var(--text-primary)] mb-6">{% trans "Editar Evento" %}</h1>

  <form method="post" enctype="multipart/form-data" class="bg-[var(--bg-secondary)] border border-[var(--border)] rounded-2xl card-sm p-6 space-y-6">
    {% csrf_token %}
    {% for field in form %}
      {% if field.name != 'inscricoes' and field.name != 'numero_presentes' %}
        {% if field.name == 'avatar' or field.name == 'cover' %}
          {% if field.value %}
            <img src="{{ field.value.url }}" alt="{{ field.label }}" class="w-32 h-32 object-cover mb-2">
          {% endif %}
          {% include '_forms/field.html' with field=field|attr:'accept:image/*' %}
        {% else %}
          {% include '_forms/field.html' with field=field %}
        {% endif %}
      {% endif %}
    {% endfor %}

    <div class="flex justify-end gap-3 pt-4 border-t border-[var(--border)]">
      <a href="{% url 'eventos:calendario' %}" class="btn btn-secondary" aria-label="{% trans 'Cancelar' %}">{% trans "Cancelar" %}</a>
      <button type="submit" class="btn btn-primary" aria-label="{% trans 'Salvar' %}">{% trans "Salvar" %}</button>
    </div>
  </form>

  <!-- Orçamento -->
  <div class="mt-10">
    <h2 class="text-lg font-semibold text-[var(--text-primary)] mb-4">{% trans "Orçamento" %}</h2>
    <form id="orcamento-form" method="post" action="{% url 'eventos:evento_orcamento' object.pk %}" class="bg-[var(--bg-secondary)] border border-[var(--border)] rounded-2xl card-sm p-6 space-y-6">
      {% csrf_token %}
      <div>
        {% include '_forms/field.html' with id='id_orcamento_estimado' name='orcamento_estimado' type='number' step='0.01' label=_("Orçamento estimado") value=object.orcamento_estimado|default_if_none:'' %}
      </div>
      <div>
        {% include '_forms/field.html' with id='id_valor_gasto' name='valor_gasto' type='number' step='0.01' label=_("Valor gasto") value=object.valor_gasto|default_if_none:'' %}
      </div>
      <div class="flex justify-end gap-3 pt-4 border-t border-[var(--border)]">
        <button type="submit" class="btn btn-primary" aria-label="{% trans 'Salvar' %}">{% trans "Salvar" %}</button>
      </div>
    </form>
    <p id="orcamento-feedback" class="text-sm mt-2"></p>
  </div>

  <!-- Inscritos -->
  <h2 class="text-lg font-semibold text-[var(--text-primary)] mt-10 mb-4">{% trans "Inscritos" %}</h2>
  {% if object.inscricoes.all %}
    <div class="card-grid gap-4">
      {% for ins in object.inscricoes.all %}
        {% with inscrito=ins.user %}
        <article class="card">
          <div class="card-body flex items-center justify-between">
            <div>
              <h3 class="text-sm font-medium text-[var(--text-primary)]">{{ inscrito.get_full_name|default:inscrito.username }}</h3>
              <p class="text-xs text-[var(--text-secondary)]">{{ inscrito.email }}</p>
            </div>
            {% if user.user_type in ['admin', 'coordenador'] %}
            <form method="post" action="{% url 'eventos:evento_remover_inscrito' object.pk inscrito.pk %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-secondary text-sm" aria-label="{% trans 'Remover' %}">{% trans "Remover" %}</button>
            </form>
            {% endif %}
          </div>
        </article>
        {% endwith %}
      {% endfor %}
    </div>
  {% else %}
    <p class="text-sm text-[var(--text-secondary)]">{% trans "Nenhum inscrito." %}</p>
  {% endif %}
</section>
{% endblock %}

{% block extra_js %}
<script>
  const orcamentoForm = document.getElementById('orcamento-form');
  if (orcamentoForm) {
    orcamentoForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const feedback = document.getElementById('orcamento-feedback');
      const formData = new FormData(orcamentoForm);
      try {
        const response = await fetch(orcamentoForm.action, {
          method: 'POST',
          headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
          },
          body: formData
        });
        if (response.ok) {
          const data = await response.json();
          document.getElementById('id_orcamento_estimado').value = data.orcamento_estimado;
          document.getElementById('id_valor_gasto').value = data.valor_gasto;
          feedback.textContent = '{% trans "Orçamento atualizado com sucesso." %}';
          feedback.className = 'text-sm text-green-600';
        } else {
          feedback.textContent = '{% trans "Erro ao atualizar orçamento." %}';
          feedback.className = 'text-sm text-red-600';
        }
      } catch (err) {
        feedback.textContent = '{% trans "Erro ao atualizar orçamento." %}';
        feedback.className = 'text-sm text-red-600';
      }
    });
  }
</script>
{% endblock %}
