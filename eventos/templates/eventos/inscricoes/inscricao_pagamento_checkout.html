{% extends 'base.html' %}
{% load i18n widget_tweaks %}

{% block title %}{{ title|default:_('Pagamento da inscrição') }}{% endblock %}

{% block hero %}{% include '_components/hero_evento_detail.html' with evento=evento %}{% endblock %}

{% block content %}
  <article class="card">
    <div class="card-header">
      <h2 class="text-xl font-semibold flex items-center gap-2">
        {% trans "Pagamento" %}
      </h2>
      <p class="text-sm text-[var(--text-secondary)]">{% trans "Preencha os dados para concluir o pagamento com segurança." %}</p>
    </div>
    <div class="card-body space-y-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <form
          id="inscricao-checkout-form"
          hx-post="{% url 'pagamentos:checkout' %}"
          hx-target="#checkout-result"
          hx-swap="outerHTML"
          method="post"
          class="space-y-4"
        >
          {% csrf_token %}
          <input type="hidden" name="organizacao_id" value="{{ evento.organizacao.id }}" />
          <input type="hidden" name="transacao_id" id="id_transacao_id" value="{{ transacao.id|default_if_none:'' }}">
          <input type="hidden" name="metodo_pagamento" id="id_metodo_pagamento" value="{{ transacao.metodo|default_if_none:'' }}" />
          <div class="space-y-4">
            <div class="rounded-lg border border-[var(--border)] bg-[var(--surface-secondary)] p-4 space-y-4">
              <div class="flex items-center justify-between gap-2">
                <h4 class="text-sm font-semibold text-[var(--text-primary)]">{% trans "Dados do titular" %}</h4>
                <span class="text-xs text-[var(--text-secondary)]">{% trans "Usaremos os dados do perfil quando disponível." %}</span>
              </div>
              <div class="space-y-4">
                <div>
                  <label class="block text-xs font-medium text-[var(--text-secondary)]" for="id_nome">{% trans "Nome completo" %}</label>
                  {{ checkout_form.nome|add_class:"input" }}
                </div>
                <div>
                  <label class="block text-xs font-medium text-[var(--text-secondary)]" for="id_email">{% trans "E-mail" %}</label>
                  {{ checkout_form.email|add_class:"input" }}
                </div>
                <div>
                  <label class="block text-xs font-medium text-[var(--text-secondary)]" for="id_documento">{% trans "CPF/CNPJ" %}</label>
                  {{ checkout_form.documento|add_class:"input" }}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-[var(--text-secondary)]" for="id_valor">{% trans "Valor" %}</label>
                    {{ checkout_form.valor|add_class:"input" }}
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-[var(--text-secondary)]" for="id_metodo">{% trans "Método" %}</label>
                    <select
                      name="{{ checkout_form.metodo.html_name }}"
                      id="{{ checkout_form.metodo.id_for_label }}"
                      class="input"
                      data-metodo-select
                    >
                      {% for value, label in checkout_form.metodo.field.choices %}
                        {% if value != 'paypal' %}
                          <option value="{{ value }}" {% if checkout_form.metodo.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
                        {% endif %}
                      {% endfor %}
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="rounded-lg border border-[var(--border)] bg-[var(--surface-secondary)] p-4 space-y-4" data-card-section>
              <div class="flex items-center justify-between gap-2">
                <h4 class="text-sm font-semibold text-[var(--text-primary)]">{% trans "Cartão de crédito" %}</h4>
                <span class="text-xs text-[var(--text-secondary)]">{% trans "Tokenização Mercado Pago" %}</span>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-medium text-[var(--text-secondary)]" for="card-number">{% trans "Número do cartão" %}</label>
                  <input id="card-number" class="input" autocomplete="cc-number" data-card-field data-card-required="true" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-[var(--text-secondary)]" for="security-code">{% trans "CVV" %}</label>
                  <input id="security-code" class="input" autocomplete="cc-csc" data-card-field data-card-required="true" />
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-xs font-medium text-[var(--text-secondary)]" for="card-expiration-month">{% trans "Mês" %}</label>
                  <input id="card-expiration-month" class="input" placeholder="MM" data-card-field data-card-required="true" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-[var(--text-secondary)]" for="card-expiration-year">{% trans "Ano" %}</label>
                  <input id="card-expiration-year" class="input" placeholder="YYYY" data-card-field data-card-required="true" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-[var(--text-secondary)]" for="id_parcelas">{% trans "Parcelas" %}</label>
                  {{ checkout_form.parcelas|add_class:"input"|attr:"data-card-field data-card-required=true" }}
                  <p class="text-[10px] text-[var(--text-secondary)]">{% trans "Associados podem parcelar em até 3 vezes." %}</p>
                </div>
              </div>
              <input id="document-type" type="hidden" value="CPF" />
              {{ checkout_form.token_cartao|add_class:"hidden"|attr:"id=id_token_cartao" }}
              <p class="text-[10px] text-[var(--text-secondary)]">{% trans "O token do cartão é enviado ao backend sem armazenar dados sensíveis." %}</p>
            </div>

            <div class="rounded-lg border border-[var(--border)] bg-[var(--surface-secondary)] p-4 space-y-3" data-boleto-section>
              <h4 class="text-sm font-semibold text-[var(--text-primary)]">{% trans "Boleto bancário" %}</h4>
              <div>
                <label class="block text-xs font-medium text-[var(--text-secondary)]" for="id_vencimento">{% trans "Data e hora de vencimento" %}</label>
                {{ checkout_form.vencimento|add_class:"input" }}
                <p class="text-[10px] text-[var(--text-secondary)]">{% trans "Use uma data futura para evitar recusa automática." %}</p>
              </div>
            </div>

            <div class="flex justify-end">
              <button type="submit" class="btn btn-secondary w-full" aria-label="{% trans 'Gerar pagamento' %}">
                {% trans "Gerar pagamento" %}
              </button>
            </div>
          </div>
        </form>

        <div id="checkout-result" class="rounded-lg border border-[var(--border)] bg-[var(--surface-secondary)] p-4" data-checkout-result>
          {% include "pagamentos/partials/checkout_resultado.html" with form=checkout_form transacao=transacao %}
        </div>
      </div>

      <form method="post" class="flex justify-end">
        {% csrf_token %}
        <input type="hidden" name="transacao_id" id="id_transacao_hidden" value="{{ transacao.id|default_if_none:'' }}">
        <input type="hidden" name="metodo_pagamento" id="id_metodo_pagamento_hidden" value="{{ transacao.metodo|default_if_none:'' }}">
        <button type="submit" class="btn btn-primary" aria-label="{% trans 'Atualizar inscrição' %}">{% trans "Atualizar inscrição" %}</button>
      </form>
    </div>
  </article>

  <script src="https://sdk.mercadopago.com/js/v2" integrity="sha384-oVdfFvNz9sGD73SlTY+IfPVd7MFLRmd2fKcr79pCcHnX3qO71F9vE1E7aNgH6B9H" crossorigin="anonymous"></script>
  <script>
    (() => {
      const publicKey = "{{ provider_public_key|default:"" }}";
      let mpInstance = null;
      let cardFormInstance = null;

      const cardSection = document.querySelector('[data-card-section]');
      const cardFields = Array.from(document.querySelectorAll('[data-card-field]'));
      const metodoSelect = document.querySelector('[data-metodo-select]');
      const boletoSection = document.querySelector('[data-boleto-section]');
      const boletoFields = boletoSection ? Array.from(boletoSection.querySelectorAll('input, select, textarea')) : [];
      const tokenField = document.getElementById('id_token_cartao');
      const metodoInscricaoField = document.getElementById('id_metodo_pagamento');
      const metodoHiddenField = document.getElementById('id_metodo_pagamento_hidden');
      const transacaoInput = document.getElementById('id_transacao_id');
      const transacaoHiddenInput = document.getElementById('id_transacao_hidden');

      function setCardFieldsState(isCard) {
        if (cardSection) {
          cardSection.classList.toggle('hidden', !isCard);
        }

        cardFields.forEach((field) => {
          if (isCard) {
            if (field.dataset.cardRequired === 'true') {
              field.setAttribute('required', 'required');
            }
            field.removeAttribute('disabled');
          } else {
            if (field.hasAttribute('required')) {
              field.dataset.cardRequired = 'true';
            }
            field.removeAttribute('required');
            field.setAttribute('disabled', 'disabled');
          }
        });

        if (!isCard && tokenField) {
          tokenField.value = '';
        }
      }

      function destroyCardForm() {
        if (cardFormInstance?.unmount) {
          cardFormInstance.unmount();
        }
        cardFormInstance = null;
      }

      function mountCardForm() {
        if (!publicKey || cardFormInstance) return;
        if (!mpInstance) {
          mpInstance = new MercadoPago(publicKey);
        }

        cardFormInstance = mpInstance.cardForm({
          amount: document.getElementById('id_valor')?.value || '0',
          autoMount: true,
          form: {
            id: 'inscricao-checkout-form',
            cardNumber: 'card-number',
            securityCode: 'security-code',
            expirationMonth: 'card-expiration-month',
            expirationYear: 'card-expiration-year',
            cardholderName: 'id_nome',
            cardholderEmail: 'id_email',
            identificationType: 'document-type',
            identificationNumber: 'id_documento',
            installments: 'id_parcelas',
            cardToken: 'id_token_cartao'
          },
          callbacks: {
            onFormMounted: (error) => { if (error) console.error(error); },
            onError: (error) => console.error('MP error', error),
          }
        });
      }

      function setBoletoFieldsState(isBoleto) {
        if (boletoSection) {
          boletoSection.classList.toggle('hidden', !isBoleto);
        }
        boletoFields.forEach((field) => {
          if (isBoleto) {
            field.removeAttribute('disabled');
            field.setAttribute('required', 'required');
          } else {
            field.removeAttribute('required');
            field.setAttribute('disabled', 'disabled');
          }
        });
        if (!isBoleto) {
          const vencimento = document.getElementById('id_vencimento');
          if (vencimento) {
            vencimento.value = '';
          }
        }
      }

      function handleMetodoChange() {
        const metodoSelecionado = metodoSelect?.value;
        const isCard = metodoSelecionado === 'card';
        const isBoleto = metodoSelecionado === 'boleto';
        setCardFieldsState(isCard);
        setBoletoFieldsState(isBoleto);
        if (metodoInscricaoField && metodoSelecionado) {
          metodoInscricaoField.value = metodoSelecionado;
        }
        if (metodoHiddenField && metodoSelecionado) {
          metodoHiddenField.value = metodoSelecionado;
        }
        if (isCard) {
          mountCardForm();
        } else {
          destroyCardForm();
        }
      }

      function syncTransacaoIdFromResult(target) {
        const transacaoContainer = target.querySelector('[data-transacao-id]');
        const transacaoId = transacaoContainer?.dataset.transacaoId;
        const transacaoStatus = transacaoContainer?.dataset.transacaoStatus;
        const metodo = transacaoContainer?.dataset.metodo;
        if (transacaoInput) {
          transacaoInput.value = transacaoId || '';
        }
        if (transacaoHiddenInput) {
          transacaoHiddenInput.value = transacaoId || '';
        }
        if (metodoInscricaoField && metodo) {
          metodoInscricaoField.value = metodo;
        }
        if (metodoHiddenField && metodo) {
          metodoHiddenField.value = metodo;
        }
        if (transacaoStatus === 'approved') {
          document.getElementById('inscricao-checkout-form')?.classList.add('pointer-events-none', 'opacity-70');
        }
      }

      handleMetodoChange();
      metodoSelect?.addEventListener('change', handleMetodoChange);

      document.addEventListener('htmx:afterSwap', (event) => {
        if (event.detail?.target?.matches?.('#checkout-result')) {
          syncTransacaoIdFromResult(event.target || event.detail.target);
        }
      });

      document.addEventListener('click', (event) => {
        if (event.target.matches('[data-copy]')) {
          const code = event.target.getAttribute('data-copy');
          navigator.clipboard.writeText(code || '').then(() => {
            event.target.innerText = event.target.dataset.labelCopied;
            setTimeout(() => { event.target.innerText = event.target.dataset.label; }, 1200);
          });
        }
      });
    })();
  </script>
{% endblock %}
