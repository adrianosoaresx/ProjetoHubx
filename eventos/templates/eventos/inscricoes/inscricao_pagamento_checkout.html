{% extends 'base.html' %}
{% load i18n widget_tweaks %}

{% block title %}{{ title|default:_('Pagamento da inscrição') }}{% endblock %}

{% block hero %}{% include '_components/hero_evento_detail.html' with evento=evento %}{% endblock %}

{% block content %}
  <article class="card">
    <div class="card-header">
      <h2 class="text-xl font-semibold flex items-center gap-2">
        {% trans "Pagamento" %}
      </h2>
      <p class="text-sm text-[var(--text-secondary)]">{% trans "Preencha os dados para concluir o pagamento com segurança." %}</p>
    </div>
    <div class="card-body space-y-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <form
          id="inscricao-checkout-form"
          hx-post="{% url 'pagamentos:checkout' %}"
          hx-target="#checkout-result"
          hx-swap="outerHTML"
          method="post"
          class="space-y-4"
        >
          {% csrf_token %}
          <input type="hidden" name="organizacao_id" value="{{ evento.organizacao.id }}" />
          <input type="hidden" name="transacao_id" id="id_transacao_id" value="{{ transacao.id|default_if_none:'' }}">
          <input type="hidden" name="metodo_pagamento" id="id_metodo_pagamento" value="{{ transacao.metodo|default_if_none:'' }}" />
          <div class="space-y-4">
            <div class="rounded-lg border border-[var(--border)] bg-[var(--surface-secondary)] p-4 space-y-4">
              <div class="flex items-center justify-between gap-2">
                <h4 class="text-sm font-semibold text-[var(--text-primary)]">{% trans "Dados do titular" %}</h4>
                <span class="text-xs text-[var(--text-secondary)]">{% trans "Usaremos os dados do perfil quando disponível." %}</span>
              </div>
              <div class="space-y-4">
                <div>
                  <label class="block text-xs font-medium text-[var(--text-secondary)]" for="id_nome">{% trans "Nome completo" %}</label>
                  {{ checkout_form.nome|add_class:"input w-full" }}
                </div>
                <div>
                  <label class="block text-xs font-medium text-[var(--text-secondary)]" for="id_email">{% trans "E-mail" %}</label>
                  {{ checkout_form.email|add_class:"input w-full" }}
                </div>
                <div>
                  <label class="block text-xs font-medium text-[var(--text-secondary)]" for="id_documento">{% trans "CPF/CNPJ" %}</label>
                  {{ checkout_form.documento|add_class:"input w-full" }}
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-[var(--text-secondary)]" for="id_valor">{% trans "Valor" %}</label>
                    {{ checkout_form.valor|add_class:"input w-full" }}
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-[var(--text-secondary)]" for="id_metodo">{% trans "Método" %}</label>
                    <select
                      name="{{ checkout_form.metodo.html_name }}"
                      id="{{ checkout_form.metodo.id_for_label }}"
                      class="input w-full"
                      data-metodo-select
                    >
                      {% for value, label in checkout_form.metodo.field.choices %}
                        {% if value != 'paypal' %}
                          <option value="{{ value }}" {% if checkout_form.metodo.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
                        {% endif %}
                      {% endfor %}
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex justify-end">
              <button type="submit" class="btn btn-secondary w-full" aria-label="{% trans 'Gerar pagamento' %}">
                {% trans "Gerar pagamento" %}
              </button>
            </div>
          </div>
        </form>

        <div id="checkout-result" class="rounded-lg border border-[var(--border)] bg-[var(--surface-secondary)] p-4" data-checkout-result>
          {% include "pagamentos/partials/checkout_resultado.html" with form=checkout_form transacao=transacao %}
        </div>
      </div>

      <form method="post" class="flex justify-end">
        {% csrf_token %}
        <input type="hidden" name="transacao_id" id="id_transacao_hidden" value="{{ transacao.id|default_if_none:'' }}">
        <input type="hidden" name="metodo_pagamento" id="id_metodo_pagamento_hidden" value="{{ transacao.metodo|default_if_none:'' }}">
        <button type="submit" class="btn btn-primary" aria-label="{% trans 'Atualizar inscrição' %}">{% trans "Atualizar inscrição" %}</button>
      </form>
    </div>
  </article>

  <script>
    (() => {
      const metodoSelect = document.querySelector('[data-metodo-select]');
      const metodoInscricaoField = document.getElementById('id_metodo_pagamento');
      const metodoHiddenField = document.getElementById('id_metodo_pagamento_hidden');
      const transacaoInput = document.getElementById('id_transacao_id');
      const transacaoHiddenInput = document.getElementById('id_transacao_hidden');

      function handleMetodoChange() {
        const metodoSelecionado = metodoSelect?.value;
        if (metodoInscricaoField && metodoSelecionado) {
          metodoInscricaoField.value = metodoSelecionado;
        }
        if (metodoHiddenField && metodoSelecionado) {
          metodoHiddenField.value = metodoSelecionado;
        }
      }

      function syncTransacaoIdFromResult(target) {
        const transacaoContainer = target.querySelector('[data-transacao-id]');
        const transacaoId = transacaoContainer?.dataset.transacaoId;
        const transacaoStatus = transacaoContainer?.dataset.transacaoStatus;
        const metodo = transacaoContainer?.dataset.metodo;
        if (transacaoInput) {
          transacaoInput.value = transacaoId || '';
        }
        if (transacaoHiddenInput) {
          transacaoHiddenInput.value = transacaoId || '';
        }
        if (metodoInscricaoField && metodo) {
          metodoInscricaoField.value = metodo;
        }
        if (metodoHiddenField && metodo) {
          metodoHiddenField.value = metodo;
        }
        if (transacaoStatus === 'approved') {
          document.getElementById('inscricao-checkout-form')?.classList.add('pointer-events-none', 'opacity-70');
        }
      }

      handleMetodoChange();
      metodoSelect?.addEventListener('change', handleMetodoChange);

      document.addEventListener('htmx:afterSwap', (event) => {
        if (event.detail?.target?.matches?.('#checkout-result')) {
          syncTransacaoIdFromResult(event.target || event.detail.target);
        }
      });

      document.addEventListener('click', (event) => {
        if (event.target.matches('[data-copy]')) {
          const code = event.target.getAttribute('data-copy');
          navigator.clipboard.writeText(code || '').then(() => {
            event.target.innerText = event.target.dataset.labelCopied;
            setTimeout(() => { event.target.innerText = event.target.dataset.label; }, 1200);
          });
        }
      });
    })();
  </script>
{% endblock %}
