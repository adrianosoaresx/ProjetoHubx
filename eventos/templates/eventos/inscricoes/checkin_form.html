{% extends 'base.html' %}
{% load i18n static %}

{% block title %}{{ title|default:_('Check-in do evento') }}{% endblock %}

{% block hero %}{% include '_components/hero_evento.html' with evento=evento title=title subtitle=subtitle %}{% endblock %}

{% block content %}
  
    <article class="card">
      <div class="card-header">
        <h2 class="text-xl font-semibold">{{ title|default:_('Check-in do evento') }}</h2>
      </div>
      <div class="card-body space-y-6">
        <form method="post" action="{% url 'eventos:inscricao_checkin' inscricao.id %}" id="checkin-form" class="space-y-4">
          {% csrf_token %}
          <div>
            <label for="codigo" class="block text-sm font-medium">{% trans "Código do check-in" %}</label>
            <input type="text" id="codigo" name="codigo" class="form-input w-full" placeholder="{% trans 'Escaneie ou digite o código' %}" required>
          </div>
          <div id="feedback" class="text-sm" role="status" aria-live="polite"></div>
          <div id="reader" class="w-full min-h-[240px] rounded-lg border border-[var(--border)] bg-[var(--bg-secondary)] p-4"></div>
          <div class="text-right">
            <button type="submit" class="btn btn-primary" aria-label="{% trans 'Confirmar presença' %}">{% trans 'Confirmar presença' %}</button>
          </div>
        </form>
      </div>
    </article>
  
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script
    src="{% static 'js/vendor/html5-qrcode-2.3.8.min.js' %}"
    defer
    onerror="if (!this.dataset.fallbackLoaded) { this.dataset.fallbackLoaded = 'true'; this.src='https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js'; }"
  ></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("checkin-form");
      const codigoInput = document.getElementById("codigo");
      const feedback = document.getElementById("feedback");
      const successMessage = "{% trans 'Check-in realizado com sucesso!' %}";
      const readerEl = document.getElementById("reader");
      const submitButton = form.querySelector('button[type="submit"]');

      const showCameraError = (error) => {
        const message = (error?.name === "NotAllowedError" || `${error}`.toLowerCase().includes("denied"))
          ? "{% trans 'Permissão da câmera negada' %}"
          : "{% trans 'Não foi possível acessar a câmera' %}";

        feedback.classList.remove("text-[var(--success)]");
        feedback.classList.add("text-[var(--error)]");
        feedback.textContent = message;
        if (submitButton) {
          submitButton.disabled = false;
        }
      };

      if (window.Html5Qrcode && readerEl) {
        const qr = new Html5Qrcode("reader");
        qr.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decoded) => {
            codigoInput.value = decoded;
            qr.stop();
          },
          (err) => {
            showCameraError(err);
          }
        ).catch((err) => {
          showCameraError(err);
        });
      }

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        feedback.textContent = "";
        const csrf = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
        fetch(form.action, {
          method: "POST",
          headers: { "X-CSRFToken": csrf },
          body: new FormData(form),
        })
          .then((response) => {
            if (!response.ok) {
              return response.text().then((text) => {
                throw new Error(text || "{% trans 'Erro ao realizar check-in' %}");
              });
            }
            return response.json();
          })
          .then(() => {
            feedback.classList.remove("text-[var(--error)]");
            feedback.classList.add("text-[var(--success)]");
            feedback.textContent = successMessage;
            form.reset();
          })
          .catch((err) => {
            feedback.classList.remove("text-[var(--success)]");
            feedback.classList.add("text-[var(--error)]");
            feedback.textContent = err.message;
          });
      });
    });
  </script>
{% endblock %}
