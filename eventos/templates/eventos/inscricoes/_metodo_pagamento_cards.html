{% load i18n lucide_icons %}

<div
  class="space-y-2"
  data-payment-method-cards
  data-payment-field-name="{{ field.html_name }}"
>
  <p class="text-sm font-medium text-[var(--text-primary)]" id="{{ field.auto_id|default:field.html_name }}_legend">
    {{ field.label }}{% if field.field.required %} *{% endif %}
  </p>
  <div
    class="grid gap-3 sm:grid-cols-3"
    role="radiogroup"
    aria-labelledby="{{ field.auto_id|default:field.html_name }}_legend"
    {% if field.field.required %}aria-required="true"{% endif %}
  >
    {% with selected=field.value base_id=field.auto_id|default:field.html_name disabled=field.field.disabled %}
      <label
        class="block h-full {% if disabled %}cursor-not-allowed opacity-60{% else %}cursor-pointer{% endif %}"
        for="{{ base_id }}_pix"
        data-payment-card
        data-payment-card-value="pix"
      >
        <input
          type="radio"
          name="{{ field.html_name }}"
          value="pix"
          class="sr-only peer"
          id="{{ base_id }}_pix"
          {% if selected == "pix" %}checked{% endif %}
          {% if disabled %}disabled{% endif %}
          {% if field.errors %}aria-invalid="true"{% endif %}
          {% if field.field.required and not disabled %}required{% endif %}
        />
        <div
          class="relative flex h-full flex-col rounded-xl border border-[var(--border)] bg-[var(--surface-primary)] p-4 text-left transition focus-within:outline focus-within:outline-2 focus-within:outline-offset-2 focus-within:outline-primary-500 shadow-sm peer-checked:border-primary-500 peer-checked:bg-primary-500/10 peer-checked:ring-2 peer-checked:ring-primary-500/60 peer-focus-visible:outline peer-focus-visible:outline-2 peer-focus-visible:outline-offset-2 peer-focus-visible:outline-primary-500{% if disabled %} cursor-not-allowed{% else %} hover:border-primary-400{% endif %}"
          data-payment-card-body
        >
          <span
            class="pointer-events-none absolute right-3 top-3 hidden items-center justify-center rounded-full bg-primary-500 p-1 text-white peer-checked:flex"
            aria-hidden="true"
          >
            {% lucide 'check' class='h-3.5 w-3.5' aria_hidden='true' %}
          </span>
          <div class="flex items-center gap-2 text-[var(--text-primary)]">
            {% lucide 'qr-code' class='w-5 h-5 text-primary-500' aria_hidden='true' %}
            <span class="text-base font-semibold">{% trans "Pix" %}</span>
          </div>
          <p class="mt-2 text-sm text-[var(--text-secondary)]">
            {% trans "Pague instantaneamente via Pix." %}
          </p>
          <div
            class="mt-3 hidden border-t border-dashed border-[var(--border)] pt-3"
            data-payment-card-accordion
            data-payment-accordion-value="pix"
            data-pix-section
            data-pix-key="{{ evento.organizacao.chave_pix|default:''|escapejs }}"
            data-pix-amount="{{ valor_evento_usuario|default_if_none:0 }}"
            data-pix-event-title="{{ evento.titulo|default:''|escapejs }}"
            data-copy-success-text="{% trans 'Chave Pix copiada para a área de transferência.' %}"
            data-copy-error-text="{% trans 'Não foi possível copiar a chave Pix. Tente novamente.' %}"
            data-copy-missing-text="{% trans 'Nenhuma chave Pix disponível no momento.' %}"
            data-qr-error-text="{% trans 'Não foi possível gerar o QR Code Pix.' %}"
          >
            <p class="text-sm text-[var(--text-secondary)]">
              {% trans "Escolha uma opção para finalizar o pagamento via Pix." %}
            </p>
            <div
              class="mt-3 grid items-start gap-2 sm:grid-cols-2"
              role="group"
              aria-label="{% trans 'Opções de pagamento via Pix' %}"
            >
              <div
                class="flex w-full flex-col rounded-lg border border-[var(--border)] bg-[var(--surface-secondary)] p-3 text-left transition hover:border-primary-400 focus-within:ring-2 focus-within:ring-primary-500 focus-within:ring-offset-2"
              >
                <button
                  type="button"
                  class="flex w-full items-center justify-between gap-2 text-left text-[var(--text-primary)] transition hover:text-primary-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2"
                  data-pix-key-button
                  aria-expanded="false"
                  aria-controls="{{ base_id }}_pix_key_panel"
                >
                  <span class="flex items-center gap-2">
                    {% lucide 'copy' class='w-4 h-4 text-primary-500' aria_hidden='true' %}
                    <span class="text-sm font-semibold">{% trans "Copiar chave Pix" %}</span>
                  </span>
                  {% lucide 'chevron-down' class='w-4 h-4 text-[var(--text-secondary)] transition data-[state=open]:rotate-180' aria_hidden='true' data_state_indicator='true' data_state='closed' %}
                </button>
                <p class="mt-2 text-xs text-[var(--text-secondary)]">
                  {% if evento.organizacao.chave_pix %}
                    {% blocktrans trimmed %}Copie a chave Pix da organização para pagar no seu banco.{% endblocktrans %}
                  {% else %}
                    {% trans "Nenhuma chave Pix cadastrada pela organização." %}
                  {% endif %}
                </p>
                <div
                  id="{{ base_id }}_pix_key_panel"
                  class="mt-3 hidden rounded-lg border border-dashed border-[var(--border)] bg-[var(--surface-primary)] p-3"
                  data-pix-key-panel
                  aria-hidden="true"
                >
                  <div class="space-y-3">
                    <div>
                      <p class="text-xs font-medium text-[var(--text-secondary)]">{% trans "Chave Pix" %}</p>
                      <p
                        class="mt-1 break-all font-mono text-sm text-[var(--text-primary)]"
                        data-pix-key-display
                      >
                        {% if evento.organizacao.chave_pix %}
                          {{ evento.organizacao.chave_pix }}
                        {% else %}
                          {% trans "Nenhuma chave Pix cadastrada pela organização." %}
                        {% endif %}
                      </p>
                    </div>
                    <button
                      type="button"
                      class="inline-flex items-center gap-2 rounded-md bg-[var(--primary)] px-3 py-2 text-sm font-medium text-[var(--text-inverse)] transition hover:bg-[var(--primary-hover)] focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--primary)] focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60"
                      data-pix-copy-button
                      {% if not evento.organizacao.chave_pix %}disabled{% endif %}
                    >
                      {% lucide 'copy' class='w-4 h-4' aria_hidden='true' %}
                      <span>{% trans "Copiar chave" %}</span>
                    </button>
                  </div>
                </div>
              </div>
              <div
                class="flex w-full flex-col rounded-lg border border-[var(--border)] bg-[var(--surface-secondary)] p-3 text-left transition hover:border-primary-400 focus-within:ring-2 focus-within:ring-primary-500 focus-within:ring-offset-2"
                data-pix-qrcode-card
              >
                <button
                  type="button"
                  class="flex w-full items-center justify-between gap-2 text-left text-[var(--text-primary)] transition hover:text-primary-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2"
                  data-pix-qrcode-button
                  aria-expanded="false"
                  aria-controls="{{ base_id }}_pix_qrcode_panel"
                >
                  <span class="flex items-center gap-2">
                    {% lucide 'qr-code' class='w-4 h-4 text-primary-500' aria_hidden='true' %}
                    <span class="text-sm font-semibold">{% trans "Exibir QR Code" %}</span>
                  </span>
                  {% lucide 'chevron-down' class='w-4 h-4 text-[var(--text-secondary)] transition data-[state=open]:rotate-180' aria_hidden='true' data_state_indicator='true' data_state='closed' %}
                </button>
                <p class="mt-2 text-xs text-[var(--text-secondary)]">
                  {% blocktrans trimmed %}Visualize um QR Code com o valor do evento para pagamento imediato.{% endblocktrans %}
                </p>
                <div
                  id="{{ base_id }}_pix_qrcode_panel"
                  class="mt-3 hidden rounded-lg border border-dashed border-[var(--border)] bg-[var(--surface-primary)] p-3"
                  data-pix-qrcode-panel
                  aria-hidden="true"
                >
                  <p class="text-xs text-[var(--text-secondary)]">
                    {% trans "Use o aplicativo do seu banco para escanear o código." %}
                  </p>
                  <div class="mt-3 flex justify-center">
                    <div
                      class="rounded-lg bg-white p-3"
                      data-pix-qr-container
                      aria-live="polite"
                      aria-busy="false"
                    ></div>
                  </div>
                  <dl class="mt-4 space-y-2 text-xs text-[var(--text-secondary)]">
                    <div class="flex justify-between gap-4">
                      <dt class="font-medium text-[var(--text-primary)]">{% trans "Valor" %}</dt>
                      <dd data-pix-qrcode-amount class="text-right text-[var(--text-primary)]"></dd>
                    </div>
                    <div class="flex justify-between gap-4">
                      <dt class="font-medium text-[var(--text-primary)]">{% trans "Chave" %}</dt>
                      <dd data-pix-qrcode-key class="text-right break-all text-[var(--text-primary)]"></dd>
                    </div>
                  </dl>
                </div>
              </div>
            </div>
            <p
              class="mt-2 hidden text-xs font-medium text-primary-600"
              data-pix-feedback
              role="status"
            ></p>
          </div>
        </div>
      </label>

      <div class="sm:col-span-3" data-faturar-wrapper>
        <div
          class="relative flex h-full flex-col rounded-xl border border-[var(--border)] bg-[var(--surface-primary)] p-4 text-left transition focus-within:outline focus-within:outline-2 focus-within:outline-offset-2 focus-within:outline-primary-500 shadow-sm{% if disabled %} cursor-not-allowed opacity-60{% else %} hover:border-primary-400{% endif %}"
          data-faturar-container
        >
          <button
            type="button"
            class="flex w-full items-center justify-between gap-2 text-left text-[var(--text-primary)] transition focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2"
            data-faturar-toggle
            aria-expanded="false"
            aria-controls="{{ base_id }}_faturar_panel"
            {% if disabled %}disabled{% endif %}
          >
            <span class="flex items-center gap-2">
              {% lucide 'file-text' class='w-5 h-5 text-primary-500' aria_hidden='true' %}
              <span class="text-base font-semibold">{% trans "Faturar" %}</span>
            </span>
            {% lucide 'chevron-down' class='w-5 h-5 text-[var(--text-secondary)] transition data-[state=open]:rotate-180' aria_hidden='true' data_state_indicator='true' data_state='closed' %}
          </button>
          <p class="mt-2 text-sm text-[var(--text-secondary)]">
            {% trans "Escolha a modalidade de faturamento disponível." %}
          </p>
          <div
            id="{{ base_id }}_faturar_panel"
            class="mt-3 hidden border-t border-dashed border-[var(--border)] pt-3"
            data-faturar-panel
            aria-hidden="true"
          >
            <div class="grid gap-4 md:grid-cols-3">
              <label
                class="block h-full {% if disabled %}cursor-not-allowed opacity-60{% else %}cursor-pointer{% endif %}"
                for="{{ base_id }}_faturar_avista"
                data-payment-card
                data-payment-card-value="faturar_avista"
              >
                <input
                  type="radio"
                  name="{{ field.html_name }}"
                  value="faturar_avista"
                  class="sr-only peer"
                  id="{{ base_id }}_faturar_avista"
                  {% if selected == "faturar_avista" %}checked{% endif %}
                  {% if disabled %}disabled{% endif %}
                  {% if field.errors %}aria-invalid="true"{% endif %}
                  {% if field.field.required and not disabled %}required{% endif %}
                />
                <div
                  class="relative flex h-full flex-col rounded-xl border border-[var(--border)] bg-[var(--surface-primary)] p-4 text-left transition focus-within:outline focus-within:outline-2 focus-within:outline-offset-2 focus-within:outline-primary-500 shadow-sm peer-checked:border-primary-500 peer-checked:bg-primary-500/10 peer-checked:ring-2 peer-checked:ring-primary-500/60 peer-focus-visible:outline peer-focus-visible:outline-2 peer-focus-visible:outline-offset-2 peer-focus-visible:outline-primary-500{% if disabled %} cursor-not-allowed{% else %} hover:border-primary-400{% endif %}"
                  data-payment-card-body
                >
                  <span
                    class="pointer-events-none absolute right-3 top-3 hidden items-center justify-center rounded-full bg-primary-500 p-1 text-white peer-checked:flex"
                    aria-hidden="true"
                  >
                    {% lucide 'check' class='h-3.5 w-3.5' aria_hidden='true' %}
                  </span>
                  <div class="flex items-center gap-2 text-[var(--text-primary)]">
                    {% lucide 'file-text' class='w-5 h-5 text-primary-500' aria_hidden='true' %}
                    <span class="text-base font-semibold">{% trans "Faturar à vista" %}</span>
                  </div>
                  <p class="mt-2 text-sm text-[var(--text-secondary)]">
                    {% trans "Pague o valor integral na próxima fatura." %}
                  </p>
                  <div
                    class="mt-3 hidden border-t border-dashed border-[var(--border)] pt-3"
                    data-payment-card-accordion
                    data-payment-accordion-value="faturar_avista"
                  >
                    <p class="text-sm text-[var(--text-secondary)]">
                      {% blocktrans trimmed %}O valor será incluído integralmente na próxima fatura conforme acordo com a organização.{% endblocktrans %}
                    </p>
                  </div>
                </div>
              </label>

              <label
                class="block h-full {% if disabled %}cursor-not-allowed opacity-60{% else %}cursor-pointer{% endif %}"
                for="{{ base_id }}_faturar_2x"
                data-payment-card
                data-payment-card-value="faturar_2x"
              >
                <input
                  type="radio"
                  name="{{ field.html_name }}"
                  value="faturar_2x"
                  class="sr-only peer"
                  id="{{ base_id }}_faturar_2x"
                  {% if selected == "faturar_2x" %}checked{% endif %}
                  {% if disabled %}disabled{% endif %}
                  {% if field.errors %}aria-invalid="true"{% endif %}
                  {% if field.field.required and not disabled %}required{% endif %}
                />
                <div
                  class="relative flex h-full flex-col rounded-xl border border-[var(--border)] bg-[var(--surface-primary)] p-4 text-left transition focus-within:outline focus-within:outline-2 focus-within:outline-offset-2 focus-within:outline-primary-500 shadow-sm peer-checked:border-primary-500 peer-checked:bg-primary-500/10 peer-checked:ring-2 peer-checked:ring-primary-500/60 peer-focus-visible:outline peer-focus-visible:outline-2 peer-focus-visible:outline-offset-2 peer-focus-visible:outline-primary-500{% if disabled %} cursor-not-allowed{% else %} hover:border-primary-400{% endif %}"
                  data-payment-card-body
                >
                  <span
                    class="pointer-events-none absolute right-3 top-3 hidden items-center justify-center rounded-full bg-primary-500 p-1 text-white peer-checked:flex"
                    aria-hidden="true"
                  >
                    {% lucide 'check' class='h-3.5 w-3.5' aria_hidden='true' %}
                  </span>
                  <div class="flex items-center gap-2 text-[var(--text-primary)]">
                    {% lucide 'file-text' class='w-5 h-5 text-primary-500' aria_hidden='true' %}
                    <span class="text-base font-semibold">{% trans "Faturar em 2x" %}</span>
                  </div>
                  <p class="mt-2 text-sm text-[var(--text-secondary)]">
                    {% trans "Divida o valor em duas faturas consecutivas." %}
                  </p>
                  <div
                    class="mt-3 hidden border-t border-dashed border-[var(--border)] pt-3"
                    data-payment-card-accordion
                    data-payment-accordion-value="faturar_2x"
                  >
                    <p class="text-sm text-[var(--text-secondary)]">
                      {% blocktrans trimmed %}O valor será faturado em duas parcelas conforme acordo com a organização.{% endblocktrans %}
                    </p>
                  </div>
                </div>
              </label>

              <label
                class="block h-full {% if disabled %}cursor-not-allowed opacity-60{% else %}cursor-pointer{% endif %}"
                for="{{ base_id }}_faturar_3x"
                data-payment-card
                data-payment-card-value="faturar_3x"
              >
                <input
                  type="radio"
                  name="{{ field.html_name }}"
                  value="faturar_3x"
                  class="sr-only peer"
                  id="{{ base_id }}_faturar_3x"
                  {% if selected == "faturar_3x" %}checked{% endif %}
                  {% if disabled %}disabled{% endif %}
                  {% if field.errors %}aria-invalid="true"{% endif %}
                  {% if field.field.required and not disabled %}required{% endif %}
                />
                <div
                  class="relative flex h-full flex-col rounded-xl border border-[var(--border)] bg-[var(--surface-primary)] p-4 text-left transition focus-within:outline focus-within:outline-2 focus-within:outline-offset-2 focus-within:outline-primary-500 shadow-sm peer-checked:border-primary-500 peer-checked:bg-primary-500/10 peer-checked:ring-2 peer-checked:ring-primary-500/60 peer-focus-visible:outline peer-focus-visible:outline-2 peer-focus-visible:outline-offset-2 peer-focus-visible:outline-primary-500{% if disabled %} cursor-not-allowed{% else %} hover:border-primary-400{% endif %}"
                  data-payment-card-body
                >
                  <span
                    class="pointer-events-none absolute right-3 top-3 hidden items-center justify-center rounded-full bg-primary-500 p-1 text-white peer-checked:flex"
                    aria-hidden="true"
                  >
                    {% lucide 'check' class='h-3.5 w-3.5' aria_hidden='true' %}
                  </span>
                  <div class="flex items-center gap-2 text-[var(--text-primary)]">
                    {% lucide 'file-text' class='w-5 h-5 text-primary-500' aria_hidden='true' %}
                    <span class="text-base font-semibold">{% trans "Faturar em 3x" %}</span>
                  </div>
                  <p class="mt-2 text-sm text-[var(--text-secondary)]">
                    {% trans "Divida o valor em três faturas consecutivas." %}
                  </p>
                  <div
                    class="mt-3 hidden border-t border-dashed border-[var(--border)] pt-3"
                    data-payment-card-accordion
                    data-payment-accordion-value="faturar_3x"
                  >
                    <p class="text-sm text-[var(--text-secondary)]">
                      {% blocktrans trimmed %}O valor será faturado em três parcelas conforme acordo com a organização.{% endblocktrans %}
                    </p>
                  </div>
                </div>
              </label>
            </div>
          </div>
        </div>
      </div>
    {% endwith %}
  </div>

  {% if field.errors %}
    <ul class="errorlist">
      {% for error in field.errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {% if field.help_text %}
    <p class="text-xs text-[var(--text-secondary)]">{{ field.help_text }}</p>
  {% endif %}
</div>

<script>
  (() => {
    const SELECTED_CLASSES = [
      "border-primary-500",
      "bg-primary-500/10",
      "ring-2",
      "ring-primary-500/60",
    ];

    const initializedGroups = new WeakSet();
    const initializedPixSections = new WeakSet();
    const faturarAccordionControllers = new WeakMap();
    const ACCORDION_HIDDEN_CLASS = 'hidden';
    const FATURAR_VALUE_PREFIX = 'faturar';

    let qrLibraryPromise = null;

    function getFaturarContainer(group) {
      if (!group) {
        return null;
      }
      return group.querySelector('[data-faturar-container]');
    }

    function updateFaturarContainerHighlight(group) {
      if (!group) {
        return;
      }
      const container = getFaturarContainer(group);
      if (!container) {
        return;
      }
      const isSelected = !!group.querySelector(
        'input[type="radio"][value^="faturar"]:checked'
      );
      SELECTED_CLASSES.forEach((className) => {
        container.classList.toggle(className, isSelected);
      });
    }

    function initFaturarAccordion(group) {
      const container = getFaturarContainer(group);
      if (!container) {
        return;
      }

      if (faturarAccordionControllers.has(container)) {
        const existing = faturarAccordionControllers.get(container);
        if (existing && typeof existing.refresh === 'function') {
          existing.refresh();
        }
        return;
      }

      const toggle = container.querySelector('[data-faturar-toggle]');
      const panel = container.querySelector('[data-faturar-panel]');
      if (!toggle || !panel) {
        return;
      }

      const indicator = toggle.querySelector('[data-state-indicator]');

      const controller = {
        expandedBySelection: false,
        setState(open, { fromSelection = false } = {}) {
          toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
          panel.classList.toggle(ACCORDION_HIDDEN_CLASS, !open);
          if (open) {
            panel.removeAttribute('aria-hidden');
          } else {
            panel.setAttribute('aria-hidden', 'true');
          }
          if (indicator) {
            indicator.setAttribute('data-state', open ? 'open' : 'closed');
          }
          if (fromSelection) {
            controller.expandedBySelection = open;
          }
        },
        isOpen() {
          return toggle.getAttribute('aria-expanded') === 'true';
        },
        openFromSelection() {
          controller.setState(true, { fromSelection: true });
        },
        closeFromSelection() {
          controller.setState(false, { fromSelection: true });
        },
        refresh() {
          const selectedInput = container.querySelector(
            'input[type="radio"][value^="faturar"]:checked'
          );
          controller.setState(!!selectedInput);
          controller.expandedBySelection = !!selectedInput;
        },
      };

      toggle.addEventListener('click', () => {
        const isExpanded = controller.isOpen();
        controller.setState(!isExpanded);
        if (!isExpanded) {
          controller.expandedBySelection = false;
        }
      });

      faturarAccordionControllers.set(container, controller);
      controller.refresh();
    }

    function toggleAccordion(card, open) {
      const accordion = card.querySelector('[data-payment-card-accordion]');
      if (!accordion) {
        return;
      }
      accordion.classList.toggle(ACCORDION_HIDDEN_CLASS, !open);
      if (open) {
        accordion.removeAttribute('aria-hidden');
      } else {
        accordion.setAttribute('aria-hidden', 'true');
        const pixPanel = accordion.querySelector('[data-pix-qrcode-panel]');
        if (pixPanel) {
          pixPanel.classList.add(ACCORDION_HIDDEN_CLASS);
          pixPanel.setAttribute('aria-hidden', 'true');
        }
        const pixButton = accordion.querySelector('[data-pix-qrcode-button]');
        if (pixButton) {
          pixButton.setAttribute('aria-expanded', 'false');
          const indicator = pixButton.querySelector('[data-state-indicator]');
          if (indicator) {
            indicator.setAttribute('data-state', 'closed');
          }
        }
        const pixKeyPanel = accordion.querySelector('[data-pix-key-panel]');
        if (pixKeyPanel) {
          pixKeyPanel.classList.add(ACCORDION_HIDDEN_CLASS);
          pixKeyPanel.setAttribute('aria-hidden', 'true');
        }
        const pixKeyButton = accordion.querySelector('[data-pix-key-button]');
        if (pixKeyButton) {
          pixKeyButton.setAttribute('aria-expanded', 'false');
          const indicator = pixKeyButton.querySelector('[data-state-indicator]');
          if (indicator) {
            indicator.setAttribute('data-state', 'closed');
          }
        }
      }
    }

    function updatePaymentProofVisibility(group, { emitEvent = true } = {}) {
      if (!group) {
        return;
      }

      const form = group.closest('form');
      if (!form) {
        return;
      }

      const proofField = form.querySelector('[data-payment-proof-field]');
      if (!proofField) {
        return;
      }

      const selectedInput = group.querySelector('input[type="radio"]:checked');
      const shouldHide = !!(
        selectedInput &&
        typeof selectedInput.value === 'string' &&
        selectedInput.value.startsWith('faturar')
      );

      proofField.classList.toggle('hidden', shouldHide);
      if (shouldHide) {
        proofField.setAttribute('aria-hidden', 'true');
      } else {
        proofField.removeAttribute('aria-hidden');
      }

      const fileInput = proofField.querySelector('[data-payment-proof-input]');
      const clearCheckbox = proofField.querySelector('[data-payment-proof-clear]');
      if (fileInput) {
        if (fileInput.dataset.originalRequired === undefined) {
          fileInput.dataset.originalRequired = fileInput.hasAttribute('required') ? 'true' : 'false';
        }

        if (shouldHide) {
          fileInput.removeAttribute('required');
          fileInput.value = '';
          if (clearCheckbox) {
            clearCheckbox.checked = false;
          }
          fileInput.dispatchEvent(new Event('change', { bubbles: true }));
        } else if (fileInput.dataset.originalRequired === 'true') {
          fileInput.setAttribute('required', 'required');
        }
      }

      const detail = {
        value: selectedInput ? selectedInput.value : null,
        hidden: shouldHide,
        container: proofField,
      };

      document.dispatchEvent(
        new CustomEvent('payment-proof-visibility-change', { detail })
      );

      if (emitEvent) {
        document.dispatchEvent(new CustomEvent('payment-method-change', { detail }));
      }
    }

    function updateCardState(card) {
      const input = card.querySelector('input[type="radio"]');
      const body = card.querySelector('[data-payment-card-body]');
      if (!body || !input) {
        return;
      }

      const isChecked = input.checked;
      SELECTED_CLASSES.forEach((className) => {
        body.classList.toggle(className, isChecked);
      });
      toggleAccordion(card, isChecked);
    }

    function clearOtherSelections(cards, currentInput) {
      cards.forEach((card) => {
        const input = card.querySelector('input[type="radio"]');
        if (input && input !== currentInput) {
          input.checked = false;
          updateCardState(card);
        }
      });
    }

    function formatCurrency(value) {
      if (typeof value !== 'number' || !Number.isFinite(value) || value <= 0) {
        return '-';
      }
      try {
        return new Intl.NumberFormat('pt-BR', {
          style: 'currency',
          currency: 'BRL',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }).format(value);
      } catch (err) {
        return value.toFixed(2);
      }
    }

    function createPixPayload({ key, amount, description }) {
      const parts = ['PIX'];
      const cleanedKey = (key || '').toString().trim();
      if (cleanedKey) {
        parts.push(`chave=${cleanedKey}`);
      }
      if (typeof amount === 'number' && Number.isFinite(amount) && amount > 0) {
        parts.push(`valor=${amount.toFixed(2)}`);
      }
      const cleanedDescription = (description || '').toString().trim();
      if (cleanedDescription) {
        parts.push(`descricao=${cleanedDescription}`);
      }
      return parts.join('|');
    }

    function ensureQRCodeLibrary() {
      if (window.QRCode) {
        return Promise.resolve(window.QRCode);
      }
      if (!qrLibraryPromise) {
        qrLibraryPromise = new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
          script.async = true;
          script.onload = () => {
            if (window.QRCode) {
              resolve(window.QRCode);
            } else {
              reject(new Error('QRCode library did not expose QRCode constructor.'));
            }
          };
          script.onerror = () => reject(new Error('Failed to load QRCode library.'));
          document.head.appendChild(script);
        });
      }
      return qrLibraryPromise;
    }

    function decodeUnicodeEscapes(value) {
      if (typeof value !== 'string') {
        return value;
      }
      return value.replace(/\\u([0-9a-fA-F]{4})/g, (_, hex) => {
        const code = parseInt(hex, 16);
        if (Number.isNaN(code)) {
          return _;
        }
        return String.fromCharCode(code);
      });
    }

    async function renderPixQrCode(section) {
      const panel = section.querySelector('[data-pix-qrcode-panel]');
      if (!panel) {
        return;
      }
      const qrContainer = panel.querySelector('[data-pix-qr-container]');
      const amountContainer = panel.querySelector('[data-pix-qrcode-amount]');
      const keyContainer = panel.querySelector('[data-pix-qrcode-key]');

      const rawAmount = parseFloat(section.dataset.pixAmount || '0');
      const amount = Number.isFinite(rawAmount) ? rawAmount : 0;
      const pixKey = decodeUnicodeEscapes(section.dataset.pixKey || '').trim();
      const description = decodeUnicodeEscapes(section.dataset.pixEventTitle || '');
      const fallbackMessage = section.dataset.copyMissingText || '';
      const qrErrorMessage = section.dataset.qrErrorText || fallbackMessage || '';

      if (amountContainer) {
        amountContainer.textContent = formatCurrency(amount);
      }
      if (keyContainer) {
        keyContainer.textContent = pixKey || '-';
      }

      if (!qrContainer) {
        return;
      }

      qrContainer.innerHTML = '';
      qrContainer.setAttribute('aria-busy', 'true');

      if (!pixKey) {
        if (fallbackMessage) {
          const message = document.createElement('p');
          message.className = 'text-sm text-[var(--text-secondary)]';
          message.textContent = fallbackMessage;
          qrContainer.appendChild(message);
        }
        qrContainer.setAttribute('aria-busy', 'false');
        return;
      }

      try {
        const QRCodeClass = await ensureQRCodeLibrary();
        if (!QRCodeClass) {
          throw new Error('QRCode constructor unavailable.');
        }

        const payload = createPixPayload({ key: pixKey, amount, description });
        const qrOptions = {
          text: payload,
          width: 192,
          height: 192,
          colorDark: '#000000',
          colorLight: '#ffffff',
        };
        if (QRCodeClass.CorrectLevel && QRCodeClass.CorrectLevel.M) {
          qrOptions.correctLevel = QRCodeClass.CorrectLevel.M;
        }

        new QRCodeClass(qrContainer, qrOptions);
        qrContainer.setAttribute('aria-busy', 'false');
      } catch (err) {
        qrContainer.setAttribute('aria-busy', 'false');
        const errorElement = document.createElement('p');
        errorElement.className = 'text-sm text-red-500';
        errorElement.textContent = qrErrorMessage || '';
        qrContainer.appendChild(errorElement);
      }
    }

    function togglePixKeyPanel(section) {
      const keyButton = section.querySelector('[data-pix-key-button]');
      const keyPanel = section.querySelector('[data-pix-key-panel]');
      if (!keyButton || !keyPanel) {
        return;
      }

      const indicator = keyButton.querySelector('[data-state-indicator]');
      const keyDisplay = keyPanel.querySelector('[data-pix-key-display]');
      const fallbackMessage = section.dataset.copyMissingText || '';

      function updateKeyDisplay() {
        if (!keyDisplay) {
          return;
        }
        const pixKey = decodeUnicodeEscapes(section.dataset.pixKey || '').trim();
        keyDisplay.textContent = pixKey || fallbackMessage || '-';
      }

      function setKeyPanelState(isOpen) {
        keyButton.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        keyPanel.classList.toggle(ACCORDION_HIDDEN_CLASS, !isOpen);
        if (isOpen) {
          keyPanel.removeAttribute('aria-hidden');
          updateKeyDisplay();
        } else {
          keyPanel.setAttribute('aria-hidden', 'true');
        }
        if (indicator) {
          indicator.setAttribute('data-state', isOpen ? 'open' : 'closed');
        }
      }

      updateKeyDisplay();
      setKeyPanelState(false);

      keyButton.addEventListener('click', () => {
        const isExpanded = keyButton.getAttribute('aria-expanded') === 'true';
        setKeyPanelState(!isExpanded);
      });
    }

    function togglePixQrPanel(section) {
      const qrButton = section.querySelector('[data-pix-qrcode-button]');
      const panel = section.querySelector('[data-pix-qrcode-panel]');
      if (!qrButton || !panel) {
        return;
      }

      qrButton.addEventListener('click', async () => {
        const isHidden = panel.classList.contains(ACCORDION_HIDDEN_CLASS);
        const indicator = qrButton.querySelector('[data-state-indicator]');
        if (isHidden) {
          panel.classList.remove(ACCORDION_HIDDEN_CLASS);
          panel.removeAttribute('aria-hidden');
          qrButton.setAttribute('aria-expanded', 'true');
          if (indicator) {
            indicator.setAttribute('data-state', 'open');
          }
          await renderPixQrCode(section);
        } else {
          panel.classList.add(ACCORDION_HIDDEN_CLASS);
          panel.setAttribute('aria-hidden', 'true');
          qrButton.setAttribute('aria-expanded', 'false');
          if (indicator) {
            indicator.setAttribute('data-state', 'closed');
          }
        }
      });
    }

    function showPixFeedback(section, message, { isError = false } = {}) {
      const feedback = section.querySelector('[data-pix-feedback]');
      if (!feedback) {
        return;
      }
      feedback.textContent = message || '';
      feedback.classList.remove('hidden');
      if (isError) {
        feedback.classList.add('text-red-500');
        feedback.classList.remove('text-primary-600');
      } else {
        feedback.classList.add('text-primary-600');
        feedback.classList.remove('text-red-500');
      }
      setTimeout(() => {
        feedback.classList.add('hidden');
      }, 4000);
    }

    async function copyPixKey(section) {
      const pixKey = decodeUnicodeEscapes(section.dataset.pixKey || '').trim();
      const successMessage = section.dataset.copySuccessText || '';
      const errorMessage = section.dataset.copyErrorText || '';
      const missingMessage = section.dataset.copyMissingText || '';

      if (!pixKey) {
        showPixFeedback(section, missingMessage, { isError: true });
        return;
      }

      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(pixKey);
        } else {
          const textarea = document.createElement('textarea');
          textarea.value = pixKey;
          textarea.setAttribute('readonly', '');
          textarea.style.position = 'absolute';
          textarea.style.left = '-9999px';
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
        }
        showPixFeedback(section, successMessage, { isError: false });
      } catch (err) {
        showPixFeedback(section, errorMessage || missingMessage, { isError: true });
      }
    }

    function initPixSection(root) {
      const sections = (root || document).querySelectorAll('[data-pix-section]');
      sections.forEach((section) => {
        if (initializedPixSections.has(section)) {
          return;
        }
        const copyButton = section.querySelector('[data-pix-copy-button]');
        if (copyButton) {
          copyButton.addEventListener('click', () => {
            copyPixKey(section);
          });
        }
        togglePixKeyPanel(section);
        togglePixQrPanel(section);
        initializedPixSections.add(section);
      });
    }

    function initPaymentGroup(group) {
      if (!group || initializedGroups.has(group)) {
        return;
      }

      const cards = Array.from(group.querySelectorAll('[data-payment-card]'));
      if (!cards.length) {
        return;
      }

      cards.forEach((card) => {
        const input = card.querySelector('input[type="radio"]');
        if (!input) {
          return;
        }

        card.addEventListener('click', () => {
          if (input.disabled) {
            return;
          }
          if (!input.checked) {
            input.checked = true;
            input.dispatchEvent(new Event('change', { bubbles: true }));
          }
        });

        input.addEventListener('change', () => {
          if (!input.checked) {
            return;
          }
          clearOtherSelections(cards, input);
          updateCardState(card);
          updatePaymentProofVisibility(group);
          updateFaturarContainerHighlight(group);
          const faturarContainer = getFaturarContainer(group);
          if (faturarContainer) {
            const controller = faturarAccordionControllers.get(faturarContainer);
            if (controller) {
              const isFaturarValue =
                typeof input.value === 'string' &&
                input.value.startsWith(FATURAR_VALUE_PREFIX);
              if (isFaturarValue) {
                controller.openFromSelection();
              } else if (controller.expandedBySelection) {
                controller.closeFromSelection();
              }
            }
          }
        });

        updateCardState(card);
      });

      initFaturarAccordion(group);
      updateFaturarContainerHighlight(group);
      updatePaymentProofVisibility(group, { emitEvent: false });
      initPixSection(group);

      initializedGroups.add(group);
    }

    function initAll(root) {
      const groups = (root || document).querySelectorAll('[data-payment-method-cards]');
      groups.forEach((group) => initPaymentGroup(group));
      initPixSection(root || document);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => initAll(document));
    } else {
      initAll(document);
    }

    document.addEventListener('htmx:afterSwap', (event) => {
      initAll(event.target);
    });
  })();
</script>
