{% load i18n lucide_icons %}

<div
  class="space-y-2"
  data-payment-method-cards
  data-payment-field-name="{{ field.html_name }}"
>
  <p class="text-sm font-medium text-[var(--text-primary)]" id="{{ field.auto_id|default:field.html_name }}_legend">
    {{ field.label }}{% if field.field.required %} *{% endif %}
  </p>
  <div
    class="grid gap-3 sm:grid-cols-3"
    role="radiogroup"
    aria-labelledby="{{ field.auto_id|default:field.html_name }}_legend"
    {% if field.field.required %}aria-required="true"{% endif %}
  >
    {% with selected=field.value base_id=field.auto_id|default:field.html_name disabled=field.field.disabled %}
      <label
        class="block h-full {% if disabled %}cursor-not-allowed opacity-60{% else %}cursor-pointer{% endif %}"
        for="{{ base_id }}_pix"
        data-payment-card
      >
        <input
          type="radio"
          name="{{ field.html_name }}"
          value="pix"
          class="sr-only peer"
          id="{{ base_id }}_pix"
          {% if selected == "pix" %}checked{% endif %}
          {% if disabled %}disabled{% endif %}
          {% if field.errors %}aria-invalid="true"{% endif %}
          {% if field.field.required and not disabled %}required{% endif %}
        />
        <div
          class="relative flex h-full flex-col justify-between rounded-xl border border-[var(--border)] bg-[var(--surface-primary)] p-4 text-left transition focus-within:outline focus-within:outline-2 focus-within:outline-offset-2 focus-within:outline-primary-500 shadow-sm peer-checked:border-primary-500 peer-checked:bg-primary-500/10 peer-checked:ring-2 peer-checked:ring-primary-500/60 peer-focus-visible:outline peer-focus-visible:outline-2 peer-focus-visible:outline-offset-2 peer-focus-visible:outline-primary-500{% if disabled %} cursor-not-allowed{% else %} hover:border-primary-400{% endif %}"
          data-payment-card-body
        >
          <span
            class="pointer-events-none absolute right-3 top-3 hidden items-center justify-center rounded-full bg-primary-500 p-1 text-white peer-checked:flex"
            aria-hidden="true"
          >
            {% lucide 'check' class='h-3.5 w-3.5' aria_hidden='true' %}
          </span>
          <div class="flex items-center gap-2 text-[var(--text-primary)]">
            {% lucide 'qr-code' class='w-5 h-5 text-primary-500' aria_hidden='true' %}
            <span class="text-base font-semibold">{% trans "Pix" %}</span>
          </div>
          <p class="mt-2 text-sm text-[var(--text-secondary)]">
            {% trans "Pague instantaneamente via Pix." %}
          </p>
        </div>
      </label>

      <label
        class="block h-full {% if disabled %}cursor-not-allowed opacity-60{% else %}cursor-pointer{% endif %}"
        for="{{ base_id }}_boleto"
        data-payment-card
      >
        <input
          type="radio"
          name="{{ field.html_name }}"
          value="boleto"
          class="sr-only peer"
          id="{{ base_id }}_boleto"
          {% if selected == "boleto" %}checked{% endif %}
          {% if disabled %}disabled{% endif %}
          {% if field.errors %}aria-invalid="true"{% endif %}
          {% if field.field.required and not disabled %}required{% endif %}
        />
        <div
          class="relative flex h-full flex-col justify-between rounded-xl border border-[var(--border)] bg-[var(--surface-primary)] p-4 text-left transition focus-within:outline focus-within:outline-2 focus-within:outline-offset-2 focus-within:outline-primary-500 shadow-sm peer-checked:border-primary-500 peer-checked:bg-primary-500/10 peer-checked:ring-2 peer-checked:ring-primary-500/60 peer-focus-visible:outline peer-focus-visible:outline-2 peer-focus-visible:outline-offset-2 peer-focus-visible:outline-primary-500{% if disabled %} cursor-not-allowed{% else %} hover:border-primary-400{% endif %}"
          data-payment-card-body
        >
          <span
            class="pointer-events-none absolute right-3 top-3 hidden items-center justify-center rounded-full bg-primary-500 p-1 text-white peer-checked:flex"
            aria-hidden="true"
          >
            {% lucide 'check' class='h-3.5 w-3.5' aria_hidden='true' %}
          </span>
          <div class="flex items-center gap-2 text-[var(--text-primary)]">
            {% lucide 'barcode' class='w-5 h-5 text-primary-500' aria_hidden='true' %}
            <span class="text-base font-semibold">{% trans "Boleto" %}</span>
          </div>
          <p class="mt-2 text-sm text-[var(--text-secondary)]">
            {% trans "Receba um boleto para pagamento." %}
          </p>
        </div>
      </label>

      <label
        class="block h-full {% if disabled %}cursor-not-allowed opacity-60{% else %}cursor-pointer{% endif %}"
        for="{{ base_id }}_faturar"
        data-payment-card
      >
        <input
          type="radio"
          name="{{ field.html_name }}"
          value="faturar"
          class="sr-only peer"
          id="{{ base_id }}_faturar"
          {% if selected == "faturar" %}checked{% endif %}
          {% if disabled %}disabled{% endif %}
          {% if field.errors %}aria-invalid="true"{% endif %}
          {% if field.field.required and not disabled %}required{% endif %}
        />
        <div
          class="relative flex h-full flex-col justify-between rounded-xl border border-[var(--border)] bg-[var(--surface-primary)] p-4 text-left transition focus-within:outline focus-within:outline-2 focus-within:outline-offset-2 focus-within:outline-primary-500 shadow-sm peer-checked:border-primary-500 peer-checked:bg-primary-500/10 peer-checked:ring-2 peer-checked:ring-primary-500/60 peer-focus-visible:outline peer-focus-visible:outline-2 peer-focus-visible:outline-offset-2 peer-focus-visible:outline-primary-500{% if disabled %} cursor-not-allowed{% else %} hover:border-primary-400{% endif %}"
          data-payment-card-body
        >
          <span
            class="pointer-events-none absolute right-3 top-3 hidden items-center justify-center rounded-full bg-primary-500 p-1 text-white peer-checked:flex"
            aria-hidden="true"
          >
            {% lucide 'check' class='h-3.5 w-3.5' aria_hidden='true' %}
          </span>
          <div class="flex items-center gap-2 text-[var(--text-primary)]">
            {% lucide 'file-text' class='w-5 h-5 text-primary-500' aria_hidden='true' %}
            <span class="text-base font-semibold">{% trans "Faturar" %}</span>
          </div>
          <p class="mt-2 text-sm text-[var(--text-secondary)]">
            {% trans "Pagar na fatura." %}
          </p>
        </div>
      </label>
    {% endwith %}
  </div>

  {% if field.errors %}
    <ul class="errorlist">
      {% for error in field.errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {% if field.help_text %}
    <p class="text-xs text-[var(--text-secondary)]">{{ field.help_text }}</p>
  {% endif %}
</div>

<script>
  (() => {
    const SELECTED_CLASSES = [
      "border-primary-500",
      "bg-primary-500/10",
      "ring-2",
      "ring-primary-500/60",
    ];

    const initializedGroups = new WeakSet();

    function updatePaymentProofVisibility(group, { emitEvent = true } = {}) {
      if (!group) {
        return;
      }

      const form = group.closest('form');
      if (!form) {
        return;
      }

      const proofField = form.querySelector('[data-payment-proof-field]');
      if (!proofField) {
        return;
      }

      const selectedInput = group.querySelector('input[type="radio"]:checked');
      const shouldHide = !!(selectedInput && selectedInput.value === 'faturar');

      proofField.classList.toggle('hidden', shouldHide);
      if (shouldHide) {
        proofField.setAttribute('aria-hidden', 'true');
      } else {
        proofField.removeAttribute('aria-hidden');
      }

      const fileInput = proofField.querySelector('[data-payment-proof-input]');
      const clearCheckbox = proofField.querySelector('[data-payment-proof-clear]');
      if (fileInput) {
        if (fileInput.dataset.originalRequired === undefined) {
          fileInput.dataset.originalRequired = fileInput.hasAttribute('required') ? 'true' : 'false';
        }

        if (shouldHide) {
          fileInput.removeAttribute('required');
          fileInput.value = '';
          if (clearCheckbox) {
            clearCheckbox.checked = false;
          }
          fileInput.dispatchEvent(new Event('change', { bubbles: true }));
        } else if (fileInput.dataset.originalRequired === 'true') {
          fileInput.setAttribute('required', 'required');
        }
      }

      const detail = {
        value: selectedInput ? selectedInput.value : null,
        hidden: shouldHide,
        container: proofField,
      };

      document.dispatchEvent(
        new CustomEvent('payment-proof-visibility-change', { detail })
      );

      if (emitEvent) {
        document.dispatchEvent(new CustomEvent('payment-method-change', { detail }));
      }
    }

    function updateCardState(card) {
      const input = card.querySelector('input[type="radio"]');
      const body = card.querySelector('[data-payment-card-body]');
      if (!body || !input) {
        return;
      }

      const isChecked = input.checked;
      SELECTED_CLASSES.forEach((className) => {
        body.classList.toggle(className, isChecked);
      });
    }

    function clearOtherSelections(cards, currentInput) {
      cards.forEach((card) => {
        const input = card.querySelector('input[type="radio"]');
        if (input && input !== currentInput) {
          input.checked = false;
          updateCardState(card);
        }
      });
    }

    function initPaymentGroup(group) {
      if (!group || initializedGroups.has(group)) {
        return;
      }

      const cards = Array.from(group.querySelectorAll('[data-payment-card]'));
      if (!cards.length) {
        return;
      }

      cards.forEach((card) => {
        const input = card.querySelector('input[type="radio"]');
        if (!input) {
          return;
        }

        card.addEventListener('click', () => {
          if (input.disabled) {
            return;
          }
          if (!input.checked) {
            input.checked = true;
            input.dispatchEvent(new Event('change', { bubbles: true }));
          }
        });

        input.addEventListener('change', () => {
          if (!input.checked) {
            return;
          }
          clearOtherSelections(cards, input);
          updateCardState(card);
          updatePaymentProofVisibility(group);
        });

        updateCardState(card);
      });

      updatePaymentProofVisibility(group, { emitEvent: false });

      initializedGroups.add(group);
    }

    function initAll(root) {
      const groups = (root || document).querySelectorAll('[data-payment-method-cards]');
      groups.forEach((group) => initPaymentGroup(group));
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => initAll(document));
    } else {
      initAll(document);
    }

    document.addEventListener('htmx:afterSwap', (event) => {
      initAll(event.target);
    });
  })();
</script>
