 {% load i18n widget_tweaks %}
{% include "eventos/partials/_painel_hero_oob.html" %}
<section class="max-w-screen-xl mx-auto pt-8 px-6 lg:px-8">
  
   <div class="card">
    <div class="card-header">
        <h2 class="text-xl font-semibold">{% trans "Adicionar evento" %}</h2>
    </div>
    <div class="card-body space-y-6">
      <form method="post" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}

        {{ form.non_field_errors }}

        <div class="space-y-6">
          <div>
            {% include '_forms/field.html' with field=form.titulo %}
          </div>

          <div>
            {% include '_forms/field.html' with field=form.descricao %}
          </div>

          <div>
            {% include '_forms/field.html' with field=form.cronograma %}
          </div>

          <div>
            {% include '_forms/field.html' with field=form.local %}
          </div>

          <div class="grid gap-6 md:grid-cols-2">
            <div>
              {% include '_forms/field.html' with field=form.data_inicio %}
            </div>
            <div>
              {% include '_forms/field.html' with field=form.data_fim %}
            </div>
          </div>

          <div class="grid gap-6 md:grid-cols-3">
            <div>
              {% include '_forms/field.html' with field=form.cidade %}
            </div>
            <div>
              {% include '_forms/field.html' with field=form.estado %}
            </div>
            <div>
              {% include '_forms/field.html' with field=form.cep %}
            </div>
          </div>

          <div>
            {% include '_forms/field.html' with field=form.coordenador %}
          </div>

          <div class="grid gap-6 md:grid-cols-3">
            <div>
              {% include '_forms/field.html' with field=form.status %}
            </div>
            <div>
              {% include '_forms/field.html' with field=form.publico_alvo %}
            </div>
            <div id="nucleo-field-container">
              {% include '_forms/field.html' with field=form.nucleo %}
            </div>
          </div>

          <div class="grid gap-6 md:grid-cols-3">
            <div>
              {% include '_forms/field.html' with field=form.numero_convidados %}
            </div>
            <div>
              {% include '_forms/field.html' with field=form.participantes_maximo %}
            </div>
            <div>
              {% include '_forms/field.html' with field=form.valor_ingresso %}
            </div>
          </div>

          <div class="grid gap-6 md:grid-cols-2">
            <div>
              {% include '_forms/field.html' with field=form.briefing %}
            </div>
            <div>
              {% include '_forms/field.html' with field=form.parcerias %}
            </div>
          </div>

          <div class="grid gap-6 md:grid-cols-3">
            <div>
              {% include '_forms/field.html' with field=form.contato_nome %}
            </div>
            <div>
              {% include '_forms/field.html' with field=form.contato_email %}
            </div>
            <div>
              {% include '_forms/field.html' with field=form.contato_whatsapp %}
            </div>
          </div>

          <div>
            {% include '_forms/field.html' with field=form.informacoes_adicionais %}
          </div>

          <div class="grid gap-6 md:grid-cols-2">
            <div>
              {% include '_forms/field.html' with field=form.avatar|attr:'accept:image/*' %}
            </div>
            <div>
              {% include '_forms/field.html' with field=form.cover|attr:'accept:image/*' %}
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t border-[var(--border)]">
          <a id="btn-voltar" href="{% url 'eventos:calendario' %}" data-fallback-url="{% url 'eventos:calendario' %}" class="btn btn-secondary" aria-label="{% trans 'Voltar' %}" data-behavior="back">{% trans "Voltar" %}</a>
          <button type="submit" class="btn btn-primary" aria-label="{% trans 'Salvar' %}">{% trans "Salvar" %}</button>
        </div>
      </form>
    </div>
  </div>
</section>

{% block extra_js %}
<script>
  // Comportamento do botão Voltar: tenta voltar no histórico; se não houver origem válida, usa fallback
  (function(){
    const btn = document.getElementById('btn-voltar');
    if(!btn) return;
    btn.addEventListener('click', function(e){
      const ref = document.referrer;
      const fallback = btn.getAttribute('data-fallback-url');
      const sameOrigin = ref && ref.startsWith(window.location.origin);
      // Evita voltar para a própria página ou páginas de criação/edição em loop
      const invalid = !sameOrigin || ref === window.location.href;
      if(invalid || window.history.length <= 1) {
        if(fallback) {
          e.preventDefault();
          window.location.href = fallback;
        }
      } else {
        e.preventDefault();
        window.history.back();
      }
    });
  })();
  document.addEventListener('DOMContentLoaded', function () {
    const publicoAlvoSelect = document.getElementById('id_publico_alvo');
    const nucleoInput = document.getElementById('id_nucleo');
    const nucleoFieldWrapper = document.getElementById('nucleo-field-container');

    const toggleNucleoField = () => {
      if (!publicoAlvoSelect || !nucleoInput || !nucleoFieldWrapper) {
        return;
      }

      if (publicoAlvoSelect.value === '1') {
        nucleoFieldWrapper.classList.remove('hidden');
      } else {
        nucleoFieldWrapper.classList.add('hidden');
        nucleoInput.value = '';
      }
    };

    toggleNucleoField();

    if (publicoAlvoSelect) {
      publicoAlvoSelect.addEventListener('change', toggleNucleoField);
    }
  });
</script>
{% endblock %}

