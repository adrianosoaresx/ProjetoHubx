{% extends 'base.html' %}
{% load i18n l10n static lucide_icons %}

{% block title %}{{ title|default:object.titulo|default:_('Eventos') }}{% endblock %}

{% block hero %}{% include '_components/hero_evento_detail.html' with evento=evento %}{% endblock %}

{% block content %}
  
    <div class="flex flex-col gap-6">
      <article class="card">
        <details class="group">
          <summary class="card-header flex cursor-pointer items-center justify-between gap-4 select-none [&::-webkit-details-marker]:hidden">
            <div class="flex items-start gap-3">
              <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-info-500)]/10 text-[var(--color-info-600)] shadow-lg shadow-[var(--color-info-500)]/15">
                {% lucide 'info' class='h-6 w-6' aria_hidden='true' %}
              </span>
              <div class="space-y-1">
                <h2 class="text-xl font-semibold">{% trans "Informações" %}</h2>
                <p class="text-sm text-[var(--text-secondary)]">{% trans "Dados gerais do evento" %}</p>
              </div>
            </div>
            <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:rotate-180">
              {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
            </span>
          </summary>
          <div class="card-body space-y-6">
            <dl class="space-y-6 text-sm">
              <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                  <dt class="text-[var(--text-secondary)]">{% trans "Status" %}</dt>
                  <dd class="font-medium text-[var(--text-primary)]">{{ object.get_status_display }}</dd>
                </div>
                <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                  <dt class="text-[var(--text-secondary)]">{% trans "Público alvo" %}</dt>
                  <dd class="font-medium text-[var(--text-primary)]">{{ object.get_publico_alvo_display }}</dd>
                </div>
              </div>

              <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                  <dt class="text-[var(--text-secondary)]">{% trans "Início" %}</dt>
                  <dd class="font-medium text-[var(--text-primary)]">{{ object.data_inicio|date:'SHORT_DATETIME_FORMAT' }}</dd>
                </div>
                <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                  <dt class="text-[var(--text-secondary)]">{% trans "Fim" %}</dt>
                  <dd class="font-medium text-[var(--text-primary)]">{{ object.data_fim|date:'SHORT_DATETIME_FORMAT' }}</dd>
                </div>
              </div>

              {% if object.local or object.cidade or object.estado or object.cep %}
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                  {% if object.local %}
                    <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                      <dt class="text-[var(--text-secondary)]">{% trans "Local" %}</dt>
                      <dd class="font-medium text-[var(--text-primary)]">{{ object.local }}</dd>
                    </div>
                  {% endif %}
                  {% if object.cidade or object.estado %}
                    <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                      <dt class="text-[var(--text-secondary)]">{% trans "Cidade / Estado" %}</dt>
                      <dd class="font-medium text-[var(--text-primary)]">
                        {{ object.cidade }}{% if object.cidade and object.estado %} - {% endif %}{{ object.estado }}
                      </dd>
                    </div>
                  {% endif %}
                  {% if object.cep %}
                    <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                      <dt class="text-[var(--text-secondary)]">{% trans "CEP" %}</dt>
                      <dd class="font-medium text-[var(--text-primary)]">{{ object.cep }}</dd>
                    </div>
                  {% endif %}
                </div>
              {% endif %}

              <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2 sm:col-span-2 lg:col-span-3">
                  <dt class="text-[var(--text-secondary)]">{% trans "Descrição" %}</dt>
                  <dd class="font-medium text-[var(--text-primary)] whitespace-pre-line">{{ object.descricao|linebreaksbr }}</dd>
                </div>
                {% if object.cronograma %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2 sm:col-span-2 lg:col-span-3">
                    <dt class="text-[var(--text-secondary)]">{% trans "Cronograma" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)] whitespace-pre-line">{{ object.cronograma|linebreaksbr }}</dd>
                  </div>
                {% endif %}
                {% if object.informacoes_adicionais %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2 sm:col-span-2 lg:col-span-3">
                    <dt class="text-[var(--text-secondary)]">{% trans "Informações adicionais" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)] whitespace-pre-line">{{ object.informacoes_adicionais|linebreaksbr }}</dd>
                  </div>
                {% endif %}
                {% if object.participantes_maximo and pode_ver_campos_restritos %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                    <dt class="text-[var(--text-secondary)]">{% trans "Máximo de participantes" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)]">{{ object.participantes_maximo }}</dd>
                  </div>
                {% endif %}
                {% if object.gratuito %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                    <dt class="text-[var(--text-secondary)]">{% trans "Evento gratuito" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)]">{% trans "Sim" %}</dd>
                  </div>
                {% else %}
                  {% if object.valor_associado is not None %}
                    <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                      <dt class="text-[var(--text-secondary)]">{% trans "Valor para associados" %}</dt>
                      <dd class="font-medium text-[var(--text-primary)]">{{ object.valor_associado|localize }}</dd>
                    </div>
                  {% endif %}
                  {% if object.valor_nucleado is not None %}
                    <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                      <dt class="text-[var(--text-secondary)]">{% trans "Valor para nucleados" %}</dt>
                      <dd class="font-medium text-[var(--text-primary)]">{{ object.valor_nucleado|localize }}</dd>
                    </div>
                  {% endif %}
                {% endif %}
                {% if object.orcamento_estimado %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                    <dt class="text-[var(--text-secondary)]">{% trans "Orçamento estimado" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)]">{{ object.orcamento_estimado }}</dd>
                  </div>
                {% endif %}
                {% if object.valor_gasto %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                    <dt class="text-[var(--text-secondary)]">{% trans "Valor gasto" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)]">{{ object.valor_gasto }}</dd>
                  </div>
                {% endif %}
                {% if object.briefing and pode_ver_campos_restritos %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                    <dt class="text-[var(--text-secondary)]">{% trans "Briefing" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)]">
                      {% include 'eventos/partials/shared/_file_link.html' with file=object.briefing %}
                    </dd>
                  </div>
                {% endif %}
                {% if object.parcerias and pode_ver_campos_restritos %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                    <dt class="text-[var(--text-secondary)]">{% trans "Parcerias" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)]">
                      {% include 'eventos/partials/shared/_file_link.html' with file=object.parcerias %}
                    </dd>
                  </div>
                {% endif %}
              </div>
            </dl>

            {% if inscricao and avaliacao_permitida %}
              <section aria-labelledby="evento-avaliacao" class="space-y-4">
                <h3 id="evento-avaliacao" class="text-lg font-semibold text-[var(--text-primary)]">{% trans "Avaliação" %}</h3>
                <form method="post" action="{% url 'eventos:evento_feedback' object.pk %}" class="space-y-6">
                  {% csrf_token %}
                  {{ feedback_form.non_field_errors }}
                  {% include '_forms/field.html' with field=feedback_form.nota %}
                  {% include '_forms/field.html' with field=feedback_form.comentario %}
                  <div class="flex justify-end gap-3 pt-4 border-t border-[var(--border)]">
                    <button type="submit" class="btn btn-primary" aria-label="{% trans 'Enviar avaliação' %}">{% trans 'Enviar avaliação' %}</button>
                  </div>
                </form>
              </section>
            {% endif %}

            <div class="flex flex-wrap items-center justify-end gap-3 pt-4 border-t border-[var(--border)]">
              <div class="flex flex-wrap justify-end gap-3">
                {% if pode_editar_evento %}
                  <a href="{% url 'eventos:evento_editar' object.pk %}"
                     class="btn btn-secondary"
                     aria-label="{% trans 'Editar evento' %}">{% trans 'Editar' %}</a>
                {% endif %}
                {% if pode_excluir_evento %}
                  <a
                    href="{% url 'eventos:evento_excluir' object.pk %}"
                    hx-get="{% url 'eventos:evento_excluir' object.pk %}"
                    hx-target="#modal"
                    hx-trigger="click"
                    hx-swap="innerHTML"
                    hx-on="htmx:beforeRequest: window.HubxModalTrigger = this;"
                    class="btn btn-danger"
                    aria-label="{% trans 'Excluir evento' %}"
                  >{% trans 'Excluir' %}</a>
                {% endif %}
              </div>

              {% if user.is_authenticated and user.get_tipo_usuario != 'admin' and user.get_tipo_usuario != 'associado' %}
                {% if inscricao and pode_cancelar %}
                  <form method="post" action="{% url 'eventos:evento_cancelar_inscricao' object.pk %}" class="flex">
                    {% csrf_token %}
                    <button
                      type="button"
                      class="btn btn-secondary"
                      hx-get="{% url 'eventos:evento_cancelar_inscricao_modal' object.pk %}"
                      hx-target="#modal"
                      hx-trigger="click"
                      hx-swap="innerHTML"
                      hx-on="htmx:beforeRequest: window.HubxModalTrigger = this;"
                      aria-label="{% trans 'Cancelar inscrição' %}"
                    >
                      {% trans 'Cancelar inscrição' %}
                    </button>
                    <noscript>
                      <button type="submit" class="btn btn-secondary" aria-label="{% trans 'Cancelar inscrição' %}">{% trans 'Cancelar inscrição' %}</button>
                    </noscript>
                  </form>
                {% elif not inscricao and inscricao_permitida %}
                  <form method="post" action="{% url 'eventos:evento_subscribe' object.pk %}" class="flex">
                    {% csrf_token %}
                    <button
                      type="submit"
                      class="btn btn-primary"
                      aria-label="{% if vagas_disponiveis == 0 %}{% trans 'Inscrições esgotadas' %}{% else %}{% trans 'Quero me inscrever' %}{% endif %}"
                      {% if vagas_disponiveis == 0 %}disabled aria-disabled="true"{% endif %}
                    >
                      {% if vagas_disponiveis == 0 %}
                        {% trans 'Inscrições esgotadas' %}
                      {% else %}
                        {% trans 'Quero me inscrever' %}
                      {% endif %}
                    </button>
                  </form>
                {% elif inscricao %}
                  <p class="text-sm text-[var(--text-secondary)]">{% trans 'Inscrição confirmada' %}</p>
                {% elif not inscricao %}
                  <p class="text-sm text-[var(--text-secondary)]">{% trans 'Inscrições indisponíveis para este evento.' %}</p>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </details>
        </article>

        {% include 'eventos/partials/portfolio_card.html' %}

        {% if user.is_authenticated and user.get_tipo_usuario == 'associado' %}
          <article class="card">
            <details class="group">
              <summary class="card-header flex cursor-pointer items-center justify-between gap-4 select-none [&::-webkit-details-marker]:hidden">
                <div class="flex items-start gap-3">
                  <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-primary-500)]/10 text-[var(--color-primary-600)] shadow-lg shadow-[var(--color-primary-500)]/15">
                    {% lucide 'ticket' class='h-6 w-6' aria_hidden='true' %}
                  </span>
                  <div class="space-y-1">
                    <h2 class="text-xl font-semibold">
                      {% blocktrans with event_title=object.titulo %}Inscrição {{ event_title }}{% endblocktrans %}
                    </h2>
                    <p class="text-sm text-[var(--text-secondary)]">{% trans "Gerencie sua participação no evento" %}</p>
                  </div>
                </div>
                <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:rotate-180">
                  {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
                </span>
              </summary>
              <div class="card-body space-y-4">
                {% if inscricao and pode_cancelar %}
                  <form method="post" action="{% url 'eventos:evento_cancelar_inscricao' object.pk %}" class="flex">
                    {% csrf_token %}
                    <button
                      type="button"
                      class="btn btn-secondary"
                      hx-get="{% url 'eventos:evento_cancelar_inscricao_modal' object.pk %}"
                      hx-target="#modal"
                      hx-trigger="click"
                      hx-swap="innerHTML"
                      hx-on="htmx:beforeRequest: window.HubxModalTrigger = this;"
                      aria-label="{% trans 'Cancelar inscrição' %}"
                    >
                      {% trans 'Cancelar inscrição' %}
                    </button>
                    <noscript>
                      <button type="submit" class="btn btn-secondary" aria-label="{% trans 'Cancelar inscrição' %}">{% trans 'Cancelar inscrição' %}</button>
                    </noscript>
                  </form>
                {% elif not inscricao and inscricao_permitida %}
                  {% if vagas_disponiveis == 0 %}
                    <p class="text-sm text-[var(--text-secondary)]">{% trans 'Inscrições esgotadas' %}</p>
                  {% else %}
                    <a
                      href="{% url 'eventos:inscricao_criar' object.pk %}"
                      class="btn btn-primary"
                      role="button"
                      aria-label="{% trans 'Quero me inscrever' %}"
                    >
                      {% trans 'Quero me inscrever' %}
                    </a>
                  {% endif %}
                {% elif inscricao %}
                  <p class="text-sm text-[var(--text-secondary)]">{% trans 'Inscrição confirmada' %}</p>
                {% else %}
                  <p class="text-sm text-[var(--text-secondary)]">{% trans 'Inscrições indisponíveis para este evento.' %}</p>
                {% endif %}
              </div>
            </details>
          </article>
        {% endif %}

        {% if pode_ver_inscritos %}
          <article class="card">
            <details
              class="group"
              hx-get="{% url 'eventos:evento_inscritos' object.pk %}"
              hx-target="#inscritos-list"
              hx-trigger="toggle[target.open]"
              hx-include="#inscritos-filter-form"
              hx-indicator="#inscritos-loading"
              hx-push-url="true"
            >
              <summary class="card-header flex cursor-pointer items-center justify-between gap-4 select-none [&::-webkit-details-marker]:hidden">
                <div class="flex items-start gap-3">
                  <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-primary-500)]/10 text-[var(--color-primary-600)] shadow-lg shadow-[var(--color-primary-500)]/15">
                    {% lucide 'users' class='h-6 w-6' aria_hidden='true' %}
                  </span>
                  <div class="space-y-1">
                    <h2 class="text-lg font-semibold">{% trans "Inscritos" %}</h2>
                    <p class="text-sm text-[var(--text-secondary)]" id="inscritos-summary">
                      {% blocktrans count count=inscritos_total_count %}
                        {{ count }} inscrito confirmado
                      {% plural %}
                        {{ count }} inscritos confirmados
                      {% endblocktrans %}
                      {% if vagas_disponiveis is not None %}
                        ·
                        {% blocktrans count vagas=vagas_disponiveis %}
                          {{ vagas }} vaga disponível
                        {% plural %}
                          {{ vagas }} vagas disponíveis
                        {% endblocktrans %}
                      {% endif %}
                    </p>
                  </div>
                </div>
                <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:rotate-180">
                  {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
                </span>
              </summary>
              <div class="card-body space-y-6">
                <div id="inscritos-filter-container">
                  {% include 'eventos/partials/inscritos_filter_form.html' with form_id='inscritos-filter-form' search_input_id='inscritos-search' hx_target='#inscritos-list' hx_indicator='#inscritos-loading' hx_push_url='true' search_value=inscritos_search_query %}
                </div>
                <section class="space-y-6">
                  <div id="inscritos-list">
                    {% include 'eventos/partials/inscritos_list.html' %}
                  </div>
                  <div
                    id="inscritos-loading"
                    class="htmx-indicator text-center text-sm text-[var(--text-secondary)]"
                    role="status"
                    aria-live="polite"
                  >
                    {% trans 'Carregando inscritos...' %}
                  </div>
                </section>
              </div>
            </details>
          </article>
      {% endif %}
        {% if pode_ver_financeiro %}
          <article class="card">
            <details class="group">
              <summary class="card-header flex cursor-pointer items-center justify-between gap-4 select-none [&::-webkit-details-marker]:hidden">
                <div class="flex items-start gap-3">
                  <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-success-500)]/10 text-[var(--color-success-600)] shadow-lg shadow-[var(--color-success-500)]/15">
                    {% lucide 'wallet' class='h-6 w-6' aria_hidden='true' %}
                  </span>
                  <div class="space-y-1">
                    <h2 class="text-xl font-semibold">{% trans "Financeiro" %}</h2>
                    <p class="text-sm text-[var(--text-secondary)]">
                      {% trans "Acompanhe as confirmações de pagamento das inscrições" %}
                    </p>
                  </div>
                </div>
                <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:rotate-180">
                  {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
                </span>
              </summary>
              <div class="card-body space-y-5">
                <div class="flex flex-wrap gap-2">
                  <span class="inline-flex items-center gap-2 rounded-full border border-[var(--border)] bg-[var(--bg-secondary)] px-3 py-1 text-xs font-medium text-[var(--text-secondary)]">
                    {% lucide 'shield-check' class='h-3.5 w-3.5 text-[var(--color-success-600)]' aria_hidden='true' %}
                    <span class="text-[var(--text-primary)]">{{ total_pagamentos_validados }}</span>
                    <span class="uppercase tracking-wide">{% trans "validados" %}</span>
                  </span>
                  <span class="inline-flex items-center gap-2 rounded-full border border-[var(--border)] px-3 py-1 text-xs font-medium text-[var(--text-secondary)]">
                    {% lucide 'timer' class='h-3.5 w-3.5 text-[var(--color-warning-600)]' aria_hidden='true' %}
                    <span class="text-[var(--text-primary)]">{{ total_pagamentos_pendentes }}</span>
                    <span class="uppercase tracking-wide">{% trans "pendentes" %}</span>
                  </span>
                  {% if valor_total_pagamentos_validados %}
                    <span class="inline-flex items-center gap-2 rounded-full border border-[var(--border)] px-3 py-1 text-xs font-medium text-[var(--text-secondary)]">
                      {% lucide 'banknote' class='h-3.5 w-3.5 text-[var(--color-primary-600)]' aria_hidden='true' %}
                      <span class="text-[var(--text-primary)]">{{ valor_total_pagamentos_validados|localize }}</span>
                      <span class="uppercase tracking-wide">{% trans "em receitas validadas" %}</span>
                    </span>
                  {% endif %}
                </div>
                <div class="overflow-x-auto">
                  {% if inscricoes_financeiro %}
                    <table class="min-w-full table-auto text-sm">
                      <thead class="bg-[var(--bg-secondary)] text-[var(--text-secondary)]">
                        <tr>
                          <th scope="col" class="px-4 py-2 text-left font-semibold">{% trans "Contato" %}</th>
                          <th scope="col" class="px-4 py-2 text-left font-semibold">{% trans "Razão social" %}</th>
                          <th scope="col" class="px-4 py-2 text-left font-semibold">{% trans "Forma de pagamento" %}</th>
                          <th scope="col" class="px-4 py-2 text-left font-semibold">{% trans "Valor" %}</th>
                          <th scope="col" class="px-4 py-2 text-left font-semibold">{% trans "Validação" %}</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-[var(--border)] text-[var(--text-primary)]">
                        {% for inscricao in inscricoes_financeiro %}
                          <tr class="align-middle">
                            <td class="px-4 py-3">
                              <div class="flex flex-col">
                                <span class="font-medium">{{ inscricao.user.contato|default:inscricao.user.display_name|default:inscricao.user.get_full_name|default:inscricao.user.username }}</span>
                                <span class="text-xs text-[var(--text-secondary)]">@{{ inscricao.user.username }}</span>
                              </div>
                            </td>
                            <td class="px-4 py-3">
                              {% if inscricao.user.razao_social %}
                                <span class="font-medium">{{ inscricao.user.razao_social }}</span>
                              {% else %}
                                <span class="text-[var(--text-secondary)]">&mdash;</span>
                              {% endif %}
                            </td>
                            <td class="px-4 py-3">
                              {% if inscricao.metodo_pagamento %}
                                <span class="inline-flex items-center gap-2 rounded-full border border-[var(--border)] px-3 py-1 text-xs uppercase tracking-wide">
                                  {% lucide 'credit-card' class='h-3.5 w-3.5 text-[var(--color-primary-600)]' aria_hidden='true' %}
                                  {{ inscricao.get_metodo_pagamento_display }}
                                </span>
                              {% else %}
                                <span class="text-[var(--text-secondary)]">{% trans "Não informado" %}</span>
                              {% endif %}
                            </td>
                            <td class="px-4 py-3">
                              {% if inscricao.valor_pago %}
                                <span class="font-medium">{{ inscricao.valor_pago|localize }}</span>
                              {% elif inscricao.get_valor_evento %}
                                <span class="font-medium">{{ inscricao.get_valor_evento|localize }}</span>
                              {% else %}
                                <span class="text-[var(--text-secondary)]">&mdash;</span>
                              {% endif %}
                            </td>
                            <td class="px-4 py-3">
                              <div class="inline-flex" id="financeiro-validacao-{{ inscricao.pk }}">
                                {% include 'eventos/partials/financeiro_validacao_button.html' with inscricao=inscricao %}
                              </div>
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  {% else %}
                    <p class="text-sm text-[var(--text-secondary)]">{% trans "Nenhuma inscrição para exibir neste momento." %}</p>
                  {% endif %}
                </div>
              </div>
            </details>
          </article>
        {% endif %}

    </div>

    <div id="modal" role="presentation" aria-live="polite"></div>

{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const portfolioRoots = document.querySelectorAll('[data-portfolio-root]');
      portfolioRoots.forEach((root) => {
        const eventId = root.getAttribute('data-event-id') || 'evento';
        const highlightStorageKey = `eventPortfolioHighlights:${eventId}`;
        const accordionStorageKey = `eventPortfolioAccordion:${eventId}`;
        const list = root.querySelector('[data-portfolio-list]');
        const buttons = root.querySelectorAll('[data-highlight-toggle]');
        const details = root.querySelector('details');
        const shouldForceOpen = root.dataset.portfolioForceOpen === 'true';

        if (details) {
          const readAccordionState = () => {
            try {
              const stored = localStorage.getItem(accordionStorageKey);
              if (stored === 'open' || stored === 'closed') {
                return stored;
              }
            } catch (error) {
              console.warn('Não foi possível ler o estado do portfólio do evento.', error);
            }
            return null;
          };

          const persistAccordionState = (isOpen) => {
            try {
              localStorage.setItem(accordionStorageKey, isOpen ? 'open' : 'closed');
            } catch (error) {
              console.warn('Não foi possível salvar o estado do portfólio do evento.', error);
            }
          };

          const storedAccordionState = readAccordionState();
          if (shouldForceOpen) {
            details.open = true;
            persistAccordionState(true);
          } else if (storedAccordionState === 'open') {
            details.open = true;
          }

          details.addEventListener('toggle', () => {
            persistAccordionState(details.open);
          });
        }

        const readStored = () => {
          try {
            const stored = localStorage.getItem(highlightStorageKey);
            if (!stored) {
              return new Set();
            }
            const parsed = JSON.parse(stored);
            if (Array.isArray(parsed)) {
              return new Set(parsed.map(String));
            }
          } catch (error) {
            console.warn('Não foi possível ler os destaques do evento.', error);
          }
          return new Set();
        };

        const highlightedIds = readStored();

        const persist = () => {
          try {
            localStorage.setItem(highlightStorageKey, JSON.stringify(Array.from(highlightedIds)));
          } catch (error) {
            console.warn('Não foi possível salvar os destaques do evento.', error);
          }
        };

        const setButtonState = (button, isActive) => {
          const labelOn = button.dataset.highlightLabelOn || button.getAttribute('aria-label') || '';
          const labelOff = button.dataset.highlightLabelOff || button.getAttribute('aria-label') || '';
          button.setAttribute('aria-pressed', String(isActive));
          button.setAttribute('aria-label', isActive ? labelOn : labelOff);
          button.title = isActive ? labelOn : labelOff;
          button.classList.toggle('text-red-500', isActive);
          button.classList.toggle('text-[var(--text-secondary)]', !isActive);
          const iconOn = button.querySelector('[data-highlight-icon="on"]');
          const iconOff = button.querySelector('[data-highlight-icon="off"]');
          if (iconOn && iconOff) {
            iconOn.classList.toggle('hidden', !isActive);
            iconOff.classList.toggle('hidden', isActive);
          }
        };

        const sortCards = () => {
          if (!list) {
            return;
          }
          const cards = Array.from(list.querySelectorAll('[data-media-card]'));
          cards.sort((a, b) => {
            const aId = a.dataset.mediaId ? String(a.dataset.mediaId) : '';
            const bId = b.dataset.mediaId ? String(b.dataset.mediaId) : '';
            const aHighlighted = highlightedIds.has(aId);
            const bHighlighted = highlightedIds.has(bId);
            if (aHighlighted !== bHighlighted) {
              return aHighlighted ? -1 : 1;
            }
            const aDate = Date.parse(a.dataset.createdAt || '') || 0;
            const bDate = Date.parse(b.dataset.createdAt || '') || 0;
            return bDate - aDate;
          });
          cards.forEach((card) => list.appendChild(card));
        };

        buttons.forEach((button) => {
          const mediaId = button.dataset.mediaId;
          if (!mediaId) {
            return;
          }
          const isActive = highlightedIds.has(String(mediaId));
          setButtonState(button, isActive);
          button.addEventListener('click', () => {
            const key = String(mediaId);
            if (highlightedIds.has(key)) {
              highlightedIds.delete(key);
            } else {
              highlightedIds.add(key);
            }
            setButtonState(button, highlightedIds.has(key));
            persist();
            sortCards();
          });
        });

        sortCards();
      });
    });
  </script>
{% endblock %}
