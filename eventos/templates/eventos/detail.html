{% extends 'base.html' %}
{% load i18n l10n static lucide_icons %}

{% block title %}{{ title|default:object.titulo|default:_('Eventos') }}{% endblock %}

{% block hero %}{% include '_components/hero_evento_detail.html' with evento=evento %}{% endblock %}

{% block content %}
  
    <div class="flex flex-col gap-6">
      <article class="card">
        <details class="group">
          <summary class="card-header flex cursor-pointer items-center justify-between gap-4 select-none [&::-webkit-details-marker]:hidden">
            <div class="flex items-start gap-3">
              <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-info-500)]/10 text-[var(--color-info-600)] shadow-lg shadow-[var(--color-info-500)]/15">
                {% lucide 'info' class='h-6 w-6' aria_hidden='true' %}
              </span>
              <div class="space-y-1">
                <h2 class="text-xl font-semibold">{% trans "Informações" %}</h2>
                <p class="text-sm text-[var(--text-secondary)]">{% trans "Dados gerais do evento" %}</p>
              </div>
            </div>
            <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:rotate-180">
              {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
            </span>
          </summary>
          <div class="card-body space-y-6">
            <dl class="space-y-6 text-sm">
              <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                  <dt class="text-[var(--text-secondary)]">{% trans "Status" %}</dt>
                  <dd class="font-medium text-[var(--text-primary)]">{{ object.get_status_display }}</dd>
                </div>
                <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                  <dt class="text-[var(--text-secondary)]">{% trans "Público alvo" %}</dt>
                  <dd class="font-medium text-[var(--text-primary)]">{{ object.get_publico_alvo_display }}</dd>
                </div>
              </div>

              <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                  <dt class="text-[var(--text-secondary)]">{% trans "Início" %}</dt>
                  <dd class="font-medium text-[var(--text-primary)]">{{ object.data_inicio|date:'SHORT_DATETIME_FORMAT' }}</dd>
                </div>
                <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                  <dt class="text-[var(--text-secondary)]">{% trans "Fim" %}</dt>
                  <dd class="font-medium text-[var(--text-primary)]">{{ object.data_fim|date:'SHORT_DATETIME_FORMAT' }}</dd>
                </div>
              </div>

              {% if object.local or object.cidade or object.estado or object.cep %}
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                  {% if object.local %}
                    <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                      <dt class="text-[var(--text-secondary)]">{% trans "Local" %}</dt>
                      <dd class="font-medium text-[var(--text-primary)]">{{ object.local }}</dd>
                    </div>
                  {% endif %}
                  {% if object.cidade or object.estado %}
                    <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                      <dt class="text-[var(--text-secondary)]">{% trans "Cidade / Estado" %}</dt>
                      <dd class="font-medium text-[var(--text-primary)]">
                        {{ object.cidade }}{% if object.cidade and object.estado %} - {% endif %}{{ object.estado }}
                      </dd>
                    </div>
                  {% endif %}
                  {% if object.cep %}
                    <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                      <dt class="text-[var(--text-secondary)]">{% trans "CEP" %}</dt>
                      <dd class="font-medium text-[var(--text-primary)]">{{ object.cep }}</dd>
                    </div>
                  {% endif %}
                </div>
              {% endif %}

              <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2 sm:col-span-2 lg:col-span-3">
                  <dt class="text-[var(--text-secondary)]">{% trans "Descrição" %}</dt>
                  <dd class="font-medium text-[var(--text-primary)] whitespace-pre-line">{{ object.descricao|linebreaksbr }}</dd>
                </div>
                {% if object.cronograma %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2 sm:col-span-2 lg:col-span-3">
                    <dt class="text-[var(--text-secondary)]">{% trans "Cronograma" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)] whitespace-pre-line">{{ object.cronograma|linebreaksbr }}</dd>
                  </div>
                {% endif %}
                {% if object.informacoes_adicionais %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2 sm:col-span-2 lg:col-span-3">
                    <dt class="text-[var(--text-secondary)]">{% trans "Informações adicionais" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)] whitespace-pre-line">{{ object.informacoes_adicionais|linebreaksbr }}</dd>
                  </div>
                {% endif %}
                {% if object.participantes_maximo and pode_ver_campos_restritos %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                    <dt class="text-[var(--text-secondary)]">{% trans "Máximo de participantes" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)]">{{ object.participantes_maximo }}</dd>
                  </div>
                {% endif %}
                {% if object.gratuito %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                    <dt class="text-[var(--text-secondary)]">{% trans "Evento gratuito" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)]">{% trans "Sim" %}</dd>
                  </div>
                {% elif object.valor %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                    <dt class="text-[var(--text-secondary)]">{% trans "Valor" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)]">{{ object.valor }}</dd>
                  </div>
                {% endif %}
                {% if object.orcamento_estimado %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                    <dt class="text-[var(--text-secondary)]">{% trans "Orçamento estimado" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)]">{{ object.orcamento_estimado }}</dd>
                  </div>
                {% endif %}
                {% if object.valor_gasto %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                    <dt class="text-[var(--text-secondary)]">{% trans "Valor gasto" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)]">{{ object.valor_gasto }}</dd>
                  </div>
                {% endif %}
                {% if object.briefing and pode_ver_campos_restritos %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                    <dt class="text-[var(--text-secondary)]">{% trans "Briefing" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)]">
                      {% include 'eventos/partials/shared/_file_link.html' with file=object.briefing %}
                    </dd>
                  </div>
                {% endif %}
                {% if object.parcerias and pode_ver_campos_restritos %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                    <dt class="text-[var(--text-secondary)]">{% trans "Parcerias" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)]">
                      {% include 'eventos/partials/shared/_file_link.html' with file=object.parcerias %}
                    </dd>
                  </div>
                {% endif %}
              </div>
            </dl>

            {% if inscricao and avaliacao_permitida %}
              <section aria-labelledby="evento-avaliacao" class="space-y-4">
                <h3 id="evento-avaliacao" class="text-lg font-semibold text-[var(--text-primary)]">{% trans "Avaliação" %}</h3>
                <form method="post" action="{% url 'eventos:evento_feedback' object.pk %}" class="space-y-6">
                  {% csrf_token %}
                  {{ feedback_form.non_field_errors }}
                  {% include '_forms/field.html' with field=feedback_form.nota %}
                  {% include '_forms/field.html' with field=feedback_form.comentario %}
                  <div class="flex justify-end gap-3 pt-4 border-t border-[var(--border)]">
                    <button type="submit" class="btn btn-primary" aria-label="{% trans 'Enviar avaliação' %}">{% trans 'Enviar avaliação' %}</button>
                  </div>
                </form>
              </section>
            {% endif %}

            <div class="flex flex-wrap items-center justify-between gap-3 pt-4 border-t border-[var(--border)]">
              <div class="flex flex-wrap gap-3">
                {% if pode_editar_evento %}
                  <a href="{% url 'eventos:evento_editar' object.pk %}"
                     class="btn btn-secondary"
                     aria-label="{% trans 'Editar evento' %}">{% trans 'Editar' %}</a>
                {% endif %}
                {% if pode_excluir_evento %}
                  <a
                    href="{% url 'eventos:evento_excluir' object.pk %}"
                    hx-get="{% url 'eventos:evento_excluir' object.pk %}"
                    hx-target="#modal"
                    hx-trigger="click"
                    hx-swap="innerHTML"
                    hx-on="htmx:beforeRequest: window.HubxModalTrigger = this;"
                    class="btn btn-danger"
                    aria-label="{% trans 'Excluir evento' %}"
                  >{% trans 'Excluir' %}</a>
                {% endif %}
              </div>

              {% if user.is_authenticated and user.get_tipo_usuario != 'admin' and user.get_tipo_usuario != 'associado' %}
                {% if inscricao and pode_cancelar %}
                  <form method="post" action="{% url 'eventos:evento_cancelar_inscricao' object.pk %}" class="flex">
                    {% csrf_token %}
                    <button
                      type="button"
                      class="btn btn-secondary"
                      hx-get="{% url 'eventos:evento_cancelar_inscricao_modal' object.pk %}"
                      hx-target="#modal"
                      hx-trigger="click"
                      hx-swap="innerHTML"
                      hx-on="htmx:beforeRequest: window.HubxModalTrigger = this;"
                      aria-label="{% trans 'Cancelar inscrição' %}"
                    >
                      {% trans 'Cancelar inscrição' %}
                    </button>
                    <noscript>
                      <button type="submit" class="btn btn-secondary" aria-label="{% trans 'Cancelar inscrição' %}">{% trans 'Cancelar inscrição' %}</button>
                    </noscript>
                  </form>
                {% elif not inscricao and inscricao_permitida %}
                  <form method="post" action="{% url 'eventos:evento_subscribe' object.pk %}" class="flex">
                    {% csrf_token %}
                    <button
                      type="submit"
                      class="btn btn-primary"
                      aria-label="{% if vagas_disponiveis == 0 %}{% trans 'Inscrições esgotadas' %}{% else %}{% trans 'Inscrever-se' %}{% endif %}"
                      {% if vagas_disponiveis == 0 %}disabled aria-disabled="true"{% endif %}
                    >
                      {% if vagas_disponiveis == 0 %}
                        {% trans 'Inscrições esgotadas' %}
                      {% else %}
                        {% trans 'Inscrever-se' %}
                      {% endif %}
                    </button>
                  </form>
                {% elif inscricao %}
                  <p class="text-sm text-[var(--text-secondary)]">{% trans 'Inscrição confirmada' %}</p>
                {% elif not inscricao %}
                  <p class="text-sm text-[var(--text-secondary)]">{% trans 'Inscrições indisponíveis para este evento.' %}</p>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </details>
        </article>

        {% if user.is_authenticated and user.get_tipo_usuario == 'associado' %}
          <article class="card">
            <details class="group">
              <summary class="card-header flex cursor-pointer items-center justify-between gap-4 select-none [&::-webkit-details-marker]:hidden">
                <div class="flex items-start gap-3">
                  <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-primary-500)]/10 text-[var(--color-primary-600)] shadow-lg shadow-[var(--color-primary-500)]/15">
                    {% lucide 'ticket' class='h-6 w-6' aria_hidden='true' %}
                  </span>
                  <div class="space-y-1">
                    <h2 class="text-xl font-semibold">
                      {% blocktrans with event_title=object.titulo %}Inscrição {{ event_title }}{% endblocktrans %}
                    </h2>
                    <p class="text-sm text-[var(--text-secondary)]">{% trans "Gerencie sua participação no evento" %}</p>
                  </div>
                </div>
                <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:rotate-180">
                  {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
                </span>
              </summary>
              <div class="card-body space-y-4">
                {% if inscricao and pode_cancelar %}
                  <form method="post" action="{% url 'eventos:evento_cancelar_inscricao' object.pk %}" class="flex">
                    {% csrf_token %}
                    <button
                      type="button"
                      class="btn btn-secondary"
                      hx-get="{% url 'eventos:evento_cancelar_inscricao_modal' object.pk %}"
                      hx-target="#modal"
                      hx-trigger="click"
                      hx-swap="innerHTML"
                      hx-on="htmx:beforeRequest: window.HubxModalTrigger = this;"
                      aria-label="{% trans 'Cancelar inscrição' %}"
                    >
                      {% trans 'Cancelar inscrição' %}
                    </button>
                    <noscript>
                      <button type="submit" class="btn btn-secondary" aria-label="{% trans 'Cancelar inscrição' %}">{% trans 'Cancelar inscrição' %}</button>
                    </noscript>
                  </form>
                {% elif not inscricao and inscricao_permitida %}
                  {% if vagas_disponiveis == 0 %}
                    <p class="text-sm text-[var(--text-secondary)]">{% trans 'Inscrições esgotadas' %}</p>
                  {% else %}
                    <a
                      href="{% url 'eventos:inscricao_criar' object.pk %}"
                      class="btn btn-primary"
                      role="button"
                      aria-label="{% trans 'Inscrever-se' %}"
                    >
                      {% trans 'Inscrever-se' %}
                    </a>
                  {% endif %}
                {% elif inscricao %}
                  <p class="text-sm text-[var(--text-secondary)]">{% trans 'Inscrição confirmada' %}</p>
                {% else %}
                  <p class="text-sm text-[var(--text-secondary)]">{% trans 'Inscrições indisponíveis para este evento.' %}</p>
                {% endif %}
              </div>
            </details>
          </article>
        {% endif %}

        {% if pode_ver_inscritos %}
          <article class="card">
            <details class="group">
              <summary class="card-header flex cursor-pointer items-center justify-between gap-4 select-none [&::-webkit-details-marker]:hidden">
                <div class="flex items-start gap-3">
                  <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-primary-500)]/10 text-[var(--color-primary-600)] shadow-lg shadow-[var(--color-primary-500)]/15">
                    {% lucide 'users' class='h-6 w-6' aria_hidden='true' %}
                  </span>
                  <div class="space-y-1">
                    <h2 class="text-lg font-semibold">{% trans "Inscritos" %}</h2>
                    {% with total_inscritos=inscricoes_confirmadas|default_if_none:''|length %}
                      <p class="text-sm text-[var(--text-secondary)]">
                        {% blocktrans count count=total_inscritos %}
                          {{ count }} inscrito confirmado
                        {% plural %}
                          {{ count }} inscritos confirmados
                        {% endblocktrans %}
                        {% if vagas_disponiveis is not None %}
                          ·
                          {% blocktrans count vagas=vagas_disponiveis %}
                            {{ vagas }} vaga disponível
                          {% plural %}
                            {{ vagas }} vagas disponíveis
                          {% endblocktrans %}
                        {% endif %}
                      </p>
                    {% endwith %}
                  </div>
                </div>
                <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:rotate-180">
                  {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
                </span>
              </summary>
              <div class="card-body space-y-4">
                {% if inscricoes_confirmadas %}
                  <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                    {% for ins in inscricoes_confirmadas %}
                      {% with inscrito=ins.user %}
                        <article class="card h-full">
                          <div class="card-body flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                            <div class="flex items-center gap-4">
                              {% if inscrito.avatar %}
                                <img src="{{ inscrito.avatar.url }}" alt="{{ inscrito.display_name|default:inscrito.username }}" class="w-12 h-12 rounded-full object-cover" loading="lazy">
                              {% else %}
                                <div class="w-12 h-12 rounded-full bg-[var(--bg-tertiary)] flex items-center justify-center text-sm font-semibold" role="img" aria-label="{{ inscrito.display_name|default:inscrito.username }}">
                                  {{ inscrito.username|make_list|first|upper }}
                                </div>
                              {% endif %}
                              <div>
                                <h4 class="text-sm font-medium">{{ inscrito.display_name }}</h4>
                                <p class="text-xs">@{{ inscrito.username }}</p>
                              </div>
                            </div>
                            {% if pode_gerenciar_inscricoes %}
                              <div class="flex flex-wrap gap-2 sm:justify-end">
                                <a
                                  href="{% url 'eventos:inscricao_editar' ins.pk %}"
                                  class="btn btn-secondary btn-sm"
                                  aria-label="{% blocktrans with username=inscrito.display_name|default:inscrito.username %}Editar inscrição de {{ username }}{% endblocktrans %}"
                                >
                                  {% lucide 'pencil' class='w-4 h-4' aria_hidden='true' %}
                                </a>
                                <div class="inline-flex">
                                  <button
                                    type="button"
                                    class="btn btn-danger btn-sm"
                                    hx-get="{% url 'eventos:evento_remover_inscrito_modal' object.pk inscrito.pk %}"
                                    hx-target="#modal"
                                    hx-trigger="click"
                                    hx-swap="innerHTML"
                                    hx-on="htmx:beforeRequest: window.HubxModalTrigger = this;"
                                    aria-label="{% blocktrans with username=inscrito.display_name|default:inscrito.username %}Excluir inscrição de {{ username }}{% endblocktrans %}"
                                  >
                                    {% lucide 'trash' class='w-4 h-4' aria_hidden='true' %}
                                  </button>
                                  <noscript>
                                    <form
                                      method="post"
                                      action="{% url 'eventos:evento_remover_inscrito' object.pk inscrito.pk %}"
                                    >
                                      {% csrf_token %}
                                      <button
                                        type="submit"
                                        class="btn btn-danger btn-sm"
                                        aria-label="{% blocktrans with username=inscrito.display_name|default:inscrito.username %}Excluir inscrição de {{ username }}{% endblocktrans %}"
                                      >
                                        {% lucide 'trash' class='w-4 h-4' aria_hidden='true' %}
                                      </button>
                                    </form>
                                  </noscript>
                                </div>
                              </div>
                            {% endif %}
                          </div>
                        </article>
                      {% endwith %}
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="text-sm">{% trans "Nenhum inscrito." %}</p>
                {% endif %}
              </div>
            </details>
          </article>
      {% endif %}
    </div>

    <div id="modal" role="presentation" aria-live="polite"></div>

{% endblock %}
