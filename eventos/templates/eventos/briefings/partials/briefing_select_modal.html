{% load i18n widget_tweaks %}
{% with modal_title_id="modal-briefing-template-title-"|add:evento.pk|stringformat:"s" %}
<div
  class="modal !active"
  role="dialog"
  aria-modal="true"
  aria-labelledby="{{ modal_title_id }}"
  data-modal-root
>
  <div class="modal-content rounded-lg bg-[var(--bg-primary)] shadow-xl focus:outline-none">
    <div class="flex items-start justify-between gap-4 border-b border-[var(--border)] px-6 py-4">
      <h2 id="{{ modal_title_id }}" class="text-xl font-semibold text-[var(--text-primary)]">{{ title }}</h2>
      <button
        type="button"
        class="btn btn-secondary"
        aria-label="{% trans 'Fechar modal' %}"
        data-modal-dismiss
      >
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="space-y-5 px-6 py-5">
      <p class="text-sm text-[var(--text-secondary)]">
        {{ subtitle }}
      </p>
      <form method="post" action="{% url 'eventos:briefing_selecionar' evento.pk %}" class="space-y-5">
        {% csrf_token %}
        {{ form.non_field_errors }}
        {% for field in form %}
          <div class="rounded-lg border border-[var(--border)] bg-[var(--bg-secondary)] p-4 space-y-2">
            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-[var(--text-primary)]">
              {{ field.label }}{% if field.field.required %} *{% endif %}
            </label>
            {% if field|widget_type == 'select' %}
              {% render_field field class+="form-select w-full" %}
            {% else %}
              {% render_field field class+="form-input w-full" %}
            {% endif %}
            {{ field.errors }}
          </div>
        {% endfor %}
        <div class="flex flex-col gap-3 border-t border-[var(--border)] pt-4 sm:flex-row sm:justify-end sm:gap-4">
          <button type="button" class="btn btn-secondary" data-modal-dismiss>{% trans "Cancelar" %}</button>
          <button type="submit" class="btn btn-primary">{% trans "Continuar" %}</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
  (function () {
    const modalContainer = document.getElementById('modal');
    if (!modalContainer) {
      return;
    }
    const dialog = modalContainer.querySelector('[data-modal-root]');
    if (!dialog) {
      return;
    }
    const focusableSelectors = [
      'a[href]','area[href]','input:not([disabled])','select:not([disabled])','textarea:not([disabled])',
      'button:not([disabled])','[tabindex]:not([tabindex="-1"])'
    ].join(',');
    const focusableElements = Array.from(dialog.querySelectorAll(focusableSelectors)).filter((el) => !el.hasAttribute('hidden'));
    const previouslyFocused = window.HubxModalTrigger instanceof HTMLElement ? window.HubxModalTrigger : document.activeElement;
    function closeModal(event) {
      if (event) {
        event.preventDefault();
      }
      modalContainer.innerHTML = '';
      if (previouslyFocused && typeof previouslyFocused.focus === 'function') {
        previouslyFocused.focus();
      }
      if (window.HubxModalTrigger) {
        window.HubxModalTrigger = null;
      }
    }
    const cancelButtons = dialog.querySelectorAll('[data-modal-dismiss]');
    cancelButtons.forEach((button) => {
      button.addEventListener('click', closeModal);
    });
    modalContainer.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeModal(event);
      }
      if (event.key === 'Tab' && focusableElements.length) {
        const first = focusableElements[0];
        const last = focusableElements[focusableElements.length - 1];
        if (event.shiftKey && document.activeElement === first) {
          event.preventDefault();
          last.focus();
        } else if (!event.shiftKey && document.activeElement === last) {
          event.preventDefault();
          first.focus();
        }
      }
    });
    if (focusableElements.length) {
      focusableElements[0].focus();
    }
  })();
</script>
{% endwith %}
