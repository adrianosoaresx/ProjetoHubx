{% load i18n %}

<article role="article" data-message-id="{{ m.id }}" class="flex gap-2 p-2 rounded-lg bg-gray-50 {% if m.pinned_at %}border-l-4 border-yellow-400 bg-yellow-50 pinned{% endif %} {% if m.hidden_at %}opacity-60{% endif %}" tabindex="0">
  <div class="flex-shrink-0">
    {% if m.remetente.profile.avatar %}
      {% blocktrans with username=m.remetente.username asvar alt_text %}Avatar de {{ username }}{% endblocktrans %}
      <img src="{{ m.remetente.profile.avatar.url }}" alt="{{ alt_text }}" class="w-8 h-8 rounded-full" />
      {% else %}
      <span class="inline-block w-8 h-8 rounded-full bg-gray-300 text-sm flex items-center justify-center">{{ m.remetente.username|first|upper }}</span>
    {% endif %}
  </div>
  <div class="flex-1">
    <header class="flex items-center gap-2 text-xs text-gray-500">
      <span class="font-semibold text-gray-700">{{ m.remetente.username }}</span>
      <time datetime="{{ m.created_at|date:'c' }}">{{ m.created_at|date:'SHORT_DATETIME_FORMAT' }}</time>
      {% if m.pinned_at %}<span class="text-primary" aria-label="{% trans 'Mensagem fixada' %}">📌</span>{% endif %}
      {% if m.hidden_at %}<span class="text-red-500">{% trans "Oculta" %}</span>{% endif %}
    </header>
    {% if m.reply_to %}
      <div class="reply-preview border-l-2 pl-2 text-sm text-neutral-600 mb-1">
        <strong>{{ m.reply_to.remetente.username }}</strong>:
        {% if m.reply_to.conteudo_cifrado %}
          🔒 {% trans 'Mensagem cifrada' %}
        {% elif m.reply_to.tipo == 'text' %}
          {{ m.reply_to.conteudo|truncatechars:50 }}
        {% else %}
          {{ m.reply_to.tipo }}
        {% endif %}
      </div>
    {% endif %}
    <div class="mt-1 msg-body">
      {% if m.conteudo_cifrado %}
        <p data-cipher="{{ m.conteudo_cifrado }}" data-alg="{{ m.alg }}" data-key-version="{{ m.key_version }}">🔒 {% trans 'Mensagem cifrada' %}</p>
      {% else %}
        {% if m.tipo == 'text' %}
          <p>{{ m.conteudo|linebreaksbr }}</p>
        {% elif m.tipo == 'image' %}
          <img src="{{ m.arquivo.url }}" alt="{% trans 'Imagem enviada' %}" class="w-full max-w-xs h-auto rounded" />
        {% elif m.tipo == 'video' %}
          <video src="{{ m.arquivo.url }}" controls class="w-full max-w-xs h-auto" aria-label="{% trans 'Player de vídeo' %}"></video>
        {% elif m.tipo == 'file' %}
          <a href="{{ m.arquivo.url }}" class="text-primary underline" download aria-label="{% trans 'Baixar arquivo' %}">
            {{ m.arquivo.name }}
          </a>
        {% endif %}
      {% endif %}
    </div>
    <div class="mt-2 flex items-center gap-2">
      <div class="reaction-container relative">
        <button
          type="button"
          class="reaction-btn"
          aria-haspopup="true"
          aria-expanded="false"
          aria-label="{% trans 'Adicionar reação' %}"
        >🙂</button>
        <ul
          class="reaction-menu hidden absolute bg-white border rounded p-1 flex gap-1"
          role="menu"
        >
          <li>
            <button type="button" class="react-option" data-emoji="🙂" aria-label="{% trans 'Reagir com 🙂' %}">🙂</button>
          </li>
          <li>
            <button type="button" class="react-option" data-emoji="❤️" aria-label="{% trans 'Reagir com ❤️' %}">❤️</button>
          </li>
          <li>
            <button type="button" class="react-option" data-emoji="👍" aria-label="{% trans 'Reagir com 👍' %}">👍</button>
          </li>
          <li>
            <button type="button" class="react-option" data-emoji="😂" aria-label="{% trans 'Reagir com 😂' %}">😂</button>
          </li>
          <li>
            <button type="button" class="react-option" data-emoji="🎉" aria-label="{% trans 'Reagir com 🎉' %}">🎉</button>
          </li>
          <li>
            <button type="button" class="react-option" data-emoji="😢" aria-label="{% trans 'Reagir com 😢' %}">😢</button>
          </li>
          <li>
            <button type="button" class="react-option" data-emoji="😡" aria-label="{% trans 'Reagir com 😡' %}">😡</button>
          </li>
        </ul>
      </div>

      <div class="action-container relative">
        <button
          type="button"
          class="action-btn"
          aria-haspopup="true"
          aria-expanded="false"
          aria-label="{% trans 'Abrir menu' %}"
        >⋮</button>
        <ul
          class="action-menu hidden absolute bg-white border rounded p-1 flex flex-col"
          role="menu"
        >
          <li>
            <button type="button" class="reply-btn" aria-label="{% trans 'Responder' %}">
              {% trans 'Responder' %}
            </button>
          </li>
          <li>
            <button type="button" class="create-item" aria-label="{% trans 'Criar evento/tarefa' %}">
              {% trans 'Criar evento/tarefa' %}
            </button>
          </li>
          <li>
            <button type="button" class="flag-message" aria-label="{% trans 'Denunciar mensagem' %}">
              {% trans 'Denunciar' %}
            </button>
          </li>
        </ul>
      </div>

      <button
        type="button"
        class="favorite-btn"
        aria-label="{% trans 'Favoritar mensagem' %}"
      >⭐</button>

      {% if is_admin %}
        <button
          type="button"
          class="pin-toggle text-xs text-neutral-600"
          aria-label="{% if m.pinned_at %}{% trans 'Desafixar mensagem' %}{% else %}{% trans 'Fixar mensagem' %}{% endif %}"
        >
          {% if m.pinned_at %}{% trans 'Desafixar' %}{% else %}{% trans 'Fixar' %}{% endif %}
        </button>
        <button
          hx-get="{% url 'chat:historico_edicoes' m.channel_id m.id %}"
          hx-target="#modal"
          class="text-xs text-neutral-600"
          aria-label="{% trans 'Histórico de edições' %}"
          type="button"
        >
          {% trans 'Histórico' %}
        </button>
      {% endif %}
      <ul class="reactions flex gap-2 ml-2">
        {% for emoji, count in m.reaction_counts.items %}
          <li class="text-sm">{{ emoji }} <span class="count">{{ count }}</span></li>
        {% endfor %}
      </ul>
    </div>
    <div class="read-status mt-1 text-xs text-gray-500 flex items-center gap-1 {% if m.lido_por.count == 0 %}hidden{% endif %}">
      <ul class="reader-icons flex -space-x-1">
        {% for user in m.lido_por.all %}
          <li
            class="w-4 h-4 rounded-full bg-gray-300 text-[0.5rem] flex items-center justify-center"
            data-username="{{ user.username }}"
          >
            {% if user.profile.avatar %}
              <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}" class="w-4 h-4 rounded-full" />
            {% else %}
              {{ user.username|first|upper }}
            {% endif %}
          </li>
        {% endfor %}
      </ul>
      <span class="reader-count">{{ m.lido_por.count }}</span>
    </div>
  </div>
</article>
