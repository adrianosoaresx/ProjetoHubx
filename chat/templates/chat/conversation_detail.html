{% extends "chat/base_chat.html" %}
{% load i18n static %}

{% block title %}{{ conversation.titulo }}{% endblock %}

{% block chat_content %}
<main class="max-w-4xl mx-auto h-screen flex flex-col p-4">
  <div id="i18n-data" data-i18n='{"noResults": "{{ _("Nenhum resultado encontrado.")|escapejs }}", "loadMore": "{{ _("Carregar mais")|escapejs }}", "clear": "{{ _("Limpar")|escapejs }}", "addReaction": "{{ _("Adicionar rea√ß√£o")|escapejs }}", "reactWith": "{{ _("Reagir com")|escapejs }}", "pin": "{{ _("Fixar")|escapejs }}", "unpin": "{{ _("Desafixar")|escapejs }}", "pinMessage": "{{ _("Fixar mensagem")|escapejs }}", "unpinMessage": "{{ _("Desafixar mensagem")|escapejs }}", "edit": "{{ _("Editar")|escapejs }}", "uploadError": "{{ _("Erro no upload")|escapejs }}", "videoPlayer": "{{ _("Player de v√≠deo")|escapejs }}"}'></div>
  <div
    id="chat-container"
    data-dest-id="{{ conversation.id }}"
    data-current-user="{{ request.user.username }}"
    data-csrf-token="{{ csrf_token }}"
    data-is-admin="{{ is_admin|yesno:'true,false' }}"
    data-upload-url="{% url 'chat_api:chat-upload' %}"
    data-history-url="{{ history_url }}"
    class="flex flex-col h-full"
  >
    <header class="mb-4 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        {% if conversation.imagem %}
          <img src="{{ conversation.imagem.url }}" alt="{{ conversation.titulo }}" class="w-12 h-12 rounded-full" />
        {% endif %}
        <div>
          <h2 class="text-lg font-semibold">{{ conversation.titulo }}</h2>
          {% if conversation.descricao %}
            <p class="text-sm text-neutral-500">{{ conversation.descricao }}</p>
          {% endif %}
        </div>
      </div>
      <div class="flex items-center gap-2 text-sm text-neutral-600">
        <span>{{ conversation.participants.count }} {% trans 'participantes' %}</span>
        {% if not is_owner %}
          <a href="#" class="text-red-600 hover:underline" aria-label="{% trans 'Sair do canal' %}">{% trans 'Sair' %}</a>
        {% endif %}
        {% if is_admin %}
          <button hx-get="{% url 'chat:exportar_modal' conversation.id %}" hx-target="#modal" class="text-blue-600 hover:underline" type="button">{% trans 'Exportar hist√≥rico' %}</button>
        {% endif %}
      </div>
    </header>

    <form id="search-form" data-channel="{{ conversation.id }}" class="mb-4 flex flex-wrap items-end gap-2" aria-label="{% trans 'Buscar mensagens' %}">
      <label for="search-q" class="sr-only">{% trans 'Buscar mensagens' %}</label>
      <input type="search" id="search-q" name="q" class="w-full sm:flex-1 border rounded p-2" placeholder="{% trans 'Buscar' %}" />
      <input type="date" name="desde" class="w-full sm:w-auto border rounded p-2" />
      <input type="date" name="ate" class="w-full sm:w-auto border rounded p-2" />
      <select name="tipo" class="w-full sm:w-auto border rounded p-2">
        <option value="">{% trans 'Todos' %}</option>
        <option value="text">{% trans 'Texto' %}</option>
        <option value="image">{% trans 'Imagem' %}</option>
        <option value="video">{% trans 'V√≠deo' %}</option>
        <option value="file">{% trans 'Arquivo' %}</option>
      </select>
      <button type="submit" class="w-full sm:w-auto bg-primary text-white px-4 py-2 rounded">{% trans 'Buscar' %}</button>
      <button type="button" id="search-clear" class="w-full sm:w-auto px-4 py-2 border rounded">{% trans 'Limpar' %}</button>
    </form>
    <p id="search-feedback" class="text-sm text-neutral-500 mb-2 hidden text-center"></p>
    <div id="search-results" class="mb-4 space-y-2"></div>

    {% if pinned_messages %}
      <section id="pinned" class="mb-4 space-y-2" aria-label="{% trans 'Mensagens fixadas' %}">
        <h3 class="flex items-center gap-1 text-sm font-semibold text-neutral-600"><span>üìå</span>{% trans 'Mensagens fixadas' %}</h3>
        {% for m in pinned_messages %}
          {% include "chat/partials/message.html" with m=m %}
        {% endfor %}
      </section>
    {% endif %}

    <section id="chat-messages" class="flex-1 overflow-y-auto space-y-4 mb-4" aria-live="polite">
      {% for m in messages %}
        {% include "chat/partials/message.html" with m=m %}
      {% empty %}
        <p class="text-neutral-500">{% trans "Nenhuma mensagem." %}</p>
      {% endfor %}
    </section>

    <form id="chat-form" class="mt-auto flex items-center gap-2" aria-label="{% trans 'Enviar mensagem' %}">
      {% csrf_token %}
      <input type="text" id="chat-input" class="flex-1 border rounded p-2" placeholder="{% trans 'Mensagem' %}" />
      <input type="file" id="file-input" class="hidden" />
      <button type="button" id="upload-btn" class="p-2 border rounded" aria-label="{% trans 'Enviar arquivo' %}">üìé</button>
      <button type="submit" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary/90 focus:outline-none focus:ring" aria-label="{% trans 'Enviar mensagem' %}">{% trans "Enviar" %}</button>
    </form>
  </div>
  <div id="modal"></div>
  <dialog id="edit-modal" class="p-4 rounded max-w-md w-full">
    <form method="dialog" class="space-y-2">
      <label for="edit-input" class="sr-only">{% trans 'Editar mensagem' %}</label>
      <textarea id="edit-input" class="w-full border rounded p-2" rows="3"></textarea>
      <div class="flex justify-end gap-2">
        <button type="button" id="edit-cancel" class="px-3 py-1 border rounded" aria-label="{% trans 'Cancelar edi√ß√£o' %}">{% trans 'Cancelar' %}</button>
        <button type="submit" id="edit-save" class="px-3 py-1 bg-primary text-white rounded" aria-label="{% trans 'Salvar mensagem editada' %}">{% trans 'Salvar' %}</button>
      </div>
    </form>
  </dialog>
</main>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  document.addEventListener('DOMContentLoaded', function(){
    if(window.HubXChatRoom){HubXChatRoom.init(document.getElementById('chat-container'));}
    const texts = window.chatTexts || {};
    const searchForm = document.getElementById('search-form');
    const results = document.getElementById('search-results');
    const feedback = document.getElementById('search-feedback');
    const clearBtn = document.getElementById('search-clear');
    let nextUrl = null;
    function render(data, append){
      if(!append){ results.innerHTML=''; }
      if(data.results.length === 0 && !append){
        feedback.innerHTML = `<div class="text-center"><span class="block text-4xl">üîç</span>${texts.noResults || '{% trans "Nenhum resultado encontrado." %}'}</div>`;
        feedback.classList.remove('hidden');
        nextUrl = null;
        return;
      }
      feedback.classList.add('hidden');
      const ul = append ? results.querySelector('ul') : document.createElement('ul');
      if(!append){ ul.className = 'divide-y'; }
      data.results.forEach(m=>{
        const li = document.createElement('li');
        li.innerHTML = `<button type="button" class="w-full text-left p-2 hover:bg-neutral-100" data-id="${m.id}"><span class="font-semibold">${m.remetente}</span> <time class="text-xs text-neutral-500">${new Date(m.created_at).toLocaleString()}</time> - ${m.conteudo.substring(0,80)}</button>`;
        ul.appendChild(li);
      });
      if(!append){ results.appendChild(ul); }
      if(data.next){
        nextUrl = data.next;
        const more = document.createElement('button');
        more.id = 'search-more';
        more.className = 'text-blue-600 hover:underline mt-2';
        more.textContent = texts.loadMore || '{% trans "Carregar mais" %}';
        results.appendChild(more);
      }else{
        nextUrl = null;
      }
    }
    searchForm.addEventListener('submit', function(e){
      e.preventDefault();
      const params = new URLSearchParams(new FormData(searchForm));
      fetch(`/api/chat/channels/${searchForm.dataset.channel}/messages/search/?${params.toString()}`)
        .then(r=>r.json())
        .then(data=>render(data,false));
    });
    clearBtn.addEventListener('click', function(){
      searchForm.reset();
      results.innerHTML = '';
      feedback.classList.add('hidden');
      nextUrl = null;
    });
    results.addEventListener('click', function(e){
      const btn = e.target.closest('button[data-id]');
      if(btn){
        const id = btn.dataset.id;
        const msg = document.querySelector(`[data-message-id="${id}"], [data-id="${id}"]`);
        if(msg){
          msg.classList.add('bg-yellow-100');
          msg.scrollIntoView({behavior:'smooth', block:'center'});
          setTimeout(()=>msg.classList.remove('bg-yellow-100'),2000);
        }
      } else if(e.target.id === 'search-more' && nextUrl){
        fetch(nextUrl).then(r=>r.json()).then(data=>{
          e.target.remove();
          render(data,true);
        });
      }
    });
  });
</script>
{% endblock %}

