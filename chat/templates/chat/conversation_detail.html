{% extends "chat/base_chat.html" %}
{% load i18n static %}

{% block title %}{{ conversation.titulo }}{% endblock %}

{% block chat_content %}
<main class="max-w-4xl mx-auto h-screen flex flex-col p-4">
  <div id="i18n-data" data-i18n='{"noResults": "{{ _("Nenhum resultado encontrado.")|escapejs }}", "loadMore": "{{ _("Carregar mais")|escapejs }}", "clear": "{{ _("Limpar")|escapejs }}", "addReaction": "{{ _("Adicionar reação")|escapejs }}", "reactWith": "{{ _("Reagir com")|escapejs }}", "pin": "{{ _("Fixar")|escapejs }}", "unpin": "{{ _("Desafixar")|escapejs }}", "pinMessage": "{{ _("Fixar mensagem")|escapejs }}", "unpinMessage": "{{ _("Desafixar mensagem")|escapejs }}", "edit": "{{ _("Editar")|escapejs }}", "uploadError": "{{ _("Erro no upload")|escapejs }}", "videoPlayer": "{{ _("Player de vídeo")|escapejs }}", "itemCreated": "{{ _("Item criado com sucesso")|escapejs }}", "itemCreateError": "{{ _("Erro ao criar item")|escapejs }}", "createItem": "{{ _("Criar evento/tarefa")|escapejs }}", "openMenu": "{{ _("Abrir menu")|escapejs }}", "reply": "{{ _("Responder")|escapejs }}", "cancelReply": "{{ _("Cancelar")|escapejs }}"}'></div>
  <div
    id="chat-container"
    data-dest-id="{{ conversation.id }}"
    data-current-user="{{ request.user.username }}"
    data-csrf-token="{{ csrf_token }}"
    data-is-admin="{{ is_admin|yesno:'true,false' }}"
    data-e2ee="{{ conversation.e2ee_habilitado|yesno:'true,false' }}"
    data-upload-url="{% url 'chat_api:chat-upload' %}"
    data-history-url="{{ history_url }}"
    class="flex flex-col h-full"
  >
    <header class="mb-4 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        {% if conversation.imagem %}
          <img src="{{ conversation.imagem.url }}" alt="{{ conversation.titulo }}" class="w-12 h-12 rounded-full" />
        {% endif %}
        <div>
          <h2 class="text-lg font-semibold">{{ conversation.titulo }}</h2>
          {% if conversation.descricao %}
            <p class="text-sm text-neutral-500">{{ conversation.descricao }}</p>
          {% endif %}
        </div>
      </div>
      <div class="flex items-center gap-2 text-sm text-neutral-600">
        <span>{{ conversation.participants.count }} {% trans 'participantes' %}</span>
        {% if not is_owner %}
          <button id="leave-channel" type="button" class="text-red-600 hover:underline" data-success="{% trans 'Você saiu do canal' %}" aria-label="{% trans 'Sair do canal' %}">{% trans 'Sair' %}</button>
        {% endif %}
        {% if is_admin %}
          <button hx-get="{% url 'chat:exportar_modal' conversation.id %}" hx-target="#modal" class="text-blue-600 hover:underline" type="button">{% trans 'Exportar histórico' %}</button>
        {% endif %}
      </div>
    </header>

    <section id="resumos" class="mb-4" aria-label="{% trans 'Resumos disponíveis' %}">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold text-neutral-600">{% trans 'Resumos' %}</h3>
        {% if is_admin %}
          <button id="resumo-gerar" class="text-blue-600 hover:underline text-sm" type="button">{% trans 'Gerar resumo' %}</button>
        {% endif %}
      </div>
      <ul id="resumos-list" class="pl-5 list-disc text-sm text-neutral-700" aria-live="polite"></ul>
    </section>

    <section id="trending" class="mb-4" aria-label="{% trans 'Tópicos em alta' %}">
      <h3 class="text-sm font-semibold text-neutral-600">{% trans 'Tópicos em alta' %}</h3>
      <ul id="trending-list" class="pl-5 list-disc text-sm text-neutral-700" aria-live="polite"></ul>
    </section>

    {% if is_admin %}
      <section id="retencao" class="mb-4" aria-label="{% trans 'Configurar retenção de mensagens' %}">
        <h3 class="text-sm font-semibold text-neutral-600">{% trans 'Retenção de mensagens (dias)' %}</h3>
        <form id="retencao-form" class="mt-2 flex items-center gap-2">
          <label for="retencao-dias" class="sr-only">{% trans 'Dias de retenção' %}</label>
          <input
            type="number"
            id="retencao-dias"
            name="retencao_dias"
            class="border rounded p-2 w-24"
            min="1"
            value="{{ conversation.retencao_dias|default_if_none:'' }}"
          />
          <button type="submit" class="bg-primary text-white px-3 py-1 rounded">{% trans 'Salvar' %}</button>
        </form>
        <p class="text-xs text-neutral-500 mt-1">{% trans 'Deixar em branco desativa a retenção.' %}</p>
        <p id="retencao-feedback" class="text-sm mt-2 hidden"></p>
      </section>
    {% endif %}

    <form id="search-form" data-channel="{{ conversation.id }}" class="mb-4 flex flex-wrap items-end gap-2" aria-label="{% trans 'Buscar mensagens' %}">
      <label for="search-q" class="sr-only">{% trans 'Buscar mensagens' %}</label>
      <input type="search" id="search-q" name="q" class="w-full sm:flex-1 border rounded p-2" placeholder="{% trans 'Buscar' %}" />
      <input type="date" name="desde" class="w-full sm:w-auto border rounded p-2" />
      <input type="date" name="ate" class="w-full sm:w-auto border rounded p-2" />
      <select name="tipo" class="w-full sm:w-auto border rounded p-2">
        <option value="">{% trans 'Todos' %}</option>
        <option value="text">{% trans 'Texto' %}</option>
        <option value="image">{% trans 'Imagem' %}</option>
        <option value="video">{% trans 'Vídeo' %}</option>
        <option value="file">{% trans 'Arquivo' %}</option>
      </select>
      <button type="submit" class="w-full sm:w-auto bg-primary text-white px-4 py-2 rounded">{% trans 'Buscar' %}</button>
      <button type="button" id="search-clear" class="w-full sm:w-auto px-4 py-2 border rounded">{% trans 'Limpar' %}</button>
    </form>
    <p id="search-feedback" class="text-sm text-neutral-500 mb-2 hidden text-center"></p>
    <div id="search-results" class="mb-4 space-y-2"></div>

    {% if pinned_messages %}
      <section id="pinned" class="mb-4 space-y-2" aria-label="{% trans 'Mensagens fixadas' %}">
        <h3 class="flex items-center gap-1 text-sm font-semibold text-neutral-600"><span>📌</span>{% trans 'Mensagens fixadas' %}</h3>
        {% for m in pinned_messages %}
          {% include "chat/partials/message.html" with m=m %}
        {% endfor %}
      </section>
    {% endif %}

    <section id="chat-messages" class="flex-1 overflow-y-auto space-y-4 mb-4" aria-live="polite">
      {% for m in messages %}
        {% include "chat/partials/message.html" with m=m %}
      {% empty %}
        <p class="text-neutral-500">{% trans "Nenhuma mensagem." %}</p>
      {% endfor %}
    </section>

    <div id="reply-preview" class="hidden mb-2 text-sm text-neutral-700"></div>

    <form id="chat-form" class="mt-auto flex items-center gap-2" aria-label="{% trans 'Enviar mensagem' %}">
      {% csrf_token %}
      <input type="text" id="chat-input" class="flex-1 border rounded p-2" placeholder="{% trans 'Mensagem' %}" />
      <input type="file" id="file-input" class="hidden" />
      <button type="button" id="upload-btn" class="p-2 border rounded" aria-label="{% trans 'Enviar arquivo' %}">📎</button>
      <button type="submit" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary/90 focus:outline-none focus:ring" aria-label="{% trans 'Enviar mensagem' %}">{% trans "Enviar" %}</button>
    </form>
  </div>
  <div id="modal"></div>
  <dialog id="item-modal" class="p-4 rounded max-w-md w-full">
    <form method="dialog" class="space-y-2" id="item-form">
      <label class="block" for="item-type">{% trans 'Tipo' %}
        <select id="item-type" class="w-full border rounded p-2">
          <option value="evento">{% trans 'Evento' %}</option>
          <option value="tarefa">{% trans 'Tarefa' %}</option>
        </select>
      </label>
      <label class="block" for="item-title">{% trans 'Título' %}
        <input type="text" id="item-title" class="w-full border rounded p-2" />
      </label>
      <label class="block" for="item-start">{% trans 'Início' %}
        <input type="date" id="item-start" class="w-full border rounded p-2" />
      </label>
      <label class="block" for="item-end">{% trans 'Fim' %}
        <input type="date" id="item-end" class="w-full border rounded p-2" />
      </label>
      <div class="flex justify-end gap-2">
        <button type="button" id="item-cancel" class="px-3 py-1 border rounded" aria-label="{% trans 'Cancelar' %}">{% trans 'Cancelar' %}</button>
        <button type="submit" class="px-3 py-1 bg-primary text-white rounded" aria-label="{% trans 'Criar' %}">{% trans 'Criar' %}</button>
      </div>
    </form>
  </dialog>
  <dialog id="edit-modal" class="p-4 rounded max-w-md w-full">
    <form method="dialog" class="space-y-2">
      <label for="edit-input" class="sr-only">{% trans 'Editar mensagem' %}</label>
      <textarea id="edit-input" class="w-full border rounded p-2" rows="3"></textarea>
      <div class="flex justify-end gap-2">
        <button type="button" id="edit-cancel" class="px-3 py-1 border rounded" aria-label="{% trans 'Cancelar edição' %}">{% trans 'Cancelar' %}</button>
        <button type="submit" id="edit-save" class="px-3 py-1 bg-primary text-white rounded" aria-label="{% trans 'Salvar mensagem editada' %}">{% trans 'Salvar' %}</button>
      </div>
    </form>
  </dialog>
</main>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  document.addEventListener('DOMContentLoaded', function(){
    if(window.HubXChatRoom){HubXChatRoom.init(document.getElementById('chat-container'));}
    const texts = window.chatTexts || {};
    const searchForm = document.getElementById('search-form');
    const results = document.getElementById('search-results');
    const feedback = document.getElementById('search-feedback');
    const clearBtn = document.getElementById('search-clear');
    let nextUrl = null;
    const chatContainer = document.getElementById('chat-container');
    const channelId = chatContainer.dataset.destId;
    const csrfToken = chatContainer.dataset.csrfToken;
    const isAdmin = chatContainer.dataset.isAdmin === 'true';
    const resumosList = document.getElementById('resumos-list');
    const trendingList = document.getElementById('trending-list');
    const gerarBtn = document.getElementById('resumo-gerar');
    const retencaoForm = document.getElementById('retencao-form');
    const retencaoFeedback = document.getElementById('retencao-feedback');
    const leaveBtn = document.getElementById('leave-channel');

    function showMessage(list, message){
      list.replaceChildren();
      const li = document.createElement('li');
      li.textContent = message;
      list.appendChild(li);
    }

    async function carregarResumos(){
      showMessage(resumosList, '{% trans "Carregando..." %}');
      try{
        const r = await fetch(`/api/chat/channels/${channelId}/resumos/`);
        const data = await r.json();
        resumosList.replaceChildren();
        data.forEach(item=>{
          const li=document.createElement('li');
          const dt=new Date(item.created_at).toLocaleString();
          li.textContent=`${item.periodo} - ${dt}`;
          resumosList.appendChild(li);
        });
      }catch(e){
        showMessage(resumosList, '{% trans "Erro ao carregar" %}');
      }
    }

    async function carregarTrending(){
      showMessage(trendingList, '{% trans "Carregando..." %}');
      try{
        const r = await fetch(`/api/chat/trending/?canal=${channelId}`);
        const data = await r.json();
        trendingList.replaceChildren();
        data.forEach(item=>{
          const li=document.createElement('li');
          li.textContent=`${item.palavra} (${item.frequencia})`;
          trendingList.appendChild(li);
        });
      }catch(e){
        showMessage(trendingList, '{% trans "Erro ao carregar" %}');
      }
    }

    if(isAdmin && gerarBtn){
      gerarBtn.addEventListener('click', async function(){
        const originalText = gerarBtn.textContent;
        gerarBtn.disabled = true;
        gerarBtn.textContent = '{% trans "Gerando..." %}';
        try{
          const r = await fetch(`/api/chat/channels/${channelId}/gerar-resumo/`, {
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
            body: JSON.stringify({periodo:'diario'})
          });
          if(r.ok){
            carregarResumos();
          }else{
            alert('{% trans "Erro ao gerar resumo." %}');
          }
        }catch(e){
          alert('{% trans "Erro ao gerar resumo." %}');
        }finally{
          gerarBtn.disabled = false;
          gerarBtn.textContent = originalText;
        }
      });
    }

    if(retencaoForm){
      retencaoForm.addEventListener('submit', function(e){
        e.preventDefault();
        retencaoFeedback.classList.add('hidden');
        const value = retencaoForm.retencao_dias.value;
        if(value === '0'){
          retencaoFeedback.textContent = '{% trans "Valor deve ser maior que zero." %}';
          retencaoFeedback.className = 'text-sm text-red-600 mt-2';
          retencaoFeedback.classList.remove('hidden');
          return;
        }
        fetch(`/api/chat/channels/${channelId}/config-retention/`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
          body: JSON.stringify({retencao_dias: value || null})
        })
          .then(r=>r.json().then(data=>({ok:r.ok, data})))
          .then(({ok, data})=>{
            if(ok){
              retencaoFeedback.textContent = '{% trans "Retenção atualizada com sucesso." %}';
              retencaoFeedback.className = 'text-sm text-green-600 mt-2';
              retencaoForm.retencao_dias.value = data.retencao_dias;
            }else{
              retencaoFeedback.textContent = data.detail || '{% trans "Erro ao atualizar retenção." %}';
              retencaoFeedback.className = 'text-sm text-red-600 mt-2';
            }
            retencaoFeedback.classList.remove('hidden');
          })
          .catch(()=>{
            retencaoFeedback.textContent = '{% trans "Erro ao atualizar retenção." %}';
            retencaoFeedback.className = 'text-sm text-red-600 mt-2';
            retencaoFeedback.classList.remove('hidden');
          });
      });
    }

    if(leaveBtn){
      leaveBtn.addEventListener('click', function(){
        fetch(`/api/chat/channels/${channelId}/leave/`, {
          method: 'POST',
          headers: {'X-CSRFToken': csrfToken}
        }).then(r => {
          if(r.ok){
            leaveBtn.outerHTML = `<span class="text-green-600">${leaveBtn.dataset.success}</span>`;
          }else{
            r.json().then(data=>{alert(data.erro || 'Erro');});
          }
        }).catch(()=>alert('{% trans "Erro ao sair do canal." %}'));
      });
    }

    carregarResumos();
    carregarTrending();
    function render(data, append){
      if(!append){ results.innerHTML=''; }
      if(data.results.length === 0 && !append){
        feedback.innerHTML = `<div class="text-center"><span class="block text-4xl">🔍</span>${texts.noResults || '{% trans "Nenhum resultado encontrado." %}'}</div>`;
        feedback.classList.remove('hidden');
        nextUrl = null;
        return;
      }
      feedback.classList.add('hidden');
      const ul = append ? results.querySelector('ul') : document.createElement('ul');
      if(!append){ ul.className = 'divide-y'; }
      data.results.forEach(m=>{
        const li = document.createElement('li');
        const snippet = m.conteudo_cifrado ? '🔒' : (m.conteudo || '').substring(0,80);
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'w-full text-left p-2 hover:bg-neutral-100';
        btn.dataset.id = m.id;
        const span = document.createElement('span');
        span.className = 'font-semibold';
        span.textContent = m.remetente;
        const time = document.createElement('time');
        time.className = 'text-xs text-neutral-500';
        time.textContent = new Date(m.created_at).toLocaleString();
        btn.appendChild(span);
        btn.append(' ');
        btn.appendChild(time);
        btn.append(' - ');
        btn.append(snippet);
        li.appendChild(btn);
        ul.appendChild(li);
      });
      if(!append){ results.appendChild(ul); }
      if(data.next){
        nextUrl = data.next;
        const more = document.createElement('button');
        more.id = 'search-more';
        more.className = 'text-blue-600 hover:underline mt-2';
        more.textContent = texts.loadMore || '{% trans "Carregar mais" %}';
        results.appendChild(more);
      }else{
        nextUrl = null;
      }
    }
    searchForm.addEventListener('submit', async function(e){
      e.preventDefault();
      const params = new URLSearchParams(new FormData(searchForm));
      results.innerHTML = '<p>{% trans "Carregando..." %}</p>';
      try{
        const r = await fetch(`/api/chat/channels/${searchForm.dataset.channel}/messages/search/?${params.toString()}`);
        const data = await r.json();
        render(data,false);
      }catch(err){
        results.innerHTML = '';
        feedback.textContent = '{% trans "Erro ao buscar mensagens." %}';
        feedback.classList.remove('hidden');
      }
    });
    clearBtn.addEventListener('click', function(){
      searchForm.reset();
      results.innerHTML = '';
      feedback.classList.add('hidden');
      nextUrl = null;
    });
    results.addEventListener('click', function(e){
      const btn = e.target.closest('button[data-id]');
      if(btn){
        const id = btn.dataset.id;
        const msg = document.querySelector(`[data-message-id="${id}"], [data-id="${id}"]`);
        if(msg){
          msg.classList.add('bg-yellow-100');
          msg.scrollIntoView({behavior:'smooth', block:'center'});
          setTimeout(()=>msg.classList.remove('bg-yellow-100'),2000);
        }
      } else if(e.target.id === 'search-more' && nextUrl){
        const moreBtn = e.target;
        moreBtn.disabled = true;
        moreBtn.textContent = '{% trans "Carregando..." %}';
        fetch(nextUrl)
          .then(r=>r.json())
          .then(data=>{
            moreBtn.remove();
            render(data,true);
          })
          .catch(()=>{
            moreBtn.disabled = false;
            moreBtn.textContent = '{% trans "Erro ao carregar" %}';
          });
      }
    });
  });
</script>
{% endblock %}

