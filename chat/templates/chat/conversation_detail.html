{% extends "chat/base_chat.html" %}
{% load i18n static %}

{% block title %}{{ conversation.titulo }}{% endblock %}

{% block chat_content %}
<main class="max-w-4xl mx-auto h-screen flex flex-col p-4">
  <div
    id="chat-container"
    data-dest-id="{{ conversation.id }}"
    data-current-user="{{ request.user.username }}"
    data-csrf-token="{{ csrf_token }}"
    data-is-admin="{{ is_admin|yesno:'true,false' }}"
    data-upload-url="{% url 'chat_api:chat-upload' %}"
    data-history-url=""
    class="flex flex-col h-full"
  >
    <header class="mb-4 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        {% if conversation.imagem %}
          <img src="{{ conversation.imagem.url }}" alt="" class="w-12 h-12 rounded-full" />
        {% endif %}
        <div>
          <h2 class="text-lg font-semibold">{{ conversation.titulo }}</h2>
          {% if conversation.descricao %}
            <p class="text-sm text-neutral-500">{{ conversation.descricao }}</p>
          {% endif %}
        </div>
      </div>
      <div class="flex items-center gap-2 text-sm text-neutral-600">
        <span>{{ conversation.participants.count }} {% trans 'participantes' %}</span>
        {% if not is_owner %}
          <a href="#" class="text-red-600 hover:underline" aria-label="{% trans 'Sair do canal' %}">{% trans 'Sair' %}</a>
        {% endif %}
        {% if is_admin %}
          <button hx-get="{% url 'chat:exportar_modal' conversation.id %}" hx-target="#modal" class="text-blue-600 hover:underline" type="button">{% trans 'Exportar histÃ³rico' %}</button>
        {% endif %}
      </div>
    </header>

    {% if pinned_messages %}
      <section id="pinned" class="mb-4 space-y-2" aria-label="{% trans 'Mensagens fixadas' %}">
        {% for m in pinned_messages %}
          {% include "chat/partials/message.html" with m=m %}
        {% endfor %}
      </section>
    {% endif %}

    <section id="chat-messages" class="flex-1 overflow-y-auto space-y-4 mb-4" aria-live="polite">
      {% for m in messages %}
        {% include "chat/partials/message.html" with m=m %}
      {% empty %}
        <p class="text-neutral-500">{% trans "Nenhuma mensagem." %}</p>
      {% endfor %}
    </section>

    <form id="chat-form" class="mt-auto flex items-center gap-2" aria-label="{% trans 'Enviar mensagem' %}">
      {% csrf_token %}
      <input type="text" id="chat-input" class="flex-1 border rounded p-2" placeholder="{% trans 'Mensagem' %}" />
      <input type="file" id="file-input" class="hidden" />
      <button type="button" id="upload-btn" class="p-2 border rounded" aria-label="{% trans 'Enviar arquivo' %}">ðŸ“Ž</button>
      <button type="submit" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary/90 focus:outline-none focus:ring" aria-label="{% trans 'Enviar mensagem' %}">{% trans "Enviar" %}</button>
    </form>
  </div>
  <div id="modal"></div>
  <script src="{% static 'chat/js/chat_socket.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      if(window.HubXChatRoom){HubXChatRoom.init(document.getElementById('chat-container'));}
    });
  </script>
</main>
{% endblock %}

