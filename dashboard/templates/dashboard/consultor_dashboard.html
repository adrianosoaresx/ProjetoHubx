{% extends "base.html" %}
{% load i18n lucide_icons %}

{% block title %}{% trans "Dashboard do consultor" %}{% endblock %}

{% block hero %}
  {% include "_components/hero.html" with title=_("Dashboard do consultor") subtitle=_("Acompanhe o desempenho dos núcleos em que você oferece consultoria e os eventos relacionados.") breadcrumb_template=None neural_background="dashboard" section_classes="relative isolate overflow-hidden text-white" container_classes="max-w-6xl mx-auto w-full px-6 py-14 md:py-16" %}
{% endblock %}

{% block content %}
  <div class="mx-auto flex w-full max-w-6xl flex-col gap-10">
    <section aria-labelledby="consultor-metricas-title" class="space-y-6">
      <details class="card group" open>
        <summary class="card-header flex cursor-pointer items-center justify-between gap-4">
          <div class="flex items-start gap-3">
            <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-primary-500)]/10 text-[var(--color-primary-500)] shadow-lg shadow-[var(--color-primary-500)]/15">
              {% lucide 'gauge' class='h-6 w-6' aria_hidden='true' %}
            </span>
            <div class="space-y-1">
              <h2 id="consultor-metricas-title" class="text-xl font-semibold text-[var(--text-primary)]">
                {% trans "Visão geral" %}
              </h2>
              <p class="text-sm text-[var(--text-secondary)]">
                {% trans "Resumo dos núcleos e eventos sob sua consultoria." %}
              </p>
            </div>
          </div>
          <span class="text-[var(--text-muted)] transition-transform duration-200 group-open:-rotate-180">
            {% lucide 'chevron-down' class='h-5 w-5' aria_hidden='true' %}
          </span>
        </summary>
        <div class="card-body space-y-6">
          <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-4">
            {% include "_partials/cards/total_card.html" with label=_("Núcleos acompanhados") valor=total_nucleos_consultoria icon_name="layers" %}
            {% include "_partials/cards/total_card.html" with label=_("Eventos ativos") valor=total_eventos_consultoria icon_name="calendar-days" %}
            {% include "_partials/cards/total_card.html" with label=_("Inscrições confirmadas") valor=total_inscritos_consultoria icon_name="users" %}
            {% include "_partials/cards/total_card.html" with label=_("Receita de inscrições") valor=valor_total_inscricoes_consultoria icon_name="wallet" %}
          </div>

          <div class="grid gap-6 md:grid-cols-2">
            <article class="card" aria-labelledby="consultor-nucleos-title">
              <div class="card-body space-y-4">
                <div class="flex items-start gap-3">
                  <span class="flex h-10 w-10 items-center justify-center rounded-full bg-[var(--bg-secondary)] text-[var(--color-success-600)]">
                    {% lucide 'layers' class='h-5 w-5' aria_hidden='true' %}
                  </span>
                  <div class="space-y-1">
                    <h3 id="consultor-nucleos-title" class="text-lg font-semibold text-[var(--text-primary)]">{% trans "Núcleos com sua consultoria" %}</h3>
                    <p class="text-sm text-[var(--text-secondary)]">{% trans "Grupos nos quais você atua como consultor." %}</p>
                  </div>
                </div>
                <ul class="space-y-3" aria-live="polite">
                  {% for nucleo in nucleos_consultoria %}
                    <li class="rounded-lg border border-[var(--border)] bg-[var(--bg-secondary)] px-4 py-3">
                      <div class="flex flex-col gap-1">
                        <span class="text-sm font-medium text-[var(--text-primary)]">{{ nucleo.nome }}</span>
                        {% if nucleo.cidade or nucleo.estado %}
                          <span class="text-xs text-[var(--text-muted)]">{{ nucleo.cidade }}{% if nucleo.cidade and nucleo.estado %} · {% endif %}{{ nucleo.estado }}</span>
                        {% endif %}
                        {% if nucleo.total_membros or nucleo.total_membros == 0 %}
                          <span class="text-xs text-[var(--text-secondary)]">{% trans "Membros ativos" %}: {{ nucleo.total_membros }}</span>
                        {% endif %}
                      </div>
                    </li>
                  {% empty %}
                    <li class="rounded-lg border border-dashed border-[var(--border)] px-4 py-3 text-sm text-[var(--text-secondary)]">
                      {% trans "Você ainda não é consultor de nenhum núcleo." %}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </article>

            <article class="card" aria-labelledby="consultor-eventos-title">
              <div class="card-body space-y-4">
                <div class="flex items-start gap-3">
                  <span class="flex h-10 w-10 items-center justify-center rounded-full bg-[var(--bg-secondary)] text-[var(--color-info-600)]">
                    {% lucide 'calendar-days' class='h-5 w-5' aria_hidden='true' %}
                  </span>
                  <div class="space-y-1">
                    <h3 id="consultor-eventos-title" class="text-lg font-semibold text-[var(--text-primary)]">{% trans "Eventos em seus núcleos" %}</h3>
                    <p class="text-sm text-[var(--text-secondary)]">{% trans "Atividades em andamento ou planejadas." %}</p>
                  </div>
                </div>
                <ul class="space-y-3" aria-live="polite">
                  {% for evento in eventos_consultoria %}
                    <li class="rounded-lg border border-[var(--border)] bg-[var(--bg-secondary)] px-4 py-3">
                      <div class="flex flex-col gap-1">
                        <span class="text-sm font-medium text-[var(--text-primary)]">{{ evento.titulo|default:_('Evento sem título') }}</span>
                        <span class="text-xs text-[var(--text-muted)]">
                          {{ evento.data_inicio|date:"SHORT_DATE_FORMAT" }}
                          {% if evento.nucleo %}
                            · {{ evento.nucleo.nome }}
                          {% endif %}
                        </span>
                        {% if evento.total_inscritos or evento.total_inscritos == 0 %}
                          <span class="text-xs text-[var(--text-secondary)]">{% trans "Inscrições confirmadas" %}: {{ evento.total_inscritos }}</span>
                        {% endif %}
                        {% if evento.valor_total_inscricoes or evento.valor_total_inscricoes == 0 %}
                          <span class="text-xs text-[var(--text-secondary)]">{% trans "Receita" %}: {{ evento.valor_total_inscricoes }}</span>
                        {% endif %}
                      </div>
                    </li>
                  {% empty %}
                    <li class="rounded-lg border border-dashed border-[var(--border)] px-4 py-3 text-sm text-[var(--text-secondary)]">
                      {% trans "Ainda não há eventos vinculados aos núcleos que você acompanha." %}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </article>
          </div>
        </div>
      </details>
    </section>

    <section aria-labelledby="consultor-visualizacoes-title" class="space-y-6">
      <details class="card group" {% if dashboard_period_changed %}open{% endif %}>
        <summary class="card-header flex cursor-pointer items-center justify-between gap-4">
          <div class="flex items-start gap-3">
            <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-info-500)]/10 text-[var(--color-info-600)] shadow-lg shadow-[var(--color-info-500)]/20">
              {% lucide 'chart-line' class='h-6 w-6' aria_hidden='true' %}
            </span>
            <div class="space-y-1">
              <h2 id="consultor-visualizacoes-title" class="text-xl font-semibold text-[var(--text-primary)]">
                {% trans "Visualizações" %}
              </h2>
              <p class="text-sm text-[var(--text-secondary)]">
                {% trans "Analise a evolução de eventos, inscrições e nucleados dos núcleos que você acompanha." %}
              </p>
            </div>
          </div>
          <span class="text-[var(--text-muted)] transition-transform duration-200 group-open:-rotate-180">
            {% lucide 'chevron-down' class='h-5 w-5' aria_hidden='true' %}
          </span>
        </summary>
        <div class="card-body space-y-6">
          <form method="get" class="flex flex-wrap items-center justify-end gap-3 rounded-md border border-[var(--border)] bg-[var(--bg-secondary)] px-4 py-3">
            <label class="flex items-center gap-3 text-sm font-medium text-[var(--text-secondary)]">
              <span>{% trans "Período" %}</span>
              <select name="months" class="form-select w-32" onchange="this.form.submit()">
                {% for option in dashboard_period_choices %}
                  <option value="{{ option }}" {% if option == dashboard_period_months %}selected{% endif %}>
                    {% blocktrans trimmed count months=option %}
                      Último mês
                    {% plural %}
                      Últimos {{ months }} meses
                    {% endblocktrans %}
                  </option>
                {% endfor %}
              </select>
            </label>
          </form>

          <div class="grid gap-6">
            <figure class="card" aria-labelledby="consultor-eventos-inscricoes-chart-title">
              <div
                class="card-body space-y-6"
              >
                <div
                  id="consultor-eventos-inscricoes-chart"
                  role="img"
                  aria-label="{% trans 'Gráfico comparativo entre eventos ativos e inscrições confirmadas por mês.' %}"
                  class="h-80 w-full rounded-md border border-[var(--border)] bg-[var(--bg-primary)]"
                ></div>
                {{ eventos_inscricoes_chart.figure|json_script:"consultor-eventos-inscricoes-chart-data" }}
                <figcaption id="consultor-eventos-inscricoes-chart-title" class="text-sm text-[var(--text-secondary)]">
                  {% trans "Comparação mensal de eventos ativos e inscrições confirmadas." %}
                </figcaption>
              </div>
            </figure>

            <figure class="card" aria-labelledby="consultor-nucleados-chart-title">
              <div class="card-body space-y-6">
                <div
                  id="consultor-nucleados-chart"
                  role="img"
                  aria-label="{% trans 'Gráfico linear exibindo a evolução de nucleados ativos por mês, com desvio padrão.' %}"
                  class="h-80 w-full rounded-md border border-[var(--border)] bg-[var(--bg-primary)]"
                ></div>
                {{ nucleados_chart.figure|json_script:"consultor-nucleados-chart-data" }}
                <figcaption id="consultor-nucleados-chart-title" class="text-sm text-[var(--text-secondary)]">
                  {% trans "Total de membros nucleados por mês." %}
                </figcaption>
              </div>
            </figure>

            <figure class="card" aria-labelledby="consultor-receita-chart-title">
              <div class="card-body space-y-6">
                <div
                  id="consultor-receita-chart"
                  role="img"
                  aria-label="{% trans 'Gráfico linear mostrando a receita total das inscrições confirmadas por mês.' %}"
                  class="h-80 w-full rounded-md border border-[var(--border)] bg-[var(--bg-primary)]"
                ></div>
                {{ receita_inscricoes_chart.figure|json_script:"consultor-receita-chart-data" }}
                <figcaption id="consultor-receita-chart-title" class="text-sm text-[var(--text-secondary)]">
                  {% trans "Receita total das inscrições confirmadas." %}
                </figcaption>
              </div>
            </figure>
          </div>
        </div>
      </details>
    </section>
  </div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" defer></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const chartsRegistry = new Map();

      function cloneFigure(figure) {
        if (typeof structuredClone === "function") {
          return structuredClone(figure);
        }
        try {
          return JSON.parse(JSON.stringify(figure));
        } catch (error) {
          console.error("Não foi possível clonar a figura do gráfico.", error);
          return null;
        }
      }

      function readThemeTokens() {
        const styles = getComputedStyle(document.documentElement);
        const pick = (variable, fallback) => {
          const value = styles.getPropertyValue(variable) || "";
          return value.trim() || fallback;
        };

        return {
          surface: pick("--bg-primary", "#ffffff"),
          border: pick("--border", "rgba(148, 163, 184, 0.4)"),
          textPrimary: pick("--text-primary", "#0f172a"),
          textMuted: pick("--text-secondary", "#475569"),
        };
      }

      function applyThemeToFigure(figure) {
        const cloned = cloneFigure(figure);
        if (!cloned) {
          return null;
        }

        const { surface, border, textPrimary, textMuted } = readThemeTokens();
        const layout = cloned.layout ?? {};

        layout.paper_bgcolor = "rgba(0,0,0,0)";
        layout.plot_bgcolor = layout.plot_bgcolor || surface;
        layout.font = Object.assign({}, layout.font || {}, { color: textPrimary });

        const baseLegend = {
          orientation: "h",
          x: 0.5,
          y: -0.18,
          xanchor: "center",
          yanchor: "top",
          bgcolor: surface,
          bordercolor: border,
          borderwidth: 1,
          font: { size: 12 },
        };
        layout.legend = Object.assign({}, baseLegend, layout.legend || {});
        layout.legend.bgcolor = layout.legend.bgcolor ?? surface;
        layout.legend.bordercolor = layout.legend.bordercolor ?? border;
        layout.legend.borderwidth = layout.legend.borderwidth ?? 1;
        layout.legend.font = Object.assign({}, layout.legend.font || {}, { color: textPrimary });

        const baseHoverlabel = {
          bgcolor: surface,
          bordercolor: border,
          font: {},
        };
        const mergedHoverlabel = Object.assign({}, layout.hoverlabel || {});
        const hoverlabel = Object.assign({}, baseHoverlabel, mergedHoverlabel);
        hoverlabel.bgcolor = surface;
        hoverlabel.bordercolor = border;
        hoverlabel.font = Object.assign({}, hoverlabel.font || {}, { color: textPrimary });
        layout.hoverlabel = hoverlabel;

        const axisKeys = Object.keys(layout).filter((key) => /^(x|y)axis/.test(key));
        axisKeys.forEach((axisKey) => {
          const axis = Object.assign({}, layout[axisKey]);
          axis.tickfont = Object.assign({}, axis.tickfont || {}, { color: textPrimary });
          axis.title = Object.assign({}, axis.title || {});
          if (axis.title.font || axis.title.text) {
            axis.title.font = Object.assign({}, axis.title.font || {}, { color: textPrimary });
          }
          axis.gridcolor = axis.gridcolor || border;
          axis.zerolinecolor = axis.zerolinecolor || border;
          layout[axisKey] = axis;
        });

        if (Array.isArray(layout.annotations)) {
          layout.annotations = layout.annotations.map((annotation) => {
            const mapped = Object.assign({}, annotation);
            const baseColor = String(mapped.font?.color || "").toLowerCase();
            const wantsMuted = baseColor.includes("6b7280") || baseColor.includes("var(--text-muted");
            const targetColor = wantsMuted ? textMuted : textPrimary;
            mapped.font = Object.assign({}, mapped.font || {}, { color: targetColor });
            return mapped;
          });
        }

        cloned.layout = layout;
        return cloned;
      }

      function parseFigure(scriptId) {
        const script = document.getElementById(scriptId);
        if (!script) {
          return null;
        }

        try {
          return JSON.parse(script.textContent || "{}");
        } catch (error) {
          console.error(`Não foi possível interpretar os dados do gráfico "${scriptId}".`, error);
          return null;
        }
      }

      function renderPlotlyChart(containerId, dataScriptId) {
        const container = document.getElementById(containerId);
        const figure = parseFigure(dataScriptId);

        if (!container || !figure) {
          return;
        }

        if (typeof Plotly === "undefined") {
          console.warn("Plotly não está disponível para renderizar o gráfico", containerId);
          return;
        }

        const themedFigure = applyThemeToFigure(figure);
        if (!themedFigure) {
          return;
        }

        const config = {
          responsive: true,
          displayModeBar: false,
        };

        Plotly.newPlot(container, themedFigure.data ?? [], themedFigure.layout ?? {}, config).then(() => {
          const baseFigure = cloneFigure(figure);
          if (baseFigure) {
            chartsRegistry.set(containerId, { container, baseFigure, config });
          }
        });
      }

      function refreshChartsTheme() {
        chartsRegistry.forEach(({ container, baseFigure, config }) => {
          const themedFigure = applyThemeToFigure(baseFigure);
          if (!themedFigure) {
            return;
          }
          Plotly.react(container, themedFigure.data ?? [], themedFigure.layout ?? {}, config ?? {});
        });
      }

      const chartsToRender = [
        ["consultor-eventos-inscricoes-chart", "consultor-eventos-inscricoes-chart-data"],
        ["consultor-nucleados-chart", "consultor-nucleados-chart-data"],
        ["consultor-receita-chart", "consultor-receita-chart-data"],
      ];

      const themeObserver = new MutationObserver((mutations) => {
        if (mutations.some((mutation) => mutation.attributeName === "class")) {
          refreshChartsTheme();
        }
      });
      themeObserver.observe(document.documentElement, { attributes: true });

      window.addEventListener("storage", (event) => {
        if (event.key === "tema") {
          refreshChartsTheme();
        }
      });

      chartsToRender.forEach(([containerId, dataScriptId]) => {
        renderPlotlyChart(containerId, dataScriptId);
      });
    });
  </script>
{% endblock %}
