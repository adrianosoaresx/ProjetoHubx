{% extends "base.html" %}
{% load i18n static %}

{% block title %}{% trans "Dashboard administrativo" %}{% endblock %}

{% block hero %}
{% include "_components/hero.html" with title=_("Dashboard administrativo") subtitle=_("Acompanhe indicadores-chave da organização e o desempenho dos eventos.") breadcrumb_template="dashboard/partials/admin_dashboard_breadcrumb.html" neural_background="dashboard" section_classes="relative isolate overflow-hidden text-white" container_classes="max-w-7xl mx-auto w-full px-6 py-14 md:py-16" %}

{% endblock %}

{% block content %}
  <div class="mx-auto flex w-full max-w-7xl flex-col gap-10">
    <section aria-labelledby="dashboard-metrics-title" class="space-y-6">
      <div class="flex items-center justify-between gap-4">
        <h2 id="dashboard-metrics-title" class="text-xl font-semibold text-[var(--text-primary)]">
          {% trans "Métricas principais" %}
        </h2>
        <p class="text-sm text-[var(--text-muted)]">
          {% trans "Visão geral do crescimento da comunidade e atividades em andamento." %}
        </p>
      </div>
      <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-3">
        {% include "_partials/cards/total_card.html" with label=_("Associados") valor=total_associados icon_name="users" %}
        {% include "_partials/cards/total_card.html" with label=_("Nucleados") valor=total_nucleados icon_name="network" %}
        {% include "_partials/cards/total_card.html" with label=_("Eventos ativos") valor=eventos_ativos icon_name="activity" %}
      </div>
    </section>

    <section aria-labelledby="dashboard-charts-title" class="space-y-6 pt-4 md:pt-6">
      <div class="flex items-center justify-between gap-4">
        <h2 id="dashboard-charts-title" class="text-xl font-semibold text-[var(--text-primary)]">
          {% trans "Visualizações" %}
        </h2>
        <p class="text-sm text-[var(--text-muted)]">
          {% trans "Explore a distribuição de membros e a participação dos núcleos nos eventos." %}
        </p>
      </div>
      <div class="grid gap-6 lg:grid-cols-2">
        <figure class="card" aria-labelledby="membros-chart-title">
          <div class="card-body space-y-6">
            <div
              id="membros-chart"
              role="img"
              aria-label="{% trans 'Gráfico de pizza apresentando a proporção de associados nucleados e não nucleados.' %}"
              class="h-80 w-full rounded-md border border-[var(--border)] bg-[var(--bg-primary)]"
            ></div>
            {{ membros_chart.figure|json_script:"membros-chart-data" }}
            <figcaption class="space-y-1">
              <h3 id="membros-chart-title" class="text-lg font-semibold text-[var(--text-primary)]">
                {% trans "Distribuição de membros" %}
              </h3>
              <p class="text-sm text-[var(--text-muted)]">
                {% trans "Comparativo entre associados nucleados e não nucleados." %}
              </p>
            </figcaption>
          </div>
        </figure>

        <figure class="card" aria-labelledby="eventos-nucleo-chart-title">
          <div class="card-body space-y-6">
            <div
              id="eventos-nucleo-chart"
              role="img"
              aria-label="{% trans 'Gráfico de barras com a distribuição de eventos por núcleo e eventos públicos.' %}"
              class="h-80 w-full rounded-md border border-[var(--border)] bg-[var(--bg-primary)]"
            ></div>
            {{ eventos_por_nucleo.figure|json_script:"eventos-nucleo-chart-data" }}
            <figcaption class="space-y-1">
              <h3 id="eventos-nucleo-chart-title" class="text-lg font-semibold text-[var(--text-primary)]">
                {% trans "Eventos por núcleo" %}
              </h3>
              <p class="text-sm text-[var(--text-muted)]">
                {% trans "Quantidade de eventos por núcleo, incluindo iniciativas públicas." %}
              </p>
            </figcaption>
          </div>
        </figure>
      </div>
    </section>
  </div>
{% endblock %}
{% block extra_js %}
  {{ block.super }}
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" defer></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const chartsRegistry = new Map();

      function cloneFigure(figure) {
        if (typeof structuredClone === "function") {
          return structuredClone(figure);
        }
        return JSON.parse(JSON.stringify(figure));
      }

      function readThemeTokens() {
        const styles = getComputedStyle(document.documentElement);
        const pick = (variable, fallback) => {
          const value = styles.getPropertyValue(variable) || "";
          return value.trim() || fallback;
        };

        return {
          surface: pick("--bg-primary", "#ffffff"),
          border: pick("--border", "rgba(148, 163, 184, 0.4)"),
          textPrimary: pick("--text-primary", "#0f172a"),
          textMuted: pick("--text-secondary", "#475569"),
        };
      }

      function applyThemeToFigure(figure) {
        const themedFigure = cloneFigure(figure);
        const { surface, border, textPrimary, textMuted } = readThemeTokens();
        const layout = themedFigure.layout ?? {};

        layout.paper_bgcolor = "rgba(0,0,0,0)";
        layout.plot_bgcolor = layout.plot_bgcolor || surface;
        layout.font = Object.assign({ color: textPrimary }, layout.font || {});

        layout.legend = Object.assign(
          {
            orientation: "h",
            x: 0.5,
            y: -0.18,
            xanchor: "center",
            yanchor: "top",
            bgcolor: surface,
            bordercolor: border,
            borderwidth: 1,
            font: { color: textPrimary, size: 12 },
          },
          layout.legend || {},
        );
        layout.legend.font = Object.assign({ color: textPrimary }, layout.legend.font || {});

        layout.hoverlabel = Object.assign(
          {
            bgcolor: surface,
            bordercolor: border,
            font: { color: textPrimary },
          },
          layout.hoverlabel || {},
        );

        const axisKeys = Object.keys(layout).filter((key) => /^(x|y)axis/.test(key));
        axisKeys.forEach((axisKey) => {
          const axis = Object.assign({}, layout[axisKey]);
          axis.tickfont = Object.assign({ color: textMuted }, axis.tickfont || {});
          axis.title = Object.assign({ font: { color: textPrimary } }, axis.title || {});
          if (axis.title.font) {
            axis.title.font = Object.assign({ color: textPrimary }, axis.title.font);
          }
          axis.gridcolor = axis.gridcolor || border;
          axis.zerolinecolor = axis.zerolinecolor || border;
          layout[axisKey] = axis;
        });

        if (Array.isArray(layout.annotations)) {
          layout.annotations = layout.annotations.map((annotation) => {
            const mapped = Object.assign({}, annotation);
            const baseColor = String(mapped.font?.color || "").toLowerCase();
            const targetColor = baseColor.includes("6b7280") ? textMuted : textPrimary;
            mapped.font = Object.assign({ color: targetColor }, mapped.font || {});
            return mapped;
          });
        }

        themedFigure.layout = layout;
        return themedFigure;
      }

      function renderPlotlyChart(containerId, dataScriptId) {
        const container = document.getElementById(containerId);
        const script = document.getElementById(dataScriptId);
        if (!container || !script) {
          return;
        }

        let figure;
        try {
          figure = JSON.parse(script.textContent);
        } catch (error) {
          console.error("Não foi possível interpretar os dados do gráfico", error);
          return;
        }

        if (typeof Plotly === "undefined") {
          console.warn("Plotly não está disponível para renderizar o gráfico", containerId);
          return;
        }

        const themedFigure = applyThemeToFigure(figure);
        const config = {
          responsive: true,
          displayModeBar: false,
        };

        Plotly.newPlot(container, themedFigure.data ?? [], themedFigure.layout ?? {}, config).then(() => {
          chartsRegistry.set(containerId, { container, baseFigure: cloneFigure(figure), config });
        });
      }

      function refreshChartsTheme() {
        chartsRegistry.forEach(({ container, baseFigure, config }) => {
          const themedFigure = applyThemeToFigure(baseFigure);
          Plotly.react(container, themedFigure.data ?? [], themedFigure.layout ?? {}, config ?? {});
        });
      }

      const themeObserver = new MutationObserver((mutations) => {
        if (mutations.some((mutation) => mutation.attributeName === "class")) {
          refreshChartsTheme();
        }
      });
      themeObserver.observe(document.documentElement, { attributes: true });
      window.addEventListener("storage", (event) => {
        if (event.key === "tema") {
          refreshChartsTheme();
        }
      });

      renderPlotlyChart("membros-chart", "membros-chart-data");
      renderPlotlyChart("eventos-nucleo-chart", "eventos-nucleo-chart-data");
    });
  </script>
{% endblock %}
