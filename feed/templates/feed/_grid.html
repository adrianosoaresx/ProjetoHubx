{% load static i18n lucide_icons %}
{% if request.user.user_type != 'root' %}
<section id="feed-grid" class="grid gap-6 grid-cols-1 sm:grid-cols-2 xl:grid-cols-3">
  {% for post in posts %}
    <article class="rounded-lg bg-white shadow p-6 space-y-4">
      <p class="text-xs text-neutral-500">
        {% if post.tipo_feed == 'nucleo' %}
          {% blocktrans with nome=post.nucleo.nome %}Feed do Núcleo: {{ nome }}{% endblocktrans %}
        {% elif post.tipo_feed == 'evento' %}
          {% blocktrans with titulo=post.evento.titulo %}Feed do Evento: {{ titulo }}{% endblocktrans %}
        {% elif post.tipo_feed == 'usuario' %}
          {% trans "Mural do Usuário" %}
        {% else %}
          {% trans "Feed Global" %}
        {% endif %}
      </p>
      <div class="flex items-center gap-4">
  <a href="{% url 'accounts:perfil_publico_uuid' post.autor.public_id %}">
          {% if post.autor.avatar %}
            <img src="{{ post.autor.avatar.url }}" alt="{{ post.autor.username }}" class="w-10 h-10 rounded-full object-cover">
          {% else %}
            <div class="w-10 h-10 rounded-full bg-neutral-200 flex items-center justify-center text-neutral-600 font-bold" role="img" aria-label="{{ post.autor.username }}">
              {{ post.autor.username|first|upper }}
            </div>
          {% endif %}
        </a>
        <div>
          <p class="text-sm font-medium text-neutral-800">{{ post.autor.get_full_name|default:post.autor.username }}</p>
          <p class="text-xs text-neutral-500">{{ post.created_at|date:"SHORT_DATETIME_FORMAT" }}</p>
        </div>
      </div>
      <div class="text-sm text-neutral-800 whitespace-pre-line">
        {{ post.conteudo|linebreaksbr }}
      </div>
      {% if post.pdf %}
        <div class="relative">
          <img src="{% static 'img/pdf-placeholder.png' %}" alt="{% trans 'PDF' %}" class="w-full rounded">
          <a href="{{ post.pdf.url }}" target="_blank" class="absolute top-2 left-2 bg-white/90 hover:bg-white shadow rounded p-1.5 text-sm">
            {% lucide 'eye' class='w-4 h-4' %}
          </a>
          <a href="{{ post.pdf.url }}" download class="absolute top-2 right-2 bg-white/90 hover:bg-white shadow rounded p-1.5 text-sm">
            {% lucide 'download' class='w-4 h-4' %}
          </a>
        </div>
      {% elif post.image %}
        <div>
          <img src="{{ post.image.url }}" class="w-full rounded" alt="{% trans 'mídia do post' %}">
        </div>
      {% elif post.video %}
        <div>
          {% if post.video_preview %}
            <video src="{{ post.video.url }}" poster="{{ post.video_preview.url }}" controls class="w-full rounded"></video>
          {% else %}
            <video src="{{ post.video.url }}" controls class="w-full rounded"></video>
          {% endif %}
        </div>
      {% endif %}
      <div class="flex items-center justify-between text-sm text-neutral-600">
        <div class="flex items-center gap-4">
          <div id="like-btn-{{ post.id }}">
            {% include 'feed/_like_button.html' with post=post %}
          </div>
            <button type="button" data-post-id="{{ post.id }}" class="share-btn inline-flex items-center gap-1 hover:text-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded {% if post.is_shared %}text-blue-600{% endif %}" aria-label="{% trans 'Compartilhar' %}">
            {% lucide 'share-2' class='w-4 h-4' %}
            <span class="share-count">{{ post.share_count }}</span>
          </button>

          <button type="button" data-post-id="{{ post.id }}" class="bookmark-btn hover:text-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 rounded {% if post.is_bookmarked %}text-yellow-600{% endif %}" aria-label="{% trans 'Salvar' %}">
            {% lucide 'bookmark' class='w-4 h-4' %}
          </button>
          <button type="button" data-post-id="{{ post.id }}" class="flag-btn hover:text-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 rounded {% if post.is_flagged %}text-red-600 cursor-not-allowed{% endif %}" aria-label="{% trans 'Denunciar' %}" {% if post.is_flagged %}disabled{% endif %}>
            {% lucide 'flag' class='w-4 h-4' %}

          </button>
        </div>
        <span>{{ post.comments.count }} {% trans 'comentários' %}</span>
      </div>
      </article>
  {% empty %}
    <p class="col-span-full text-center text-neutral-500">{% trans "Nenhuma postagem encontrada." %}</p>
  {% endfor %}
</section>
<script>
  const csrfToken = '{{ csrf_token }}';
  document.querySelectorAll('.bookmark-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const postId = btn.dataset.postId;
      const res = await fetch(`/api/feed/posts/${postId}/bookmark/`, {method: 'POST', headers: {'X-CSRFToken': csrfToken}});
      if (!res.ok) {
        alert('{% trans "Erro ao salvar" %}');
        return;
      }
      const data = await res.json();
      btn.classList.toggle('text-yellow-600', data.bookmarked);
    });
  });
  document.querySelectorAll('.flag-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const postId = btn.dataset.postId;
      const res = await fetch(`/api/feed/posts/${postId}/flag/`, {method: 'POST', headers: {'X-CSRFToken': csrfToken}});
      if (!res.ok) {
        alert('{% trans "Erro ao denunciar" %}');
        return;
      }
      btn.classList.add('text-red-600', 'cursor-not-allowed');
      btn.setAttribute('disabled', 'disabled');
    });
  });
</script>
{% endif %}
