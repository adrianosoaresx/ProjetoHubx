{% load static i18n lucide_icons %}
{# Exceção HTMX: parcial renderizado isoladamente durante atualizações dinâmicas #}
{% if request.user.user_type != 'root' %}

<section id="feed-grid" class="grid grid-cols-1 auto-rows-[1fr] gap-4 sm:gap-6 lg:grid-cols-2">
  {% for post in posts %}
  <article
    id="post-{{ post.id }}"
    class="card group relative flex h-full flex-col overflow-hidden border border-transparent bg-[var(--bg-secondary)] p-0 shadow-lg transition-all duration-300 hover:-translate-y-1 hover:border-[var(--accent)] hover:shadow-2xl"
    tabindex="-1"
  >
    <span aria-hidden="true" class="pointer-events-none absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-[var(--primary)] via-[var(--accent-light)] to-[var(--accent)] opacity-80 transition-opacity duration-300 group-hover:opacity-100"></span>
    <a href="{% url 'feed:post_detail' post.id %}" class="absolute inset-0 z-10" aria-label="{% trans 'Ver detalhes do post' %}">
      <span class="sr-only">{% trans "Ver detalhes do post" %}</span>
    </a>
    <div class="card-body flex h-full flex-col space-y-4 sm:space-y-6">
      <!-- Cabeçalho com tipo de postagem acima do avatar -->
      <header class="flex flex-col gap-2">
        {% with badge_classes="relative z-20 inline-flex max-w-full items-center gap-2 self-start rounded-full bg-[var(--primary-soft,rgba(59,130,246,0.15))] px-3 py-1 text-[0.6rem] font-semibold uppercase tracking-wide text-[var(--primary,#2563eb)] shadow-sm ring-1 ring-[var(--primary-soft-border,rgba(59,130,246,0.3))] whitespace-nowrap" icon_classes="h-3.5 w-3.5 shrink-0" %}
          {% if post.tipo_feed == 'nucleo' %}
            {% blocktrans with nome=post.nucleo.nome asvar badge_label %}Núcleo · {{ nome }}{% endblocktrans %}
            <span class="{{ badge_classes }}" style="--primary:#22c55e; --primary-soft:rgba(34,197,94,0.15); --primary-soft-border:rgba(34,197,94,0.3);">
              {% lucide 'users' class=icon_classes aria_hidden='true' %}
              <span class="truncate">{{ badge_label }}</span>
            </span>
          {% elif post.tipo_feed == 'evento' %}
            {% blocktrans with titulo=post.evento.titulo asvar badge_label %}Evento · {{ titulo }}{% endblocktrans %}
            <span class="{{ badge_classes }}" style="--primary:#0ea5e9; --primary-soft:rgba(14,165,233,0.15); --primary-soft-border:rgba(14,165,233,0.3);">
              {% lucide 'calendar-days' class=icon_classes aria_hidden='true' %}
              <span class="truncate">{{ badge_label }}</span>
            </span>
          {% elif post.tipo_feed == 'usuario' %}
            <span class="{{ badge_classes }}" style="--primary:#8b5cf6; --primary-soft:rgba(139,92,246,0.15); --primary-soft-border:rgba(139,92,246,0.3);">
              {% lucide 'user' class=icon_classes aria_hidden='true' %}
              <span class="truncate">{% trans "Mural" %}</span>
            </span>
          {% else %}
            <span class="{{ badge_classes }}" style="--primary:#f97316; --primary-soft:rgba(249,115,22,0.15); --primary-soft-border:rgba(249,115,22,0.3);">
              {# Ícone globe-2 não existe na versão lucide==1.1.3; substituído por globe #}
              {% lucide 'globe' class=icon_classes aria_hidden='true' %}
              <span class="truncate">{% trans "Público" %}</span>
            </span>
          {% endif %}
        {% endwith %}
        <div class="flex items-start justify-between gap-3 sm:gap-4">
          <div class="flex items-center gap-2 sm:gap-3">
            <a href="{% url 'accounts:perfil_publico_uuid' post.autor.public_id %}" class="relative z-20 flex-shrink-0">
              {% if post.autor.avatar %}
                <img src="{{ post.autor.avatar.url }}" alt="{{ post.autor.display_name|default:post.autor.username }}" class="h-12 w-12 rounded-full border-2 border-[var(--bg-primary)] object-cover shadow-md transition duration-300 group-hover:scale-105" loading="lazy">
              {% else %}
                <div class="flex h-12 w-12 items-center justify-center rounded-full border border-[var(--border)] bg-[var(--bg-tertiary)] text-lg font-semibold text-[var(--text-secondary)] shadow-inner" role="img" aria-label="{{ post.autor.display_name|default:post.autor.username }}">
                  {{ post.autor.username|first|upper }}
                </div>
              {% endif %}
            </a>
            <div class="min-w-0">
              <p class="truncate text-sm font-semibold text-[var(--text-primary)]">{{ post.autor.display_name }}</p>
              <time datetime="{{ post.created_at|date:'c' }}" class="mt-0.5 flex items-center gap-1 text-xs text-[var(--text-muted)]">
                {% lucide 'clock' class='h-3.5 w-3.5' %}
                {{ post.created_at|date:"SHORT_DATETIME_FORMAT" }}
              </time>
            </div>
          </div>
          {% if request.user == post.autor or request.user.user_type == 'admin' or request.user.user_type == 'root' %}
          <div class="post-actions-area relative z-30 mr-2 flex items-center gap-2 pt-1">
            {% with update_url=back_origin|default_if_none:'' %}
            <a href="{% url 'feed:post_update' post.id %}{% if update_url %}?back={{ update_url }}&focus={{ post.id }}{% endif %}"
               class="relative inline-flex items-center justify-center rounded-full p-2 text-[var(--text-muted)] transition hover:bg-[var(--bg-tertiary)] hover:text-[var(--accent)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)] focus:ring-offset-2 focus:ring-offset-[var(--bg-secondary)]"
               aria-label="{% trans 'Editar postagem' %}">
              {% lucide 'pencil' class='h-5 w-5' %}
            </a>
            {% endwith %}
            <a href="{% url 'feed:post_delete' post.id %}"
               hx-get="{% url 'feed:post_delete' post.id %}"
               hx-target="#modal"
               hx-trigger="click"
               hx-swap="innerHTML"
               hx-on="htmx:beforeRequest: window.HubxModalTrigger = this;"
               class="relative inline-flex items-center justify-center rounded-full p-2 text-[var(--error)] transition hover:bg-[var(--bg-tertiary)] focus:outline-none focus:ring-2 focus:ring-[var(--error)] focus:ring-offset-2 focus:ring-offset-[var(--bg-secondary)]"
               aria-label="{% trans 'Excluir postagem' %}">
              {% lucide 'trash-2' class='h-5 w-5' %}
            </a>
          </div>
          {% endif %}
        </div>
      </header>

      {% if post.conteudo %}
      <div class="relative z-20 rounded-2xl bg-[var(--bg-tertiary)] p-3 text-sm leading-relaxed text-[var(--text-primary)] break-words shadow-sm ring-1 ring-transparent transition duration-300 group-hover:ring-[var(--border)] sm:p-4"
           id="post-content-{{ post.id }}" data-post-content>
        {{ post.conteudo|linebreaksbr }}
      </div>
      {% with preview=post.link_preview %}
        <div class="space-y-2 {% if not preview %}hidden{% endif %}" data-link-preview data-link-preview-source="#post-content-{{ post.id }}"
             data-loading-text="{% trans 'Carregando pré-visualização do link…' %}"
             data-error-text="{% trans 'Não foi possível carregar os dados do link.' %}">
          <p class="text-xs text-[var(--text-secondary)]" data-link-preview-status></p>
          <a data-link-preview-card
             data-link-preview-url
             target="_blank"
             rel="noopener"
             href="{{ preview.url|default:'#' }}"
             class="flex gap-4 rounded-2xl border border-[var(--border-secondary)] bg-[var(--bg-tertiary)] p-3 shadow-sm {% if not preview %}hidden{% endif %}">
            <div class="h-24 w-24 flex-shrink-0 overflow-hidden rounded-xl bg-[var(--bg-secondary)] {% if not preview.image %}hidden{% endif %}" data-link-preview-image-wrapper>
              <img data-link-preview-image alt="{% trans 'Imagem de pré-visualização do link' %}" class="h-full w-full object-cover" loading="lazy"{% if preview.image %} src="{{ preview.image }}"{% endif %}>
            </div>
            <div class="flex-1 space-y-1 min-w-0">
              <span data-link-preview-title class="block truncate text-sm font-semibold text-[var(--text-primary)] hover:text-[var(--accent)]">
                {% if preview %}{{ preview.title|default:preview.url }}{% endif %}
              </span>
              <p data-link-preview-description class="text-xs text-[var(--text-secondary)] overflow-hidden"
                 style="display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;">{% if preview.description %}{{ preview.description }}{% endif %}</p>
              <p data-link-preview-host class="text-[10px] text-[var(--text-muted)] truncate">{% if preview.site_name %}{{ preview.site_name }}{% endif %}</p>
            </div>
          </a>
        </div>
      {% endwith %}
      {% endif %}

      {% if post.pdf %}
      <div class="relative z-20 overflow-hidden rounded-2xl border border-[var(--border)] bg-[var(--bg-tertiary)] shadow-sm transition duration-300 group-hover:border-[var(--accent)]">
        <a href="{{ post.pdf.url }}" target="_blank" rel="noopener" class="flex items-center justify-between gap-3 p-3 text-sm font-medium text-[var(--text-primary)] transition-colors hover:text-[var(--accent)] sm:gap-4 sm:p-4">
          <span class="flex items-center gap-3">
            <span class="flex h-12 w-12 items-center justify-center rounded-2xl bg-[var(--bg-secondary)] text-[var(--primary)]">
              {% lucide 'file-text' class='h-6 w-6' %}
            </span>
            <span class="truncate">{% trans "Documento em PDF" %}</span>
          </span>
          {% lucide 'external-link' class='h-5 w-5 flex-shrink-0 text-[var(--text-muted)]' %}
        </a>
      </div>
      {% elif post.image %}
      <figure class="relative z-20 mx-auto w-full max-w-2xl overflow-hidden rounded-2xl border border-[var(--border)] bg-[var(--bg-tertiary)] shadow-sm">
        <div class="relative flex max-h-[280px] w-full items-center justify-center overflow-hidden bg-[var(--bg-secondary)] sm:max-h-[320px] md:max-h-[360px] lg:max-h-[420px]">
          <img src="{{ post.image.url }}" class="h-auto w-full max-h-[280px] object-contain transition duration-500 ease-out group-hover:scale-[1.02] sm:max-h-[320px] md:max-h-[360px] lg:max-h-[420px]" alt="{% trans 'mídia do post' %}" loading="lazy">
        </div>
      </figure>
      {% elif post.video %}
      <figure class="relative z-20 mx-auto w-full max-w-2xl overflow-hidden rounded-2xl border border-[var(--border)] bg-black shadow-sm">
        <div class="feed-video-wrapper">
          <div class="feed-video-frame">
          {% if post.video_preview %}
          <video src="{{ post.video.url }}" poster="{{ post.video_preview.url }}" controls class="feed-video-player"></video>
          {% else %}
          <video src="{{ post.video.url }}" controls class="feed-video-player"></video>
          {% endif %}
          </div>
        </div>
      </figure>
      {% endif %}

      <!-- Rodapé: botões de ação e contagem de comentários abaixo -->
      <footer class="relative z-20 mt-auto">
        <div class="rounded-2xl border border-[var(--border)] bg-[var(--bg-tertiary)] px-3 py-2 text-sm text-[var(--text-secondary)] shadow-inner sm:px-4 sm:py-3">
          <div class="mt-2 flex items-center justify-between gap-2 text-xs font-semibold uppercase tracking-wide text-[var(--text-muted)] sm:gap-3">
            {% blocktrans trimmed count comment_count=post.comments.count asvar comment_text %}
              {{ comment_count }} comentário
            {% plural %}
              {{ comment_count }} comentários
            {% endblocktrans %}
            <div class="flex flex-shrink-0 items-center gap-2">
              {% lucide 'message-circle' class='h-4 w-4' %}
              <span class="sr-only">{{ comment_text }}</span>
              <span aria-hidden="true" class="hidden sm:inline">{{ comment_text }}</span>
              <span aria-hidden="true" class="sm:hidden">{{ post.comments.count }}</span>
            </div>
            <div class="flex flex-shrink-0 items-center gap-2 sm:gap-3">
              <div id="like-btn-{{ post.id }}" class="relative z-20">
                {% include 'feed/_like_button.html' with post=post %}
              </div>
              <button type="button" data-post-id="{{ post.id }}" class="share-btn btn btn-secondary {% if post.is_shared %}text-[var(--primary)]{% endif %} relative z-20 inline-flex items-center gap-1 rounded-full px-3 py-1.5 text-xs font-semibold transition" aria-label="{% trans 'Compartilhar' %}">
                {% lucide 'share-2' class='w-4 h-4' %}
                <span aria-hidden="true" class="share-count min-w-[1.5rem] text-center">{{ post.share_count }}</span>
                <span class="sr-only">
                  {% blocktrans trimmed count share_count=post.share_count %}
                    {{ share_count }} compartilhamento
                  {% plural %}
                    {{ share_count }} compartilhamentos
                  {% endblocktrans %}
                </span>
              </button>
              <button type="button" data-post-id="{{ post.id }}" class="bookmark-btn btn btn-secondary {% if post.is_bookmarked %}text-[var(--warning)]{% endif %} relative z-20 inline-flex items-center justify-center rounded-full p-2 transition" aria-label="{% trans 'Salvar' %}" aria-pressed="{% if post.is_bookmarked %}true{% else %}false{% endif %}">
                {% lucide 'bookmark' class='w-4 h-4' %}
              </button>
              <button type="button" data-post-id="{{ post.id }}" data-flag-error-message="{% trans 'Erro ao denunciar' %}" class="flag-btn btn btn-secondary {% if post.is_flagged %}text-[var(--error)] cursor-not-allowed disabled{% endif %} relative z-20 inline-flex items-center justify-center rounded-full p-2 transition" aria-label="{% trans 'Denunciar' %}" {% if post.is_flagged %}disabled aria-pressed="true"{% else %}aria-pressed="false"{% endif %}>
                {% lucide 'flag' class='w-4 h-4' %}
              </button>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </article>
  {% empty %}
    <p class="col-span-full text-center text-[var(--text-muted)]">{% trans "Nenhuma postagem encontrada." %}</p>
  {% endfor %}
</section>

{% endif %}
