{% extends 'base.html' %}
{% load static i18n lucide_icons widget_tweaks %}
{% block title %}{% trans "Editar Postagem" %} - Hubx{% endblock %}

{% block hero %}
  {% include '_components/hero_feed.html' with title=_('Editar Postagem') %}
{% endblock %}

{% block content %}
{% if request.user.user_type == 'root' %}
  <p class="text-center text-[var(--text-muted)]">{% trans "Usuário root não tem acesso ao feed." %}</p>
{% else %}

<article class="card">
  <div class="card-header">
    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex items-center gap-3">
        {% include '_components/back_button.html' with href=back_href fallback_href=back_component_config.fallback_href %}
        <div>
          <h1 class="text-xl font-semibold text-[var(--text-primary)]">{% trans "Editar Postagem" %}</h1>
          <p class="text-sm text-[var(--text-secondary)]">{% trans "Atualize sua postagem" %}</p>
        </div>
      </div>
    </div>
  </div>
  <div class="card-body space-y-6">
    <form method="post"
          enctype="multipart/form-data"
          hx-post="{% url 'feed:post_update' post.pk %}"
          hx-encoding="multipart/form-data"
          class="post-form space-y-6">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="rounded-xl border border-[var(--error)] bg-[var(--error-light)] p-3 text-sm text-[var(--error)]">
          <ul class="list-disc list-inside space-y-1">
            {% for error in form.non_field_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <div class="space-y-4">
        {% include '_forms/field.html' with field=form.tipo_feed %}
        {% include '_forms/field.html' with field=form.organizacao %}
        {% include '_forms/field.html' with field=form.nucleo %}
        {% include '_forms/field.html' with field=form.evento %}
      </div>

      {% with placeholder_value=_('O que você gostaria de compartilhar?') %}
        {% with placeholder_attr='placeholder:'|add:placeholder_value %}
          {% with conteudo_field=form.conteudo|attr:'rows:6'|attr:placeholder_attr %}
            <div class="space-y-2">
              {% include '_forms/field.html' with field=conteudo_field %}
              <span id="char-count" class="text-xs text-[var(--text-muted)]"></span>
            </div>
          {% endwith %}
        {% endwith %}
      {% endwith %}

      <div class="space-y-4">
        {% include '_forms/field.html' with field=form.tags|attr:'id:tags-select' %}
        {% include '_forms/field.html' with id='id_tags_text' name='tags_text' label=_('Novas tags') placeholder=_('Digite novas tags separadas por vírgula') value=request.POST.tags_text|default:'' help_text=_('Use vírgula para separar as tags adicionais.') %}
      </div>

      <div class="space-y-4">
        <div class="space-y-4">
          {% include '_forms/field.html' with field=form.image %}
          {% include '_forms/field.html' with field=form.pdf %}
          {% include '_forms/field.html' with field=form.video %}
        </div>
        {% if post.pdf %}
          <div class="space-y-2">
            <img src="{% static 'img/pdf-placeholder.png' %}" alt="{% trans 'PDF' %}" class="max-w-xs rounded-xl object-cover" loading="lazy">
            <div class="flex gap-3">
              <a href="{{ post.pdf.url }}" target="_blank" class="btn btn-secondary" aria-label="{% trans 'Visualizar PDF' %}">
                {% lucide 'eye' class='w-4 h-4' %}
              </a>
              <a href="{{ post.pdf.url }}" download class="btn btn-secondary" aria-label="{% trans 'Baixar PDF' %}">
                {% lucide 'download' class='w-4 h-4' %}
              </a>
            </div>
          </div>
        {% elif post.image %}
          <div class="space-y-2">
            <img src="{{ post.image.url }}" alt="{% trans 'mídia do post' %}" class="max-w-xs rounded-xl object-cover" loading="lazy">
          </div>
        {% elif post.video %}
          <div class="space-y-2">
            {% if post.video_preview %}
              <video src="{{ post.video.url }}" poster="{{ post.video_preview.url }}" controls class="max-w-full rounded-xl"></video>
            {% else %}
              <video src="{{ post.video.url }}" controls class="max-w-full rounded-xl"></video>
            {% endif %}
          </div>
        {% endif %}
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t border-[var(--border)]">
        {% include '_components/cancel_button.html' with config=cancel_component_config href=back_href fallback_href=cancel_component_config.fallback_href %}
        <button type="submit" class="btn btn-primary" aria-label="{% trans 'Salvar' %}">{% trans "Salvar" %}</button>
      </div>
    </form>
  </div>
</article>
<script src="{% static 'feed/js/feed.js' %}"></script>
{% endif %}
{% endblock %}
