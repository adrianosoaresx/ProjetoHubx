{% extends "base.html" %}
{% load static i18n widget_tweaks %}

{% block title %}{% trans "Nova Postagem" %} - Hubx{% endblock %}

{% block hero %}
  {% include '_components/hero_feed.html' with title=_('Nova Postagem') %}
{% endblock %}

{% block content %}
<section class="max-w-2xl mx-auto px-4 py-10">
  {% if request.user.user_type == 'root' %}
    <p class="text-center text-[var(--text-muted)]">{% trans "Usuário root não tem acesso ao feed." %}</p>
  {% else %}

  {% with selected=selected_tipo_feed|default:"global" %}
  <!-- Cabeçalho -->
  <div class="mb-6">
    <p class="text-sm text-[var(--text-secondary)] text-center">{% trans "Compartilhe algo com sua comunidade" %}</p>
  </div>

  <!-- Container para HTMX swaps -->
  <div id="nova-postagem-form">
    <form method="post"
          action="{% url 'feed:nova_postagem' %}"
          hx-post="{% url 'feed:nova_postagem' %}"
          hx-target="#nova-postagem-form"
          hx-swap="outerHTML"
          hx-encoding="multipart/form-data"
          enctype="multipart/form-data"
          class="post-form card">
      <div class="card-body space-y-6">
      {% csrf_token %}

      {% if form.errors %}
        <div class="rounded-xl border border-[var(--error)] bg-[var(--error-light)] text-[var(--error)] text-sm p-3">
          <ul class="list-disc list-inside space-y-1">
            {% for field in form %}
              {% for error in field.errors %}
                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
              {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <!-- Visibilidade / Destino -->
      <div>
        <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">{% trans "Destino" %} <span class="text-red-600">*</span></label>
        <div class="flex flex-wrap gap-4 text-sm">
          <label class="inline-flex items-center gap-2">
            <input type="radio" name="tipo_feed" value="global" class="accent-blue-600" {% if selected == 'global' %}checked{% endif %} />
            <span>{% trans "Público (feed global)" %}</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="radio" name="tipo_feed" value="usuario" class="accent-blue-600" {% if selected == 'usuario' %}checked{% endif %} />
            <span>{% trans "Privado (seu mural)" %}</span>
          </label>
          <!-- Radio oculto para 'nucleo' (marcado quando um núcleo for escolhido) -->
          <input type="radio" name="tipo_feed" value="nucleo" id="tipo_feed_nucleo_hidden" class="hidden" {% if selected == 'nucleo' %}checked{% endif %} />
        </div>
        {% if form.tipo_feed.errors %}
          <p class="text-red-500 text-xs mt-1">{{ form.tipo_feed.errors|striptags }}</p>
        {% endif %}

        <!-- Núcleos do usuário como opções -->
        <div id="nucleos-opcoes" class="mt-3">
          {% if nucleos_do_usuario %}
            <div class="flex flex-wrap gap-3">
              {% for n in nucleos_do_usuario %}
                <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-[var(--border)] hover:bg-[var(--bg-tertiary)] cursor-pointer">
                  <input type="radio" name="nucleo" value="{{ n.id }}" class="accent-blue-600"
                         {% if selected_nucleo|stringformat:'s' == n.id|stringformat:'s' %}checked{% endif %} />
                  <span class="text-sm text-[var(--text-primary)]">{{ n.nome }}</span>
                </label>
              {% endfor %}
            </div>
            <p class="text-xs text-[var(--text-muted)] mt-1">{% trans "Selecione um núcleo para publicar lá." %}</p>
          {% else %}
            <p class="text-xs text-[var(--text-muted)] mt-1">{% trans "Você não participa de nenhum núcleo." %}</p>
          {% endif %}
          {% if form.nucleo.errors %}
            <p class="text-red-500 text-xs mt-1">{{ form.nucleo.errors|striptags }}</p>
          {% endif %}
        </div>
      </div>

      <!-- Conteúdo -->
      <div>
        <label for="{{ form.conteudo.id_for_label }}" class="block text-sm font-medium text-[var(--text-secondary)]">
          {{ form.conteudo.label }} <span class="text-red-600">*</span>
        </label>
        <textarea
          id="{{ form.conteudo.id_for_label }}"
          name="{{ form.conteudo.name }}"
          class="mt-1 block w-full rounded-xl border border-[var(--border)] card-sm focus:ring-primary-500 focus:border-primary-500 text-sm"
          placeholder="{% trans 'O que você gostaria de compartilhar?' %}"
          rows="6"
        >{{ form.conteudo.value|default_if_none:"" }}</textarea>
        <div class="mt-1">
          <span id="char-count" class="text-xs text-[var(--text-muted)]"></span>
        </div>
        {% if form.conteudo.errors %}
          <p class="text-red-500 text-xs mt-1">{{ form.conteudo.errors }}</p>
        {% endif %}
        <p class="text-sm text-[var(--text-muted)] mt-1">{% trans "Compartilhe ideias, atualizações ou conteúdos com sua rede." %}</p>
      </div>

      {% if request.user.organizacao %}
        <input type="hidden" name="organizacao" value="{{ request.user.organizacao.id }}">
      {% endif %}

      <!-- Tags (chips) -->
      <div class="mb-4">
        <label class="font-semibold mb-1 block">{% trans "Tags" %}</label>
        <input type="hidden" id="id_tags_text" name="tags_text" value="{{ request.POST.tags_text|default:'' }}" />
        <div id="tags-chips" class="flex flex-wrap gap-2 mb-2"></div>
        <div class="flex items-center gap-2">
          <input
            type="text"
            id="tags-input"
            class="flex-1 mt-1 block rounded-xl border border-[var(--border)] card-sm focus:ring-primary-500 focus:border-primary-500 text-sm px-3 py-2"
            placeholder="{% trans 'Digite e pressione Enter ou vírgula para adicionar' %}"
            autocomplete="off"
          />
        </div>
      </div>

      <!-- Arquivo -->
      <div>
        <label for="id_file" class="block text-sm font-medium text-[var(--text-secondary)]">{% trans "Arquivo (imagem, vídeo ou PDF)" %}</label>
        <input type="file" id="id_file" name="arquivo" accept="image/*,video/*,.pdf"
               class="mt-2 block w-full text-sm text-[var(--text-secondary)] file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-[var(--bg-tertiary)] file:text-[var(--text-secondary)] hover:file:bg-[var(--bg-tertiary)]">
        <span class="file-text">{% trans "Nenhum arquivo selecionado" %}</span>
        {% if form.image.errors or form.pdf.errors or form.video.errors %}
          <p class="text-red-500 text-xs mt-1">
            {{ form.image.errors }} {{ form.pdf.errors }} {{ form.video.errors }}
          </p>
        {% endif %}
      </div>

      <!-- Legenda de obrigatoriedade -->
      <div class="mt-2 text-xs text-[var(--text-secondary)]">{% trans "Campos marcados com * são obrigatórios. Informe conteúdo ou anexe um arquivo." %}</div>

      <!-- Ações -->
      <div class="flex justify-end gap-3 mt-6">
        {% url 'feed:listar' as feed_list_url %}
        {% include '_components/back_button.html' with href=feed_list_url label=_('Cancelar') aria_label=_('Cancelar') %}
        <button type="submit" class="btn btn-primary" aria-label="{% trans 'Salvar' %}">
          {% trans "Salvar" %}
        </button>
      </div>
      </div>
    </form>
  </div>
  {% endwith %}

  <script src="{% static 'feed/js/feed.js' %}"></script>
  {% endif %}
</section>
{% endblock %}
