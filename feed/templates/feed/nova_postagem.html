{% extends "base.html" %}
{% load static i18n widget_tweaks %}

{% block title %}{% trans "Nova Postagem" %} - Hubx{% endblock %}

{% block hero %}
  {% include '_components/hero_feed.html' with title=_('Nova Postagem') %}
{% endblock %}

{% block content %}

  {% if request.user.user_type == 'root' %}
    <p class="text-center text-[var(--text-muted)]">{% trans "Usuário root não tem acesso ao feed." %}</p>
  {% else %}

  <article class="card">
    <div class="card-header">
      <div class="flex flex-col gap-1 text-center">
        <h1 class="text-xl font-semibold text-[var(--text-primary)]">{% trans "Nova Postagem" %}</h1>
        <p class="text-sm text-[var(--text-secondary)]">{% trans "Compartilhe algo com sua comunidade" %}</p>
      </div>
    </div>
    <div class="card-body space-y-6">
      <div id="nova-postagem-form">
        <form method="post"
              action="{% url 'feed:nova_postagem' %}"
              hx-post="{% url 'feed:nova_postagem' %}"
              hx-target="#nova-postagem-form"
              hx-swap="outerHTML"
              hx-encoding="multipart/form-data"
              enctype="multipart/form-data"
              class="post-form space-y-6">
          {% csrf_token %}

          {% if form.non_field_errors %}
            <div class="rounded-xl border border-[var(--error)] bg-[var(--error-light)] p-3 text-sm text-[var(--error)]">
              <ul class="list-disc list-inside space-y-1">
                {% for error in form.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          <div class="space-y-4">
            <div class="space-y-2">
              <span class="block text-sm font-medium text-[var(--text-primary)]">
                {% trans "Tipo de feed" %} *
              </span>
              <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                <label for="tipo_feed_global" class="flex items-center gap-2 rounded-xl border border-[var(--border-secondary)] bg-[var(--bg-secondary)] px-4 py-3 text-sm text-[var(--text-primary)]">
                  <input type="checkbox"
                         id="tipo_feed_global"
                         name="tipo_feed"
                         value="global"
                         class="form-checkbox"
                         data-exclusive="tipo-feed"
                         {% if selected_tipo_feed|default:'global' == 'global' %}checked{% endif %}>
                  <span>{% trans "Feed Público" %}</span>
                </label>
                <label for="tipo_feed_usuario" class="flex items-center gap-2 rounded-xl border border-[var(--border-secondary)] bg-[var(--bg-secondary)] px-4 py-3 text-sm text-[var(--text-primary)]">
                  <input type="checkbox"
                         id="tipo_feed_usuario"
                         name="tipo_feed"
                         value="usuario"
                         class="form-checkbox"
                         data-exclusive="tipo-feed"
                         {% if selected_tipo_feed == 'usuario' %}checked{% endif %}>
                  <span>{% trans "Mural" %}</span>
                </label>
              </div>
              {% if form.tipo_feed.errors %}
                <ul class="errorlist">
                  {% for error in form.tipo_feed.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
          </div>

          {% with placeholder_value=_('O que você gostaria de compartilhar?') %}
            {% with placeholder_attr='placeholder:'|add:placeholder_value %}
              {% with conteudo_field=form.conteudo|attr:'rows:6'|attr:placeholder_attr %}
                <div class="space-y-2">
                  {% include '_forms/field.html' with field=conteudo_field %}
                  <span id="char-count" class="text-xs text-[var(--text-muted)]"></span>
                  <p class="text-xs text-[var(--text-secondary)]">{% trans "Compartilhe ideias, atualizações ou conteúdos com sua rede." %}</p>
                </div>
              {% endwith %}
            {% endwith %}
          {% endwith %}

          {% if request.user.organizacao %}
            <input type="hidden" name="organizacao" value="{{ request.user.organizacao.id }}">
          {% endif %}

          <div class="space-y-2">
            <label for="tags-input" class="block text-sm font-medium text-[var(--text-primary)]">
              {% trans "Tags" %}
            </label>
            <div id="tags-chips" class="flex flex-wrap gap-2"></div>
            <input id="tags-input"
                   type="text"
                   class="form-input w-full"
                   placeholder="{% trans 'Digite e pressione Enter para adicionar' %}">
            <input type="hidden"
                   id="id_tags_text"
                   name="tags_text"
                   value="{{ request.POST.tags_text|default:'' }}">
            <p class="text-xs text-[var(--text-secondary)]">{% trans "Use Enter ou vírgula para separar as tags." %}</p>
          </div>

          <div class="space-y-4">
            {% include '_forms/field.html' with field=form.image %}
            {% include '_forms/field.html' with field=form.pdf %}
            {% include '_forms/field.html' with field=form.video %}
          </div>

          <p class="text-xs text-[var(--text-secondary)]">{% trans "Campos marcados com * são obrigatórios. Informe conteúdo ou anexe um arquivo." %}</p>

          <div class="flex justify-end pt-4 border-t border-[var(--border)]">
            <button type="submit" class="btn btn-primary" aria-label="{% trans 'Salvar' %}">
              {% trans "Salvar" %}
            </button>
          </div>
        </form>
      </div>
    </div>
  </article>

  <script src="{% static 'feed/js/feed.js' %}"></script>
  {% endif %}

{% endblock %}
