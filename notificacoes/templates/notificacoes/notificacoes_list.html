{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans 'Notificações pendentes' %} | HubX{% endblock %}

{% block hero %}
  {% include '_components/hero_notificacoes.html' with title=_('Notificações push pendentes') subtitle=_('Revise envios já realizados e marque como lidos para organizar sua central.') helper_text=_('Exibindo apenas notificações enviadas via Push que aguardam leitura.') %}
{% endblock %}

{% block content %}
  <div class="max-w-6xl mx-auto px-4 py-10">
    <article class="card">
      <header class="card-header space-y-1">
        <h2 class="text-xl font-semibold text-[var(--text-primary)]">{% trans 'Notificações push enviadas' %}</h2>
        <p class="text-sm text-[var(--text-secondary)]">{% trans 'Logs filtrados por canal Push e status Enviada.' %}</p>
      </header>
      <div class="card-body space-y-4">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-[var(--border)] text-sm" aria-describedby="pending-notifications-description">
            <caption class="sr-only">{% trans 'Notificações push pendentes de leitura' %}</caption>
            <thead class="bg-[var(--bg-tertiary)]">
              <tr>
                <th scope="col" class="px-4 py-2 text-left font-medium text-[var(--text-secondary)]">{% trans 'Assunto' %}</th>
                <th scope="col" class="px-4 py-2 text-left font-medium text-[var(--text-secondary)]">{% trans 'Mensagem' %}</th>
                <th scope="col" class="px-4 py-2 text-left font-medium text-[var(--text-secondary)]">{% trans 'Enviada em' %}</th>
                <th scope="col" class="px-4 py-2 text-left font-medium text-[var(--text-secondary)]">{% trans 'Ações' %}</th>
              </tr>
            </thead>
            <tbody id="pending-push-logs-body" class="divide-y divide-[var(--border)]">
              {% with push_logs=push_logs %}
                {% for log in push_logs %}
                  {% if log.canal == 'push' and log.status == 'enviada' %}
                    <tr id="notification-log-{{ log.id }}" data-log-row>
                      <td class="px-4 py-3 align-top font-medium text-[var(--text-primary)]">{{ log.template.assunto }}</td>
                      <td class="px-4 py-3 align-top text-[var(--text-secondary)] prose prose-sm max-w-none">{{ log.corpo_renderizado|safe }}</td>
                      <td class="px-4 py-3 align-top whitespace-nowrap text-[var(--text-secondary)]">{{ log.data_envio|date:"SHORT_DATETIME_FORMAT" }}</td>
                      <td class="px-4 py-3 align-top">
                        <button
                          type="button"
                          class="btn btn-primary btn-sm"
                          hx-ext="json-enc"
                          hx-patch="/api/notificacoes/logs/{{ log.id }}/"
                          hx-vals='{"status": "lida"}'
                          hx-headers='{"X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/json"}'
                          hx-on::after-request="if(event.detail.xhr.status===204){const row=this.closest('tr');const tbody=row?.closest('tbody');row?.remove();const emptyRow=document.getElementById('empty-push-logs-row');if(tbody&&!tbody.querySelector('[data-log-row]')){emptyRow?.classList.remove('hidden');}}"
                        >
                          {% trans 'Marcar como lida' %}
                        </button>
                      </td>
                    </tr>
                  {% endif %}
                {% endfor %}
                <tr id="empty-push-logs-row" class="{% if push_logs %}hidden{% endif %}">
                  <td colspan="4" class="px-4 py-6 text-center text-[var(--text-secondary)]">{% trans 'Nenhuma notificação push enviada foi encontrada.' %}</td>
                </tr>
              {% endwith %}
            </tbody>
          </table>
        </div>
        <script>
          (() => {
            const tbody = document.getElementById('pending-push-logs-body');
            const emptyRow = document.getElementById('empty-push-logs-row');
            const hasVisibleRows = tbody?.querySelector('[data-log-row]');

            if (emptyRow) {
              emptyRow.classList.toggle('hidden', Boolean(hasVisibleRows));
            }
          })();
        </script>
        <p id="pending-notifications-description" class="sr-only">{% trans 'A tabela apresenta notificações enviadas via Push aguardando confirmação de leitura.' %}</p>
      </div>
    </article>
  </div>
{% endblock %}
