{% load i18n lucide_icons %}
<article class="card">
  <div class="card-header flex items-center justify-between gap-3">
    <h2 class="text-base font-semibold text-[var(--text-primary)]">{% trans "Buscar pessoas" %}</h2>
    {% url 'conexoes:perfil_sections_conexoes' as conexoes_partial_url %}
    {% url 'accounts:perfil' as perfil_url %}
    {% with partial_query='?view=buscar' full_query='?section=conexoes&view=buscar' %}
      {% if q %}
        {% with encoded_q=q|urlencode %}
          {% with partial_query=partial_query|add:'&q='|add:encoded_q full_query=full_query|add:'&q='|add:encoded_q %}    

          {% endwith %}
        {% endwith %}
      
        
      {% endif %}
    {% endwith %}
  </div>

  <div class="card-body space-y-6">
    <form
      method="get"
      class="space-y-4 sm:flex sm:items-end sm:gap-3"
      hx-get="{% url 'conexoes:perfil_conexoes_buscar' %}"
      hx-target="#perfil-content"
      hx-push-url="?section=conexoes&view=buscar"
    >
      <div class="sm:flex-1">
        {% include '_forms/field.html' with field=form.q %}
      </div>
      <button type="submit" class="btn btn-primary btn-sm" aria-label="{% trans 'Buscar' %}">
        {% lucide 'search' class='w-4 h-4' aria_hidden='true' %}
      </button>
    </form>

    {% if tem_organizacao %}
      {% if associados %}
        <div role="list" class="space-y-3">
          {% for associado in associados %}
            <article
              role="listitem"
              id="connection-{{ associado.id }}"
              data-connection-card
              class="card"
            >
              <div class="card-body space-y-4">
                <div class="flex items-center gap-3">
                  {% if associado.avatar %}
                    <img src="{{ associado.avatar.url }}" alt="{{ associado.display_name|default:associado.username }}" class="h-12 w-12 rounded-full object-cover" loading="lazy" />
                  {% else %}
                    <div class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--bg-tertiary)] text-sm font-semibold text-[var(--text-secondary)]" role="img" aria-label="{{ associado.display_name|default:associado.username }}">
                      {{ associado.username|first|upper }}
                    </div>
                  {% endif %}
                  <div class="min-w-0 space-y-1">
                    <p class="truncate font-semibold text-[var(--text-primary)]">{{ associado.display_name }}</p>
                    <p class="text-sm text-[var(--text-secondary)]">@{{ associado.username }}</p>
                    {% if associado.razao_social %}
                      <p class="text-xs text-[var(--text-secondary)]">{{ associado.razao_social }}</p>
                    {% endif %}
                    {% if associado.cnpj %}
                      <p class="text-xs text-[var(--text-tertiary)]">CNPJ: {{ associado.cnpj }}</p>
                    {% endif %}
                  </div>
                </div>
                <div class="flex flex-wrap justify-end gap-3 pt-4 border-t border-[var(--border)]">
                  <a
                    href="{% url 'accounts:perfil_publico_uuid' associado.public_id %}"
                    class="btn btn-secondary btn-sm"
                    data-connection-link="connection-{{ associado.id }}"
                  >
                    {% trans "Ver perfil" %}
                  </a>

                  {% if associado.id in conexoes_ids %}
                  <form
                      hx-post="{% url 'conexoes:remover_conexao' associado.id %}"
                      hx-target="#perfil-content"
                      hx-swap="innerHTML"
                      class="space-y-4"
                    >
                      {% csrf_token %}
                      <input type="hidden" name="q" value="{{ q }}" />
                      <button type="submit" class="btn btn-danger btn-sm">
                        {% trans "Desconectar" %}
                      </button>
                    </form>
                  {% elif associado.id in solicitacoes_enviadas_ids %}
                    <button type="button" class="btn btn-secondary btn-sm cursor-default opacity-70" disabled>
                      {% trans "Solicitação enviada" %}
                    </button>
                  {% elif associado.id in solicitacoes_recebidas_ids %}
                    <a
                      href="{% url 'conexoes:perfil_sections_conexoes' %}?tab=solicitacoes"
                      class="btn btn-secondary btn-sm"
                    >
                      {% trans "Responder solicitação" %}
                    </a>
                  {% else %}
                    <form
                      hx-post="{% url 'conexoes:solicitar_conexao' associado.id %}"
                      hx-target="#perfil-content"
                      hx-swap="innerHTML"
                      class="space-y-4"
                    >
                      {% csrf_token %}
                      <input type="hidden" name="q" value="{{ q }}" />
                      <button type="submit" class="btn btn-primary btn-sm">
                        {% trans "Conectar" %}
                      </button>
                    </form>
                  {% endif %}
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-sm text-[var(--text-secondary)]">{% trans "Nenhum associado encontrado para os critérios informados." %}</p>
      {% endif %}
    {% else %}
      <p class="text-sm text-[var(--text-secondary)]">{% trans "Você não está vinculado a uma organização no momento." %}</p>
    {% endif %}
  </div>
</article>
