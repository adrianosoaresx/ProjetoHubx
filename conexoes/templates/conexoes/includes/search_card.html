{% load i18n lucide_icons %}
<article class="card" {% if search_container_id %}id="{{ search_container_id }}"{% endif %}>
  <div class="card-header flex items-center justify-between gap-3">
    <h2 class="text-base font-semibold text-[var(--text-primary)]">{% trans "Buscar pessoas" %}</h2>
    {% if back_to_dashboard_url %}
      <a
        href="{{ back_to_dashboard_url }}"
        class="btn btn-secondary btn-sm"
        {% if back_to_dashboard_hx_get %}hx-get="{{ back_to_dashboard_hx_get }}"{% endif %}
        {% if back_to_dashboard_hx_target %}hx-target="#{{ back_to_dashboard_hx_target }}"{% endif %}
        {% if back_to_dashboard_hx_push_url %}hx-push-url="{{ back_to_dashboard_hx_push_url }}"{% endif %}
      >
        {% trans "Minhas conexões" %}
      </a>
    {% endif %}
  </div>

  <div class="card-body space-y-6">
    <form
      method="get"
      {% if search_form_action %}action="{{ search_form_action }}"{% endif %}
      class="space-y-4 sm:flex sm:items-end sm:gap-3"
      {% if search_form_hx_get %}hx-get="{{ search_form_hx_get }}"{% endif %}
      {% if search_form_hx_target %}hx-target="#{{ search_form_hx_target }}"{% endif %}
      {% if search_form_hx_push_url %}hx-push-url="{{ search_form_hx_push_url }}"{% endif %}
    >
      <div class="sm:flex-1">
        {% include '_forms/field.html' with field=form.q %}
      </div>
      <button type="submit" class="btn btn-primary btn-sm" aria-label="{% trans 'Buscar' %}">
        {% lucide 'search' class='w-4 h-4' aria_hidden='true' %}
      </button>
    </form>

    {% if tem_organizacao %}
      {% if associados %}
        <div role="list" class="space-y-3">
          {% for associado in associados %}
            <article
              role="listitem"
              id="connection-{{ associado.id }}"
              data-connection-card
              class="card"
            >
              <div class="card-body space-y-4">
                <div class="flex items-center gap-3">
                  {% if associado.avatar %}
                    <img src="{{ associado.avatar.url }}" alt="{{ associado.display_name|default:associado.username }}" class="h-12 w-12 rounded-full object-cover" loading="lazy" />
                  {% else %}
                    <div class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--bg-tertiary)] text-sm font-semibold text-[var(--text-secondary)]" role="img" aria-label="{{ associado.display_name|default:associado.username }}">
                      {{ associado.username|first|upper }}
                    </div>
                  {% endif %}
                  <div class="min-w-0 space-y-1">
                    <p class="truncate font-semibold text-[var(--text-primary)]">{{ associado.display_name }}</p>
                    <p class="text-sm text-[var(--text-secondary)]">@{{ associado.username }}</p>
                    {% if associado.razao_social %}
                      <p class="text-xs text-[var(--text-secondary)]">{{ associado.razao_social }}</p>
                    {% endif %}
                    {% if associado.cnpj %}
                      <p class="text-xs text-[var(--text-tertiary)]">CNPJ: {{ associado.cnpj }}</p>
                    {% endif %}
                  </div>
                </div>
                <div class="flex flex-wrap justify-end gap-3 pt-4 border-t border-[var(--border)]">
                  <a
                    href="{% url 'accounts:perfil_publico_uuid' associado.public_id %}"
                    class="btn btn-secondary btn-sm"
                    data-connection-link="connection-{{ associado.id }}"
                  >
                    {% trans "Ver perfil" %}
                  </a>

                  {% if associado.id in conexoes_ids %}
                    <form
                      method="post"
                      action="{% url 'conexoes:remover_conexao' associado.id %}"
                      {% if search_form_hx_target %}
                        hx-post="{% url 'conexoes:remover_conexao' associado.id %}"
                        hx-target="#{{ search_form_hx_target }}"
                        hx-swap="innerHTML"
                      {% endif %}
                      class="space-y-4"
                    >
                      {% csrf_token %}
                      {% if form.q.value %}
                        <input type="hidden" name="q" value="{{ form.q.value }}" />
                      {% endif %}
                      <button type="submit" class="btn btn-danger btn-sm">
                        {% trans "Desconectar" %}
                      </button>
                    </form>
                  {% elif associado.id in solicitacoes_enviadas_ids %}
                    <button type="button" class="btn btn-secondary btn-sm cursor-default opacity-70" disabled>
                      {% trans "Solicitação enviada" %}
                    </button>
                  {% elif associado.id in solicitacoes_recebidas_ids %}
                    <a
                      href="{{ solicitacoes_url }}"
                      class="btn btn-secondary btn-sm"
                      {% if solicitacoes_hx_get %}hx-get="{{ solicitacoes_hx_get }}"{% endif %}
                      {% if solicitacoes_hx_target %}hx-target="#{{ solicitacoes_hx_target }}"{% endif %}
                      {% if solicitacoes_hx_push_url %}hx-push-url="{{ solicitacoes_hx_push_url }}"{% endif %}
                    >
                      {% trans "Responder solicitação" %}
                    </a>
                  {% else %}
                    <form
                      method="post"
                      action="{% url 'conexoes:solicitar_conexao' associado.id %}"
                      {% if search_form_hx_target %}
                        hx-post="{% url 'conexoes:solicitar_conexao' associado.id %}"
                        hx-target="#{{ search_form_hx_target }}"
                        hx-swap="innerHTML"
                      {% endif %}
                      class="space-y-4"
                    >
                      {% csrf_token %}
                      {% if form.q.value %}
                        <input type="hidden" name="q" value="{{ form.q.value }}" />
                      {% endif %}
                      <button type="submit" class="btn btn-primary btn-sm">
                        {% trans "Conectar" %}
                      </button>
                    </form>
                  {% endif %}
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-sm text-[var(--text-secondary)]">{% trans "Nenhum associado encontrado para os critérios informados." %}</p>
      {% endif %}
    {% else %}
      <p class="text-sm text-[var(--text-secondary)]">{% trans "Você não está vinculado a uma organização no momento." %}</p>
    {% endif %}
  </div>
</article>
