{% load i18n lucide_icons %}
<article class="card" {% if search_container_id %}id="{{ search_container_id }}"{% endif %}>
  <div class="card-header flex items-center justify-between gap-3">
    <h2 class="text-base font-semibold text-[var(--text-primary)]">{% trans "Adicionar conexão" %}</h2>
    {% if back_to_dashboard_url %}
      <a
        href="{{ back_to_dashboard_url }}"
        class="btn btn-secondary btn-sm"
        {% if back_to_dashboard_hx_get %}hx-get="{{ back_to_dashboard_hx_get }}"{% endif %}
        {% if back_to_dashboard_hx_target %}hx-target="#{{ back_to_dashboard_hx_target }}"{% endif %}
        {% if back_to_dashboard_hx_push_url %}hx-push-url="{{ back_to_dashboard_hx_push_url }}"{% endif %}
      >
        {% trans "Voltar para conexões" %}
      </a>
    {% endif %}
  </div>

  <div class="card-body space-y-6">
    <form
      method="get"
      {% if search_form_action %}action="{{ search_form_action }}"{% endif %}
      class="space-y-4 sm:flex sm:items-end sm:gap-3"
      {% if search_form_hx_get %}hx-get="{{ search_form_hx_get }}"{% endif %}
      {% if search_form_hx_target %}hx-target="#{{ search_form_hx_target }}"{% endif %}
      {% if search_form_hx_push_url %}hx-push-url="{{ search_form_hx_push_url }}"{% endif %}
    >
      <div class="sm:flex-1">
        {% include '_forms/field.html' with field=form.q %}
      </div>
      <button type="submit" class="btn btn-primary btn-sm" aria-label="{% trans 'Buscar' %}">
        {% lucide 'search' class='w-4 h-4' aria_hidden='true' %}
      </button>
    </form>

    {% if tem_organizacao %}
      {% if membros %}
        <div
          role="list"
          class="grid gap-4 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4"
        >
          {% for membro in membros %}
            <article
              role="listitem"
              id="connection-{{ membro.id }}"
              data-connection-card
              class="card h-full transition-shadow duration-200 hover:shadow-lg focus-within:shadow-lg"
            >
              <div class="card-body flex h-full flex-col gap-4">
                <div class="flex items-center gap-3">
                  {% if membro.avatar %}
                    <img src="{{ membro.avatar.url }}" alt="{{ membro.display_name|default:membro.username }}" class="h-12 w-12 rounded-full object-cover" loading="lazy" />
                  {% else %}
                    <div class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--bg-tertiary)] text-sm font-semibold text-[var(--text-secondary)]" role="img" aria-label="{{ membro.display_name|default:membro.username }}">
                      {{ membro.username|first|upper }}
                    </div>
                  {% endif %}
                  <div class="min-w-0 space-y-1">
                    <p class="truncate text-sm font-semibold text-[var(--text-primary)]">{{ membro.display_name }}</p>
                    <p class="text-xs text-[var(--text-secondary)]">@{{ membro.username }}</p>
                    {% if membro.nome_fantasia %}
                      <p class="truncate text-xs text-[var(--text-secondary)]">{{ membro.nome_fantasia }}</p>
                    {% endif %}
                  </div>
                </div>
                <div class="mt-auto grid gap-2 border-t border-[var(--border)] pt-3">
                  <a
                    href="{% url 'accounts:perfil_publico_uuid' membro.public_id %}"
                    class="btn btn-secondary btn-sm w-full justify-center"
                    data-connection-link="connection-{{ membro.id }}"
                  >
                    {% trans "Ver perfil" %}
                  </a>

                  {% if membro.id in conexoes_ids %}
                    {% with membro_id=membro.id|stringformat:'s' %}
                      {% with card_id='connection-'|add:membro_id %}
                        {% if search_form_hx_target %}
                          {% with query_value=form.q.value %}
                            <button
                              type="button"
                              class="btn btn-danger btn-sm w-full justify-center"
                              hx-get="{% url 'conexoes:remover_conexao_modal' membro.id %}?target_id={{ search_form_hx_target }}&swap=innerHTML{% if query_value %}&q={{ query_value|urlencode }}{% endif %}"
                              hx-target="#modal"
                              hx-swap="innerHTML"
                              hx-on="htmx:beforeRequest: window.HubxModalTrigger = this;"
                            >
                              {% trans "Desconectar" %}
                            </button>
                          {% endwith %}
                        {% else %}
                          {% with query_value=form.q.value %}
                            <button
                              type="button"
                              class="btn btn-danger btn-sm w-full justify-center"
                              hx-get="{% url 'conexoes:remover_conexao_modal' membro.id %}?target_id={{ card_id }}&swap=outerHTML&remove_target={{ card_id }}{% if query_value %}&q={{ query_value|urlencode }}{% endif %}"
                              hx-target="#modal"
                              hx-swap="innerHTML"
                              hx-on="htmx:beforeRequest: window.HubxModalTrigger = this;"
                            >
                              {% trans "Desconectar" %}
                            </button>
                          {% endwith %}
                        {% endif %}
                      {% endwith %}
                    {% endwith %}
                  {% elif membro.id in solicitacoes_enviadas_ids %}
                    <button type="button" class="btn btn-secondary btn-sm w-full cursor-default justify-center opacity-70" disabled>
                      {% trans "Solicitação enviada" %}
                    </button>
                  {% elif membro.id in solicitacoes_recebidas_ids %}
                    <a
                      href="{{ solicitacoes_url }}"
                      class="btn btn-secondary btn-sm w-full justify-center"
                      {% if solicitacoes_hx_get %}hx-get="{{ solicitacoes_hx_get }}"{% endif %}
                      {% if solicitacoes_hx_target %}hx-target="#{{ solicitacoes_hx_target }}"{% endif %}
                      {% if solicitacoes_hx_push_url %}hx-push-url="{{ solicitacoes_hx_push_url }}"{% endif %}
                    >
                      {% trans "Responder solicitação" %}
                    </a>
                  {% else %}
                    <form
                      method="post"
                      action="{% url 'conexoes:solicitar_conexao' membro.id %}"
                      {% if search_form_hx_target %}
                        hx-post="{% url 'conexoes:solicitar_conexao' membro.id %}"
                        hx-target="#{{ search_form_hx_target }}"
                        hx-swap="innerHTML"
                      {% endif %}
                      class="w-full"
                    >
                      {% csrf_token %}
                      {% if form.q.value %}
                        <input type="hidden" name="q" value="{{ form.q.value }}" />
                      {% endif %}
                      <button type="submit" class="btn btn-primary btn-sm w-full justify-center">
                        {% trans "Conectar" %}
                      </button>
                    </form>
                  {% endif %}
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-sm text-[var(--text-secondary)]">{% trans "Nenhum membro encontrado para os critérios informados." %}</p>
      {% endif %}
    {% else %}
      <p class="text-sm text-[var(--text-secondary)]">{% trans "Você não está vinculado a uma organização no momento." %}</p>
    {% endif %}
  </div>
</article>
<div id="modal" role="presentation" aria-live="polite"></div>
