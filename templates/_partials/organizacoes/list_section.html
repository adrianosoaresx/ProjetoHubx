{% load i18n %}
{% with select_classes="form-select w-full rounded-xl border border-[var(--border)] bg-[var(--bg-secondary)] px-3 py-2 text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary)] focus:border-[var(--primary)] transition" %}
<div class="card">
  <div class="card-body space-y-4">
    <form hx-get="{% url 'organizacoes:list' %}" hx-target="#org-list" hx-push-url="true" class="grid gap-4 md:grid-cols-5">
      <select name="tipo" class="{{ select_classes }}" aria-label="{% trans 'Filtrar por tipo' %}">
        <option value="">{% trans 'Tipo' %}</option>
        {% for value, label in tipos %}
          <option value="{{ value }}" {% if request.GET.tipo == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <select name="cidade" class="{{ select_classes }}" aria-label="{% trans 'Filtrar por cidade' %}">
        <option value="">{% trans 'Cidade' %}</option>
        {% for c in cidades %}
          <option value="{{ c }}" {% if request.GET.cidade == c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
      <select name="estado" class="{{ select_classes }}" aria-label="{% trans 'Filtrar por estado' %}">
        <option value="">{% trans 'Estado' %}</option>
        {% for e in estados %}
          <option value="{{ e }}" {% if request.GET.estado == e %}selected{% endif %}>{{ e }}</option>
        {% endfor %}
      </select>
      <select name="inativa" class="{{ select_classes }}" aria-label="{% trans 'Filtrar por status' %}">
        <option value="">{% trans 'Status' %}</option>
        <option value="false" {% if inativa == 'false' %}selected{% endif %}>{% trans 'Ativas' %}</option>
        <option value="true" {% if inativa == 'true' %}selected{% endif %}>{% trans 'Inativas' %}</option>
      </select>
      <select name="ordering" class="{{ select_classes }}" aria-label="{% trans 'Ordenar resultados' %}">
        <option value="nome" {% if request.GET.ordering == 'nome' or not request.GET.ordering %}selected{% endif %}>{% trans 'Nome' %}</option>
        <option value="tipo" {% if request.GET.ordering == 'tipo' %}selected{% endif %}>{% trans 'Tipo' %}</option>
        <option value="cidade" {% if request.GET.ordering == 'cidade' %}selected{% endif %}>{% trans 'Localização' %}</option>
        <option value="created_at" {% if request.GET.ordering == 'created_at' %}selected{% endif %}>{% trans 'Data' %}</option>
      </select>
      <div class="md:col-span-5 flex flex-wrap items-center justify-end gap-2">
        <button type="submit" class="btn">{% trans 'Filtrar' %}</button>
        {% if request.GET %}
          <a href="{% url 'organizacoes:list' %}" class="btn btn-secondary">{% trans 'Limpar' %}</a>
        {% endif %}
      </div>
    </form>
  </div>
</div>

  {% if object_list %}
    <section class="card-grid">
    {% for organizacao in object_list %}
      <article class="card flex flex-col">
      <div class="card-body flex flex-col">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-12 h-12 bg-[var(--bg-tertiary)] rounded-xl flex items-center justify-center overflow-hidden" {% if not organizacao.avatar %}role="img" aria-label="{{ organizacao.nome }}"{% endif %}>
          {% if organizacao.avatar %}
            <img src="{{ organizacao.avatar.url }}" alt="{{ organizacao.nome }}" class="w-full h-full object-cover rounded-xl" loading="lazy" />
          {% else %}
            <span class="text-sm font-bold text-[var(--text-muted)]">{{ organizacao.nome|make_list|first|upper }}</span>
          {% endif %}
        </div>
        <div>
          <a href="{% url 'organizacoes:detail' organizacao.id %}" class="text-[var(--text-primary)] font-medium hover:underline">{{ organizacao.nome }}</a>
          {% if organizacao.inativa %}
            <span class="ml-2 badge badge-warning">{% trans 'Inativa' %}</span>
          {% endif %}
        </div>
      </div>
      {% if request.user.get_tipo_usuario != 'root' %}
      <div class="grid grid-cols-3 gap-4 text-center mt-auto">
        <div>
          <p class="text-xs text-[var(--text-muted)]">{% trans 'Usuários' %}</p>
          <p class="text-lg font-semibold text-[var(--text-primary)]">{{ organizacao.users_count }}</p>
        </div>
        <div>
          <p class="text-xs text-[var(--text-muted)]">{% trans 'Núcleos' %}</p>
          <p class="text-lg font-semibold text-[var(--text-primary)]">{{ organizacao.nucleos_count }}</p>
        </div>
        <div>
          <p class="text-xs text-[var(--text-muted)]">{% trans 'Eventos' %}</p>
          <p class="text-lg font-semibold text-[var(--text-primary)]">{{ organizacao.events_count }}</p>
        </div>
      </div>
      {% endif %}
      <div class="flex gap-2 justify-center {% if request.user.get_tipo_usuario == 'root' %}mt-auto{% else %}mt-4{% endif %}">
        <a href="{% url 'organizacoes:detail' organizacao.id %}" class="btn btn-secondary" aria-label="{% trans 'Visualizar' %}">{% trans 'Visualizar' %}</a>
        {% if perms.organizacoes.change_organizacao %}
        <a href="{% url 'organizacoes:update' organizacao.id %}" class="btn btn-secondary" aria-label="{% trans 'Editar' %}">{% trans 'Editar' %}</a>
        {% endif %}
      </div>
      </div>
    </article>
    {% endfor %}
  </section>
  <div class="mt-6 flex justify-center gap-2">
    {% if page_obj.has_previous %}
      <a hx-get="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.cidade %}&cidade={{ request.GET.cidade }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}{% if request.GET.ordering %}&ordering={{ request.GET.ordering }}{% endif %}{% if inativa %}&inativa={{ inativa }}{% endif %}" hx-target="#org-list" hx-push-url="true" class="btn btn-secondary" aria-label="{% trans 'Anterior' %}">{% trans 'Anterior' %}</a>
    {% endif %}
    <span class="btn btn-secondary">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
      <a hx-get="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.cidade %}&cidade={{ request.GET.cidade }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}{% if request.GET.ordering %}&ordering={{ request.GET.ordering }}{% endif %}{% if inativa %}&inativa={{ inativa }}{% endif %}" hx-target="#org-list" hx-push-url="true" class="btn btn-secondary" aria-label="{% trans 'Próxima' %}">{% trans 'Próxima' %}</a>
    {% endif %}
  </div>
{% else %}
    <article class="card text-center">
      <div class="card-body p-10">
        <p class="text-[var(--text-muted)] mb-4">{% trans 'Nenhuma organização cadastrada.' %}</p>
        <a href="{% url 'organizacoes:create' %}" class="btn">
          {% trans 'Cadastrar' %}
        </a>
      </div>
    </article>
  {% endif %}
{% endwith %}
