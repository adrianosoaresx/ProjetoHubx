{% load i18n %}
{% for message in messages %}
  <article class="chat-message flex {{ 'justify-end' if message.is_user }}">
    <div class="w-full max-w-4xl space-y-2">
      <div class="flex items-center gap-2 text-xs text-[var(--text-secondary)]">
        <span class="inline-flex items-center gap-1 rounded-full px-2 py-1 font-semibold {{
          'bg-primary/10 text-primary' if message.is_user else 'bg-[var(--bg-secondary)] text-[var(--text-primary)]' if not message.is_tool else 'bg-amber-100 text-amber-700'
        }}">
          {% if message.role == 'assistant' %}{% trans "Assistente" %}
          {% elif message.role == 'tool' %}{% trans "Ferramenta" %}
          {% else %}{% trans "VocÃª" %}{% endif %}
        </span>
        <time datetime="{{ message.created_at|date:'c' }}">{{ message.created_at|date:"d/m/Y H:i" }}</time>
      </div>
      <div class="rounded-2xl px-4 py-3 shadow-sm border border-[var(--border)] {{
        'bg-primary text-white border-primary/60' if message.is_user else 'bg-[var(--bg-secondary)]' if not message.is_tool else 'bg-amber-50 border-amber-200'
      }}">
        {% if message.is_tool %}
          <pre class="whitespace-pre-wrap break-words text-sm">{{ message.content }}</pre>
        {% else %}
          <p class="whitespace-pre-line leading-relaxed text-sm">{{ message.content }}</p>
        {% endif %}
      </div>
      {% if message.plotly_payload %}
        {% with script_id=message.plotly_script_id container_id=message.plotly_container_id %}
          {{ message.plotly_payload.figure|default:message.plotly_payload|json_script:script_id }}
          <div id="{{ container_id }}" class="mt-3 min-h-[260px] rounded-xl border border-dashed border-[var(--border)] bg-white" data-plotly-script="{{ script_id }}"></div>
        {% endwith %}
      {% endif %}
    </div>
  </article>
{% endfor %}
