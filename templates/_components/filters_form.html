{% load i18n static %}
<script src="{% static 'js/vendor/jquery-3.7.1.min.js' %}"></script>
<script src="{% static 'js/vendor/select2-4.1.0-rc.0.min.js' %}"></script>
{% if messages %}
<div id="filter-errors" class="mb-4" aria-live="polite">
  {% for message in messages %}
    <div class="bg-red-100 text-red-800 p-2 rounded" role="alert">{{ message }}</div>
  {% endfor %}
</div>
{% else %}
<div id="filter-errors" aria-live="polite"></div>
{% endif %}
<form method="get" class="mb-6 flex flex-wrap gap-4 items-end" aria-label="{% trans 'Filtros do dashboard' %}">
  <div>
    <label for="periodo" class="block text-sm font-medium text-neutral-700">{% trans 'Período' %}</label>
    <select id="periodo" name="periodo" class="mt-1 block border-gray-300 rounded" aria-label="{% trans 'Selecionar período' %}">
      <option value="mensal" {% if periodo == 'mensal' %}selected{% endif %}>{% trans 'Mensal' %}</option>
      <option value="trimestral" {% if periodo == 'trimestral' %}selected{% endif %}>{% trans 'Trimestral' %}</option>
      <option value="semestral" {% if periodo == 'semestral' %}selected{% endif %}>{% trans 'Semestral' %}</option>
      <option value="anual" {% if periodo == 'anual' %}selected{% endif %}>{% trans 'Anual' %}</option>
    </select>
  </div>
  <div>
    <label for="escopo" class="block text-sm font-medium text-neutral-700">{% trans 'Escopo' %}</label>
    <select id="escopo" name="escopo" class="mt-1 block border-gray-300 rounded" aria-label="{% trans 'Selecionar escopo' %}">
      <option value="auto" {% if escopo == 'auto' %}selected{% endif %}>{% trans 'Automático' %}</option>
      {% if request.user.user_type == 'root' %}
      <option value="global" {% if escopo == 'global' %}selected{% endif %}>{% trans 'Global' %}</option>
      {% endif %}
      <option value="organizacao" {% if escopo == 'organizacao' %}selected{% endif %}>{% trans 'Organização' %}</option>
      <option value="nucleo" {% if escopo == 'nucleo' %}selected{% endif %}>{% trans 'Núcleo' %}</option>
      <option value="evento" {% if escopo == 'evento' %}selected{% endif %}>{% trans 'Evento' %}</option>
    </select>
  </div>
  <div>
    <label for="organizacao_id" class="block text-sm font-medium text-neutral-700">{% trans 'Organização' %}</label>
    <select id="organizacao_id" name="organizacao_id" class="mt-1 block border-gray-300 rounded" aria-label="{% trans 'Selecionar organização' %}">
      <option value="" {% if not filtros.organizacao_id|default:'' %}selected{% endif %}>—</option>
      {% for org in organizacoes_permitidas %}
      <option value="{{ org.id }}" {% if filtros.organizacao_id|default:'' == org.id|stringformat:'s' %}selected{% endif %}>{{ org.nome }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="nucleo_id" class="block text-sm font-medium text-neutral-700">{% trans 'Núcleo' %}</label>
    <select id="nucleo_id" name="nucleo_id" class="mt-1 block border-gray-300 rounded" aria-label="{% trans 'Selecionar núcleo' %}">
      <option value="" {% if not filtros.nucleo_id|default:'' %}selected{% endif %}>—</option>
      {% for nucleo in nucleos_permitidos %}
      <option value="{{ nucleo.id }}" {% if filtros.nucleo_id|default:'' == nucleo.id|stringformat:'s' %}selected{% endif %}>{{ nucleo.nome }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="evento_id" class="block text-sm font-medium text-neutral-700">{% trans 'Evento' %}</label>
    <select id="evento_id" name="evento_id" class="mt-1 block border-gray-300 rounded" aria-label="{% trans 'Selecionar evento' %}">
      <option value="" {% if not filtros.evento_id|default:'' %}selected{% endif %}>—</option>
      {% for evento in eventos_permitidos %}
      <option value="{{ evento.id }}" {% if filtros.evento_id|default:'' == evento.id|stringformat:'s' %}selected{% endif %}>{{ evento.titulo }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="data_inicio" class="block text-sm font-medium text-neutral-700">{% trans 'Data início' %}</label>
    <input type="date" id="data_inicio" name="data_inicio" value="{{ filtros.data_inicio }}" class="mt-1 border-gray-300 rounded" />
  </div>
  <div>
    <label for="data_fim" class="block text-sm font-medium text-neutral-700">{% trans 'Data fim' %}</label>
    <input type="date" id="data_fim" name="data_fim" value="{{ filtros.data_fim }}" class="mt-1 border-gray-300 rounded" />
  </div>
  <fieldset class="flex flex-col">
    <legend class="text-sm font-medium text-neutral-700">{% trans 'Métricas' %}</legend>
    <div class="flex flex-wrap gap-2 mt-1">
      {% for m in metricas_disponiveis %}
      <label class="flex items-center gap-1 text-sm">
        <input type="checkbox" name="metricas" value="{{ m.key }}" {% if m.key in metricas_selecionadas %}checked{% endif %} class="border-gray-300 rounded" />
        {{ m.label }}
      </label>
      {% endfor %}
    </div>
  </fieldset>
  <div class="flex gap-2 mt-4">
      <button type="submit" class="btn btn-primary" aria-label="{% trans 'Aplicar filtros' %}">{% trans 'Filtrar' %}</button>
      {% if can_export %}
      <label for="formato" class="sr-only">{% trans 'Formato de exportação' %}</label>
      <select id="formato" name="formato" class="border-gray-300 rounded" aria-label="{% trans 'Formato de exportação' %}">
        <option value="pdf">{% trans 'PDF' %}</option>
        <option value="png">{% trans 'PNG' %}</option>
      </select>
    <button type="submit" formaction="{% url 'dashboard:export' %}" class="btn btn-secondary" aria-label="{% trans 'Exportar métricas' %}">{% trans 'Exportar' %}</button>
    {% endif %}
    <a href="{% url 'dashboard:filter-create' %}?{{ request.GET.urlencode }}" class="btn btn-secondary" aria-label="{% trans 'Salvar filtro rápido' %}">{% trans 'Salvar filtro' %}</a>
    <a href="{% url 'dashboard:filters' %}" class="btn btn-secondary" aria-label="{% trans 'Ver filtros salvos' %}">{% trans 'Meus filtros' %}</a>
    <a href="{% url 'dashboard:config-create' %}?{{ request.GET.urlencode }}" class="btn btn-secondary" aria-label="{% trans 'Salvar configuração' %}">{% trans 'Salvar configuração' %}</a>
    <a href="{% url 'dashboard:configs' %}" class="btn btn-secondary" aria-label="{% trans 'Ver configurações salvas' %}">{% trans 'Minhas configurações' %}</a>
  </div>
</form>
<script>
  $(function () {
    $('#organizacao_id').select2({
      ajax: {
        url: '{% url "dashboard:search-organizacoes" %}',
        dataType: 'json',
        delay: 250,
        data: function (params) { return { q: params.term }; },
        processResults: function (data) { return { results: data.results }; },
        cache: true
      },
      width: 'resolve',
      allowClear: true
    });
    $('#nucleo_id').select2({
      ajax: {
        url: '{% url "dashboard:search-nucleos" %}',
        dataType: 'json',
        delay: 250,
        data: function (params) { return { q: params.term }; },
        processResults: function (data) { return { results: data.results }; },
        cache: true
      },
      width: 'resolve',
      allowClear: true
    });
    $('#evento_id').select2({
      ajax: {
        url: '{% url "dashboard:search-eventos" %}',
        dataType: 'json',
        delay: 250,
        data: function (params) { return { q: params.term }; },
        processResults: function (data) { return { results: data.results }; },
        cache: true
      },
      width: 'resolve',
      allowClear: true
    });
  });
</script>
