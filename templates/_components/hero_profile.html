{% load i18n lucide_icons membros_extras %}

<section class="relative isolate overflow-visible">
  <div class="relative overflow-hidden min-h-[400px] sm:min-h-[440px] lg:min-h-[480px] {% if not profile.cover %}bg-gradient-to-r from-[var(--hero-from)] to-[var(--hero-to)]{% endif %}">
    {% if profile.cover %}
      <img src="{{ profile.cover.url }}" alt="" class="absolute inset-0 h-full w-full object-cover" loading="eager" fetchpriority="high">
      <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>
    {% endif %}
  </div>


  <div class="container relative mx-auto px-6 pb-10 lg:pb-14 z-10 sm:-mt-12 md:-mt-16 lg:-mt-24 xl:-mt-28">
    <div class="rounded-2xl border border-[var(--border)] bg-transparent p-4 md:p-6 shadow-lg transition-colors">
      {% with display_name=hero_title|default:profile.display_name subtitle=hero_subtitle %}
        <div class="flex flex-col items-center gap-4 sm:flex-row sm:items-start sm:gap-6">
          <div class="mx-auto h-20 w-20 shrink-0 overflow-hidden rounded-full bg-[var(--bg-secondary)] ring-4 ring-[var(--bg-primary)] sm:mx-0 md:h-24 md:w-24">
            {% if profile.avatar %}
              <img src="{{ profile.avatar_url }}" alt="{{ display_name|default:profile.username }}" class="h-full w-full object-cover" loading="lazy">
            {% else %}
              <div class="grid h-full w-full place-items-center text-2xl font-semibold text-[var(--text-secondary)]">
                {{ profile.get_initials|default:profile.username|slice:":2"|upper }}
              </div>
            {% endif %}
          </div>

          <div class="min-w-0 space-y-1.5 text-center sm:text-left">
            <h2 class="text-2xl font-semibold text-[var(--text-primary)] md:text-3xl">
              <span class="inline-block rounded-lg bg-black/60 px-2 py-1 text-white shadow-sm ring-1 ring-white/10 backdrop-blur-sm">
                {{ display_name|default:profile.username }}
              </span>
            </h2>

            <span class="inline-flex items-center gap-1 rounded-lg border border-[var(--border)] bg-[var(--bg-secondary)] px-2 py-0.5 text-sm font-medium text-[var(--text-secondary)] sm:text-base">
              <span aria-hidden="true">@</span>{{ profile.username }}
            </span>

            {% if subtitle %}
              <p class="text-sm text-[var(--text-secondary)] sm:text-base">
                {{ subtitle }}
              </p>
            {% endif %}

            <div class="mt-2 flex flex-wrap items-center justify-center gap-3 text-sm sm:justify-start">
              <div
                class="inline-flex items-center gap-2 rounded-lg border border-[var(--border)] bg-[var(--bg-secondary)] px-3 py-1 shadow-sm"
                data-user-rating-container
              >
                <div class="flex items-center gap-1" data-user-rating-stars>
                  {% rating_stars perfil_avaliacao_media as perfil_stars %}
                  {% for star in perfil_stars %}
                    <span class="inline-flex" data-rating-state="{{ star }}">
                      {% if star == "full" %}
                        {% lucide "star" class="h-4 w-4 text-[var(--primary)] fill-[var(--primary)]" aria_hidden="true" %}
                      {% else %}
                        {% lucide "star" class="h-4 w-4 text-[var(--text-muted)]" aria_hidden="true" %}
                      {% endif %}
                    </span>
                  {% endfor %}
                </div>
                <span
                  class="text-base font-semibold text-[var(--text-primary)] {% if not perfil_avaliacao_display %}hidden{% endif %}"
                  data-user-rating-value
                >
                  {{ perfil_avaliacao_display }}
                </span>
                <span
                  class="text-sm text-[var(--text-muted)] {% if perfil_avaliacao_display %}hidden{% endif %}"
                  data-user-rating-empty
                >
                  {% trans "Sem avaliações" %}
                </span>
                <span class="text-xs text-[var(--text-secondary)]" data-user-rating-count>
                  ({{ perfil_avaliacao_total|default:0 }})
                </span>
              </div>
              {% if can_promote_profile and promote_profile_url %}
                <a
                  href="{{ promote_profile_url }}"
                  class="btn btn-primary btn-sm"
                  aria-label="{% trans 'Promover usuário' %}"
                >
                  {% lucide 'arrow-up-right' class='h-4 w-4' aria_hidden='true' %}
                  <span>{% trans "Promover" %}</span>
                </a>
              {% endif %}
              {% if perfil_avaliar_url and request.user.is_authenticated and not is_owner and not perfil_feedback_exists %}
                <button
                  type="button"
                  class="btn btn-primary btn-sm"
                  hx-get="{{ perfil_avaliar_url }}"
                  hx-target="#modal"
                  hx-swap="innerHTML"
                  hx-on="htmx:beforeRequest: window.HubxModalTrigger = this;"
                  aria-label="{% trans 'Avaliar perfil' %}"
                  data-user-rating-action
                >
                  {% trans "Avaliar" %}
                </button>
              {% endif %}
            </div>

          </div>

        </div>
      {% endwith %}

      {% with redes=profile.redes_sociais %}
        <div class="mt-6 flex flex-wrap items-center justify-center gap-3{% if redes or profile.whatsapp %} sm:justify-between{% endif %}">
          {% if redes %}
            <div class="flex flex-wrap justify-center gap-3">
              {% for rede, url in redes.items %}
                {% if url %}
                  <a
                    href="{{ url }}"
                    target="_blank"
                    rel="noopener noreferrer"
                    aria-label="{{ rede|capfirst }}"
                    class="inline-flex items-center text-[var(--text-secondary)] transition hover:scale-110 hover:text-[var(--text-primary)]"
                  >
                    {% lucide rede class="h-6 w-6" %}
                  </a>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}

          {% if profile.whatsapp %}
            <a
              href="https://wa.me/{{ profile.whatsapp|cut:"+" }}"
              class="inline-flex items-center text-[var(--text-secondary)] transition hover:scale-110 hover:text-[var(--text-primary)]"
              aria-label="WhatsApp"
            >
              {% lucide "whatsapp" width="28" height="28" %}
            </a>
          {% else %}
            <span class="inline-flex items-center text-[var(--text-muted)]" aria-label="WhatsApp indisponível">
              {% lucide "whatsapp" class="h-8 w-8" %}
            </span>
          {% endif %}
        </div>
      {% endwith %}

      {% usuario_tipo_badge profile as profile_tipo_badge %}
      {% usuario_badges profile as profile_badges %}
      {% with first_badge=profile_badges.0 badges_len=profile_badges|length %}
        {% if profile_tipo_badge or profile_badges %}
          <div class="mt-6 space-y-3 text-center sm:text-left">
            {% if profile_tipo_badge %}
              {% if profile_tipo_badge.type == 'associado' and badges_len == 1 and first_badge.type == 'associado' %}
                {# Skip duplicated associado badge #}
              {% else %}
                <div class="flex flex-wrap justify-center gap-2 sm:justify-start">
                  <span class="inline-flex max-w-full items-center gap-2 rounded-full bg-[var(--primary-soft,rgba(59,130,246,0.15))] px-3 py-1 text-xs font-semibold uppercase tracking-wide text-[var(--primary,#2563eb)] shadow-sm ring-1 ring-[var(--primary-soft-border,rgba(59,130,246,0.3))]"{% if profile_tipo_badge.style %} style="{{ profile_tipo_badge.style }}"{% endif %}>
                    {% lucide profile_tipo_badge.icon|default:'badge-check' class='h-3.5 w-3.5 shrink-0' aria_hidden='true' %}
                    <span class="truncate">{{ profile_tipo_badge.label }}</span>
                  </span>
                </div>
              {% endif %}
            {% endif %}
            {% if profile_badges %}
              <div class="flex flex-wrap justify-center gap-2 sm:justify-start">
                {% for badge in profile_badges %}
                  <span class="inline-flex max-w-full items-center gap-2 rounded-full bg-[var(--primary-soft,rgba(59,130,246,0.15))] px-3 py-1 text-xs font-semibold uppercase tracking-wide text-[var(--primary,#2563eb)] shadow-sm ring-1 ring-[var(--primary-soft-border,rgba(59,130,246,0.3))]"{% if badge.style %} style="{{ badge.style }}"{% endif %}>
                    {% lucide badge.icon|default:'badge-check' class='h-3.5 w-3.5 shrink-0' aria_hidden='true' %}
                    <span class="truncate">{{ badge.label }}</span>
                  </span>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        {% endif %}
      {% endwith %}

    </div>
  </div>
</section>

<script>
  (function () {
    const defaultErrorMessage = gettext('Você não tem permissão para realizar esta ação.');

    function clamp(value, min, max) {
      return Math.min(Math.max(value, min), max);
    }

    function computeStarStates(average) {
      const parsed = Number(average);
      const value = Number.isFinite(parsed) ? parsed : 0;
      const rounded = Math.round(value * 2) / 2;
      const clamped = clamp(rounded, 0, 5);
      const stars = [];

      for (let position = 1; position <= 5; position += 1) {
        const fullThreshold = position;
        const halfThreshold = position - 0.5;

        if (clamped >= fullThreshold) {
          stars.push('full');
        } else if (clamped >= halfThreshold) {
          stars.push('half');
        } else {
          stars.push('empty');
        }
      }

      return stars;
    }

    function createStarIcon(state) {
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('viewBox', '0 0 24 24');
      svg.setAttribute('aria-hidden', 'true');
      svg.setAttribute('stroke', 'currentColor');
      svg.setAttribute('stroke-width', '2');
      svg.setAttribute('stroke-linecap', 'round');
      svg.setAttribute('stroke-linejoin', 'round');
      svg.classList.add('h-4', 'w-4');

      if (state === 'full') {
        svg.classList.add('text-[var(--primary)]', 'fill-[var(--primary)]');
        svg.setAttribute('fill', 'currentColor');
      } else {
        svg.classList.add('text-[var(--text-muted)]');
        svg.setAttribute('fill', 'none');
      }

      const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
      polygon.setAttribute('points', '12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2');
      svg.appendChild(polygon);
      return svg;
    }

    function renderStarStates(states) {
      const starsContainer = document.querySelector('[data-user-rating-stars]');
      if (!starsContainer) {
        return;
      }

      const fragment = document.createDocumentFragment();
      const starStates = Array.isArray(states) && states.length ? states : Array(5).fill('empty');

      starStates.forEach((state) => {
        const wrapper = document.createElement('span');
        wrapper.className = 'inline-flex';
        wrapper.dataset.ratingState = state;
        wrapper.appendChild(createStarIcon(state));
        fragment.appendChild(wrapper);
      });

      starsContainer.innerHTML = '';
      starsContainer.appendChild(fragment);
    }

    function handleUserRatingSubmitted(event) {
      const detail = event.detail || {};
      const valueEl = document.querySelector('[data-user-rating-value]');
      const emptyEl = document.querySelector('[data-user-rating-empty]');
      const countEl = document.querySelector('[data-user-rating-count]');

      if (valueEl) {
        const display = detail.display || (typeof detail.average === 'number' ? detail.average.toFixed(1).replace('.', ',') : '');
        valueEl.textContent = display;
        valueEl.classList.toggle('hidden', !display);
      }

      if (emptyEl) {
        emptyEl.classList.add('hidden');
      }

      if (countEl && Object.prototype.hasOwnProperty.call(detail, 'total')) {
        countEl.textContent = `(${detail.total})`;
      }

      const actionButton = document.querySelector('[data-user-rating-action]');
      if (actionButton) {
        actionButton.remove();
      }

      if (Object.prototype.hasOwnProperty.call(detail, 'average')) {
        const states = computeStarStates(detail.average);
        renderStarStates(states);
      }

      const modal = document.getElementById('modal');
      if (modal) {
        modal.innerHTML = '';
      }
    }

    function showUserRatingMessage(message) {
      const displayMessage = typeof message === 'string' && message.trim()
        ? message.trim()
        : defaultErrorMessage;

      if (typeof window.HubxToast === 'function') {
        window.HubxToast(displayMessage);
      }
    }

    function handleUserRatingError(event) {
      const detail = event.detail || {};
      showUserRatingMessage(detail.message);
    }

    document.addEventListener('user-rating:submitted', handleUserRatingSubmitted);
    document.addEventListener('user-rating:error', handleUserRatingError);
  })();
</script>
