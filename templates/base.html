{% load static i18n %}
{% get_current_language as LANGUAGE_CODE %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="{% static 'manifest.json' %}">
  <meta name="theme-color" content="#0f172a">
  <script>
    (function () {
      let theme = localStorage.getItem('tema');
      if (!theme) {
        const match = document.cookie.match(/(?:^|; )tema=([^;]+)/);
        theme = match ? match[1] : null;
      }
      if (!theme || theme === 'automatico') {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'escuro' : 'claro';
      }
      document.documentElement.classList.toggle('dark', theme === 'escuro');

      const langMatch = document.cookie.match(/(?:^|; )django_language=([^;]+)/);
      if (langMatch) {
        document.documentElement.setAttribute('lang', langMatch[1]);
      }
    })();
  </script>
  <title>{% block title %}{% trans "HubX" %}{% endblock %}</title>
  <script src="{% url 'javascript-catalog' %}"></script>

  <link rel="preconnect" href="https://rsms.me/">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <link rel="stylesheet" href="{% static 'tailwind.css' %}">
  <!-- Font Awesome removed: icons are now inline SVGs -->
  {% block extra_css %}{% endblock %}
</head>

<body class="min-h-full flex flex-col font-sans text-gray-800" data-is-authenticated="{{ request.user.is_authenticated|yesno:'true,false' }}">
  <a href="#main-content" class="sr-only focus:not-sr-only">{% trans "Pular para o conteúdo principal" %}</a>

  {% if messages %}
  <div id="messages" class="fixed top-4 right-4 space-y-2 z-50">
    {% for message in messages %}
      <div class="px-4 py-2 rounded shadow text-white {% if 'error' in message.tags %}bg-red-500{% elif 'success' in message.tags %}bg-green-500{% else %}bg-blue-500{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
  <script>
    setTimeout(() => {
      const el = document.getElementById('messages');
      if (el) { el.remove(); }
    }, 4000);
  </script>
  {% endif %}

  <!-- Navbar -->
  {% if not hide_nav %}
  <header class="bg-white shadow">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <a href="/" class="text-2xl font-bold text-primary" aria-label="{% trans 'Página inicial' %}">HubX</a>
      <button
        id="menu-toggle"
        class="md:hidden text-gray-800"
        aria-label="{% trans 'Abrir menu' %}"
        aria-controls="menu"
        aria-expanded="false"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 5h16" />
          <path d="M4 12h16" />
          <path d="M4 19h16" />
        </svg>
      </button>
      <nav
        id="menu"
        class="hidden md:flex flex-col md:flex-row md:items-center gap-4 text-sm"
        aria-label="{% trans 'Menu principal' %}"
      >
        {% if user.is_authenticated %}
        <a href="{% url 'accounts:perfil' %}" class="flex items-center hover:text-primary transition" aria-label="{% trans 'Perfil' %}">
          {% if user.avatar %}
            <img src="{{ user.avatar.url }}" alt="{{ user.username }}" class="w-6 h-6 rounded-full object-cover" />
          {% else %}
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
              <circle cx="12" cy="7" r="4" />
            </svg>
          {% endif %}
        </a>
        <span id="notif-count" class="hidden"></span>
        {% endif %}
        {% if user.user_type == 'admin' or user.user_type == 'coordenador' %}
        <a href="/" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m12 14 4-4" />
            <path d="M3.34 19a10 10 0 1 1 17.32 0" />
          </svg>
          {% trans "Dashboard" %}
        </a>
        <a href="{% url 'associados_lista' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
            <path d="M16 3.128a4 4 0 0 1 0 7.744" />
            <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
            <circle cx="9" cy="7" r="4" />
          </svg>
          {% trans "Associados" %}
        </a>
        <a href="{% url 'empresas:lista' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z" />
            <path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2" />
            <path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2" />
            <path d="M10 6h4" />
            <path d="M10 10h4" />
            <path d="M10 14h4" />
            <path d="M10 18h4" />
          </svg>
          {% trans "Empresas" %}
        </a>
        <a href="{% url 'nucleos:list' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
            <path d="M16 3.128a4 4 0 0 1 0 7.744" />
            <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
            <circle cx="9" cy="7" r="4" />
          </svg>
          {% trans "Núcleos" %}
        </a>
        <a href="{% url 'eventos:lista' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8 2v4" />
            <path d="M16 2v4" />
            <rect width="18" height="18" x="3" y="4" rx="2" />
            <path d="M3 10h18" />
            <path d="M8 14h.01" />
            <path d="M12 14h.01" />
            <path d="M16 14h.01" />
            <path d="M8 18h.01" />
            <path d="M12 18h.01" />
            <path d="M16 18h.01" />
          </svg>
          {% trans "Eventos" %}
        </a>
        <a href="{% url 'feed:listar' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 11a9 9 0 0 1 9 9" />
            <path d="M4 4a16 16 0 0 1 16 16" />
            <circle cx="5" cy="19" r="1" />
          </svg>
          {% trans "Feed" %}
        </a>
        <a href="{% url 'financeiro:repasses' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 15h2a2 2 0 1 0 0-4h-3c-.6 0-1.1.2-1.4.6L3 17" />
            <path d="m7 21 1.6-1.4c.3-.4.8-.6 1.4-.6h4c1.1 0 2.1-.4 2.8-1.2l4.6-4.4a2 2 0 0 0-2.75-2.91l-4.2 3.9" />
            <path d="m2 16 6 6" />
            <circle cx="16" cy="9" r="2.9" />
            <circle cx="6" cy="5" r="3" />
          </svg>
          {% trans "Financeiro" %}
        </a>
        <a href="{% url 'tokens:listar_api_tokens' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4" />
            <path d="m21 2-9.6 9.6" />
            <circle cx="7.5" cy="15.5" r="5.5" />
          </svg>
          {% trans "Tokens" %}
        </a>
          <a href="{% url 'configuracoes' %}" class="hover:text-primary transition" aria-label="{% trans 'Configurações' %}">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915" />
              <circle cx="12" cy="12" r="3" />
            </svg>
          </a>
          <a href="{% url 'accounts:logout' %}" class="flex items-center gap-x-2 hover:text-primary transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m16 17 5-5-5-5" />
              <path d="M21 12H9" />
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            </svg>
            {% trans "Sair" %}
          </a>
        {% else %}
        <a href="/" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m12 14 4-4" />
            <path d="M3.34 19a10 10 0 1 1 17.32 0" />
          </svg>
          {% trans "Dashboard" %}
        </a>
        {% if user.user_type != 'root' %}
        <a href="{% url 'empresas:lista' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z" />
            <path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2" />
            <path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2" />
            <path d="M10 6h4" />
            <path d="M10 10h4" />
            <path d="M10 14h4" />
            <path d="M10 18h4" />
          </svg>
          {% trans "Empresas" %}
        </a>
        {% endif %}
        {% if user.user_type != 'root' %}
        <a href="{% url 'empresas:buscar' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m21 21-4.34-4.34" />
            <circle cx="11" cy="11" r="8" />
          </svg>
          {% trans "Buscar Empresas" %}
        </a>
        {% endif %}
        {% if user.user_type != 'root' %}
        <a href="{% url 'eventos:lista' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8 2v4" />
            <path d="M16 2v4" />
            <rect width="18" height="18" x="3" y="4" rx="2" />
            <path d="M3 10h18" />
            <path d="M8 14h.01" />
            <path d="M12 14h.01" />
            <path d="M16 14h.01" />
            <path d="M8 18h.01" />
            <path d="M12 18h.01" />
            <path d="M16 18h.01" />
          </svg>
          {% trans "Eventos" %}
        </a>
        {% endif %}
  {# App Discussão removido: link ocultado #}
        {% if user.user_type != 'root' %}
        <a href="{% url 'feed:listar' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 11a9 9 0 0 1 9 9" />
            <path d="M4 4a16 16 0 0 1 16 16" />
            <circle cx="5" cy="19" r="1" />
          </svg>
          {% trans "Feed" %}
        </a>
        {% endif %}
        {% if user.user_type != 'root' %}
        <a href="{% url 'nucleos:list' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
            <path d="M16 3.128a4 4 0 0 1 0 7.744" />
            <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
            <circle cx="9" cy="7" r="4" />
          </svg>
          {% trans "Núcleos" %}
        </a>
        {% endif %}
        {% if user.user_type != 'root' and user.user_type != 'admin' %}
        <a href="{% url 'nucleos:meus' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 21a8 8 0 0 0-16 0" />
            <circle cx="10" cy="8" r="5" />
            <path d="M22 20c0-3.37-2-6.5-4-8a5 5 0 0 0-.45-8.3" />
          </svg>
          {% trans "Meus Núcleos" %}
        </a>
        {% endif %}
        {% if user.is_authenticated %}
        {% if user.user_type == 'financeiro' or user.user_type == 'admin' %}
        <a href="{% url 'financeiro:repasses' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 15h2a2 2 0 1 0 0-4h-3c-.6 0-1.1.2-1.4.6L3 17" />
            <path d="m7 21 1.6-1.4c.3-.4.8-.6 1.4-.6h4c1.1 0 2.1-.4 2.8-1.2l4.6-4.4a2 2 0 0 0-2.75-2.91l-4.2 3.9" />
            <path d="m2 16 6 6" />
            <circle cx="16" cy="9" r="2.9" />
            <circle cx="6" cy="5" r="3" />
          </svg>
          {% trans "Financeiro" %}
        </a>
        {% endif %}
        {% endif %}
        {% if user.is_authenticated and user.user_type == 'root' %}
        <a href="{% url 'organizacoes:list' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="6" x2="6" y1="3" y2="15" />
            <circle cx="18" cy="6" r="3" />
            <circle cx="6" cy="18" r="3" />
            <path d="M18 9a9 9 0 0 1-9 9" />
          </svg>
          {% trans "Organizações" %}
        </a>
        {% endif %}
  {% if user.is_authenticated and user.user_type in 'root,admin,coordenador' %}
        {% if user.user_type in 'root,admin' %}
        <a href="{% url 'tokens:listar_api_tokens' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4" />
            <path d="m21 2-9.6 9.6" />
            <circle cx="7.5" cy="15.5" r="5.5" />
          </svg>
          {% trans "Token" %}
        </a>
        {% else %}
        <a href="{% url 'tokens:gerar_convite' %}" class="flex items-center gap-x-2 hover:text-primary transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4" />
            <path d="m21 2-9.6 9.6" />
            <circle cx="7.5" cy="15.5" r="5.5" />
          </svg>
          {% trans "Token" %}
        </a>
        {% endif %}
        {% endif %}
          {% if user.is_authenticated %}
            <a href="{% url 'configuracoes' %}" class="hover:text-primary transition" aria-label="{% trans 'Configurações' %}">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915" />
                <circle cx="12" cy="12" r="3" />
              </svg>
            </a>
            <a href="{% url 'accounts:logout' %}" class="flex items-center gap-x-2 hover:text-primary transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m16 17 5-5-5-5" />
                <path d="M21 12H9" />
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
              </svg>
              {% trans "Sair" %}
            </a>
          {% else %}
            <a href="{% url 'accounts:login' %}" class="flex items-center gap-x-2 hover:text-primary transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m10 17 5-5-5-5" />
                <path d="M15 12H3" />
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" />
              </svg>
              {% trans "Entrar" %}
            </a>
            <a href="{% url 'accounts:onboarding' %}" class="flex items-center gap-x-2 bg-primary text-white py-2 px-4 rounded-xl hover:bg-primary/90 transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <line x1="19" x2="19" y1="8" y2="14" />
                <line x1="22" x2="16" y1="11" y2="11" />
              </svg>
              {% trans "Cadastrar" %}
            </a>
          {% endif %}
        {% endif %}
      </nav>
    </div>
  </header>
  {% endif %}

  <!-- Conteúdo principal -->
  <main id="main-content" class="flex-grow">
    {% block content %}{% endblock %}
  </main>

  <!-- Rodapé -->
  <footer class="bg-white border-t mt-10">
    <div class="container mx-auto px-4 py-6 text-sm text-gray-500 flex flex-col items-center gap-2 md:flex-row md:justify-between">
      <p>{% blocktrans with year=now|date:"Y" %}© {{ year }} HubX. Todos os direitos reservados.{% endblocktrans %}</p>
      <nav class="flex gap-4">
        <a href="{% url 'core:about' %}" class="hover:text-primary">{% trans "Sobre" %}</a>
        <a href="mailto:contato@hubx.space" class="hover:text-primary">{% trans "Contato" %}</a>
        <a href="{% url 'core:privacy' %}" class="hover:text-primary">{% trans "Privacidade" %}</a>
        <a href="{% url 'core:terms' %}" class="hover:text-primary">{% trans "Termos" %}</a>
      </nav>
    </div>
  </footer>

  {% if WEBSOCKETS_ENABLED %}
  <script src="{% static 'notificacoes/js/push_socket.js' %}"></script>
  {% endif %}
  <script src="{% static 'js/vendor/htmx-1.9.12.min.js' %}"></script>
  <script src="{% static 'js/vendor/json-enc.js' %}"></script>
  <script src="{% static 'js/dashboard.js' %}"></script>
  <script type="module" src="{% static 'feed/js/share.js' %}"></script>
  <script>
    document.body.addEventListener('htmx:responseError', function (evt) {
      if (evt.detail.xhr.status === 403) {
        alert(gettext('Você não tem permissão para realizar esta ação.'));
      }
    });
  </script>
  <script>
    (function () {
      const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

      function getThemePreference() {
        const stored = localStorage.getItem('tema');
        if (stored) return stored;
        const match = document.cookie.match(/(?:^|; )tema=([^;]+)/);
        return match ? match[1] : 'automatico';
      }

      function applyTheme(theme) {
        document.documentElement.classList.toggle('dark', theme === 'escuro');
      }

      function toggleTheme(theme) {
        if (theme === 'automatico') {
          document.cookie = 'tema=automatico;path=/';
          localStorage.setItem('tema', 'automatico');
          applyTheme(mediaQuery.matches ? 'escuro' : 'claro');
        } else {
          document.cookie = `tema=${theme};path=/`;
          localStorage.setItem('tema', theme);
          applyTheme(theme);
        }
      }

      toggleTheme(getThemePreference());
      mediaQuery.addEventListener('change', e => {
        if (getThemePreference() === 'automatico') {
          toggleTheme(e.matches ? 'escuro' : 'claro');
        }
      });

      const themeMatch = document.cookie.match(/(?:^|; )tema=([^;]+)/);
      if (themeMatch) {
        localStorage.setItem('tema', themeMatch[1]);
      }
      const langMatch = document.cookie.match(/(?:^|; )django_language=([^;]+)/);
      if (langMatch) {
        localStorage.setItem('idioma', langMatch[1]);
      }

      const menuToggle = document.getElementById('menu-toggle');
      const menu = document.getElementById('menu');
      if (menuToggle && menu) {
        menuToggle.addEventListener('click', () => {
          const expanded = menuToggle.getAttribute('aria-expanded') === 'true';
          menuToggle.setAttribute('aria-expanded', String(!expanded));
          menu.classList.toggle('hidden');
        });
      }

      window.toggleTheme = toggleTheme;
      window.getThemePreference = getThemePreference;
    })();
  </script>
  {% block extra_js %}
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "{{ ONESIGNAL_APP_ID|default:'107f7e3e-2720-46ac-9068-d595d762dda4' }}",
      });
    });
  </script>
  {% endblock %}
</body></html>
