{% extends 'base.html' %}
{% load i18n l10n %}
{% block title %}{{ empresa.nome }} | Hubx{% endblock %}

{% block hero %}
  {% include '_components/hero.html' with title=empresa.nome subtitle=empresa.descricao %}
{% endblock %}

{% block content %}
  <div class="py-12 card max-w-4xl mx-auto px-4">
    <div class="card-body">
      <div class="space-y-1 text-sm text-[var(--text-primary)]">
    <p><strong>{% trans "CNPJ" %}:</strong> {{ empresa.cnpj|localize }}</p>
    <p><strong>{% trans "Status de validação" %}:</strong>
      {% if empresa.validado_em %}
        {% blocktrans trimmed with date=empresa.validado_em|date source=empresa.fonte_validacao %}
          Validado em {{ date }} ({{ source }})
        {% endblocktrans %}
      {% else %}
        {% trans "Pendente" %}
      {% endif %}
    </p>
        <p><strong>{% trans "Localização" %}:</strong> {{ empresa.municipio }}, {{ empresa.estado }}</p>
        {% if pode_visualizar_contatos %}
          {% with empresa.get_contato_principal as contato %}
            {% if contato %}
              <p><strong>{% trans "Contato" %}:</strong> {{ contato.nome }}</p>
            {% else %}
              <p><strong>{% trans "Contato" %}:</strong> {% trans "Nenhum contato cadastrado" %}</p>
            {% endif %}
          {% endwith %}
        {% endif %}
      </div>

      {% if pode_visualizar_contatos %}
        <h2 class="mt-8 text-lg font-semibold text-[var(--text-primary)]">{% trans "Contatos" %}</h2>
        <div class="mt-4 card-grid">
          {% for contato in contatos %}
            <div class="card flex justify-between items-start p-4">
              <div class="text-sm">
                <p class="font-medium text-[var(--text-primary)]">{{ contato.nome }}</p>
                <p class="text-[var(--text-tertiary)]">{{ contato.cargo }}</p>
                <p class="text-[var(--text-tertiary)]">{{ contato.email }}</p>
                <p class="text-[var(--text-tertiary)]">{{ contato.telefone }}</p>
              </div>
              <div class="flex gap-2">
                <a href="{% url 'empresas:contato_editar' contato.id %}" class="btn btn-secondary btn-sm">{% trans "Editar" %}</a>
                <a href="{% url 'empresas:contato_remover' contato.id %}" class="btn btn-danger btn-sm">{% trans "Remover" %}</a>
              </div>
            </div>
          {% empty %}
            <p class="text-sm text-[var(--text-secondary)]">{% trans "Nenhum contato cadastrado." %}</p>
          {% endfor %}
        </div>
        <div class="mt-4">
          <a href="{% url 'empresas:contato_novo' empresa.id %}" class="btn btn-primary btn-sm">{% trans "Adicionar" %}</a>
        </div>
      {% endif %}

  {% if empresa_tags %}
    <div class="mt-4">
      <strong>{% trans "Tags" %}:</strong>
      <div class="flex flex-wrap gap-2 mt-1">
        {% for tag in empresa_tags %}
          <span class="text-xs bg-primary-100 text-primary-800 rounded-full px-2 py-0.5">{{ tag.nome }}</span>
        {% endfor %}
      </div>
    </div>
  {% endif %}

      {% if prod_tags %}
        <h2 class="mt-8 text-lg font-semibold text-[var(--text-primary)]">{% trans "Produtos" %}</h2>
        <div class="card-grid mt-4">
          {% for tag in prod_tags %}
            <div class="card p-4">
              <h3 class="text-base font-medium text-[var(--text-primary)]">{{ tag.nome }}</h3>
            </div>
          {% empty %}
            <p class="text-sm text-[var(--text-secondary)]">{% trans "Nenhum produto cadastrado." %}</p>
          {% endfor %}
        </div>
      {% endif %}

      {% if serv_tags %}
        <h2 class="mt-8 text-lg font-semibold text-[var(--text-primary)]">{% trans "Serviços" %}</h2>
        <div class="card-grid mt-4">
          {% for tag in serv_tags %}
            <div class="card p-4">
              <h3 class="text-base font-medium text-[var(--text-primary)]">{{ tag.nome }}</h3>
            </div>
          {% empty %}
            <p class="text-sm text-[var(--text-secondary)]">{% trans "Nenhum serviço cadastrado." %}</p>
          {% endfor %}
        </div>
      {% endif %}

      {% if empresa.usuario %}
        <h2 class="mt-8 text-lg font-semibold text-[var(--text-primary)]">{% trans "Proprietário" %}</h2>
        <div class="flex items-center gap-4 mt-4">
      {% with dono=empresa.usuario %}
        {% if dono.avatar %}
          <img src="{{ dono.avatar.url }}" alt="{{ dono.username }}" class="w-12 h-12 rounded-full object-cover" />
        {% else %}
          <div class="w-12 h-12 rounded-full bg-[var(--bg-tertiary)] flex items-center justify-center text-sm font-semibold text-[var(--text-secondary)]" role="img" aria-label="{{ dono.username }}">
            {{ dono.username|make_list|first|upper }}
        </div>
      {% endif %}
        <div>
          <p class="text-sm font-medium text-[var(--text-primary)]">{{ dono.get_full_name|default:dono.username }}</p>
          <p class="text-xs text-[var(--text-tertiary)]">{{ dono.email }}</p>
        </div>
      {% endwith %}
    </div>
  {% endif %}

      {% if nucleos_dono %}
        <h2 class="mt-8 text-lg font-semibold text-[var(--text-primary)]">{% trans "Núcleos" %}</h2>
        <div class="card-grid mt-4">
          {% for nucleo in nucleos_dono %}
            <div class="card p-4 text-center">
              {% if nucleo.avatar %}
                <img src="{{ nucleo.avatar.url }}" alt="{{ nucleo.nome }}" class="w-16 h-16 rounded-full object-cover mx-auto mb-2" />
              {% else %}
                <div class="w-16 h-16 rounded-full bg-[var(--bg-tertiary)] flex items-center justify-center text-sm font-medium text-[var(--text-secondary)] mx-auto mb-2" role="img" aria-label="{{ nucleo.nome }}">
                  {{ nucleo.nome|make_list|first|upper }}
                </div>
              {% endif %}
              <h3 class="text-sm font-medium text-[var(--text-primary)]">{{ nucleo.nome }}</h3>
            </div>
          {% empty %}
            <p class="text-sm text-[var(--text-secondary)]">{% trans "Nenhum núcleo." %}</p>
          {% endfor %}
        </div>
      {% endif %}

      {% if eventos_dono %}
        <h2 class="mt-8 text-lg font-semibold text-[var(--text-primary)]">{% trans "Eventos" %}</h2>
        <div class="card-grid mt-4">
          {% for evento in eventos_dono %}
            <div class="card p-4">
              <h3 class="text-base font-medium text-[var(--text-primary)]">{{ evento.titulo }}</h3>
              <p class="text-sm text-[var(--text-tertiary)]">{{ evento.data_inicio|date:"SHORT_DATE_FORMAT" }}</p>
            </div>
          {% empty %}
            <p class="text-sm text-[var(--text-secondary)]">{% trans "Nenhum evento." %}</p>
          {% endfor %}
        </div>
      {% endif %}

      <div class="mt-8">
        {% include "_components/avaliacoes_empresa.html" %}
      </div>

      <div class="flex justify-end gap-3 mt-8">
        <a href="{% url 'empresas:lista' %}" class="btn btn-secondary btn-sm">{% trans "Voltar" %}</a>
        {% translate "Favoritar" as txt_favoritar %}
        {% translate "Desfavoritar" as txt_desfavoritar %}
        <button
          id="favorito-btn"
          class="btn btn-secondary btn-sm"
          {% if empresa.favoritado %}
            hx-delete="{% url 'empresas_api:empresa-favoritar' empresa.id %}"
          {% else %}
            hx-post="{% url 'empresas_api:empresa-favoritar' empresa.id %}"
          {% endif %}
          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
          hx-swap="none"
          hx-on:afterRequest="
            if (event.detail.xhr.status === 201) {
              this.innerText='{{ txt_desfavoritar }}';
              this.setAttribute('hx-delete', '{% url 'empresas_api:empresa-favoritar' empresa.id %}');
              this.removeAttribute('hx-post');
            } else if (event.detail.xhr.status === 204) {
              this.innerText='{{ txt_favoritar }}';
              this.setAttribute('hx-post', '{% url 'empresas_api:empresa-favoritar' empresa.id %}');
              this.removeAttribute('hx-delete');
            }
          "
        >
          {% if empresa.favoritado %}{{ txt_desfavoritar }}{% else %}{{ txt_favoritar }}{% endif %}
        </button>
        {% if request.user == empresa.usuario %}
          <a href="{% url 'empresas:empresa_editar' empresa.id %}" class="btn btn-primary btn-sm">{% trans "Editar" %}</a>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}
