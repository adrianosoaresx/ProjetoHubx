{% load i18n lucide_icons %}
<div id="avaliacoes">
  <h2 class="text-lg font-semibold text-neutral-900">{% trans "Avaliações" %}</h2>
  <p class="text-sm text-neutral-600">
    {% trans "Média" %}: {{ media_avaliacoes|floatformat:1 }}/5 - {{ avaliacoes|length }} {% trans "avaliações" %}
  </p>
  {% if request.user.is_authenticated %}
  <form
    hx-post="{% if avaliacao_usuario %}{% url 'empresas:avaliacao_editar' empresa.id %}{% else %}{% url 'empresas:avaliacao_criar' empresa.id %}{% endif %}"
    hx-target="#avaliacoes"
    hx-swap="outerHTML"
    class="flex flex-col gap-2 mt-2"
  >
    {% csrf_token %}
    <div class="flex gap-1">
      <input type="hidden" name="nota" id="avaliacao-nota" value="{{ avaliacao_usuario.nota|default:0 }}" />
      {% for _ in '12345' %}
        <button
          type="button"
          data-star="{{ forloop.counter }}"
          class="text-yellow-400"
          aria-label="{% trans 'Avaliar com' %} {{ forloop.counter }} {% trans 'estrelas' %}"
        >
          {% if avaliacao_usuario and forloop.counter <= avaliacao_usuario.nota %}
            {% lucide 'star' class='w-5 h-5' fill='currentColor' %}
          {% else %}
            {% lucide 'star' class='w-5 h-5' fill='none' %}
          {% endif %}
        </button>
      {% endfor %}
    </div>
    <input
      type="text"
      name="comentario"
      value="{{ avaliacao_usuario.comentario|default:'' }}"
      placeholder="{% trans 'Comentário (opcional)' %}"
      class="border border-neutral-300 rounded px-2 py-1 text-sm"
    />
    <button type="submit" class="self-start btn btn-primary">{% trans "Enviar" %}</button>
  </form>
  <script>
    document.querySelectorAll('#avaliacoes [data-star]').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var notaInput = document.getElementById('avaliacao-nota');
        notaInput.value = this.dataset.star;
        document.querySelectorAll('#avaliacoes [data-star]').forEach(function (b) {
          var icon = b.querySelector('svg');
          if (parseInt(b.dataset.star) <= notaInput.value) {
            icon.setAttribute('fill', 'currentColor');
          } else {
            icon.setAttribute('fill', 'none');
          }
        });
      });
    });
  </script>
  {% endif %}
  {% if avaliacoes %}
    <ul class="mt-2 space-y-2">
      {% for avaliacao in avaliacoes %}
        <li class="border border-neutral-200 rounded p-2">
          <strong>{{ avaliacao.usuario.get_full_name|default:avaliacao.usuario.email }}</strong> - {{ avaliacao.nota }}/5
          {% if avaliacao.comentario %}
            <p class="text-sm">{{ avaliacao.comentario }}</p>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-sm text-neutral-500">{% trans "Nenhuma avaliação registrada." %}</p>
  {% endif %}
</div>
