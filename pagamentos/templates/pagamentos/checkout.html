{% extends "base.html" %}
{% load i18n widget_tweaks %}

{% block content %}
<div class="max-w-3xl mx-auto py-10 space-y-6">
  <div class="bg-[var(--bg-secondary)] shadow rounded-xl p-6 space-y-2 border border-[var(--border)]">
    <p class="text-xs uppercase font-semibold text-[var(--text-muted)]">{% trans "Pagamento" %}</p>
    <h1 class="text-2xl font-bold text-[var(--text-primary)]">{% trans "Checkout Hubx" %}</h1>
    <p class="text-[var(--text-secondary)]">{% trans "Escolha a melhor forma de pagamento e acompanhe o status em tempo real." %}</p>
  </div>

  <form
    id="checkout-form"
    hx-post="{% url 'pagamentos:checkout' %}"
    hx-target="#checkout-result-content"
    hx-swap="innerHTML"
    method="post"
    class="bg-[var(--bg-secondary)] shadow rounded-xl p-6 space-y-5 border border-[var(--border)]"
  >
    {% csrf_token %}
    {{ form.organizacao_id }}
    {{ form.metodo.as_hidden }}
    {% if inscricao %}
      <input type="hidden" name="inscricao_uuid" value="{{ inscricao.uuid }}">
    {% endif %}

    <div class="space-y-6">
      <div class="space-y-2">
        <label class="text-sm font-medium text-[var(--text-secondary)]" for="id_valor">{% trans "Valor" %}</label>
        {{ form.valor|add_class:"mt-1 w-full rounded-lg border-[var(--border)] bg-[var(--bg-primary)] text-[var(--text-primary)] placeholder:text-[var(--text-muted)] shadow-sm focus:border-[var(--border-focus)] focus:ring-[var(--border-focus)]" }}
        <p class="text-xs text-[var(--text-muted)]">{% trans "Mostramos o total logo no início para evitar surpresas." %}</p>
      </div>

      {% with modo_exibicao=form.data.modo_exibicao|default:form.initial.modo_exibicao|default:'pix' %}
        <fieldset class="space-y-3">
          <legend class="text-sm font-medium text-[var(--text-secondary)]">{% trans "Escolha a forma de pagamento" %}</legend>
          <div class="grid grid-cols-1 gap-3" data-metodo-wrapper>
            <label class="flex items-start gap-3 border border-[var(--border)] rounded-lg px-4 py-4 transition hover:border-[var(--border-focus)] bg-[var(--bg-primary)] peer-checked:border-[var(--border-focus)] peer-checked:bg-[var(--bg-accent)]">
              <input
                type="radio"
                name="modo_exibicao"
                value="pix"
                {% if modo_exibicao == 'pix' %}checked{% endif %}
                class="peer mt-1 text-[var(--primary)] focus:ring-[var(--border-focus)]"
                data-metodo-input
              />
              <div>
                <span class="font-semibold text-[var(--text-primary)]">{% trans "Pix" %}</span>
                <p class="text-xs text-[var(--text-muted)]">{% trans "Pagamento instantâneo com QR Code e confirmação automática." %}</p>
              </div>
            </label>
            <label class="flex items-start gap-3 border border-[var(--border)] rounded-lg px-4 py-4 transition hover:border-[var(--border-focus)] bg-[var(--bg-primary)] peer-checked:border-[var(--border-focus)] peer-checked:bg-[var(--bg-accent)]">
              <input
                type="radio"
                name="modo_exibicao"
                value="faturamento"
                {% if modo_exibicao == 'faturamento' %}checked{% endif %}
                class="peer mt-1 text-[var(--primary)] focus:ring-[var(--border-focus)]"
                data-metodo-input
              />
              <div>
                <span class="font-semibold text-[var(--text-primary)]">{% trans "Faturamento interno" %}</span>
                <p class="text-xs text-[var(--text-muted)]">{% trans "Registre a cobrança sem integração com o provedor." %}</p>
              </div>
            </label>
          </div>
          <p class="text-xs text-[var(--text-muted)]">{% trans "Escolha Pix para pagamento imediato ou faturamento para controle interno." %}</p>
        </fieldset>
      {% endwith %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-2">
          <label class="text-sm font-medium text-[var(--text-secondary)]" for="id_nome">{% trans "Nome completo" %}</label>
          {{ form.nome|add_class:"mt-1 w-full rounded-lg border-[var(--border)] bg-[var(--bg-primary)] text-[var(--text-primary)] placeholder:text-[var(--text-muted)] shadow-sm focus:border-[var(--border-focus)] focus:ring-[var(--border-focus)]" }}
        </div>
        <div class="space-y-2">
          <label class="text-sm font-medium text-[var(--text-secondary)]" for="id_email">{% trans "E-mail" %}</label>
          {{ form.email|add_class:"mt-1 w-full rounded-lg border-[var(--border)] bg-[var(--bg-primary)] text-[var(--text-primary)] placeholder:text-[var(--text-muted)] shadow-sm focus:border-[var(--border-focus)] focus:ring-[var(--border-focus)]" }}
        </div>
        <div class="space-y-2">
          <label class="text-sm font-medium text-[var(--text-secondary)]" for="id_documento">{% trans "Documento" %}</label>
          {{ form.documento|add_class:"mt-1 w-full rounded-lg border-[var(--border)] bg-[var(--bg-primary)] text-[var(--text-primary)] placeholder:text-[var(--text-muted)] shadow-sm focus:border-[var(--border-focus)] focus:ring-[var(--border-focus)]" }}
          <p class="text-xs text-[var(--text-muted)]">{% trans "Usamos o documento para validar o pagador e o método escolhido." %}</p>
        </div>
        <div class="space-y-2">
          <label class="text-sm font-medium text-[var(--text-secondary)]" for="id_descricao">{% trans "Descrição" %}</label>
          {{ form.descricao|add_class:"mt-1 w-full rounded-lg border-[var(--border)] bg-[var(--bg-primary)] text-[var(--text-primary)] placeholder:text-[var(--text-muted)] shadow-sm focus:border-[var(--border-focus)] focus:ring-[var(--border-focus)]" }}
          <p class="text-xs text-[var(--text-muted)]">{% trans "Texto curto para identificar a cobrança." %}</p>
        </div>
      </div>

      <div class="space-y-4">
        <fieldset class="space-y-3 border border-[var(--border)] rounded-lg p-4 bg-[var(--bg-tertiary)]" data-metodo-section="faturamento">
          <legend class="text-sm font-semibold text-[var(--text-primary)]">{% trans "Faturamento" %}</legend>
          <p class="text-xs text-[var(--text-muted)]">
            {% trans "Opção interna para registro no financeiro, sem integração com o Mercado Pago." %}
          </p>
          <div class="grid grid-cols-1 gap-3 md:grid-cols-3">
            <label class="flex items-center gap-3 border border-[var(--border)] rounded-lg px-4 py-3 transition hover:border-[var(--border-focus)] bg-[var(--bg-primary)] peer-checked:border-[var(--border-focus)] peer-checked:bg-[var(--bg-accent)]">
              <input
                type="radio"
                name="faturamento"
                value="faturar_avista"
                class="peer text-[var(--primary)] focus:ring-[var(--border-focus)]"
                data-required="true"
              />
              <span class="font-semibold text-[var(--text-primary)]">{% trans "Faturar à vista" %}</span>
            </label>
            <label class="flex items-center gap-3 border border-[var(--border)] rounded-lg px-4 py-3 transition hover:border-[var(--border-focus)] bg-[var(--bg-primary)] peer-checked:border-[var(--border-focus)] peer-checked:bg-[var(--bg-accent)]">
              <input
                type="radio"
                name="faturamento"
                value="faturar_2x"
                class="peer text-[var(--primary)] focus:ring-[var(--border-focus)]"
                data-required="true"
              />
              <span class="font-semibold text-[var(--text-primary)]">{% trans "Faturar em 2x" %}</span>
            </label>
            <label class="flex items-center gap-3 border border-[var(--border)] rounded-lg px-4 py-3 transition hover:border-[var(--border-focus)] bg-[var(--bg-primary)] peer-checked:border-[var(--border-focus)] peer-checked:bg-[var(--bg-accent)]">
              <input
                type="radio"
                name="faturamento"
                value="faturar_3x"
                class="peer text-[var(--primary)] focus:ring-[var(--border-focus)]"
                data-required="true"
              />
              <span class="font-semibold text-[var(--text-primary)]">{% trans "Faturar em 3x" %}</span>
            </label>
          </div>
        </fieldset>
        <p class="hidden text-xs text-red-600" data-faturamento-error>
          {% trans "Selecione uma forma de faturamento para continuar." %}
        </p>
      </div>
    </div>

    <div class="flex flex-col gap-3">
      <button
        type="submit"
        class="hidden w-full rounded-lg bg-[var(--primary)] px-4 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-[var(--primary-strong)] focus:outline-none focus:ring-2 focus:ring-[var(--border-focus)]"
        data-acao-botao="pix"
      >
        {% trans "Gerar pagamento" %}
      </button>
      <button
        type="submit"
        class="hidden w-full rounded-lg bg-[var(--primary)] px-4 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-[var(--primary-strong)] focus:outline-none focus:ring-2 focus:ring-[var(--border-focus)]"
        data-acao-botao="faturamento"
      >
        {% trans "Faturar" %}
      </button>
    </div>
  </form>

  <div class="bg-[var(--bg-secondary)] shadow rounded-xl p-6 border border-[var(--border)]" id="checkout-result">
    <div class="flex items-center justify-between mb-4">
      <div>
        <p class="text-xs uppercase font-semibold text-[var(--text-muted)]">{% trans "Resumo" %}</p>
        <h2 class="text-xl font-semibold text-[var(--text-primary)]">{% trans "Status do pagamento" %}</h2>
      </div>
    </div>
    <div class="bg-[var(--bg-tertiary)] border border-[var(--border)] rounded-lg p-4" id="checkout-result-content">
      {% include "pagamentos/partials/checkout_resultado.html" %}
    </div>
  </div>
</div>
<script>
  (() => {
    const metodoInputs = Array.from(document.querySelectorAll('[data-metodo-input]'));
    const sections = document.querySelectorAll('[data-metodo-section]');
    const pixFields = document.querySelectorAll('[data-metodo-section="pix"] input');
    const faturamentoInputs = Array.from(document.querySelectorAll('input[name="faturamento"]'));
    const faturamentoError = document.querySelector('[data-faturamento-error]');
    const pixButton = document.querySelector('[data-acao-botao="pix"]');
    const faturamentoButton = document.querySelector('[data-acao-botao="faturamento"]');
    const metodoHiddenInput = document.querySelector('input[name="metodo"]');
    const checkoutForm = document.querySelector('#checkout-form');
    const metodoPorModo = {
      pix: 'pix',
      faturamento: 'pix',
    };

    if (!metodoInputs.find((input) => input.checked) && metodoInputs[0]) {
      metodoInputs[0].checked = true;
    }

    function setSectionVisibility(selected) {
      sections.forEach((section) => {
        const isActive = section.dataset.metodoSection === selected;
        section.classList.toggle('hidden', !isActive);
        const inputs = section.querySelectorAll('input, select, textarea');
        inputs.forEach((input) => {
          if (isActive) {
            input.removeAttribute('disabled');
            if (input.dataset.required !== undefined) {
              input.setAttribute('required', 'required');
            }
          } else {
            input.removeAttribute('required');
            input.setAttribute('disabled', 'disabled');
            if (input.tagName === 'INPUT') {
              const inputType = (input.getAttribute('type') || '').toLowerCase();
              if (inputType === 'radio' || inputType === 'checkbox') {
                input.checked = false;
              } else {
                input.value = '';
              }
            }
          }
        });
      });
    }

    function updateActionButtons(selected) {
      if (pixButton) {
        pixButton.classList.toggle('hidden', selected !== 'pix');
      }
      if (faturamentoButton) {
        const faturamentoSelecionado = faturamentoInputs.some((input) => input.checked);
        faturamentoButton.classList.toggle('hidden', selected !== 'faturamento' || !faturamentoSelecionado);
      }
    }

    function ensureFaturamentoSelecionado() {
      if (faturamentoInputs.some((input) => input.checked)) {
        return true;
      }
      const primeiraOpcao = faturamentoInputs.find((input) => !input.disabled);
      if (primeiraOpcao) {
        primeiraOpcao.checked = true;
        return true;
      }
      return false;
    }

    function toggleFaturamentoError(showError) {
      if (!faturamentoError) {
        return;
      }
      faturamentoError.classList.toggle('hidden', !showError);
    }

    function handleMetodoChange() {
      const selected = metodoInputs.find((input) => input.checked)?.value;
      setSectionVisibility(selected);
      if (metodoHiddenInput) {
        metodoHiddenInput.value = metodoPorModo[selected] || 'pix';
      }
      if (selected !== 'pix') {
        pixFields.forEach((field) => { field.value = ''; });
        if (selected === 'faturamento') {
          ensureFaturamentoSelecionado();
          toggleFaturamentoError(false);
        }
      }
      window.requestAnimationFrame(() => updateActionButtons(selected));
    }

    metodoInputs.forEach((input) => {
      input.addEventListener('change', handleMetodoChange);
    });

    faturamentoInputs.forEach((input) => {
      input.addEventListener('change', handleMetodoChange);
    });

    if (checkoutForm) {
      checkoutForm.addEventListener('submit', (event) => {
        const selected = metodoInputs.find((input) => input.checked)?.value;
        if (selected !== 'faturamento') {
          toggleFaturamentoError(false);
          return;
        }
        setSectionVisibility(selected);
        const faturamentoSelecionado = faturamentoInputs.some((input) => input.checked);
        if (!faturamentoSelecionado) {
          event.preventDefault();
          toggleFaturamentoError(true);
          updateActionButtons(selected);
        } else {
          toggleFaturamentoError(false);
        }
      });
    }

    handleMetodoChange();
  })();
</script>
{% endblock %}
