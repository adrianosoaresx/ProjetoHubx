{% extends "base.html" %}
{% load i18n %}

{% block content %}
<div class="max-w-3xl mx-auto py-10 space-y-6">
  <div class="bg-white shadow rounded-xl p-6 space-y-2">
    <p class="text-xs uppercase font-semibold text-slate-500">{% trans "Pagamento" %}</p>
    <h1 class="text-2xl font-bold text-slate-900">{% trans "Checkout Hubx" %}</h1>
    <p class="text-slate-600">{% trans "Informe seus dados e finalize o pagamento com segurança." %}</p>
  </div>

  <form
    id="checkout-form"
    hx-post="{% url 'pagamentos:checkout' %}"
    hx-target="#checkout-result-content"
    hx-swap="innerHTML"
    method="post"
    class="bg-white shadow rounded-xl p-6 space-y-5"
  >
    {% csrf_token %}
    {{ form.organizacao_id }}

    <div class="space-y-6">
      <div class="space-y-2">
        <label class="text-sm font-medium text-slate-700" for="id_valor">{% trans "Valor" %}</label>
        {{ form.valor|add_class:"mt-1 w-full rounded-lg border-slate-200 shadow-sm" }}
        <p class="text-xs text-slate-500">{% trans "Mostramos o total logo no início para evitar surpresas." %}</p>
      </div>

      <fieldset class="space-y-3">
        <legend class="text-sm font-medium text-slate-700">{% trans "Método de pagamento" %}</legend>
        <div class="grid grid-cols-1 gap-3" data-metodo-wrapper>
          {% for value, label in form.fields.metodo.choices %}
            {% if value == "pix" %}
              <label class="flex items-center gap-3 border rounded-lg px-4 py-3 hover:border-blue-500">
                <input
                  type="radio"
                  name="{{ form.metodo.html_name }}"
                  value="{{ value }}"
                  {% if form.initial.metodo == value %}checked{% endif %}
                  class="text-blue-600 focus:ring-blue-500"
                  data-metodo-input
                />
                <span class="font-semibold text-slate-800">{{ label }}</span>
              </label>
            {% endif %}
          {% endfor %}
        </div>
        <p class="text-xs text-slate-500">{% trans "Exibimos apenas métodos disponíveis para agilizar a escolha." %}</p>
      </fieldset>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="id_nome">{% trans "Nome completo" %}</label>
          {{ form.nome|add_class:"mt-1 w-full rounded-lg border-slate-200 shadow-sm" }}
        </div>
        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="id_email">{% trans "E-mail" %}</label>
          {{ form.email|add_class:"mt-1 w-full rounded-lg border-slate-200 shadow-sm" }}
        </div>
        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="id_documento">{% trans "Documento" %}</label>
          {{ form.documento|add_class:"mt-1 w-full rounded-lg border-slate-200 shadow-sm" }}
          <p class="text-xs text-slate-500">{% trans "Usamos o documento para validar o pagador e o método escolhido." %}</p>
        </div>
        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="id_descricao">{% trans "Descrição" %}</label>
          {{ form.descricao|add_class:"mt-1 w-full rounded-lg border-slate-200 shadow-sm" }}
          <p class="text-xs text-slate-500">{% trans "Texto curto para identificar a cobrança." %}</p>
        </div>
      </div>

      <div class="space-y-4">
        <fieldset class="space-y-3" data-metodo-section="pix">
          <legend class="text-sm font-semibold text-slate-800">{% trans "Pagamento via Pix" %}</legend>
          <p class="text-xs text-slate-500">{% trans "Defina um prazo para expiração do QR Code e, se quiser, personalize a descrição." %}</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium text-slate-700" for="id_pix_descricao">{% trans "Descrição no comprovante" %}</label>
              {{ form.pix_descricao|add_class:"mt-1 w-full rounded-lg border-slate-200 shadow-sm" }}
            </div>
            <div>
              <label class="text-sm font-medium text-slate-700" for="id_pix_expiracao">{% trans "Expira em" %}</label>
              {{ form.pix_expiracao|add_class:"mt-1 w-full rounded-lg border-slate-200 shadow-sm" }}
            </div>
          </div>
        </fieldset>

        <fieldset class="space-y-3">
          <legend class="text-sm font-semibold text-slate-800">{% trans "Faturamento" %}</legend>
          <p class="text-xs text-slate-500">
            {% trans "Opção interna para registro no financeiro, sem integração com o Mercado Pago." %}
          </p>
          <div class="grid grid-cols-1 gap-3 md:grid-cols-3">
            <label class="flex items-center gap-3 border rounded-lg px-4 py-3 hover:border-blue-500">
              <input
                type="radio"
                name="faturamento"
                value="faturar_avista"
                class="text-blue-600 focus:ring-blue-500"
              />
              <span class="font-semibold text-slate-800">{% trans "Faturar à vista" %}</span>
            </label>
            <label class="flex items-center gap-3 border rounded-lg px-4 py-3 hover:border-blue-500">
              <input
                type="radio"
                name="faturamento"
                value="faturar_2x"
                class="text-blue-600 focus:ring-blue-500"
              />
              <span class="font-semibold text-slate-800">{% trans "Faturar em 2x" %}</span>
            </label>
            <label class="flex items-center gap-3 border rounded-lg px-4 py-3 hover:border-blue-500">
              <input
                type="radio"
                name="faturamento"
                value="faturar_3x"
                class="text-blue-600 focus:ring-blue-500"
              />
              <span class="font-semibold text-slate-800">{% trans "Faturar em 3x" %}</span>
            </label>
          </div>
        </fieldset>
      </div>
    </div>

    <button
      type="submit"
      class="inline-flex items-center justify-center w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow"
    >
      {% blocktrans %}Pagar {{ form.valor.value|default:form.initial.valor|default:'R$ 0,00' }}{% endblocktrans %}
    </button>
  </form>

  <div class="bg-white shadow rounded-xl p-6" id="checkout-result">
    <div class="flex items-center justify-between mb-4">
      <div>
        <p class="text-xs uppercase font-semibold text-slate-500">{% trans "Resumo" %}</p>
        <h2 class="text-xl font-semibold text-slate-900">{% trans "Status do pagamento" %}</h2>
      </div>
    </div>
    <div class="bg-slate-50 border border-slate-200 rounded-lg p-4" id="checkout-result-content">
      {% include "pagamentos/partials/checkout_resultado.html" %}
    </div>
  </div>
</div>
<script>
  (() => {
    const metodoInputs = Array.from(document.querySelectorAll('[data-metodo-input]'));
    const sections = document.querySelectorAll('[data-metodo-section]');
    const pixFields = document.querySelectorAll('[data-metodo-section="pix"] input');

    if (!metodoInputs.find((input) => input.checked) && metodoInputs[0]) {
      metodoInputs[0].checked = true;
    }

    function setSectionVisibility(selected) {
      sections.forEach((section) => {
        const isActive = section.dataset.metodoSection === selected;
        section.classList.toggle('hidden', !isActive);
        const inputs = section.querySelectorAll('input, select, textarea');
        inputs.forEach((input) => {
          if (isActive) {
            input.removeAttribute('disabled');
            if (input.dataset.required !== undefined) {
              input.setAttribute('required', 'required');
            }
          } else {
            input.removeAttribute('required');
            input.setAttribute('disabled', 'disabled');
            if (input.tagName === 'INPUT') {
              input.value = '';
            }
          }
        });
      });
    }

    function handleMetodoChange() {
      const selected = metodoInputs.find((input) => input.checked)?.value;
      setSectionVisibility(selected);
      if (selected !== 'pix') {
        pixFields.forEach((field) => { field.value = ''; });
      }
    }

    metodoInputs.forEach((input) => {
      input.addEventListener('change', handleMetodoChange);
    });

    handleMetodoChange();
  })();
</script>
{% endblock %}
