{% load i18n %}
{% url 'organizacoes_api:organizacao-eventos-list' organizacao_pk=organizacao.id as api_url %}
<div class="bg-white p-4 rounded shadow" hx-target="this">
  <h3 class="text-lg font-semibold mb-2">{% trans 'Gerenciar eventos' %}</h3>
  <form hx-post="{{ api_url }}" hx-on="htmx:afterRequest: htmx.ajax('GET', '{{ refresh_url }}', '#eventos-section'); this.closest('#modal').innerHTML='';" class="space-y-2">
    {% csrf_token %}
    <label class="block text-sm" for="evento-search">{% trans 'Buscar evento' %}</label>
    <input
      type="text"
      id="evento-search"
      name="search"
      class="w-full border px-2 py-1 rounded"
      hx-get="{{ api_url }}"
      hx-trigger="keyup changed delay:500ms"
      hx-target="#evento-options"
      hx-swap="none"
      hx-include="[name=search]"
      hx-on="htmx:afterRequest: renderEventos(event)"
    >
    <select name="evento_id" id="evento-options" class="w-full border px-2 py-1 rounded mt-2"></select>
    <button type="submit" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded">{% trans 'Adicionar' %}</button>
  </form>
  <ul class="mt-4 space-y-1">
    {% for evento in eventos %}
      <li class="flex justify-between items-center">
        {{ evento.titulo }}
        <button hx-delete="{{ api_url }}{{ evento.id }}/" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}' hx-on="htmx:afterRequest: htmx.ajax('GET', '{{ refresh_url }}', '#eventos-section');" class="text-red-600 text-sm">{% trans 'Remover' %}</button>
      </li>
    {% empty %}
      <li class="text-neutral-500 text-sm">{% trans 'Nenhum evento associado.' %}</li>
    {% endfor %}
  </ul>
  <script src="{% url 'javascript-catalog' %}"></script>
  <script>
    function renderEventos(evt) {
      const sel = document.querySelector('#evento-options');
      sel.innerHTML = '';
      try {
        const data = JSON.parse(evt.detail.xhr.response);
        const itens = data.results || data;
        sel.innerHTML =
          itens
            .map(e => `<option value="${e.id}">${e.titulo}</option>`)
            .join('') || `<option value="">${gettext('Nenhum resultado')}</option>`;
      } catch (err) {
        sel.innerHTML = `<option value="">${gettext('Erro ao carregar')}</option>`;
      }
    }
  </script>
</div>
