{% load i18n lucide_icons %}
<div class="modal !active" role="dialog" aria-modal="true" aria-labelledby="perfil-feedback-title" data-modal-root>
  <div class="modal-content rounded-lg bg-[var(--bg-primary)] shadow-xl focus:outline-none">
    <div class="flex items-start justify-between gap-4 border-b border-[var(--border)] px-6 py-4">
      <h2 id="perfil-feedback-title" class="text-xl font-semibold text-[var(--text-primary)]">
        {% blocktrans with profile_name=perfil.display_name %}Avaliar {{ profile_name }}{% endblocktrans %}
      </h2>
      <button type="button" class="btn btn-secondary" aria-label="{% trans 'Fechar modal' %}" data-modal-dismiss>
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="px-6 py-5 space-y-5">
      {% if feedback_exists and feedback %}
        <div class="rounded-lg border border-[var(--border)] bg-[var(--bg-secondary)] p-4 text-sm text-[var(--text-primary)] space-y-2">
          <p class="font-medium flex items-center gap-2">
            {% trans "Você já enviou uma avaliação para este perfil." %}
            <span class="inline-flex items-center rounded-full bg-[var(--primary)]/10 px-2 py-0.5 text-xs font-semibold text-[var(--primary)]">{{ feedback.score }}/5</span>
          </p>
          {% if feedback.comment %}
            <p class="text-[var(--text-secondary)]">{{ feedback.comment }}</p>
          {% endif %}
        </div>
        <div class="flex justify-end">
          <button type="button" class="btn btn-primary" data-modal-dismiss>{% trans "Fechar" %}</button>
        </div>
      {% else %}
        <form
          method="post"
          action="{% url 'accounts:perfil_avaliar' perfil.public_id %}"
          class="space-y-4"
          hx-post="{% url 'accounts:perfil_avaliar' perfil.public_id %}"
          hx-target="#modal"
          hx-swap="innerHTML"
          hx-on="htmx:beforeRequest: window.HubxModalTrigger = this;"
        >
          {% csrf_token %}
          {{ form.non_field_errors }}
          <div class="space-y-1" data-rating-stars>
            <label for="{{ form.score.id_for_label }}" class="block text-sm font-medium text-[var(--text-primary)]">
              {{ form.score.label }}{% if form.score.field.required %} *{% endif %}
            </label>
            <input
              type="hidden"
              name="{{ form.score.html_name }}"
              id="{{ form.score.id_for_label }}"
              value="{{ form.score.value|default_if_none:'' }}"
            />
            <div
              class="flex items-center gap-2"
              role="radiogroup"
              aria-labelledby="{{ form.score.id_for_label }}-label"
              aria-required="{% if form.score.field.required %}true{% else %}false{% endif %}"
            >
              <span id="{{ form.score.id_for_label }}-label" class="sr-only">{{ form.score.label }}</span>
              {% for star_value in "12345" %}
                <button
                  type="button"
                  class="flex h-10 w-10 items-center justify-center rounded-md border border-transparent text-[var(--text-muted)] transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--primary)]"
                  data-value="{{ forloop.counter }}"
                  data-rating-star
                  role="radio"
                  aria-checked="false"
                  aria-label="{% blocktrans with value=forloop.counter %}{{ value }} de 5{% endblocktrans %}"
                >
                  {% lucide 'star' class='h-7 w-7' aria_hidden='true' data_star_icon='true' %}
                </button>
              {% endfor %}
            </div>
            {% if form.score.errors %}
              <ul class="errorlist">
                {% for error in form.score.errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            {% endif %}
            {% if form.score.help_text %}
              <p class="text-xs text-[var(--text-secondary)]">{{ form.score.help_text }}</p>
            {% endif %}
          </div>
          {% include '_forms/field.html' with field=form.comment %}

          <div class="flex justify-end gap-3 border-t border-[var(--border)] pt-4">
            <button type="button" class="btn btn-secondary" data-modal-dismiss>{% trans "Cancelar" %}</button>
            <button type="submit" class="btn btn-primary">{% trans "Enviar avaliação" %}</button>
          </div>
        </form>
      {% endif %}
    </div>
  </div>
</div>
<script>
  (function () {
    const modalContainer = document.getElementById('modal');
    if (!modalContainer) return;
    const dialog = modalContainer.querySelector('[data-modal-root]');
    if (!dialog) return;

    const focusableSelectors = [
      'a[href]','area[href]','input:not([disabled])','select:not([disabled])','textarea:not([disabled])',
      'button:not([disabled])','[tabindex]:not([tabindex="-1"])'
    ].join(',');
    const focusableElements = Array.from(dialog.querySelectorAll(focusableSelectors)).filter((el) => !el.hasAttribute('hidden'));
    const previouslyFocused = window.HubxModalTrigger instanceof HTMLElement ? window.HubxModalTrigger : document.activeElement;

    function closeModal(event) {
      if (event) {
        event.preventDefault();
      }
      modalContainer.innerHTML = '';
      if (previouslyFocused && typeof previouslyFocused.focus === 'function') {
        previouslyFocused.focus();
      }
      if (window.HubxModalTrigger) {
        window.HubxModalTrigger = null;
      }
    }

    dialog.addEventListener('click', (event) => {
      if (event.target === dialog) {
        closeModal(event);
      }
    });

    const cancelButtons = dialog.querySelectorAll('[data-modal-dismiss]');
    cancelButtons.forEach((button) => button.addEventListener('click', closeModal));

    modalContainer.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeModal(event);
      }
      if (event.key === 'Tab' && focusableElements.length) {
        const first = focusableElements[0];
        const last = focusableElements[focusableElements.length - 1];
        if (event.shiftKey && document.activeElement === first) {
          event.preventDefault();
          last.focus();
        } else if (!event.shiftKey && document.activeElement === last) {
          event.preventDefault();
          first.focus();
        }
      }
    });

    if (focusableElements.length) {
      focusableElements[0].focus();
    }
  })();

  (function () {
    const dialog = document.querySelector('[data-modal-root]');
    if (!dialog) return;

    const ratingContainers = dialog.querySelectorAll('[data-rating-stars]');
    ratingContainers.forEach((container) => {
      const hiddenInput = container.querySelector('input[type="hidden"][name="score"]');
      const stars = Array.from(container.querySelectorAll('[data-rating-star]'));
      if (!hiddenInput || !stars.length) return;

      let currentValue = parseInt(hiddenInput.value, 10) || 0;

      const applyState = (value) => {
        stars.forEach((star) => {
          const starValue = Number(star.dataset.value);
          const icon = star.querySelector('[data-star-icon]');
          const isActive = value >= starValue;
          star.setAttribute('aria-checked', value === starValue ? 'true' : 'false');
          star.setAttribute('tabindex', starValue === (value || 1) ? '0' : '-1');

          star.classList.toggle('text-[#FFD700]', isActive);
          star.classList.toggle('fill-[#FFD700]', isActive);
          star.classList.toggle('text-[var(--text-muted)]', !isActive);
          if (icon) {
            icon.classList.toggle('text-[#FFD700]', isActive);
            icon.classList.toggle('fill-[#FFD700]', isActive);
            icon.classList.toggle('fill-transparent', !isActive);
          }
        });
      };

      const commitValue = (value) => {
        currentValue = value;
        hiddenInput.value = value;
        applyState(value);
      };

      applyState(currentValue);

      stars.forEach((star) => {
        const starValue = Number(star.dataset.value);

        star.addEventListener('mouseenter', () => applyState(starValue));
        star.addEventListener('mouseleave', () => applyState(currentValue));

        star.addEventListener('click', () => {
          commitValue(starValue);
          star.focus();
        });

        star.addEventListener('keydown', (event) => {
          const keys = ['Enter', ' '];
          if (keys.includes(event.key)) {
            event.preventDefault();
            commitValue(starValue);
            return;
          }

          if (event.key === 'ArrowRight' || event.key === 'ArrowUp') {
            event.preventDefault();
            const nextValue = Math.min(5, (currentValue || 0) + 1);
            commitValue(nextValue);
            stars[nextValue - 1]?.focus();
          }

          if (event.key === 'ArrowLeft' || event.key === 'ArrowDown') {
            event.preventDefault();
            const prevValue = Math.max(1, (currentValue || 1) - 1);
            commitValue(prevValue);
            stars[prevValue - 1]?.focus();
          }
        });
      });

      container.addEventListener('mouseleave', () => applyState(currentValue));
    });
  })();
</script>
