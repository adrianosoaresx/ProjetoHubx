{% extends "base.html" %}
{% load i18n static lucide_icons %}

{% block hero %}
  {% include "_components/hero_profile.html" with is_owner=is_owner profile=profile hero_title=hero_title hero_subtitle=hero_subtitle %}
{% endblock %}

{% block content %}

<div class="space-y-6">

      {% with default_section=perfil_default_section|default:"info" %}
        {% trans "Informações do perfil" as info_title %}
        {% blocktrans with profile_name=profile.display_name asvar info_subtitle %}
          Visualize e gerencie as informações de {{ profile_name }}.
        {% endblocktrans %}
        {% trans "Carregando conteúdo..." as perfil_loading_text %}
        {% trans "Não foi possível carregar esta seção." as perfil_error_text %}
        {% with perfil_mode_value=perfil_mode|default:'public' %}
          {% with perfil_hx_push_url='?section='|add:default_section %}
            {% if is_owner %}
              {% with perfil_hx_vals='{"section":"'|add:default_section|add:'"}' %}
                {% include "perfil/partials/info_accordion.html" with
                  content_id='perfil-content'
                  title=info_title
                  subtitle=info_subtitle
                  icon='contact'
                  data_perfil_mode=perfil_mode_value
                  data_perfil_username=profile.username
                  data_perfil_public_id=profile.public_id
                  data_perfil_default_url=perfil_default_url
                  data_perfil_default_section=default_section
                  data_perfil_loading_text=perfil_loading_text
                  data_perfil_error_text=perfil_error_text
                  hx_trigger='load'
                  hx_get=perfil_default_url
                  hx_target='#perfil-content'
                  hx_push_url=perfil_hx_push_url
                  hx_vals=perfil_hx_vals
                %}
              {% endwith %}
            {% else %}
              {% with perfil_hx_vals='{"section":"'|add:default_section|add:'","public_id":"'|add:profile.public_id|escapejs|add:'","username":"'|add:profile.username|escapejs|add:'"}' %}
                {% include "perfil/partials/info_accordion.html" with
                  content_id='perfil-content'
                  title=info_title
                  subtitle=info_subtitle
                  icon='contact'
                  data_perfil_mode=perfil_mode_value
                  data_perfil_username=profile.username
                  data_perfil_public_id=profile.public_id
                  data_perfil_default_url=perfil_default_url
                  data_perfil_default_section=default_section
                  data_perfil_loading_text=perfil_loading_text
                  data_perfil_error_text=perfil_error_text
                  hx_trigger='load'
                  hx_get=perfil_default_url
                  hx_target='#perfil-content'
                  hx_push_url=perfil_hx_push_url
                  hx_vals=perfil_hx_vals
                %}
              {% endwith %}
            {% endif %}
          {% endwith %}
        {% endwith %}
      {% endwith %}

      <section id="perfil-posts-accordion" class="card" data-accordion>
        <div class="card-header flex flex-wrap items-center justify-between gap-3">
          <button
            type="button"
            class="flex w-full items-center justify-between gap-3 text-left sm:flex-1"
            data-accordion-toggle
            aria-expanded="false"
            aria-controls="perfil-posts-panel"
          >
            <div class="flex items-start gap-3">
              <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--primary)]/10 text-[var(--primary)] shadow-lg shadow-[var(--primary)]/20">
                {% lucide 'newspaper' class='h-6 w-6' aria_hidden='true' %}
              </span>
              <div class="space-y-1">
                <h3 class="text-xl font-semibold">{% trans "Minhas postagens" %}</h3>
                <p class="text-sm text-[var(--text-secondary)]">{% trans "Acompanhe todas as publicações feitas por você." %}</p>
              </div>
            </div>
            <svg
              class="h-5 w-5 shrink-0 text-[var(--text-secondary)] transition-transform duration-200"
              data-accordion-icon
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          {% if is_owner %}
            <a
              href="{% url 'feed:nova_postagem' %}?tipo_feed=usuario&back=minhas-postagens"
              class="btn btn-primary w-full sm:w-auto"
            >
              {% trans "Nova postagem" %}
            </a>
          {% endif %}
        </div>

        <div
          id="perfil-posts-panel"
          class="card-body space-y-6 border-t border-[var(--border)] hidden"
          data-accordion-panel
        >
          {% include "feed/_grid.html" with posts=profile_posts back_origin='minhas-postagens' %}
        </div>
      </section>

</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script src="{% static 'feed/js/feed.js' %}"></script>
  <script type="module" src="{% static 'perfil/js/perfil.js' %}"></script>
  <script>
    (function () {
      const accordion = document.getElementById('perfil-posts-accordion');
      if (!accordion) {
        return;
      }

      const toggle = accordion.querySelector('[data-accordion-toggle]');
      const panel = accordion.querySelector('[data-accordion-panel]');
      const icon = accordion.querySelector('[data-accordion-icon]');

      if (!(toggle instanceof HTMLElement) || !(panel instanceof HTMLElement)) {
        return;
      }

      const setExpanded = (expanded) => {
        toggle.setAttribute('aria-expanded', String(expanded));
        panel.classList.toggle('hidden', !expanded);
        if (icon instanceof HTMLElement) {
          icon.classList.toggle('rotate-180', expanded);
        }
      };

      const hash = window.location.hash;
      const postTarget = hash.startsWith('#post-') ? document.querySelector(hash) : null;
      const initialExpanded = toggle.getAttribute('aria-expanded') === 'true';
      const shouldExpandFromHash = hash === '#perfil-posts-accordion' || postTarget instanceof HTMLElement;
      setExpanded(shouldExpandFromHash || initialExpanded);

      if (postTarget instanceof HTMLElement) {
        requestAnimationFrame(() => {
          postTarget.focus({ preventScroll: true });
          postTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      } else if (shouldExpandFromHash) {
        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      toggle.addEventListener('click', () => {
        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
        setExpanded(!isExpanded);
      });
    })();
  </script>
{% endblock %}

