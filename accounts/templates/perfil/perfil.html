{% extends "base.html" %}
{% load i18n static lucide_icons %}

{% block hero %}
  {% include "_components/hero_profile.html" with is_owner=is_owner profile=profile hero_title=hero_title hero_subtitle=hero_subtitle %}
{% endblock %}

{% block content %}

<div class="space-y-6">

      {% with default_section=perfil_default_section|default:"info" %}
        <section
          id="perfil-content"
          class="space-y-6"
          data-perfil-default-url="{{ perfil_default_url }}"
          data-perfil-default-section="{{ default_section }}"
          data-perfil-mode="{% if is_owner %}owner{% else %}public{% endif %}"
          data-perfil-username="{{ profile.username }}"
          data-perfil-public-id="{{ profile.public_id }}"
          data-perfil-loading-text="{% trans 'Carregando conteúdo...' %}"
          data-perfil-error-text="{% trans 'Não foi possível carregar esta seção.' %}"
          aria-live="polite"
          aria-busy="true"
          hx-trigger="load"
          hx-get="{{ perfil_default_url }}"
          hx-target="#perfil-content"
          {% if default_section %}
            hx-push-url="?section={{ default_section }}"
          {% endif %}
          {% if is_owner %}
            hx-vals='{"section":"{{ default_section }}"}'
          {% else %}
            hx-vals='{"section":"{{ default_section }}","public_id":"{{ profile.public_id|escapejs }}","username":"{{ profile.username|escapejs }}"}'
          {% endif %}
        >
          <div class="py-6 text-center text-sm text-[var(--text-secondary)]" data-perfil-placeholder>
            {% trans "Carregando conteúdo..." %}
          </div>
        </section>
      {% endwith %}

      <section id="perfil-posts-accordion" class="card" data-accordion>
        <div class="card-header flex flex-wrap items-center justify-between gap-3">
          <button
            type="button"
            class="flex w-full items-center justify-between gap-3 text-left sm:flex-1"
            data-accordion-toggle
            aria-expanded="false"
            aria-controls="perfil-posts-panel"
          >
            <div class="flex items-start gap-3">
              <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--primary)]/10 text-[var(--primary)] shadow-lg shadow-[var(--primary)]/20">
                {% lucide 'newspaper' class='h-6 w-6' aria_hidden='true' %}
              </span>
              <div class="space-y-1">
                <h3 class="text-xl font-semibold">{% trans "Minhas postagens" %}</h3>
                <p class="text-sm text-[var(--text-secondary)]">{% trans "Acompanhe todas as publicações feitas por você." %}</p>
              </div>
            </div>
            <svg
              class="h-5 w-5 shrink-0 text-[var(--text-secondary)] transition-transform duration-200"
              data-accordion-icon
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          {% if is_owner %}
            <a
              href="{% url 'feed:nova_postagem' %}?tipo_feed=usuario&back=minhas-postagens"
              class="btn btn-primary w-full sm:w-auto"
            >
              {% trans "Nova postagem" %}
            </a>
          {% endif %}
        </div>

        <div
          id="perfil-posts-panel"
          class="card-body space-y-6 border-t border-[var(--border)] hidden"
          data-accordion-panel
        >
          {% include "feed/_grid.html" with posts=profile_posts back_origin='minhas-postagens' %}
        </div>
      </section>

</div>

<div id="modal" aria-live="polite"></div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script src="{% static 'feed/js/feed.js' %}"></script>
  <script type="module" src="{% static 'perfil/js/perfil.js' %}"></script>
  <script>
    (function () {
      const accordion = document.getElementById('perfil-posts-accordion');
      if (!accordion) {
        return;
      }

      const toggle = accordion.querySelector('[data-accordion-toggle]');
      const panel = accordion.querySelector('[data-accordion-panel]');
      const icon = accordion.querySelector('[data-accordion-icon]');

      if (!(toggle instanceof HTMLElement) || !(panel instanceof HTMLElement)) {
        return;
      }

      const setExpanded = (expanded) => {
        toggle.setAttribute('aria-expanded', String(expanded));
        panel.classList.toggle('hidden', !expanded);
        if (icon instanceof HTMLElement) {
          icon.classList.toggle('rotate-180', expanded);
        }
      };

      const hash = window.location.hash;
      const postTarget = hash.startsWith('#post-') ? document.querySelector(hash) : null;
      const initialExpanded = toggle.getAttribute('aria-expanded') === 'true';
      const shouldExpandFromHash = hash === '#perfil-posts-accordion' || postTarget instanceof HTMLElement;
      setExpanded(shouldExpandFromHash || initialExpanded);

      if (postTarget instanceof HTMLElement) {
        requestAnimationFrame(() => {
          postTarget.focus({ preventScroll: true });
          postTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      } else if (shouldExpandFromHash) {
        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      toggle.addEventListener('click', () => {
        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
        setExpanded(!isExpanded);
      });
    })();
  </script>
{% endblock %}

