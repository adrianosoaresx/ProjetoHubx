
{% extends 'base.html' %}
{% load i18n string_filters associados_extras %}

{% block title %}{% trans 'Promover associado' %}{% endblock %}

{% block hero %}
  {% include '_components/hero_associados.html' with title=_('Promover associado') total_usuarios=None total_associados=None total_nucleados=None action_template=None %}
{% endblock %}

{% block content %}
<section class="py-10">
  <div class="card max-w-4xl mx-auto">
    <div class="card-header">
      <div>
        <h2 class="text-xl font-semibold text-[var(--text-primary)]">{% trans 'Promover associado' %}</h2>
        <p class="mt-1 text-sm text-[var(--text-secondary)]">{% blocktrans with name=associado.display_name|default:associado.username %}Defina como {{ name }} será promovido(a).{% endblocktrans %}</p>
      </div>
    </div>
    <div class="card-body space-y-8">
      {% if form_errors %}
        <div class="rounded-lg border border-[var(--error)] bg-[var(--error-light)] px-4 py-3 text-sm text-[var(--error)]" role="alert">

          <ul class="list-disc list-inside space-y-1">
            {% for error in form_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>

      {% endif %}

      {% if success_message %}
        <div class="rounded-lg border border-[var(--success)] bg-[var(--success-light)] px-4 py-3 text-sm text-[var(--success)]" role="status">
          {{ success_message }}
        </div>
      {% endif %}

      <form method="post" class="space-y-8" data-promover-form data-user-role-map="{{ user_role_map_json|default:'{}'|escapejs }}" data-restricted-roles="{{ restricted_roles|join:',' }}">
        {% csrf_token %}
        <div>
          <label class="block text-sm font-medium text-[var(--text-muted)]" for="associado-nome">{% trans 'Associado' %}</label>
          <input
            id="associado-nome"
            type="text"
            class="mt-1 w-full rounded-lg border border-[var(--border)] bg-[var(--bg-secondary)] px-3 py-2 text-sm text-[var(--text-primary)]"
            value="{{ associado.display_name|default:associado.username }}"
            readonly
          >
          {% usuario_badges associado as usuario_badges_list %}
          {% if usuario_badges_list %}
          <div class="mt-3 flex flex-wrap gap-2">
            {% for badge in usuario_badges_list %}
              <span class="inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-medium uppercase tracking-wide" style="{{ badge.style }}">{{ badge.label }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        <div class="rounded-lg border border-dashed border-[var(--border)] bg-[var(--bg-tertiary)]/60 px-4 py-3 text-sm text-[var(--text-secondary)]">
          <p>{% trans 'Defina abaixo em quais núcleos o associado atuará e quais papéis deverá assumir.' %}</p>
          <ul class="mt-2 list-disc list-inside space-y-1">
            <li>{% trans 'É possível combinar mais de um papel por núcleo.' %}</li>
            <li>{% trans 'Ao escolher coordenador, selecione também o papel correspondente.' %}</li>
            <li>{% trans 'Coordenador geral e vice coordenador não podem repetir o mesmo papel em núcleos diferentes.' %}</li>
          </ul>
        </div>

        <fieldset class="space-y-5" data-nucleos-list>
          <legend class="text-sm font-medium text-[var(--text-muted)]">{% trans 'Promoções por núcleo' %}</legend>
          {% if nucleos %}
            {% for nucleo in nucleos %}
              <article
                class="space-y-4 rounded-xl border border-[var(--border)] bg-[var(--bg-secondary)] p-5 shadow-sm transition"
                data-nucleo-item
                data-nucleo-id="{{ nucleo.id }}"
                data-unavailable-roles="{{ nucleo.unavailable_roles|join:',' }}"
                data-user-current-roles="{{ nucleo.user_current_roles|join:',' }}"
                data-unavailable-message-map="{{ nucleo.unavailable_messages_json|default:'{}'|escapejs }}"
              >
                <header class="flex flex-wrap items-center justify-between gap-2">
                  <div class="flex items-start gap-3">
                    {% if nucleo.avatar_url %}
                      <img src="{{ nucleo.avatar_url }}" alt="{% blocktrans with nome=nucleo.nome %}Avatar do núcleo {{ nome }}{% endblocktrans %}" class="h-12 w-12 rounded-full object-cover" loading="lazy">
                    {% else %}
                      <div class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--bg-tertiary)] text-sm font-semibold uppercase text-[var(--text-muted)]">
                        {{ nucleo.nome|slice:":2"|upper }}
                      </div>
                    {% endif %}
                    <div class="space-y-1">
                      <h3 class="text-base font-semibold text-[var(--text-primary)]">{{ nucleo.nome }}</h3>
                    <div class="flex flex-wrap gap-2">
                      {% if nucleo.is_current_member %}
                        <span class="inline-flex items-center rounded-full bg-[var(--bg-tertiary)] px-2 py-0.5 text-[11px] font-medium uppercase tracking-wide text-[var(--text-secondary)]">{% trans 'Membro atual' %}</span>
                      {% endif %}
                      {% if nucleo.is_current_consultor %}
                        <span class="inline-flex items-center rounded-full bg-[var(--success-light)] px-2 py-0.5 text-[11px] font-medium uppercase tracking-wide text-[var(--success)]">{% trans 'Consultor atual' %}</span>
                      {% endif %}
                      {% for role in nucleo.user_current_roles %}
                        <span class="inline-flex items-center rounded-full bg-[var(--primary-light)] px-2 py-0.5 text-[11px] font-medium uppercase tracking-wide text-primary">{{ coordenador_role_labels|get_item:role }}</span>
                      {% endfor %}
                    </div>
                  </div>
                  </div>
                </header>

                <div class="grid gap-3 lg:grid-cols-3">
                  <label class="flex items-start gap-3 rounded-lg border border-[var(--border)] bg-[var(--bg-primary)]/40 p-3">
                    <input
                      type="checkbox"
                      name="nucleado_nucleos"
                      value="{{ nucleo.id }}"
                      class="mt-1 h-4 w-4 rounded border-[var(--border)] text-primary focus:ring-primary"
                      data-role-checkbox="nucleado"
                      {% if nucleo.id in selected_nucleado %}checked{% endif %}
                      {% if nucleo.is_current_member or nucleo.is_current_coordinator %}disabled aria-disabled="true"{% endif %}
                    >
                    <span class="flex-1 space-y-1">
                      <span class="block text-sm font-medium text-[var(--text-primary)]">{% trans 'Promover a nucleado' %}</span>
                      {% if nucleo.is_current_member or nucleo.is_current_coordinator %}
                        <span class="block text-xs text-[var(--success)]">{% trans 'Associado já é nucleado neste núcleo.' %}</span>
                      {% else %}
                        <span class="block text-xs text-[var(--text-secondary)]">{% trans 'Garante participação ativa como membro do núcleo escolhido.' %}</span>
                      {% endif %}
                    </span>
                  </label>
                  {% if nucleo.is_current_member and not nucleo.is_current_coordinator %}
                    <label class="flex items-start gap-3 rounded-lg border border-dashed border-[var(--border)] bg-[var(--bg-primary)]/20 p-3">
                      <input
                        type="checkbox"
                        name="remover_nucleado_nucleos"
                        value="{{ nucleo.id }}"
                        class="mt-1 h-4 w-4 rounded border-[var(--border)] text-[var(--error)] focus:ring-[var(--error)]"
                        {% if nucleo.id in selected_remover_nucleado %}checked{% endif %}
                      >
                      <span class="flex-1 space-y-1">
                        <span class="block text-sm font-medium text-[var(--error)]">{% trans 'Remover promoção de nucleado' %}</span>
                        <span class="block text-xs text-[var(--text-secondary)]">{% trans 'Interrompe a participação ativa do associado neste núcleo.' %}</span>
                      </span>
                    </label>
                  {% else %}
                    <div class="rounded-lg border border-transparent"></div>
                  {% endif %}

                  <label class="flex items-start gap-3 rounded-lg border border-[var(--border)] bg-[var(--bg-primary)]/40 p-3">
                    <input
                      type="checkbox"
                      name="consultor_nucleos"
                      value="{{ nucleo.id }}"
                      class="mt-1 h-4 w-4 rounded border-[var(--border)] text-primary focus:ring-primary"
                      data-role-checkbox="consultor"
                      {% if nucleo.id in selected_consultor %}checked{% endif %}
                      {% if nucleo.consultor_name and not nucleo.is_current_consultor %}
                        disabled aria-disabled="true"
                      {% elif nucleo.is_current_consultor %}
                        disabled aria-disabled="true"
                      {% endif %}
                    >
                    <span class="flex-1 space-y-1">
                      <span class="block text-sm font-medium text-[var(--text-primary)]">{% trans 'Promover a consultor' %}</span>
                      {% if nucleo.is_current_consultor %}
                        <span class="block text-xs text-[var(--success)]">{% trans 'Associado já é consultor deste núcleo.' %}</span>
                      {% elif nucleo.consultor_name %}
                        <span class="block text-xs text-[var(--error)]">{% blocktrans with nome=nucleo.consultor_name %}Consultoria em andamento com {{ nome }}.{% endblocktrans %}</span>
                      {% else %}
                        <span class="block text-xs text-[var(--text-secondary)]">{% trans 'Permite atuação consultiva em estratégias e ações do núcleo.' %}</span>
                      {% endif %}
                    </span>
                  </label>
                  {% if nucleo.is_current_consultor %}
                    <label class="flex items-start gap-3 rounded-lg border border-dashed border-[var(--border)] bg-[var(--bg-primary)]/20 p-3">
                      <input
                        type="checkbox"
                        name="remover_consultor_nucleos"
                        value="{{ nucleo.id }}"
                        class="mt-1 h-4 w-4 rounded border-[var(--border)] text-[var(--error)] focus:ring-[var(--error)]"
                        {% if nucleo.id in selected_remover_consultor %}checked{% endif %}
                      >
                      <span class="flex-1 space-y-1">
                        <span class="block text-sm font-medium text-[var(--error)]">{% trans 'Remover promoção de consultor' %}</span>
                        <span class="block text-xs text-[var(--text-secondary)]">{% trans 'Libera o núcleo para definir um novo consultor.' %}</span>
                      </span>
                    </label>
                  {% else %}
                    <div class="rounded-lg border border-transparent"></div>
                  {% endif %}

                  <div class="rounded-lg border border-[var(--border)] bg-[var(--bg-primary)]/40 p-3" data-coordenador-card>
                    <label class="flex items-start gap-3">
                      <input
                        type="checkbox"
                        name="coordenador_nucleos"
                        value="{{ nucleo.id }}"
                        class="mt-1 h-4 w-4 rounded border-[var(--border)] text-primary focus:ring-primary"
                        data-role-checkbox="coordenador"
                        {% if nucleo.id in selected_coordenador %}checked{% endif %}
                        {% if nucleo.is_current_coordinator %}disabled aria-disabled="true"{% endif %}
                      >
                      <span class="flex-1 space-y-1">
                        <span class="block text-sm font-medium text-[var(--text-primary)]">{% trans 'Promover a coordenador' %}</span>
                        {% if nucleo.is_current_coordinator %}
                          <span class="block text-xs text-[var(--success)]">{% trans 'Associado já atua como coordenador neste núcleo.' %}</span>
                        {% else %}
                          <span class="block text-xs text-[var(--text-secondary)]">{% trans 'Escolha o papel de coordenação específico para este núcleo.' %}</span>
                        {% endif %}
                      </span>
                    </label>
                    <div class="mt-3 space-y-2 {% if nucleo.id not in selected_coordenador %}hidden{% endif %}" data-coordenador-fields>
                      <label class="block text-xs font-medium uppercase tracking-wide text-[var(--text-muted)]" for="coordenador-papel-{{ nucleo.id }}">{% trans 'Papel de coordenação' %}</label>
                      <select
                        id="coordenador-papel-{{ nucleo.id }}"
                        name="coordenador_papel_{{ nucleo.id }}"
                        class="w-full rounded-lg border border-[var(--border)] bg-[var(--bg-primary)] px-3 py-2 text-sm text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-primary/30"
                        data-coordenador-select
                        {% if nucleo.id not in selected_coordenador %}disabled{% endif %}
                      >
                        <option value="">{% trans 'Selecione um papel' %}</option>
                        {% for value, label in coordenador_role_choices %}
                          <option
                            value="{{ value }}"
                            data-role-value="{{ value }}"
                            data-locked="{% if value in nucleo.unavailable_roles and value not in nucleo.user_current_roles %}true{% else %}false{% endif %}"
                            {% if value in nucleo.unavailable_roles and value not in nucleo.user_current_roles %}disabled{% endif %}
                            {# Removidos parênteses que quebravam o parser e comparação direta com filtro #}
                            {% if value == selected_coordenador_roles|get_item:nucleo.id %}selected{% endif %}
                          >
                            {{ label }}{% if value in nucleo.unavailable_roles and value not in nucleo.user_current_roles %} — {% trans 'Indisponível' %}{% endif %}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  {% if nucleo.is_current_coordinator %}
                    <label class="flex items-start gap-3 rounded-lg border border-dashed border-[var(--border)] bg-[var(--bg-primary)]/20 p-3">
                      <input
                        type="checkbox"
                        name="remover_coordenador_nucleos"
                        value="{{ nucleo.id }}"
                        class="mt-1 h-4 w-4 rounded border-[var(--border)] text-[var(--error)] focus:ring-[var(--error)]"
                        {% if nucleo.id in selected_remover_coordenador %}checked{% endif %}
                      >
                      <span class="flex-1 space-y-1">
                        <span class="block text-sm font-medium text-[var(--error)]">{% trans 'Remover promoção de coordenador' %}</span>
                        <span class="block text-xs text-[var(--text-secondary)]">{% trans 'Retira o papel de coordenação mantendo a participação como membro.' %}</span>
                      </span>
                    </label>
                  {% else %}
                    <div class="rounded-lg border border-transparent"></div>
                  {% endif %}
                </div>

                <div class="space-y-2 rounded-lg bg-[var(--bg-primary)]/40 p-3 text-xs text-[var(--text-secondary)]">
                  {% if nucleo.consultor_name %}
                    <p><span class="font-medium text-[var(--text-muted)]">{% trans 'Consultor atual:' %}</span> {{ nucleo.consultor_name }}</p>
                  {% endif %}
                  <div>
                    <p class="font-medium uppercase tracking-wide text-[var(--text-muted)]">{% trans 'Coordenadores ativos' %}</p>
                    {% if nucleo.coordenadores %}
                      <ul class="mt-2 space-y-1">
                        {% for coord in nucleo.coordenadores %}
                          <li class="flex flex-wrap items-center gap-2">
                            <span class="inline-flex items-center rounded-full bg-[var(--bg-tertiary)] px-2 py-0.5 text-[10px] font-medium uppercase tracking-wide text-[var(--text-secondary)]">{{ coordenador_role_labels|get_item:coord.papel }}</span>
                            <span>{{ coord.user_name }}</span>
                            {% if coord.is_target_user %}
                              <span class="inline-flex items-center rounded-full bg-[var(--success-light)] px-2 py-0.5 text-[10px] font-semibold uppercase text-[var(--success)]">{% trans 'Associado selecionado' %}</span>
                            {% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      <p>{% trans 'Nenhum coordenador cadastrado.' %}</p>
                    {% endif %}
                  </div>
                </div>

                <p class="hidden text-xs font-medium text-[var(--error)]" data-nucleo-warning></p>
              </article>
            {% endfor %}
          {% else %}
            <p class="text-sm text-[var(--text-muted)]">{% trans 'Nenhum núcleo disponível na organização.' %}</p>
          {% endif %}
        </fieldset>

        <div class="flex flex-wrap justify-end gap-3 border-t border-[var(--border)] pt-4">
          <a href="{% url 'accounts:associados_promover' %}" class="btn btn-secondary">{% trans 'Voltar' %}</a>
          <button type="submit" class="btn btn-primary">{% trans 'Salvar promoção' %}</button>
        </div>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script>
    (function () {
      const form = document.querySelector('[data-promover-form]');
      if (!form) {
        return;
      }

      let userRoleMap = {};
      try {
        userRoleMap = JSON.parse(form.dataset.userRoleMap || '{}');
      } catch (err) {
        userRoleMap = {};
      }
      const restrictedRoles = new Set((form.dataset.restrictedRoles || '').split(',').filter(Boolean));
      const nucleoItems = Array.from(form.querySelectorAll('[data-nucleo-item]'));

      function parseMessageMap(item) {
        if (item._messageMap) {
          return item._messageMap;
        }
        try {
          item._messageMap = JSON.parse(item.dataset.unavailableMessageMap || '{}');
        } catch (err) {
          item._messageMap = {};
        }
        return item._messageMap;
      }

      function toggleCoordinatorSection(item) {
        const checkbox = item.querySelector('[data-role-checkbox="coordenador"]');
        const fields = item.querySelector('[data-coordenador-fields]');
        const select = item.querySelector('[data-coordenador-select]');
        const warningEl = item.querySelector('[data-nucleo-warning]');
        const active = Boolean(checkbox && checkbox.checked);
        if (fields) {
          fields.classList.toggle('hidden', !active);
        }
        if (select) {
          select.disabled = !active;
          if (!active) {
            select.value = '';
          }
        }
        if (!active && warningEl) {
          warningEl.classList.add('hidden');
          warningEl.textContent = '';
        }
      }

      function buildCurrentSelections() {
        const selections = {};
        nucleoItems.forEach((item) => {
          const checkbox = item.querySelector('[data-role-checkbox="coordenador"]');
          const select = item.querySelector('[data-coordenador-select]');
          if (!checkbox || !select || !checkbox.checked || !select.value) {
            return;
          }
          selections[select.value] = item.dataset.nucleoId;
        });
        return selections;
      }

      function updateCoordinatorOptions() {
        const selectedElsewhere = buildCurrentSelections();
        nucleoItems.forEach((item) => {
          const checkbox = item.querySelector('[data-role-checkbox="coordenador"]');
          const select = item.querySelector('[data-coordenador-select]');
          const warningEl = item.querySelector('[data-nucleo-warning]');
          if (!checkbox || !select) {
            return;
          }

          const messageMap = parseMessageMap(item);
          if (!checkbox.checked) {
            if (warningEl) {
              warningEl.classList.add('hidden');
              warningEl.textContent = '';
            }
            return;
          }

          const nucleoId = item.dataset.nucleoId;
          const options = Array.from(select.options);
          let warning = '';

          options.forEach((option) => {
            const role = option.value;
            if (!role) {
              option.disabled = false;
              option.dataset.disabledReason = '';
              return;
            }
            let disabled = option.dataset.locked === 'true';
            let reason = disabled ? 'occupied' : '';
            if (!disabled && restrictedRoles.has(role)) {
              const existing = new Set((userRoleMap[role] || []).map(String));
              if (existing.size > 0 && !existing.has(nucleoId)) {
                disabled = true;
                reason = 'existing';
              } else if (selectedElsewhere[role] && selectedElsewhere[role] !== nucleoId) {
                disabled = true;
                reason = 'selected';
              }
            }
            option.disabled = disabled;
            option.dataset.disabledReason = reason;
          });

          if (select.value) {
            const selectedOption = select.selectedOptions[0];
            if (selectedOption && selectedOption.disabled) {
              const reason = selectedOption.dataset.disabledReason;
              if (reason === 'occupied') {
                warning = messageMap[select.value] || gettext('Este papel já possui um coordenador definido.');
              } else if (reason === 'existing') {
                warning = gettext('Você já possui este papel em outro núcleo.');
              } else if (reason === 'selected') {
                warning = gettext('Selecione um papel diferente para este núcleo.');
              }
              select.value = '';
            }
          }

          const hasAvailableRole = options.some((option) => option.value && !option.disabled);
          if (!hasAvailableRole) {
            warning = warning || gettext('Nenhum papel disponível para coordenação neste núcleo.');
          }

          if (warningEl) {
            warningEl.textContent = warning;
            warningEl.classList.toggle('hidden', !warning);
          }
        });
      }

      nucleoItems.forEach((item) => {
        const coordinatorCheckbox = item.querySelector('[data-role-checkbox="coordenador"]');
        const select = item.querySelector('[data-coordenador-select]');
        if (coordinatorCheckbox) {
          coordinatorCheckbox.addEventListener('change', () => {
            toggleCoordinatorSection(item);
            updateCoordinatorOptions();
          });
        }
        if (select) {
          select.addEventListener('change', updateCoordinatorOptions);
        }
        toggleCoordinatorSection(item);
      });

      updateCoordinatorOptions();
    })();
  </script>
{% endblock %}
