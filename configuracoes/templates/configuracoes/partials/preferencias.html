{% load widget_tweaks i18n %}
{% get_current_language as LANGUAGE_CODE %}
<form method="post" hx-post="{% url 'configuracoes' %}?tab=preferencias" hx-target="#content" class="space-y-4">
  {% csrf_token %}
  <input type="hidden" name="tab" value="preferencias">
  <fieldset class="space-y-4">
    <legend class="sr-only">{% trans 'Notificações' %}</legend>
    <div>
      <label class="flex items-center gap-2">
        {% with email_checked=preferencias_form.receber_notificacoes_email.value|yesno:"true,false" %}
          {{ preferencias_form.receber_notificacoes_email|add_class:'form-checkbox'|attr:'role:switch'|attr:'tabindex:0'|attr:'aria-label:Receber notificações por e-mail'|attr:'aria-checked:'|add:email_checked }}
        {% endwith %}
        <span class="text-sm font-medium">{% trans 'Receber notificações por e-mail' %}</span>
      </label>
      {{ preferencias_form.receber_notificacoes_email.errors }}
      {{ preferencias_form.frequencia_notificacoes_email|add_class:'form-select mt-2' }}
      {{ preferencias_form.frequencia_notificacoes_email.errors }}
      {% if preferencias_form.frequencia_notificacoes_email.help_text %}
        <p class="text-xs text-gray-500">{{ preferencias_form.frequencia_notificacoes_email.help_text }}</p>
      {% endif %}
      <div class="mt-2 flex items-center gap-2">
        <button type="button" class="text-xs text-blue-600 hover:underline" hx-post="{% url 'configuracoes_api:configuracoes-testar' %}" hx-vals='{"canal": "email"}' hx-include="[name=csrfmiddlewaretoken]" hx-swap="none" hx-on:afterRequest="document.getElementById('msg-email').innerText = event.detail.xhr.responseJSON.detail">
          {% trans 'Testar e-mail' %}
        </button>
        <span id="msg-email" class="text-xs text-gray-600" aria-live="polite"></span>
      </div>
    </div>
    <div>
      <label class="flex items-center gap-2">
        {% with whats_checked=preferencias_form.receber_notificacoes_whatsapp.value|yesno:"true,false" %}
          {{ preferencias_form.receber_notificacoes_whatsapp|add_class:'form-checkbox'|attr:'role:switch'|attr:'tabindex:0'|attr:'aria-label:Receber notificações por WhatsApp'|attr:'aria-checked:'|add:whats_checked }}
        {% endwith %}
        <span class="text-sm font-medium">{% trans 'Receber notificações por WhatsApp' %}</span>
      </label>
      {{ preferencias_form.receber_notificacoes_whatsapp.errors }}
      {{ preferencias_form.frequencia_notificacoes_whatsapp|add_class:'form-select mt-2' }}
      {{ preferencias_form.frequencia_notificacoes_whatsapp.errors }}
      {% if preferencias_form.frequencia_notificacoes_whatsapp.help_text %}
        <p class="text-xs text-gray-500">{{ preferencias_form.frequencia_notificacoes_whatsapp.help_text }}</p>
      {% endif %}
      <p class="text-xs text-gray-500">{% trans 'Funcionalidade de WhatsApp em desenvolvimento' %}</p>
      <div class="mt-2 flex items-center gap-2">
        <button type="button" class="text-xs text-blue-600 hover:underline" hx-post="{% url 'configuracoes_api:configuracoes-testar' %}" hx-vals='{"canal": "whatsapp"}' hx-include="[name=csrfmiddlewaretoken]" hx-swap="none" hx-on:afterRequest="document.getElementById('msg-whatsapp').innerText = event.detail.xhr.responseJSON.detail">
          {% trans 'Testar WhatsApp' %}
        </button>
        <span id="msg-whatsapp" class="text-xs text-gray-600" aria-live="polite"></span>
      </div>

    </div>
    <div>
      <label class="flex items-center gap-2">
        {% with push_checked=preferencias_form.receber_notificacoes_push.value|yesno:"true,false" %}
          {{ preferencias_form.receber_notificacoes_push|add_class:'form-checkbox'|attr:'role:switch'|attr:'tabindex:0'|attr:'aria-label:Receber notificações push'|attr:'aria-checked:'|add:push_checked }}
        {% endwith %}
        <span class="text-sm font-medium">{% trans 'Receber notificações push' %}</span>
      </label>
      {{ preferencias_form.receber_notificacoes_push.errors }}
      {{ preferencias_form.frequencia_notificacoes_push|add_class:'form-select mt-2' }}
      {{ preferencias_form.frequencia_notificacoes_push.errors }}
      {% if preferencias_form.frequencia_notificacoes_push.help_text %}
        <p class="text-xs text-gray-500">{{ preferencias_form.frequencia_notificacoes_push.help_text }}</p>
      {% endif %}
      <div class="mt-2 flex items-center gap-2">
        <button type="button" class="text-xs text-blue-600 hover:underline" hx-post="{% url 'configuracoes_api:configuracoes-testar' %}" hx-vals='{"canal": "push"}' hx-include="[name=csrfmiddlewaretoken]" hx-swap="none" hx-on:afterRequest="document.getElementById('msg-push').innerText = event.detail.xhr.responseJSON.detail">
          {% trans 'Testar push' %}
        </button>
        <span id="msg-push" class="text-xs text-gray-600" aria-live="polite"></span>
      </div>
    </div>
    <div id="campo-hora-diaria" class="hidden">
      <label for="{{ preferencias_form.hora_notificacao_diaria.id_for_label }}" class="block text-sm font-medium">{% trans 'Horário diário' %}</label>
      {{ preferencias_form.hora_notificacao_diaria|add_class:'form-input mt-1'|attr:'type:time' }}
      {{ preferencias_form.hora_notificacao_diaria.errors }}
      {% if preferencias_form.hora_notificacao_diaria.help_text %}
        <p class="text-xs text-gray-500">{{ preferencias_form.hora_notificacao_diaria.help_text }}</p>
      {% endif %}
    </div>
    <div id="campo-hora-semanal" class="hidden">
      <label for="{{ preferencias_form.hora_notificacao_semanal.id_for_label }}" class="block text-sm font-medium">{% trans 'Horário semanal' %}</label>
      {{ preferencias_form.hora_notificacao_semanal|add_class:'form-input mt-1'|attr:'type:time' }}
      {{ preferencias_form.hora_notificacao_semanal.errors }}
      {% if preferencias_form.hora_notificacao_semanal.help_text %}
        <p class="text-xs text-gray-500">{{ preferencias_form.hora_notificacao_semanal.help_text }}</p>
      {% endif %}
    </div>
    <div id="campo-dia-semanal" class="hidden">
      <label for="{{ preferencias_form.dia_semana_notificacao.id_for_label }}" class="block text-sm font-medium">{% trans 'Dia da semana' %}</label>
      {{ preferencias_form.dia_semana_notificacao|add_class:'form-select mt-1' }}
      {{ preferencias_form.dia_semana_notificacao.errors }}
      {% if preferencias_form.dia_semana_notificacao.help_text %}
        <p class="text-xs text-gray-500">{{ preferencias_form.dia_semana_notificacao.help_text }}</p>
      {% endif %}
    </div>
  </fieldset>
  <div>
    <label for="{{ preferencias_form.idioma.id_for_label }}" class="block text-sm font-medium">{% trans 'Idioma' %}</label>
    {{ preferencias_form.idioma|add_class:'form-select mt-1'|attr:'tabindex:0' }}
    {{ preferencias_form.idioma.errors }}
    <p class="text-xs text-gray-500">{% blocktrans %}Idioma atual: {{ LANGUAGE_CODE }}{% endblocktrans %}</p>
  </div>
  <div>
    <label for="{{ preferencias_form.tema.id_for_label }}" class="block text-sm font-medium">{% trans 'Tema' %}</label>
    {{ preferencias_form.tema|add_class:'form-select mt-1'|attr:'tabindex:0' }}
    {{ preferencias_form.tema.errors }}
  </div>
  <div class="text-right pt-2">
    <button type="submit" aria-label="{% trans 'Salvar Alterações' %}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">{% trans 'Salvar Alterações' %}</button>
  </div>
</form>
<script>
  (function() {
    function toggleFields() {
      const freqEmail = document.getElementById('{{ preferencias_form.frequencia_notificacoes_email.auto_id }}').value;
      const freqWhats = document.getElementById('{{ preferencias_form.frequencia_notificacoes_whatsapp.auto_id }}').value;
      const freqPush = document.getElementById('{{ preferencias_form.frequencia_notificacoes_push.auto_id }}').value;
      const showDaily = freqEmail === 'diaria' || freqWhats === 'diaria' || freqPush === 'diaria';
      const showWeekly = freqEmail === 'semanal' || freqWhats === 'semanal' || freqPush === 'semanal';
      const hasHoraDiariaError = document.querySelector('#campo-hora-diaria .errorlist') !== null;
      const hasHoraSemanalError = document.querySelector('#campo-hora-semanal .errorlist') !== null;
      const hasDiaSemanalError = document.querySelector('#campo-dia-semanal .errorlist') !== null;
      document.getElementById('campo-hora-diaria').classList.toggle('hidden', !(showDaily || hasHoraDiariaError));
      document.getElementById('campo-hora-semanal').classList.toggle('hidden', !(showWeekly || hasHoraSemanalError));
      document.getElementById('campo-dia-semanal').classList.toggle('hidden', !(showWeekly || hasDiaSemanalError));
    }
    const selEmail = document.getElementById('{{ preferencias_form.frequencia_notificacoes_email.auto_id }}');
    const selWhats = document.getElementById('{{ preferencias_form.frequencia_notificacoes_whatsapp.auto_id }}');
    const selPush = document.getElementById('{{ preferencias_form.frequencia_notificacoes_push.auto_id }}');
    selEmail.addEventListener('change', toggleFields);
    selWhats.addEventListener('change', toggleFields);
    selPush.addEventListener('change', toggleFields);
    toggleFields();
  })();
</script>
{% if updated_preferences %}
<script>
  (function () {
    const tema = "{{ preferencias_form.instance.tema }}";
    const idioma = "{{ preferencias_form.instance.idioma }}";
    localStorage.setItem('tema', tema);
    document.cookie = `tema=${tema};path=/`;
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = tema === 'automatico' ? (prefersDark ? 'escuro' : 'claro') : tema;
    document.documentElement.classList.toggle('dark', theme === 'escuro');
    localStorage.setItem('idioma', idioma);
    document.cookie = `django_language=${idioma};path=/`;
    document.documentElement.setAttribute('lang', idioma);
  })();
</script>
{% endif %}
