{% load widget_tweaks i18n static %}
{% get_current_language as LANGUAGE_CODE %}
<form method="post" hx-post="{% url 'configuracoes' %}?tab=preferencias" hx-target="#content" class="space-y-4">
  {% csrf_token %}
  {% if preferencias_form.non_field_errors %}
    <ul class="errorlist bg-[var(--bg-secondary)] text-[var(--danger-text)] border border-[var(--danger-border)] rounded-2xl p-4">
      {% for err in preferencias_form.non_field_errors %}<li>{{ err }}</li>{% endfor %}
    </ul>
  {% endif %}
  <input type="hidden" name="tab" value="preferencias">
  <input type="hidden" name="escopo_tipo" id="escopo_tipo">
  <input type="hidden" name="escopo_id" id="escopo_id">
  <fieldset class="space-y-4">
    <legend class="sr-only">{% trans 'Notificações' %}</legend>
    <div>
      {% with email_checked=preferencias_form.receber_notificacoes_email.value|yesno:"true,false" %}
        {% with email_attr='aria-checked:'|add:email_checked %}
        {% with preferencias_form.receber_notificacoes_email|attr:'role:switch'|attr:'tabindex:0'|attr:'aria-label:Receber notificações por e-mail'|attr:email_attr as email_field %}
            {% include '_forms/field.html' with field=email_field %}
          {% endwith %}
        {% endwith %}
      {% endwith %}
        {% with preferencias_form.frequencia_notificacoes_email as freq_email_field %}
        {% include '_forms/field.html' with field=freq_email_field %}
      {% endwith %}
      <div class="mt-2 flex items-center gap-2">
        <button type="button" class="btn btn-secondary" hx-post="{% url 'configuracoes_api:configuracoes-testar' %}" hx-vals='{"canal": "email"}' hx-include="[name=csrfmiddlewaretoken],#escopo_tipo,#escopo_id" hx-swap="none" hx-on:afterRequest="document.getElementById('msg-email').innerText = event.detail.xhr.responseJSON.detail" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
          {% trans 'Testar e-mail' %}
        </button>
        <span id="msg-email" class="text-xs text-[var(--text-tertiary)]" aria-live="polite"></span>
      </div>
    </div>
    <div>
      {% with whats_checked=preferencias_form.receber_notificacoes_whatsapp.value|yesno:"true,false" %}
        {% with whats_attr='aria-checked:'|add:whats_checked %}
        {% with preferencias_form.receber_notificacoes_whatsapp|attr:'role:switch'|attr:'tabindex:0'|attr:'aria-label:Receber notificações por WhatsApp'|attr:whats_attr as whats_field %}
            {% include '_forms/field.html' with field=whats_field %}
          {% endwith %}
        {% endwith %}
      {% endwith %}
        {% with preferencias_form.frequencia_notificacoes_whatsapp as freq_whats_field %}
        {% include '_forms/field.html' with field=freq_whats_field %}
      {% endwith %}
      <div class="mt-2 flex items-center gap-2">
        <button type="button" class="btn btn-secondary" hx-post="{% url 'configuracoes_api:configuracoes-testar' %}" hx-vals='{"canal": "whatsapp"}' hx-include="[name=csrfmiddlewaretoken],#escopo_tipo,#escopo_id" hx-swap="none" hx-on:afterRequest="document.getElementById('msg-whatsapp').innerText = event.detail.xhr.responseJSON.detail" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
          {% trans 'Testar WhatsApp' %}
        </button>
        <span id="msg-whatsapp" class="text-xs text-[var(--text-tertiary)]" aria-live="polite"></span>
      </div>
    </div>
    <div>
      {% with push_checked=preferencias_form.receber_notificacoes_push.value|yesno:"true,false" %}
        {% with push_attr='aria-checked:'|add:push_checked %}
        {% with preferencias_form.receber_notificacoes_push|attr:'role:switch'|attr:'tabindex:0'|attr:'aria-label:Receber notificações push'|attr:push_attr as push_field %}
            {% include '_forms/field.html' with field=push_field %}
          {% endwith %}
        {% endwith %}
      {% endwith %}
        {% with preferencias_form.frequencia_notificacoes_push as freq_push_field %}
        {% include '_forms/field.html' with field=freq_push_field %}
      {% endwith %}
      <div class="mt-2 flex items-center gap-2">
        <button type="button" class="btn btn-secondary" hx-post="{% url 'configuracoes_api:configuracoes-testar' %}" hx-vals='{"canal": "push"}' hx-include="[name=csrfmiddlewaretoken],#escopo_tipo,#escopo_id" hx-swap="none" hx-on:afterRequest="document.getElementById('msg-push').innerText = event.detail.xhr.responseJSON.detail" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
          {% trans 'Testar push' %}
        </button>
        <span id="msg-push" class="text-xs text-[var(--text-tertiary)]" aria-live="polite"></span>
      </div>
    </div>
    <div id="campo-hora-diaria" class="hidden">
        {% with preferencias_form.hora_notificacao_diaria|attr:'type:time' as hora_diaria_field %}
        {% include '_forms/field.html' with field=hora_diaria_field %}
      {% endwith %}
    </div>
    <div id="campo-hora-semanal" class="hidden">
        {% with preferencias_form.hora_notificacao_semanal|attr:'type:time' as hora_semanal_field %}
        {% include '_forms/field.html' with field=hora_semanal_field %}
      {% endwith %}
    </div>
    <div id="campo-dia-semanal" class="hidden">
        {% with preferencias_form.dia_semana_notificacao as dia_field %}
        {% include '_forms/field.html' with field=dia_field %}
      {% endwith %}
    </div>
  </fieldset>
  <div>
      {% with preferencias_form.idioma|attr:'tabindex:0' as idioma_field %}
      {% include '_forms/field.html' with field=idioma_field %}
    {% endwith %}
    <p class="text-xs text-[var(--text-muted)]">{% blocktrans %}Idioma atual: {{ LANGUAGE_CODE }}{% endblocktrans %}</p>
  </div>
  <div>
      {% with preferencias_form.tema|attr:'tabindex:0' as tema_field %}
      {% include '_forms/field.html' with field=tema_field %}
    {% endwith %}
  </div>
  <div class="text-right pt-2">
    <button type="submit" aria-label="{% trans 'Salvar Alterações' %}" class="btn btn-primary">{% trans 'Salvar Alterações' %}</button>
  </div>
  <div id="preferencias-config"
       data-chk-email="{{ preferencias_form.receber_notificacoes_email.auto_id }}"
       data-chk-whats="{{ preferencias_form.receber_notificacoes_whatsapp.auto_id }}"
       data-chk-push="{{ preferencias_form.receber_notificacoes_push.auto_id }}"
       data-sel-email="{{ preferencias_form.frequencia_notificacoes_email.auto_id }}"
       data-sel-whats="{{ preferencias_form.frequencia_notificacoes_whatsapp.auto_id }}"
       data-sel-push="{{ preferencias_form.frequencia_notificacoes_push.auto_id }}"
       data-tema="{{ preferencias_form.instance.tema }}"
       data-idioma="{{ preferencias_form.instance.idioma }}"
       data-updated-preferences="{{ updated_preferences|yesno:'true,false' }}">
  </div>
  <script src="{% static 'configuracoes/preferencias.js' %}"></script>
</form>
