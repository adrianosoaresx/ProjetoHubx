{% load widget_tweaks i18n %}
{% get_current_language as LANGUAGE_CODE %}
<form method="post" hx-post="{% url 'configuracoes' %}?tab=preferencias" hx-target="#content" class="space-y-4">
  {% csrf_token %}
  <input type="hidden" name="tab" value="preferencias">
  <div>
    <label class="flex items-center gap-2">
      {{ preferencias_form.receber_notificacoes_email|add_class:'form-checkbox'|attr:'role:switch'|attr:'tabindex:0' }}
      <span class="text-sm font-medium">{% trans 'Receber notificações por e-mail' %}</span>
    </label>
    {{ preferencias_form.frequencia_notificacoes_email|add_class:'form-select mt-2' }}
    {% if preferencias_form.frequencia_notificacoes_email.help_text %}
      <p class="text-xs text-gray-500">{{ preferencias_form.frequencia_notificacoes_email.help_text }}</p>
    {% endif %}
  </div>
  <div>
    <label class="flex items-center gap-2">
      {{ preferencias_form.receber_notificacoes_whatsapp|add_class:'form-checkbox'|attr:'role:switch'|attr:'tabindex:0' }}
      <span class="text-sm font-medium">{% trans 'Receber notificações por WhatsApp' %}</span>
    </label>
    {{ preferencias_form.frequencia_notificacoes_whatsapp|add_class:'form-select mt-2' }}
    {% if preferencias_form.frequencia_notificacoes_whatsapp.help_text %}
      <p class="text-xs text-gray-500">{{ preferencias_form.frequencia_notificacoes_whatsapp.help_text }}</p>
    {% endif %}
    <p class="text-xs text-gray-500">{% trans 'Funcionalidade de WhatsApp em desenvolvimento' %}</p>
  </div>
  <div id="campo-hora-diaria" class="hidden">
    <label for="{{ preferencias_form.hora_notificacao_diaria.id_for_label }}" class="block text-sm font-medium">{% trans 'Horário diário' %}</label>
    {{ preferencias_form.hora_notificacao_diaria|add_class:'form-input mt-1'|attr:'type:time' }}
    {% if preferencias_form.hora_notificacao_diaria.help_text %}
      <p class="text-xs text-gray-500">{{ preferencias_form.hora_notificacao_diaria.help_text }}</p>
    {% endif %}
  </div>
  <div id="campo-hora-semanal" class="hidden">
    <label for="{{ preferencias_form.hora_notificacao_semanal.id_for_label }}" class="block text-sm font-medium">{% trans 'Horário semanal' %}</label>
    {{ preferencias_form.hora_notificacao_semanal|add_class:'form-input mt-1'|attr:'type:time' }}
    {% if preferencias_form.hora_notificacao_semanal.help_text %}
      <p class="text-xs text-gray-500">{{ preferencias_form.hora_notificacao_semanal.help_text }}</p>
    {% endif %}
  </div>
  <div id="campo-dia-semanal" class="hidden">
    <label for="{{ preferencias_form.dia_semana_notificacao.id_for_label }}" class="block text-sm font-medium">{% trans 'Dia da semana' %}</label>
    {{ preferencias_form.dia_semana_notificacao|add_class:'form-select mt-1' }}
    {% if preferencias_form.dia_semana_notificacao.help_text %}
      <p class="text-xs text-gray-500">{{ preferencias_form.dia_semana_notificacao.help_text }}</p>
    {% endif %}
  </div>
  <div>
    <label for="{{ preferencias_form.idioma.id_for_label }}" class="block text-sm font-medium">{% trans 'Idioma' %}</label>
    {{ preferencias_form.idioma|add_class:'form-select mt-1'|attr:'tabindex:0' }}
    <p class="text-xs text-gray-500">{% trans 'Idioma atual:' %} {{ LANGUAGE_CODE }}</p>
  </div>
  <div>
    <label for="{{ preferencias_form.tema.id_for_label }}" class="block text-sm font-medium">{% trans 'Tema' %}</label>
    {{ preferencias_form.tema|add_class:'form-select mt-1'|attr:'tabindex:0' }}
  </div>
  <div class="text-right pt-2">
    <button type="submit" aria-label="{% trans 'Salvar Alterações' %}" class="bg-primary text-white px-4 py-2 rounded-lg">{% trans 'Salvar Alterações' %}</button>
  </div>
</form>
<script>
  (function() {
    function toggleFields() {
      const freqEmail = document.getElementById('{{ preferencias_form.frequencia_notificacoes_email.auto_id }}').value;
      const freqWhats = document.getElementById('{{ preferencias_form.frequencia_notificacoes_whatsapp.auto_id }}').value;
      const showDaily = freqEmail === 'diaria' || freqWhats === 'diaria';
      const showWeekly = freqEmail === 'semanal' || freqWhats === 'semanal';
      document.getElementById('campo-hora-diaria').classList.toggle('hidden', !showDaily);
      document.getElementById('campo-hora-semanal').classList.toggle('hidden', !showWeekly);
      document.getElementById('campo-dia-semanal').classList.toggle('hidden', !showWeekly);
    }
    const selEmail = document.getElementById('{{ preferencias_form.frequencia_notificacoes_email.auto_id }}');
    const selWhats = document.getElementById('{{ preferencias_form.frequencia_notificacoes_whatsapp.auto_id }}');
    selEmail.addEventListener('change', toggleFields);
    selWhats.addEventListener('change', toggleFields);
    toggleFields();
  })();
</script>
{% if updated_preferences %}
<script>
  (function () {
    const tema = "{{ preferencias_form.instance.tema }}";
    const idioma = "{{ preferencias_form.instance.idioma }}";
    localStorage.setItem('tema', tema);
    document.cookie = `tema=${tema};path=/`;
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = tema === 'automatico' ? (prefersDark ? 'escuro' : 'claro') : tema;
    document.documentElement.classList.toggle('dark', theme === 'escuro');
    localStorage.setItem('idioma', idioma);
    document.cookie = `django_language=${idioma};path=/`;
    document.documentElement.setAttribute('lang', idioma);
  })();
</script>
{% endif %}
