{% if partial %}
  {% for comentario in comentarios %}
    {% include 'discussao/comentario_item.html' with comentario=comentario user=user topico=topico resposta_content_type_id=resposta_content_type_id %}
  {% endfor %}
{% else %}
{% extends 'base.html' %}
{% load i18n %}
{% block title %}{{ topico.titulo }} | HubX{% endblock %}
{% block content %}
<article id="topico-container" class="max-w-3xl mx-auto px-4 py-10">
  <header class="mb-6 border-b border-neutral-200 pb-4">
    <h1 class="text-2xl font-bold text-neutral-900 mb-2">
      {{ topico.titulo }}
      {% if topico.resolvido %}
      <span class="ml-2 px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded">{% trans "Resolvido" %}</span>
      {% endif %}
    </h1>
    <p class="text-sm text-neutral-600">{% trans "Por" %} {{ topico.autor.get_full_name|default:topico.autor.username }} · {{ topico.created|date:SHORT_DATETIME_FORMAT }}</p>
    {% if user == topico.autor or user.get_tipo_usuario in ['admin','root'] %}
    <form method="post" hx-post="{% url 'discussao:topico_resolver' topico.categoria.slug topico.slug %}" hx-target="#topico-container" hx-swap="outerHTML" class="mt-2">
      {% csrf_token %}
      {% if topico.resolvido %}
      <button type="submit" class="text-sm text-green-600">{% trans "Desmarcar resolução" %}</button>
      {% else %}
      <button type="submit" class="text-sm text-green-600">{% trans "Marcar como resolvido" %}</button>
      {% endif %}
    </form>
    {% endif %}
    <div class="flex items-center space-x-1 mt-2">
      <button hx-post="{% url 'discussao:interacao' content_type_id topico.id 'up' %}" hx-swap="none" hx-on:afterRequest="document.getElementById('topic-score').innerText = event.detail.xhr.responseJSON.score">&#9650;</button>
      <span id="topic-score">{{ topico.score }}</span>
      <button hx-post="{% url 'discussao:interacao' content_type_id topico.id 'down' %}" hx-swap="none" hx-on:afterRequest="document.getElementById('topic-score').innerText = event.detail.xhr.responseJSON.score">&#9660;</button>
    </div>
  </header>
  <div class="prose max-w-none mb-10">{{ topico.conteudo|linebreaks }}</div>
  <section aria-labelledby="comentarios" class="space-y-4">
    <h2 id="comentarios" class="text-xl font-semibold">{% trans "Coment\u00e1rios" %}</h2>
    {% if melhor_resposta %}
      {% include 'discussao/comentario_item.html' with comentario=melhor_resposta user=user topico=topico melhor=True resposta_content_type_id=resposta_content_type_id %}
    {% endif %}
    <div id="lista-comentarios">
      {% include 'discussao/topico_detail.html' with partial=True topico=topico user=user resposta_content_type_id=resposta_content_type_id only %}
    </div>
    {% if comentarios.has_previous or comentarios.has_next %}
    <div class="flex justify-center gap-3 text-sm">
      {% if comentarios.has_previous %}
        <a hx-get="?page={{ comentarios.previous_page_number }}" hx-target="#lista-comentarios" class="px-3 py-1 border rounded-xl">{% trans "Anterior" %}</a>
      {% endif %}
      <span class="px-3 py-1">{% trans "P\u00e1gina" %} {{ comentarios.number }}</span>
      {% if comentarios.has_next %}
        <a hx-get="?page={{ comentarios.next_page_number }}" hx-target="#lista-comentarios" class="px-3 py-1 border rounded-xl">{% trans "Pr\u00f3xima" %}</a>
      {% endif %}
    </div>
    {% endif %}
    {% if not topico.fechado %}
    <form method="post" hx-post="{% url 'discussao:resposta_criar' topico.categoria.slug topico.slug %}" hx-target="#lista-comentarios" hx-swap="beforeend" class="space-y-4 mt-6">
      {% csrf_token %}
      <label for="id_conteudo" class="block text-sm font-medium text-neutral-700">{% trans "Comentar" %}</label>
      <textarea name="conteudo" required class="form-textarea"></textarea>
      <button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2 px-4 rounded-xl">{% trans "Comentar" %}</button>
    </form>
    {% if user == topico.autor or user.get_tipo_usuario in ['admin','root'] %}
      <form method="post" action="{% url 'discussao:topico_toggle_fechado' topico.categoria.slug topico.slug %}" class="mt-4">
        {% csrf_token %}
        <button type="submit" class="text-sm text-red-600">{% trans "Fechar tópico" %}</button>
      </form>
    {% endif %}
    {% elif user.get_tipo_usuario in ['admin','root'] %}
      <form method="post" action="{% url 'discussao:topico_toggle_fechado' topico.categoria.slug topico.slug %}">
        {% csrf_token %}
        <button type="submit" class="bg-primary-600 text-white font-semibold py-2 px-4 rounded-xl">{% trans "Reabrir tópico" %}</button>
      </form>
    {% endif %}
  </section>
</article>
{% endblock %}
{% block extra_js %}
<script>
  const socket = new WebSocket(`ws://${window.location.host}/ws/discussao/{{ topico.id }}/`);
  socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    if (data.evento === 'nova_resposta') {
      const lista = document.getElementById('lista-comentarios');
      if (lista) {
        lista.insertAdjacentHTML('beforeend', `<div>${data.conteudo}</div>`);
      }
    } else if (data.evento === 'atualizacao_votos') {
      const score = document.getElementById('topic-score');
      if (score) { score.innerText = data.score; }
    } else if (data.evento === 'resolucao') {
      if (data.resolvido) {
        location.reload();
      }
    }
  };
</script>
{% endblock %}
{% endif %}
