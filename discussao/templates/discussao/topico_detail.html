{% if partial %}
  {% for comentario in comentarios %}

    {% include 'discussao/comentario_item.html' with comentario=comentario user=user topico=topico resposta_content_type_id=resposta_content_type_id %}


  {% endfor %}
{% else %}
{% extends 'base.html' %}
{% load i18n markdown_extras %}
{% block title %}{{ topico.titulo }} | HubX{% endblock %}
{% block content %}
<article id="topico-container" class="max-w-3xl mx-auto px-4 py-10">
  <header class="mb-6 border-b border-neutral-200 pb-4">
    <h1 class="text-2xl font-bold text-neutral-900 mb-2">
      {{ topico.titulo }}
      {% if topico.resolvido %}
      <span class="ml-2 px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded">{% trans "Resolvido" %}</span>
      {% endif %}
    </h1>
    <p class="text-sm text-neutral-600">{% trans "Por" %} {{ topico.autor.get_full_name|default:topico.autor.username }} · {{ topico.created_at|date:SHORT_DATETIME_FORMAT }} · {{ topico.numero_visualizacoes }} {% trans "visualizações" %}</p>
    {% if pode_editar_topico %}
      <a href="{% url 'discussao:topico_editar' topico.categoria.slug topico.slug %}" class="text-sm text-blue-600">{% trans "Editar" %}</a>
    {% endif %}
    {% if user == topico.autor or user.get_tipo_usuario in ['admin','root'] %}
    <form method="post" hx-post="{% url 'discussao:topico_resolver' topico.categoria.slug topico.slug %}" hx-target="#topico-container" hx-swap="outerHTML" class="mt-2">
      {% csrf_token %}
      {% if topico.resolvido %}
      <button type="submit" class="text-sm text-green-600">{% trans "Desmarcar resolução" %}</button>
      {% else %}
      <button type="submit" class="text-sm text-green-600">{% trans "Marcar como resolvido" %}</button>
      {% endif %}
    </form>
    {% endif %}
    <div class="flex items-center space-x-1 mt-2">
        <button
          hx-post="{% url 'discussao:interacao' content_type_id topico.id 'up' %}"
          hx-swap="none"
          hx-on:afterRequest="const r=event.detail.xhr.responseJSON;document.getElementById('topic-score').innerText=r.score;document.getElementById('topic-votes').innerText=r.num_votos"
          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
        >&#9650;</button>
      <span id="topic-score">{{ topico.score }}</span>
      (<span id="topic-votes">{{ topico.num_votos }}</span>)
        <button
          hx-post="{% url 'discussao:interacao' content_type_id topico.id 'down' %}"
          hx-swap="none"
          hx-on:afterRequest="const r=event.detail.xhr.responseJSON;document.getElementById('topic-score').innerText=r.score;document.getElementById('topic-votes').innerText=r.num_votos"
          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
        >&#9660;</button>
    </div>
    <div class="mt-2">
      <button type="button" class="text-xs text-red-600" onclick="document.getElementById('denuncia-topico-form').classList.toggle('hidden')">{% trans "Denunciar" %}</button>
      <form id="denuncia-topico-form" class="hidden mt-2" hx-post="{% url 'discussao_api:denuncia-list' %}" hx-swap="none" hx-on:afterRequest="this.reset(); this.classList.add('hidden'); alert('{% trans "Denúncia enviada" %}');" hx-on:error="alert('{% trans "Erro ao enviar denúncia" %}');">
        {% csrf_token %}
        <input type="hidden" name="content_type_id" value="{{ content_type_id }}">
        <input type="hidden" name="object_id" value="{{ topico.id }}">
        <textarea name="motivo" required class="form-textarea w-full" placeholder="{% trans "Motivo da denúncia" %}"></textarea>
        <button type="submit" class="mt-1 bg-red-600 text-white px-3 py-1 text-xs rounded">{% trans "Enviar" %}</button>
      </form>
    </div>
  </header>
  <div class="prose max-w-none mb-10">{{ topico.conteudo|markdown }}</div>
  <section aria-labelledby="comentarios" class="space-y-4">
    <h2 id="comentarios" class="text-xl font-semibold">{% trans "Coment\u00e1rios" %}</h2>
    {% if melhor_resposta %}

      {% include 'discussao/comentario_item.html' with comentario=melhor_resposta user=user topico=topico melhor=True resposta_content_type_id=resposta_content_type_id %}
    {% endif %}
    <div id="lista-comentarios">

      {% include 'discussao/topico_detail.html' with partial=True topico=topico comentarios=comentarios user=user resposta_content_type_id=content_type_id only %}


    </div>
    {% if comentarios.has_previous or comentarios.has_next %}
    <div class="flex justify-center gap-3 text-sm">
      {% if comentarios.has_previous %}
        <a hx-get="?page={{ comentarios.previous_page_number }}" hx-target="#lista-comentarios" class="px-3 py-1 border rounded-xl">{% trans "Anterior" %}</a>
      {% endif %}
      <span class="px-3 py-1">{% trans "P\u00e1gina" %} {{ comentarios.number }}</span>
      {% if comentarios.has_next %}
        <a hx-get="?page={{ comentarios.next_page_number }}" hx-target="#lista-comentarios" class="px-3 py-1 border rounded-xl">{% trans "Pr\u00f3xima" %}</a>
      {% endif %}
    </div>
    {% endif %}
    {% if not topico.fechado %}
    <form method="post" enctype="multipart/form-data" hx-post="{% url 'discussao:resposta_criar' topico.categoria.slug topico.slug %}" hx-target="#lista-comentarios" hx-swap="beforeend" class="space-y-4 mt-6">
      {% csrf_token %}
      <input type="hidden" name="reply_to" id="reply_to" />
      <label for="id_conteudo" class="block text-sm font-medium text-neutral-700">{% trans "Comentar" %}</label>
      <textarea id="id_conteudo" name="conteudo" required class="form-textarea"></textarea>
      <input type="file" name="arquivo" />
      <button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2 px-4 rounded-xl">{% trans "Comentar" %}</button>
    </form>
    {% if user == topico.autor or user.get_tipo_usuario in ['admin','root'] %}
      <form method="post" action="{% url 'discussao:topico_toggle_fechado' topico.categoria.slug topico.slug %}" class="mt-4">
        {% csrf_token %}
        <button type="submit" class="text-sm text-red-600">{% trans "Fechar tópico" %}</button>
      </form>
    {% endif %}
    {% elif user.get_tipo_usuario in ['admin','root'] %}
      <form method="post" action="{% url 'discussao:topico_toggle_fechado' topico.categoria.slug topico.slug %}">
        {% csrf_token %}
        <button type="submit" class="bg-primary-600 text-white font-semibold py-2 px-4 rounded-xl">{% trans "Reabrir tópico" %}</button>
      </form>
    {% endif %}
  </section>
</article>
{% endblock %}
{% block extra_js %}
<script>
  const scheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const socket = new WebSocket(`${scheme}://${window.location.host}/ws/discussao/{{ topico.id }}/`);
  const comentarioUrlTemplate = "{% url 'discussao:resposta_detalhe' 0 %}";
  socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    if (data.evento === 'nova_resposta') {
      const lista = document.getElementById('lista-comentarios');
      if (lista) {
        const el = document.createElement('div');
        el.setAttribute('hx-get', comentarioUrlTemplate.replace('0', data.id));
        el.setAttribute('hx-trigger', 'load');
        el.setAttribute('hx-swap', 'outerHTML');
        lista.appendChild(el);
      }
    } else if (data.evento === 'atualizacao_votos') {
      const score = document.getElementById('topic-score');
      const votes = document.getElementById('topic-votes');
      if (score) { score.innerText = data.score; }
      if (votes) { votes.innerText = data.num_votos; }
    } else if (data.evento === 'resolucao') {
      if (data.resolvido) {
        location.reload();
      }
    }
  };
</script>
{% endblock %}
{% endif %}
