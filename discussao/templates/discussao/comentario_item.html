{% load i18n %}
<article class="p-4 border-b border-neutral-200 reply-parent {% if melhor %}bg-green-50{% endif %}" id="coment-{{ comentario.id }}">
  <header class="mb-2 flex items-center justify-between">
    <div class="text-sm text-neutral-700">
      {{ comentario.autor.get_full_name|default:comentario.autor.username }} - {{ comentario.created|date:"SHORT_DATETIME_FORMAT" }}
    </div>
    <div class="flex items-center gap-2">
    {% if comentario.pode_editar %}
      <a href="{% url 'discussao:resposta_editar' comentario.id %}" class="text-blue-600 text-xs">{% trans "Editar" %}</a>
    {% endif %}
    {% if user == comentario.autor or user.get_tipo_usuario in ['admin','coordenador','root'] %}
      <form method="post" hx-delete="{% url 'discussao:delete_comment' comentario.id %}" hx-target="#coment-{{ comentario.id }}" hx-swap="delete">
        {% csrf_token %}
        <button type="submit" class="text-red-600 text-xs">{% trans "Remover" %}</button>
      </form>
    {% endif %}
    {% if (user == topico.autor or user.get_tipo_usuario in ['admin','root']) and not topico.melhor_resposta %}
      <form method="post" hx-post="{% url 'discussao:topico_resolver' topico.categoria.slug topico.slug %}" hx-target="#topico-container" hx-swap="outerHTML">
        {% csrf_token %}
        <input type="hidden" name="melhor_resposta" value="{{ comentario.id }}" />
        <button type="submit" class="text-green-600 text-xs">{% trans "Marcar como resolvido" %}</button>
      </form>
    {% endif %}

    <button type="button" class="text-red-600 text-xs" onclick="document.getElementById('denuncia-comentario-{{ comentario.id }}').classList.toggle('hidden')">{% trans "Denunciar" %}</button>


    {% if not topico.fechado %}
      <button
        type="button"
        class="text-primary-600 text-xs"
        hx-on:click="document.getElementById('reply_to').value='{{ comentario.id }}'; document.getElementById('id_conteudo').focus(); document.querySelectorAll('.reply-parent').forEach(e=>e.classList.remove('ring-2','ring-primary-600')); document.getElementById('coment-{{ comentario.id }}').classList.add('ring-2','ring-primary-600');"
      >
        {% trans "Responder" %}
      </button>
    {% endif %}

      <div class="flex items-center gap-1">
        <button hx-post="{% url 'discussao:interacao' resposta_content_type_id comentario.id 'up' %}" hx-swap="none" hx-on:afterRequest="document.getElementById('comment-score-{{ comentario.id }}').innerText = event.detail.xhr.responseJSON.score; document.getElementById('comment-votes-{{ comentario.id }}').innerText = event.detail.xhr.responseJSON.num_votos">&#9650;</button>
        <span id="comment-score-{{ comentario.id }}">{{ comentario.score }}</span>
        <span class="text-xs">(<span id="comment-votes-{{ comentario.id }}">{{ comentario.num_votos }}</span>)</span>
        <button hx-post="{% url 'discussao:interacao' resposta_content_type_id comentario.id 'down' %}" hx-swap="none" hx-on:afterRequest="document.getElementById('comment-score-{{ comentario.id }}').innerText = event.detail.xhr.responseJSON.score; document.getElementById('comment-votes-{{ comentario.id }}').innerText = event.detail.xhr.responseJSON.num_votos">&#9660;</button>
      </div>


    </div>
  </header>
  <div class="prose max-w-none text-sm">{{ comentario.conteudo|linebreaks }}</div>
  {% if topico.melhor_resposta_id == comentario.id %}
    <div class="text-xs text-green-700 font-semibold mt-2">{% trans "Melhor resposta" %}</div>
  {% endif %}
  <form id="denuncia-comentario-{{ comentario.id }}" class="hidden mt-2" hx-post="{% url 'discussao_api:denuncia-list' %}" hx-swap="none" hx-on:afterRequest="this.reset(); this.classList.add('hidden'); alert('{% trans "Denúncia enviada" %}');" hx-on:error="alert('{% trans "Erro ao enviar denúncia" %}');">
    {% csrf_token %}
    <input type="hidden" name="content_type_id" value="{{ resposta_content_type_id }}">
    <input type="hidden" name="object_id" value="{{ comentario.id }}">
    <textarea name="motivo" required class="form-textarea w-full" placeholder="{% trans "Motivo da denúncia" %}"></textarea>
    <button type="submit" class="mt-1 bg-red-600 text-white px-3 py-1 text-xs rounded">{% trans "Enviar" %}</button>
  </form>
</article>
{% if comentario.respostas_filhas %}
  <div class="ml-6 border-l border-neutral-200">
    {% for resposta in comentario.respostas_filhas %}
      {% include 'discussao/comentario_item.html' with comentario=resposta user=user topico=topico resposta_content_type_id=resposta_content_type_id %}
    {% endfor %}
  </div>
{% endif %}
