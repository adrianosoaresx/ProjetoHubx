{% include 'nucleos/partials/nucleo_card_cta.html' with resolved_nucleo=resolved_nucleo|default:nucleo nucleacao_status=nucleacao_status cta_url=cta_url cta_label=cta_label cta_hx_get=cta_hx_get cta_hx_target=cta_hx_target cta_hx_swap=cta_hx_swap cta_hx_on=cta_hx_on cta_container_id=cta_container_id cta_focus_id=cta_focus_id cta_classes=cta_classes oob_swap=True %}
{% load i18n %}
{% with modal_title_id="modal-nucleacao-success-title-"|add:nucleo.pk|stringformat:"s" modal_description_id="modal-nucleacao-success-description-"|add:nucleo.pk|stringformat:"s" %}
<div
  class="modal !active"
  role="dialog"
  aria-modal="true"
  aria-labelledby="{{ modal_title_id }}"
  aria-describedby="{{ modal_description_id }}"
  data-modal-root
>
  <div class="modal-content max-w-3xl rounded-lg bg-[var(--bg-primary)] shadow-xl">
    <div class="relative h-44 w-full overflow-hidden rounded-t-lg">
      {% if nucleo.cover %}
        <img src="{{ nucleo.cover.url|default:nucleo.cover }}" alt="{% blocktrans with nome=nucleo.nome %}Capa do núcleo {{ nome }}{% endblocktrans %}" class="h-full w-full object-cover" loading="lazy" />
      {% else %}
        <div class="h-full w-full bg-gradient-to-r from-[var(--hero-from,#22c55e)] to-[var(--hero-to,#16a34a)]"></div>
      {% endif %}
      <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
    </div>

    <div class="-mt-10 flex flex-col gap-4 px-6 pb-6 sm:px-8">
      <div class="flex items-start gap-4">
        <div class="flex h-16 w-16 shrink-0 items-center justify-center rounded-full bg-[var(--bg-secondary)] text-3xl text-[var(--primary,#22c55e)] shadow-lg ring-1 ring-black/5 dark:ring-white/10">
          ✓
        </div>
        <div class="flex flex-col gap-2">
          <h2 id="{{ modal_title_id }}" class="text-2xl font-semibold text-[var(--text-primary)]" tabindex="-1" data-initial-focus>
            {% blocktrans with nome=nucleo.nome %}Você pediu para se nuclear no núcleo {{ nome }}!{% endblocktrans %}
          </h2>
          <p id="{{ modal_description_id }}" class="text-sm leading-relaxed text-[var(--text-muted)]">
            {% trans "Sua solicitação foi enviada aos responsáveis. Você receberá uma notificação quando houver uma decisão." %}
          </p>
        </div>
      </div>

      <div class="flex flex-col gap-3 rounded-md border border-[var(--border)] bg-[var(--bg-secondary)] p-4">
        <h3 class="text-sm font-semibold uppercase tracking-wide text-[var(--text-secondary)]">{% trans "E agora?" %}</h3>
        <p class="text-sm text-[var(--text-primary)]">
          {% trans "Você pode voltar para a página anterior enquanto aguarda a aprovação." %}
        </p>
      </div>

      <div class="flex justify-end">
        <button type="button" class="btn btn-primary" data-modal-dismiss aria-label="{% trans 'Voltar' %}">
          {% trans "Voltar" %}
        </button>
      </div>
    </div>
  </div>
</div>
<script>
  (function () {
    const modalContainer = document.getElementById('modal');
    const dialog = modalContainer ? modalContainer.querySelector('[data-modal-root]') : null;

    if (!dialog) {
      return;
    }

    const focusableSelectors = [
      'a[href]','area[href]','input:not([disabled])','select:not([disabled])','textarea:not([disabled])','button:not([disabled])','[tabindex]:not([tabindex="-1"])'
    ].join(',');
    const focusableElements = Array.from(dialog.querySelectorAll(focusableSelectors)).filter((el) => !el.hasAttribute('hidden'));
    const previouslyFocused = window.HubxModalTrigger instanceof HTMLElement ? window.HubxModalTrigger : document.activeElement;
    const updatedFocusId = '{{ cta_focus_id|default:""|escapejs }}';

    function closeModal(event) {
      if (event) {
        event.preventDefault();
      }
      if (modalContainer) {
        modalContainer.innerHTML = '';
        const explicitFocusTarget = updatedFocusId ? document.getElementById(updatedFocusId) : null;
        const fallbackContainerId = window.HubxModalTriggerContainer;
        const containerFocusTarget = fallbackContainerId
          ? document.querySelector(`#${fallbackContainerId} [id^='nucleo-cta-focus-']`)
          : null;
        const focusTarget = explicitFocusTarget || containerFocusTarget || previouslyFocused;
        if (focusTarget && typeof focusTarget.focus === 'function') {
          focusTarget.focus();
        }
        if (window.HubxModalTrigger) {
          window.HubxModalTrigger = null;
        }
        if (window.HubxModalTriggerContainer) {
          window.HubxModalTriggerContainer = null;
        }
      } else if (history.length > 1) {
        history.back();
      }
    }

    dialog.querySelectorAll('[data-modal-dismiss]').forEach((button) => {
      button.addEventListener('click', closeModal);
    });

    modalContainer.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeModal(event);
      }
      if (event.key === 'Tab' && focusableElements.length) {
        const first = focusableElements[0];
        const last = focusableElements[focusableElements.length - 1];
        if (event.shiftKey && document.activeElement === first) {
          event.preventDefault();
          last.focus();
        } else if (!event.shiftKey && document.activeElement === last) {
          event.preventDefault();
          first.focus();
        }
      }
    });

    const initialFocusElement = dialog.querySelector('[data-initial-focus]') || focusableElements[0];
    if (initialFocusElement) {
      initialFocusElement.focus();
    }
  })();
</script>
{% endwith %}
