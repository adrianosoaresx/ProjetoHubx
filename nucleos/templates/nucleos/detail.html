{% extends 'base.html' %}
{% load i18n l10n lucide_icons %}

{% block title %}{{ object.nome }}{% endblock %}

{% block hero %}
  <div id="nucleo-hero">
    {% include '_components/hero_nucleo_detail.html' with nucleo=object %}
  </div>
{% endblock %}

{% block content %}
  
    <div class="flex flex-col gap-6">
      <details class="card group">
        <summary class="card-header flex cursor-pointer items-center justify-between gap-4 select-none [&::-webkit-details-marker]:hidden">
          <h2 class="text-xl font-semibold">{% trans "Informações" %}</h2>
          <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:rotate-180">
            {% lucide 'chevron-down' class='h-5 w-5' aria_hidden='true' %}
          </span>
        </summary>
        <div class="card-body space-y-6">
          <dl class="space-y-6 text-sm">
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
              <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                <dt class="text-[var(--text-secondary)]">{% trans "Status" %}</dt>
                <dd class="font-medium text-[var(--text-primary)]">
                  {% if object.ativo %}
                    {% trans "Ativo" %}
                  {% else %}
                    {% trans "Inativo" %}
                  {% endif %}
                </dd>
              </div>

              <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                <dt class="text-[var(--text-secondary)]">{% trans "Classificação" %}</dt>
                <dd class="font-medium text-[var(--text-primary)]">{{ object.get_classificacao_display }}</dd>
              </div>
            </div>

            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
              <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                <dt class="text-[var(--text-secondary)]">{% trans "Membros" %}</dt>
                <dd class="font-medium text-[var(--text-primary)]">{{ total_membros }}</dd>
              </div>

              <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                <dt class="text-[var(--text-secondary)]">{% trans "Coordenadores" %}</dt>
                <dd class="font-medium text-[var(--text-primary)]">{{ coordenadores|length }}</dd>
              </div>
            </div>

            {% if object.created_at or object.updated_at %}
              <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                {% if object.created_at %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                    <dt class="text-[var(--text-secondary)]">{% trans "Criado em" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)]">{{ object.created_at|date:'SHORT_DATETIME_FORMAT' }}</dd>
                  </div>
                {% endif %}

                {% if object.updated_at %}
                  <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                    <dt class="text-[var(--text-secondary)]">{% trans "Atualizado em" %}</dt>
                    <dd class="font-medium text-[var(--text-primary)]">{{ object.updated_at|date:'SHORT_DATETIME_FORMAT' }}</dd>
                  </div>
                {% endif %}
              </div>
            {% endif %}

            {% if object.descricao %}
              <div class="flex flex-col gap-1 rounded-lg border border-[var(--border)] px-3 py-2">
                <dt class="text-[var(--text-secondary)]">{% trans "Descrição" %}</dt>
                <dd class="font-medium text-[var(--text-primary)] whitespace-pre-line">{{ object.descricao }}</dd>
              </div>
            {% endif %}
          </dl>
          <div id="nucleo-info-actions" class="flex justify-end gap-3 pt-4 border-t border-[var(--border)]">
            {% if perms.nucleos.change_nucleo or request.user.user_type == 'admin' or request.user.user_type == 'operador' %}
              <a
                href="{% url 'nucleos:update' object.pk %}"
                class="btn btn-secondary"
              >{% trans "Editar" %}</a>
            {% endif %}
            {% if perms.nucleos.delete_nucleo or request.user.user_type == 'admin' or request.user.user_type == 'operador' %}
              <a
                href="{% url 'nucleos:delete' object.pk %}"
                hx-get="{% url 'nucleos:delete' object.pk %}"
                hx-target="#modal"
                hx-trigger="click"
                hx-swap="innerHTML"
                hx-on="htmx:beforeRequest: window.HubxModalTrigger = this;"
                class="btn btn-danger"
              >{% trans "Excluir" %}</a>
            {% endif %}
          </div>
        </div>
      </details>

      {% with section=current_section|default:"membros" %}
        {% if section == 'membros' %}
          <details class="card group">
            <summary class="card-header flex cursor-pointer items-center justify-between gap-4 select-none [&::-webkit-details-marker]:hidden">
              <h2
                id="nucleo-membros-title"
                class="text-xl font-semibold"
                data-membros-label="{% trans 'Membros' %}"
                data-coordenadores-label="{% trans 'Coordenadores' %}"
              >
                {% if is_coordenadores_filter_active %}
                  {% trans "Coordenadores" %}
                {% else %}
                  {% trans "Membros" %}
                {% endif %}
              </h2>
              <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:rotate-180">
                {% lucide 'chevron-down' class='h-5 w-5' aria_hidden='true' %}
              </span>
            </summary>
            <div class="card-body space-y-6">
              <div id="membros-filter-container">
                {% include 'nucleos/partials/membros_filter_form.html' %}
              </div>
              <section id="nucleo-membros" class="space-y-6">
                <div id="membros-list">
                  {% if partial_template %}
                    {% include partial_template %}
                  {% else %}
                    {% include 'nucleos/partials/membros_list.html' %}
                  {% endif %}
                </div>
                <div
                  id="membros-loading"
                  class="htmx-indicator text-center text-sm text-[var(--text-secondary)]"
                  role="status"
                  aria-live="polite"
                >
                  {% trans 'Carregando membros...' %}
                </div>
              </section>
            </div>
          </details>
        {% endif %}
      {% endwith %}
    </div>

    <div id="modal" role="presentation" aria-live="polite"></div>

{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script>
    (function () {
      const titleEl = document.getElementById('nucleo-membros-title');
      if (!titleEl) {
        return;
      }

      const labels = {
        membros: titleEl.dataset.membrosLabel || titleEl.textContent.trim(),
        coordenador: titleEl.dataset.coordenadoresLabel || titleEl.textContent.trim(),
      };

      function updateTitle(papel) {
        if (!titleEl) {
          return;
        }
        const key = papel === 'coordenador' ? 'coordenador' : 'membros';
        const label = labels[key];
        if (label) {
          titleEl.textContent = label;
        }
      }

      function handleEvent(event) {
        const detail = event.detail || {};
        const params = detail.parameters || (detail.requestConfig && detail.requestConfig.parameters);
        if (!params || typeof params.papel === 'undefined') {
          return;
        }
        updateTitle(params.papel);
      }

      document.body.addEventListener('htmx:beforeRequest', handleEvent);
      document.body.addEventListener('htmx:afterSwap', handleEvent);
    })();
  </script>
{% endblock %}
