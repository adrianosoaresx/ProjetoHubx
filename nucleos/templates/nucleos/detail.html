{% extends 'base.html' %}
{% load i18n l10n %}

{% block title %}{{ object.nome }}{% endblock %}

{% block content %}
<section class="max-w-3xl mx-auto py-8">
  {% if object.cover %}
  <img src="{{ object.cover.url }}" class="w-full h-48 object-cover rounded" alt="Capa de {{ object.nome }}" />
  {% endif %}
  <div class="flex items-center gap-4 mt-4">
    {% if object.avatar %}<img src="{{ object.avatar.url }}" class="w-16 h-16 rounded-full" alt="{{ object.nome }}" />{% endif %}
    <div>
      <h1 class="text-2xl font-bold">{{ object.nome }}</h1>
      <p class="text-sm text-gray-500">{{ object.slug }}</p>
    </div>
  </div>
  <div class="mt-4 p-4 bg-blue-50 border rounded">
    <p class="font-medium">{% trans 'Mensalidade' %}: {{ object.mensalidade|localize }}</p>
  </div>
  <div class="mt-4">
    <a href="{% url 'nucleos:metrics' object.pk %}" class="text-blue-600">{% trans 'Ver métricas' %}</a>
  </div>

  <div id="membro-status" class="mt-2 text-sm text-gray-700"></div>

  <h2 class="mt-6 font-semibold">{% trans 'Membros' %}</h2>
  <ul>
    {% for part in membros_ativos %}
      {% include "nucleos/partials/membro.html" with part=part object=object %}
    {% empty %}
      <li>{% trans 'Sem membros.' %}</li>
    {% endfor %}
  </ul>

  {% if membros_pendentes %}
  <h2 class="mt-6 font-semibold">{% trans 'Pendentes' %}</h2>
  <table class="w-full text-left" id="pendentes">
    <thead>
      <tr><th>{% trans 'Usuário' %}</th><th>{% trans 'Solicitado em' %}</th><th></th></tr>
    </thead>
    <tbody>
    {% for part in membros_pendentes %}
      <tr id="pendente-{{ part.id }}">
        <td>{{ part.user.get_full_name|default:part.user.username }}</td>
        <td>{{ part.data_solicitacao|date:'d/m/Y' }}</td>
        <td class="space-x-2">
          <button class="text-sm text-green-600" hx-post="{% url 'nucleos_api:nucleo-aprovar-membro' object.pk part.user.pk %}" hx-target="#pendente-{{ part.id }}" hx-swap="none" hx-on="htmx:afterRequest: this.closest('tr').remove()" hx-confirm="{% trans 'Confirmar aprovação?' %}" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>{% trans 'Aprovar' %}</button>
          <button class="text-sm text-red-600" hx-post="{% url 'nucleos_api:nucleo-recusar-membro' object.pk part.user.pk %}" hx-target="#pendente-{{ part.id }}" hx-swap="none" hx-on="htmx:afterRequest: this.closest('tr').remove()" hx-confirm="{% trans 'Confirmar recusa?' %}" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>{% trans 'Recusar' %}</button>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  {% endif %}

  {% if suplentes %}
  <h2 class="mt-6 font-semibold">{% trans 'Suplentes' %}</h2>
  <ul>
    {% for s in suplentes %}
    <li>
      {{ s.usuario.get_full_name|default:s.usuario.username }} -
      {{ s.periodo_inicio|date:'d/m/Y' }} a {{ s.periodo_fim|date:'d/m/Y' }} -
      {% if s.ativo %}{% trans 'Ativo' %}{% else %}{% trans 'Inativo' %}{% endif %}
      {% if request.user.user_type == 'admin' or request.user.user_type == 'coordenador' %}
      <form method="post" action="{% url 'nucleos:suplente_remover' object.pk s.id %}" class="inline">
        {% csrf_token %}
        <button class="text-sm text-red-600">{% trans 'Remover' %}</button>
      </form>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
  {% endif %}
  {% if request.user.user_type == 'admin' or request.user.user_type == 'coordenador' %}
  <div class="mt-4">
    <a href="{% url 'nucleos:suplente_adicionar' object.pk %}" class="text-blue-600">{% trans 'Adicionar Suplente' %}</a>
  </div>
  {% endif %}

  {% if request.user.user_type == 'admin' %}
  <div class="mt-4">
    <button type="button" class="px-4 py-2 bg-purple-600 text-white rounded" hx-get="{% url 'nucleos:convites_modal' object.pk %}" hx-target="#modal">
      {% trans 'Gerenciar convites' %} ({{ convites_pendentes }})
    </button>
    <p class="text-sm text-gray-500 mt-1">{% trans 'Convites restantes hoje:' %} {{ convites_restantes }}</p>
  </div>
  {% endif %}

  <div class="mt-6 space-x-2">
    <div class="inline-block relative">
      <a
        href="{% url 'nucleos_api:nucleo-exportar-membros' object.pk %}?formato=csv"
        class="text-blue-600"
        hx-boost="false"
        download="nucleo-{{ object.pk }}-membros.csv"
      >{% trans 'Exportar CSV' %}</a>
      <a
        href="{% url 'nucleos_api:nucleo-exportar-membros' object.pk %}?formato=xls"
        class="text-blue-600"
        hx-boost="false"
        download="nucleo-{{ object.pk }}-membros.xlsx"
      >{% trans 'Exportar XLS' %}</a>
    </div>
    {% if request.user.user_type == 'admin' or request.user.user_type == 'coordenador' %}
    <form method="post" action="{% url 'nucleos:toggle_active' object.pk %}" class="inline">{% csrf_token %}
      <button class="ml-2 text-orange-600">{% if object.deleted %}{% trans 'Reativar' %}{% else %}{% trans 'Inativar' %}{% endif %}</button>
    </form>
    {% endif %}
  </div>

    {% if mostrar_solicitar and request.user.user_type != 'admin' and request.user.user_type != 'coordenador' %}
    <div class="mt-4">
      <button id="solicitar-btn" type="button" class="px-4 py-2 bg-blue-600 text-white rounded" hx-get="{% url 'nucleos:solicitar_modal' object.pk %}" hx-target="#modal">{% trans 'Solicitar participação' %}</button>
    </div>
    {% endif %}
    {% if pode_postar %}
    <div class="mt-4">
      <button type="button" class="px-4 py-2 bg-green-600 text-white rounded" hx-get="{% url 'nucleos:postar_modal' object.pk %}" hx-target="#modal">{% trans 'Postar no feed' %}</button>
    </div>
    {% endif %}
    <div id="modal"></div>
  </section>
  {% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const statusEl = document.getElementById('membro-status');
  if (!statusEl) return;
  const url = "{% url 'nucleos_api:nucleo-membro-status' object.pk %}";
  const papelCoordenador = gettext('Coordenador');
  const papelMembro = gettext('Membro');
  const statusAtivo = gettext('Ativo');
  const statusInativo = gettext('Inativo');
  const statusSuspenso = gettext('Suspenso');
  function updateStatus() {
    fetch(url)
      .then(resp => resp.ok ? resp.json() : null)
      .then(data => {
        if (!data) return;
        let papel = data.papel === 'coordenador' ? papelCoordenador : papelMembro;
        let status = data.ativo ? statusAtivo : statusInativo;
        if (data.suspenso) status += ' (' + statusSuspenso + ')';
        statusEl.textContent = papel + ' - ' + status;
      })
      .catch(() => {});
  }
  updateStatus();
  document.body.addEventListener('htmx:afterRequest', updateStatus);
});
</script>
{% endblock %}
