{% extends 'base.html' %}
{% load i18n l10n %}

{% block title %}{{ object.nome }}{% endblock %}

{% block content %}
<section class="max-w-5xl mx-auto py-8">
  {% if object.cover %}
  <img src="{{ object.cover.url }}" class="w-full h-48 object-cover rounded" alt="Capa de {{ object.nome }}" />
  {% endif %}
  <div class="flex items-center gap-4 mt-4">
    {% if object.avatar %}<img src="{{ object.avatar.url }}" class="w-16 h-16 rounded-full" alt="{{ object.nome }}" />{% endif %}
    <div>
      <div class="flex items-center gap-2">
        <h1 class="text-2xl font-bold">{{ object.nome }}</h1>
        {% if request.user.user_type == 'admin' or request.user.user_type == 'coordenador' %}
        <a href="{% url 'nucleos:update' object.pk %}" class="px-4 py-2 bg-blue-600 text-white rounded">{% trans 'Editar' %}</a>
        <a href="{% url 'nucleos:delete' object.pk %}" class="px-4 py-2 bg-red-600 text-white rounded">{% trans 'Excluir' %}</a>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Cards de totais -->
  <div class="card-grid mt-6 gap-4">
    {% include "_partials/cards/total_card.html" with label=_('Membros') valor=total_membros %}
    {% include "_partials/cards/total_card.html" with label=_('Eventos (ativos + concluídos)') valor=total_eventos %}
    {% include "_partials/cards/total_card.html" with label=_('Eventos ativos') valor=total_eventos_ativos %}
    {% include "_partials/cards/total_card.html" with label=_('Eventos concluídos') valor=total_eventos_concluidos %}
  </div>

  <!-- Abas -->
  <div class="mt-8">
    <div class="border-b border-[var(--border)]">
      <nav class="-mb-px flex gap-6" aria-label="Tabs">
        <button type="button" class="tab-btn py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 data-[active=true]:border-primary data-[active=true]:text-primary" data-tab="membros">{% trans 'Membros' %}</button>
        <button type="button" class="tab-btn py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 data-[active=true]:border-primary data-[active=true]:text-primary" data-tab="eventos">{% trans 'Eventos' %}</button>
        <button type="button" class="tab-btn py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 data-[active=true]:border-primary data-[active=true]:text-primary" data-tab="feed">{% trans 'Feed do Núcleo' %}</button>
      </nav>
    </div>

    <div id="tab-panels" class="mt-6">
      <!-- Painel: Membros -->
      <div class="tab-panel" data-tab="membros">
        <div class="card-grid gap-4" role="list" aria-label="{% trans 'Lista de membros do núcleo' %}">
          {% for part in membros_ativos %}
            {% include 'nucleos/partials/membro_card.html' with part=part %}
          {% empty %}
            <p class="col-span-full text-center text-gray-500">{% trans 'Sem membros.' %}</p>
          {% endfor %}
        </div>

        {% if membros_pendentes %}
        <h3 class="mt-6 font-semibold">{% trans 'Pendentes' %}</h3>
        <table class="w-full text-left" id="pendentes">
          <thead>
            <tr><th>{% trans 'Usuário' %}</th><th>{% trans 'Solicitado em' %}</th><th></th></tr>
          </thead>
          <tbody>
          {% for part in membros_pendentes %}
            <tr id="pendente-{{ part.id }}">
              <td>{{ part.user.get_full_name|default:part.user.username }}</td>
              <td>{{ part.data_solicitacao|date:'d/m/Y' }}</td>
              <td class="space-x-2">
                <button class="text-sm text-green-600" hx-post="{% url 'nucleos_api:nucleo-aprovar-membro' object.pk part.user.pk %}" hx-target="#pendente-{{ part.id }}" hx-swap="none" hx-on="htmx:afterRequest: this.closest('tr').remove()" hx-confirm="{% trans 'Confirmar aprovação?' %}" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>{% trans 'Aprovar' %}</button>
                <button class="text-sm text-red-600" hx-post="{% url 'nucleos_api:nucleo-recusar-membro' object.pk part.user.pk %}" hx-target="#pendente-{{ part.id }}" hx-swap="none" hx-on="htmx:afterRequest: this.closest('tr').remove()" hx-confirm="{% trans 'Confirmar recusa?' %}" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>{% trans 'Recusar' %}</button>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        {% endif %}

        {% if suplentes %}
        <h3 class="mt-6 font-semibold">{% trans 'Suplentes' %}</h3>
        <ul class="list-disc pl-5 text-sm text-neutral-700">
          {% for s in suplentes %}
            <li>
              {{ s.usuario.get_full_name|default:s.usuario.username }} —
              {{ s.periodo_inicio|date:'d/m/Y' }} a {{ s.periodo_fim|date:'d/m/Y' }}
            </li>
          {% endfor %}
        </ul>
        {% endif %}

        {% if mostrar_solicitar and request.user.user_type != 'admin' and request.user.user_type != 'coordenador' %}
        <div class="mt-4">
          <button id="solicitar-btn" type="button" class="px-4 py-2 bg-blue-600 text-white rounded" hx-get="{% url 'nucleos:solicitar_modal' object.pk %}" hx-target="#modal">{% trans 'Solicitar participação' %}</button>
        </div>
        {% endif %}
      </div>

      <!-- Painel: Eventos -->
      <div class="tab-panel hidden" data-tab="eventos">
        <div class="card-grid mt-2 gap-4">
          {% for evento in eventos %}
            {% include '_components/card_evento.html' with evento=evento %}
          {% empty %}
            <p class="text-sm text-gray-500">{% trans 'Sem eventos.' %}</p>
          {% endfor %}
        </div>
      </div>

      <!-- Painel: Feed -->
      <div class="tab-panel hidden" data-tab="feed">
        {% if pode_postar %}
        <div class="mb-4">
          <button type="button" class="px-4 py-2 bg-green-600 text-white rounded" hx-get="{% url 'nucleos:postar_modal' object.pk %}" hx-target="#modal">{% trans 'Postar no feed' %}</button>
        </div>
        {% endif %}
        {% include 'feed/_grid.html' with posts=nucleo_posts %}
      </div>
    </div>
    <div id="modal"></div>
  </div>

  <div class="flex justify-end mt-4">
    {% if perms.nucleos.delete_nucleo %}
    <a
      href="{% url 'nucleos:delete' object.pk %}"
      class="btn-danger btn-sm"
      hx-confirm="Deseja realmente excluir?"
      >{% trans "Excluir" %}</a
    >
    {% endif %}
  </div>

  <script>
    // Tabs simples em JS vanilla
    const tabButtons = document.querySelectorAll('.tab-btn');
    const panels = document.querySelectorAll('.tab-panel');
    function activate(tab) {
      tabButtons.forEach(btn => btn.dataset.active = (btn.dataset.tab === tab));
      panels.forEach(panel => panel.classList.toggle('hidden', panel.dataset.tab !== tab));
    }
    // Ativa 'membros' por padrão
    activate('membros');
    tabButtons.forEach(btn => btn.addEventListener('click', () => activate(btn.dataset.tab)));
  </script>
  </section>
  {% endblock %}

