{% load i18n %}
<div class="p-4 bg-[var(--bg-secondary)] rounded shadow max-w-md" id="convites-modal">
  <h2 class="text-lg font-semibold mb-2">{% trans 'Convites do núcleo' %}</h2>
  <p class="text-sm text-gray-600">{% trans 'Convites restantes hoje:' %} {{ convites_restantes }}</p>
  <form id="convite-form" class="mt-2 flex flex-col gap-2" hx-post="{% url 'nucleos_api:nucleo-convites' nucleo.pk %}" hx-swap="none">
    {% csrf_token %}
    <input type="email" name="email" class="border border-[var(--border)] bg-[var(--bg-secondary)] rounded px-2 py-1" placeholder="{% trans 'email@example.com' %}" required />
    <select name="papel" class="border border-[var(--border)] bg-[var(--bg-secondary)] rounded px-2 py-1">
      <option value="membro">{% trans 'Membro' %}</option>
      <option value="coordenador">{% trans 'Coordenador' %}</option>
    </select>
    <div class="flex justify-end gap-2">
      <button type="button" class="btn btn-secondary" hx-on="click: document.getElementById('convites-modal').remove()">{% trans 'Fechar' %}</button>
      <button type="submit" class="btn btn-primary">{% trans 'Enviar convite' %}</button>
    </div>
  </form>
  <ul id="convites-list" class="mt-4 space-y-2">
    {% for c in convites %}
    <li id="convite-{{ c.id }}" class="flex justify-between items-center">
      <span>{{ c.email }} - {{ c.papel }}</span>
      <form hx-delete="{% url 'nucleos_api:nucleo-revogar-convite' nucleo.pk c.id %}"
            hx-target="#convite-{{ c.id }}" hx-swap="outerHTML"
            hx-confirm="{% trans 'Confirmar revogação?' %}">
        {% csrf_token %}
        <button type="submit" class="text-red-600">{% trans 'Revogar' %}</button>
      </form>
    </li>
    {% empty %}
    <li class="text-sm text-gray-500">{% trans 'Nenhum convite pendente.' %}</li>
    {% endfor %}
  </ul>
  <script>
    document.getElementById('convite-form').addEventListener('htmx:afterRequest', function (event) {
      if (event.detail.xhr.status === 201) {
        const data = JSON.parse(event.detail.xhr.responseText);
        const csrfToken = document.querySelector('#convite-form input[name="csrfmiddlewaretoken"]').value;
        const deleteUrl = "{% url 'nucleos_api:nucleo-revogar-convite' nucleo.pk 0 %}".replace(/0\/$/, `${data.id}/`);
        const li = document.createElement('li');
        li.id = `convite-${data.id}`;
        li.className = 'flex justify-between items-center';
        li.innerHTML = `\n        <span>${data.email} - ${data.papel}</span>\n        <form hx-delete="${deleteUrl}" hx-target="#convite-${data.id}" hx-swap="outerHTML" hx-confirm="{% trans 'Confirmar revogação?' %}">\n          <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}" />\n          <button type="submit" class="text-red-600">{% trans 'Revogar' %}</button>\n        </form>\n      `;
        document.getElementById('convites-list').prepend(li);
        event.target.reset();
      } else if (event.detail.xhr.status === 429) {
        alert(event.detail.xhr.responseText);
      }
    });
  </script>
</div>
