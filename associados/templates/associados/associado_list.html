{% extends 'base.html' %}
{% load i18n lucide_icons %}

{% block title %}{% trans 'Associados' %}{% endblock %}

{% block hero %}
  {% include '_components/hero_associados.html' with title=_('Associados') action_template='associados/hero_action.html' %}
{% endblock %}

{% block content %}

  <div class="space-y-6">
    <details class="card group" data-associados-search-card>
      <summary class="card-header flex items-center justify-between gap-4 cursor-pointer">
        <div class="flex items-start gap-3">
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-primary-500)]/10 text-[var(--color-primary-500)] shadow-lg shadow-[var(--color-primary-500)]/15">
            {% lucide 'search' class='h-6 w-6' aria_hidden='true' %}
          </span>
          <div class="space-y-1">
            <p class="text-xl font-semibold">{% trans "Buscar associados" %}</p>
            <p class="text-sm text-[var(--text-secondary)]">{% trans "Procure por associados, nucleados, consultores e coordenadores." %}</p>
          </div>
        </div>
        <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:-rotate-180">
          {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
        </span>
      </summary>
      <div class="card-body space-y-4">
        <form
          class="flex flex-col gap-3 md:flex-row md:items-center"
          role="search"
          novalidate
          data-associados-search-form
          data-initial-search-term="{{ search_term }}"
          data-feedback-found-template="{% blocktrans with term='__term__' %}Resultado encontrado: {{ term }}.{% endblocktrans %}"
          data-feedback-not-found-template="{% blocktrans with term='__term__' %}Nenhum associado correspondente a {{ term }}.{% endblocktrans %}"
          data-feedback-empty="{% trans 'Digite um termo para buscar associados.' %}"
        >
          <div class="flex w-full items-center gap-2">
            <label for="associados-search" class="sr-only">{% trans "Buscar associados" %}</label>
            <input
              type="search"
              id="associados-search"
              name="q"
              value="{{ search_term }}"
              autocomplete="off"
              placeholder="{% trans 'Buscar por nome, usuário ou contato' %}"
              class="input input-bordered w-full"
              data-associados-search-input
            />
            <button type="submit" class="btn btn-secondary shrink-0" aria-label="{% trans 'Buscar' %}">
              {% lucide 'search' class='h-4 w-4' aria_hidden='true' %}
            </button>
          </div>
        </form>
        <p
          class="text-sm text-[var(--text-secondary)]"
          data-associados-search-feedback
          id="associados-search-feedback"
          hidden
          role="status"
          aria-live="polite"
        ></p>
      </div>
    </details>

    <details class="card group" data-associados-section="sem-nucleo">
      <summary class="card-header flex flex-col gap-4 cursor-pointer sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-start gap-3 sm:flex-1 sm:items-center">
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-primary-500)]/10 text-[var(--color-primary-500)] shadow-lg shadow-[var(--color-primary-500)]/15">
            {% lucide 'user-round-minus' class='h-6 w-6' aria_hidden='true' %}
          </span>
          <div class="space-y-1">
            <p class="text-xl font-semibold">{% trans "Associados não nucleados" %}</p>
            <p class="text-sm text-[var(--text-secondary)]">
              {% blocktrans count count=associados_sem_nucleo_count %}
                {{ count }} associado no total
              {% plural %}
                {{ count }} associados no total
              {% endblocktrans %}
            </p>
          </div>
        </div>
        <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:-rotate-180 self-end sm:self-center sm:ml-auto">
          {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
        </span>
      </summary>
      <div class="card-body">
        {% include 'associados/_grid.html' with usuarios=associados_sem_nucleo empty_message=_('Nenhum associado sem núcleo encontrado.') %}
      </div>
    </details>

    <details class="card group" data-associados-section="nucleados">
      <summary class="card-header flex flex-col gap-4 cursor-pointer sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-start gap-3 sm:flex-1 sm:items-center">
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-success-500)]/10 text-[var(--color-success-500)] shadow-lg shadow-[var(--color-success-500)]/15">
            {% lucide 'user-round-plus' class='h-6 w-6' aria_hidden='true' %}
          </span>
          <div class="space-y-1">
            <p class="text-xl font-semibold">{% trans "Associados nucleados" %}</p>
            <p class="text-sm text-[var(--text-secondary)]">
              {% blocktrans count count=associados_nucleados_count %}
                {{ count }} associado no total
              {% plural %}
                {{ count }} associados no total
              {% endblocktrans %}
            </p>
          </div>
        </div>
        <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:-rotate-180 self-end sm:self-center sm:ml-auto">
          {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
        </span>
      </summary>
      <div class="card-body">
        {% include 'associados/_grid.html' with usuarios=associados_nucleados empty_message=_('Nenhum associado nucleado encontrado.') %}
      </div>
    </details>

    <details class="card group" data-associados-section="consultores">
      <summary class="card-header flex flex-col gap-4 cursor-pointer sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-start gap-3 sm:flex-1 sm:items-center">
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-warning-500)]/10 text-[var(--color-warning-600)] shadow-lg shadow-[var(--color-warning-500)]/20">
            {% lucide 'user-round-cog' class='h-6 w-6' aria_hidden='true' %}
          </span>
          <div class="space-y-1">
            <p class="text-xl font-semibold">{% trans "Consultores" %}</p>
            <p class="text-sm text-[var(--text-secondary)]">
              {% blocktrans count count=associados_consultores_count %}
                {{ count }} consultor no total
              {% plural %}
                {{ count }} consultores no total
              {% endblocktrans %}
            </p>
          </div>
        </div>
        <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:-rotate-180 self-end sm:self-center sm:ml-auto">
          {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
        </span>
      </summary>
      <div class="card-body">
        {% include 'associados/_grid.html' with usuarios=associados_consultores empty_message=_('Nenhum consultor encontrado.') %}
      </div>
    </details>

    <details class="card group" data-associados-section="coordenadores">
      <summary class="card-header flex flex-col gap-4 cursor-pointer sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-start gap-3 sm:flex-1 sm:items-center">
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-info-500)]/10 text-[var(--color-info-600)] shadow-lg shadow-[var(--color-info-500)]/20">
            {% lucide 'shield-check' class='h-6 w-6' aria_hidden='true' %}
          </span>
          <div class="space-y-1">
            <p class="text-xl font-semibold">{% trans "Coordenadores" %}</p>
            <p class="text-sm text-[var(--text-secondary)]">
              {% blocktrans count count=associados_coordenadores_count %}
                {{ count }} coordenador no total
              {% plural %}
                {{ count }} coordenadores no total
              {% endblocktrans %}
            </p>
          </div>
        </div>
        <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:-rotate-180 self-end sm:self-center sm:ml-auto">
          {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
        </span>
      </summary>
      <div class="card-body">
        {% include 'associados/_grid.html' with usuarios=associados_coordenadores empty_message=_('Nenhum coordenador encontrado.') %}
      </div>
    </details>
  </div>

{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script>
    (function () {
      const highlightClasses = [
        'ring-2',
        'ring-offset-2',
        'ring-[var(--color-primary-500)]',
        'ring-offset-[var(--bg-primary)]',
        'transition-shadow',
      ];

      function normalizeTerm(value) {
        return value
          ? value
              .toString()
              .normalize('NFD')
              .replace(/[\u0300-\u036f]/g, '')
              .toLowerCase()
          : '';
      }

      function setFeedbackMessage(feedbackEl, message) {
        if (!feedbackEl) {
          return;
        }
        if (message) {
          feedbackEl.textContent = message;
          feedbackEl.hidden = false;
        } else {
          feedbackEl.textContent = '';
          feedbackEl.hidden = true;
        }
      }

      document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('[data-associados-search-form]');
        const searchCard = document.querySelector('[data-associados-search-card]');
        if (!form) {
          return;
        }

        const input = form.querySelector('[data-associados-search-input]');
        const feedback = form.parentElement.querySelector('[data-associados-search-feedback]');
        const cards = Array.from(document.querySelectorAll('[data-associado-card]'));
        const sections = Array.from(document.querySelectorAll('[data-associados-section]'));

        function clearHighlights() {
          cards.forEach((card) => {
            const article = card.querySelector('article');
            if (article) {
              highlightClasses.forEach((cls) => article.classList.remove(cls));
              article.removeAttribute('data-associado-highlight');
            }
          });
        }

        function highlightCard(card) {
          const article = card.querySelector('article');
          if (!article) {
            return;
          }
          highlightClasses.forEach((cls) => article.classList.add(cls));
          article.setAttribute('data-associado-highlight', 'true');

          window.requestAnimationFrame(() => {
            article.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const focusable = article.querySelector('a');
            if (focusable) {
              focusable.focus({ preventScroll: true });
            }
          });
        }

        function openSectionFor(card) {
          const section = card.closest('details');
          if (!section) {
            return null;
          }
          sections.forEach((detail) => {
            if (detail === section) {
              detail.open = true;
            } else {
              detail.open = false;
            }
          });
          return section;
        }

        function formatMessage(template, value) {
          if (!template) {
            return '';
          }
          return template.replace('__term__', value);
        }

        function performSearch(term, options = {}) {
          const trimmedTerm = term.trim();
          if (!trimmedTerm) {
            clearHighlights();
            if (searchCard && !searchCard.open) {
              searchCard.open = true;
            }
            if (options.skipEmptyMessage) {
              setFeedbackMessage(feedback, '');
            } else {
              setFeedbackMessage(feedback, form.dataset.feedbackEmpty || '');
            }
            return;
          }

          const normalizedSearch = normalizeTerm(trimmedTerm);
          if (!normalizedSearch) {
            clearHighlights();
            if (searchCard && !searchCard.open) {
              searchCard.open = true;
            }
            setFeedbackMessage(feedback, form.dataset.feedbackEmpty || '');
            return;
          }

          const match = cards.find((card) => {
            const cardValue = normalizeTerm(card.dataset.associadoSearch || '');
            return cardValue.includes(normalizedSearch);
          });

          if (match) {
            clearHighlights();
            if (searchCard && !searchCard.open) {
              searchCard.open = true;
            }
            openSectionFor(match);
            highlightCard(match);
            const label = match.dataset.associadoLabel || trimmedTerm;
            setFeedbackMessage(
              feedback,
              formatMessage(form.dataset.feedbackFoundTemplate, label) || ''
            );
            return;
          }

          clearHighlights();
          if (searchCard && !searchCard.open) {
            searchCard.open = true;
          }
          setFeedbackMessage(
            feedback,
            formatMessage(form.dataset.feedbackNotFoundTemplate, trimmedTerm) || ''
          );
        }

        form.addEventListener('submit', function (event) {
          event.preventDefault();
          performSearch(input.value || '');
        });

        input.addEventListener('input', function () {
          if (!input.value.trim()) {
            clearHighlights();
            setFeedbackMessage(feedback, '');
          }
        });

        input.addEventListener('search', function () {
          if (!input.value.trim()) {
            clearHighlights();
            setFeedbackMessage(feedback, '');
          }
        });

        input.addEventListener('keydown', function (event) {
          if (event.key === 'Escape') {
            input.value = '';
            clearHighlights();
            setFeedbackMessage(feedback, '');
          }
        });

        const initialTerm = form.dataset.initialSearchTerm || '';
        if (initialTerm.trim()) {
          performSearch(initialTerm, { skipEmptyMessage: true });
        }
      });
    })();
  </script>
{% endblock %}
