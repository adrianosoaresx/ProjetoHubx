{% extends 'base.html' %}
{% load i18n lucide_icons %}

{% block title %}{% trans 'Associados' %}{% endblock %}

{% block hero %}
  {% include '_components/hero_associados.html' with title=_('Associados') action_template='associados/hero_action.html' %}
{% endblock %}

{% block content %}

  <div class="space-y-6">
    <details class="card group" data-associados-search-card>
      <summary class="card-header flex items-center justify-between gap-4 cursor-pointer">
        <div class="flex items-start gap-3">
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-primary-500)]/10 text-[var(--color-primary-500)] shadow-lg shadow-[var(--color-primary-500)]/15">
            {% lucide 'search' class='h-6 w-6' aria_hidden='true' %}
          </span>
          <div class="space-y-1">
            <p class="text-xl font-semibold">{% trans "Buscar associados" %}</p>
            <p class="text-sm text-[var(--text-secondary)]">{% trans "Procure por associados, nucleados, consultores e coordenadores." %}</p>
          </div>
        </div>
        <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:-rotate-180">
          {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
        </span>
      </summary>
      <div class="card-body space-y-4">
        <form
          class="flex flex-col gap-3 md:flex-row md:items-center"
          role="search"
          novalidate
          data-associados-search-form
          data-initial-search-term="{{ search_term }}"
          data-feedback-found-template="{% blocktrans with term='__term__' %}Resultado encontrado: {{ term }}.{% endblocktrans %}"
          data-feedback-not-found-template="{% blocktrans with term='__term__' %}Nenhum associado correspondente a {{ term }}.{% endblocktrans %}"
          data-feedback-empty="{% trans 'Digite um termo para buscar associados.' %}"
        >
          <div class="flex w-full items-center gap-2">
            <label for="associados-search" class="sr-only">{% trans "Buscar associados" %}</label>
            <input
              type="search"
              id="associados-search"
              name="q"
              value="{{ search_term }}"
              autocomplete="off"
              placeholder="{% trans 'Buscar por nome, usuário ou contato' %}"
              class="input input-bordered w-full"
              data-associados-search-input
            />
            <button type="submit" class="btn btn-secondary shrink-0" aria-label="{% trans 'Buscar' %}">
              {% lucide 'search' class='h-4 w-4' aria_hidden='true' %}
            </button>
          </div>
        </form>
        <p
          class="text-sm text-[var(--text-secondary)]"
          data-associados-search-feedback
          id="associados-search-feedback"
          hidden
          role="status"
          aria-live="polite"
        ></p>
      </div>
    </details>

    <details class="card group" data-associados-section="sem-nucleo">
      <summary class="card-header flex items-center justify-between gap-4 cursor-pointer">
        <div class="flex items-start gap-3">
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-primary-500)]/10 text-[var(--color-primary-500)] shadow-lg shadow-[var(--color-primary-500)]/15">
            {% lucide 'user-round-minus' class='h-6 w-6' aria_hidden='true' %}
          </span>
          <div class="space-y-1">
            <p class="text-xl font-semibold">{% trans "Associados não nucleados" %}</p>
            <p class="text-sm text-[var(--text-secondary)]">
              {% blocktrans count count=associados_sem_nucleo_count %}
                {{ count }} associado no total
              {% plural %}
                {{ count }} associados no total
              {% endblocktrans %}
            </p>
          </div>
        </div>
        <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:-rotate-180">
          {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
        </span>
      </summary>
      <div >
        {% include 'associados/_carousel.html' with page=associados_sem_nucleo_page section='sem_nucleo' empty_message=associados_section_empty_messages.sem_nucleo fetch_url=associados_fetch_url search_term=search_term %}
      </div>
    </details>

    <details class="card group" data-associados-section="nucleados">
      <summary class="card-header flex items-center justify-between gap-4 cursor-pointer">
        <div class="flex items-start gap-3">
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-success-500)]/10 text-[var(--color-success-500)] shadow-lg shadow-[var(--color-success-500)]/15">
            {% lucide 'user-round-plus' class='h-6 w-6' aria_hidden='true' %}
          </span>
          <div class="space-y-1">
            <p class="text-xl font-semibold">{% trans "Associados nucleados" %}</p>
            <p class="text-sm text-[var(--text-secondary)]">
              {% blocktrans count count=associados_nucleados_count %}
                {{ count }} associado no total
              {% plural %}
                {{ count }} associados no total
              {% endblocktrans %}
            </p>
          </div>
        </div>
        <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:-rotate-180">
          {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
        </span>
      </summary>
      <div>
        {% include 'associados/_carousel.html' with page=associados_nucleados_page section='nucleados' empty_message=associados_section_empty_messages.nucleados fetch_url=associados_fetch_url search_term=search_term %}
      </div>
    </details>

    <details class="card group" data-associados-section="consultores">
      <summary class="card-header flex items-center justify-between gap-4 cursor-pointer">
        <div class="flex items-start gap-3">
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-warning-500)]/10 text-[var(--color-warning-600)] shadow-lg shadow-[var(--color-warning-500)]/20">
            {% lucide 'user-round-cog' class='h-6 w-6' aria_hidden='true' %}
          </span>
          <div class="space-y-1">
            <p class="text-xl font-semibold">{% trans "Consultores" %}</p>
            <p class="text-sm text-[var(--text-secondary)]">
              {% blocktrans count count=associados_consultores_count %}
                {{ count }} consultor no total
              {% plural %}
                {{ count }} consultores no total
              {% endblocktrans %}
            </p>
          </div>
        </div>
        <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:-rotate-180">
          {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
        </span>
      </summary>
      <div>
        {% include 'associados/_carousel.html' with page=associados_consultores_page section='consultores' empty_message=associados_section_empty_messages.consultores fetch_url=associados_fetch_url search_term=search_term %}
      </div>
    </details>

    <details class="card group" data-associados-section="coordenadores">
      <summary class="card-header flex items-center justify-between gap-4 cursor-pointer">
        <div class="flex items-start gap-3">
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-info-500)]/10 text-[var(--color-info-600)] shadow-lg shadow-[var(--color-info-500)]/20">
            {% lucide 'shield-check' class='h-6 w-6' aria_hidden='true' %}
          </span>
          <div class="space-y-1">
            <p class="text-xl font-semibold">{% trans "Coordenadores" %}</p>
            <p class="text-sm text-[var(--text-secondary)]">
              {% blocktrans count count=associados_coordenadores_count %}
                {{ count }} coordenador no total
              {% plural %}
                {{ count }} coordenadores no total
              {% endblocktrans %}
            </p>
          </div>
        </div>
        <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:-rotate-180">
          {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
        </span>
      </summary>
      <div>
        {% include 'associados/_carousel.html' with page=associados_coordenadores_page section='coordenadores' empty_message=associados_section_empty_messages.coordenadores fetch_url=associados_fetch_url search_term=search_term %}
      </div>
    </details>
  </div>

{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script>
    (function () {
      function initCarousel(root) {
        const track = root.querySelector('[data-carousel-track]');
        const prev = root.querySelector('[data-carousel-prev]');
        const next = root.querySelector('[data-carousel-next]');
        const fetchUrl = root.dataset.fetchUrl || '';
        const section = root.dataset.section || '';
        const searchTerm = root.dataset.searchTerm || '';

        if (!track) {
          return;
        }

        let currentSlide = Math.max(parseInt(root.dataset.currentSlide || '1', 10), 1);
        let currentBackendPage = Math.max(parseInt(root.dataset.backendPage || '1', 10), 1);
        let totalBackendPages = Math.max(parseInt(root.dataset.backendTotalPages || '1', 10), 1);
        const loadedBackendPages = new Set();
        loadedBackendPages.add(currentBackendPage);
        let isLoading = false;

        function getSlides() {
          return Array.from(track.querySelectorAll('[data-carousel-page]')).filter((slide) => {
            if (!(slide instanceof HTMLElement)) {
              return false;
            }
            if (slide.offsetParent !== null) {
              return true;
            }
            const rects = slide.getClientRects();
            return rects.length > 0;
          });
        }

        function setTransform(slideIndex) {
          const slides = getSlides();
          if (!slides.length) {
            currentSlide = 1;
            root.dataset.currentSlide = String(currentSlide);
            track.style.transform = 'translateX(0)';
            return currentSlide;
          }
          const clampedIndex = Math.min(Math.max(slideIndex, 1), slides.length);
          currentSlide = clampedIndex;
          root.dataset.currentSlide = String(currentSlide);
          track.style.transform = `translateX(-${(clampedIndex - 1) * 100}%)`;
          return currentSlide;
        }

        function updateButtons() {
          const slides = getSlides();
          const hasSlides = slides.length > 0;
          if (prev) {
            prev.disabled = !hasSlides || isLoading || currentSlide <= 1;
          }
          if (next) {
            const slidesCount = slides.length;
            const reachedEnd = currentSlide >= slidesCount && currentBackendPage >= totalBackendPages;
            next.disabled = !hasSlides || isLoading || reachedEnd;
          }
        }

        async function ensureBackendPage(page) {
          if (!fetchUrl || loadedBackendPages.has(page) || page > totalBackendPages) {
            return [];
          }
          isLoading = true;
          updateButtons();
          try {
            const url = new URL(fetchUrl, window.location.origin);
            url.searchParams.set('section', section);
            url.searchParams.set('page', String(page));
            if (searchTerm) {
              url.searchParams.set('q', searchTerm);
            }
            const response = await fetch(url.toString(), {
              headers: { 'X-Requested-With': 'XMLHttpRequest' },
            });
            if (!response.ok) {
              throw new Error('Request failed');
            }
            const payload = await response.json();
            const parsedTotal = parseInt(String(payload.total_pages || totalBackendPages), 10);
            if (!Number.isNaN(parsedTotal)) {
              totalBackendPages = Math.max(parsedTotal, 1);
              root.dataset.backendTotalPages = String(totalBackendPages);
            }
            const template = document.createElement('template');
            template.innerHTML = payload.html || '';
            const newSlides = Array.from(template.content.querySelectorAll('[data-carousel-page]'));
            newSlides.forEach((slide) => {
              slide.classList.add('flex-shrink-0');
              track.appendChild(slide);
            });
            loadedBackendPages.add(page);
            currentBackendPage = Math.max(currentBackendPage, page);
            root.dataset.backendPage = String(currentBackendPage);
            setTransform(currentSlide);
            updateButtons();
            return newSlides;
          } catch (error) {
            console.error(error);
            throw error;
          } finally {
            isLoading = false;
            updateButtons();
          }
        }

        async function goToSlide(targetIndex) {
          if (isLoading) {
            return;
          }
          let desiredIndex = Math.max(targetIndex, 1);
          let slides = getSlides();
          if (!slides.length) {
            return;
          }
          while (desiredIndex > slides.length) {
            if (currentBackendPage >= totalBackendPages) {
              desiredIndex = slides.length;
              break;
            }
            try {
              await ensureBackendPage(currentBackendPage + 1);
            } catch (error) {
              return;
            }
            slides = getSlides();
            if (!slides.length) {
              return;
            }
          }

          slides = getSlides();
          if (!slides.length) {
            return;
          }

          const maxIndex = slides.length;
          desiredIndex = Math.min(desiredIndex, maxIndex);
          setTransform(desiredIndex);
          updateButtons();
        }

        if (prev) {
          prev.addEventListener('click', () => {
            if (!isLoading) {
              goToSlide(currentSlide - 1);
            }
          });
        }

        if (next) {
          next.addEventListener('click', () => {
            if (!isLoading) {
              goToSlide(currentSlide + 1);
            }
          });
        }

        const mediaQuery = typeof window.matchMedia === 'function' ? window.matchMedia('(min-width: 1024px)') : null;

        function handleBreakpointChange() {
          setTransform(currentSlide);
          updateButtons();
        }

        if (mediaQuery) {
          if (typeof mediaQuery.addEventListener === 'function') {
            mediaQuery.addEventListener('change', handleBreakpointChange);
          } else if (typeof mediaQuery.addListener === 'function') {
            mediaQuery.addListener(handleBreakpointChange);
          }
        }

        window.addEventListener('resize', handleBreakpointChange);

        setTransform(currentSlide);
        updateButtons();
      }

      document.addEventListener('DOMContentLoaded', () => {
        document
          .querySelectorAll('[data-associados-carousel]')
          .forEach((element) => initCarousel(element));
      });
    })();
  </script>
{% endblock %}
