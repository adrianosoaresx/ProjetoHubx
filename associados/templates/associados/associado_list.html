{% extends 'base.html' %}
{% load i18n lucide_icons %}

{% block title %}{% trans 'Associados' %}{% endblock %}

{% block hero %}
  {% include '_components/hero_associados.html' with title=_('Associados') action_template='associados/hero_action.html' %}
{% endblock %}

{% block content %}

  <div class="space-y-6">
    <details class="card group" data-associados-search-card>
      <summary class="card-header flex items-center justify-between gap-4 cursor-pointer">
        <div class="flex items-start gap-3">
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-primary-500)]/10 text-[var(--color-primary-500)] shadow-lg shadow-[var(--color-primary-500)]/15">
            {% lucide 'search' class='h-6 w-6' aria_hidden='true' %}
          </span>
          <div class="space-y-1">
            <p class="text-xl font-semibold">{% trans "Buscar associados" %}</p>
            <p class="text-sm text-[var(--text-secondary)]">{% trans "Procure por associados, nucleados, consultores e coordenadores." %}</p>
          </div>
        </div>
        <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:-rotate-180">
          {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
        </span>
      </summary>
      <div class="card-body space-y-4">
        <form
          class="flex flex-col gap-3 md:flex-row md:items-center"
          role="search"
          novalidate
          data-associados-search-form
          data-initial-search-term="{{ search_term }}"
          data-feedback-found-template="{% blocktrans with term='__term__' %}Resultado encontrado: {{ term }}.{% endblocktrans %}"
          data-feedback-not-found-template="{% blocktrans with term='__term__' %}Nenhum associado correspondente a {{ term }}.{% endblocktrans %}"
          data-feedback-empty="{% trans 'Digite um termo para buscar associados.' %}"
        >
          <div class="flex w-full items-center gap-2">
            <label for="associados-search" class="sr-only">{% trans "Buscar associados" %}</label>
            <input
              type="search"
              id="associados-search"
              name="q"
              value="{{ search_term }}"
              autocomplete="off"
              placeholder="{% trans 'Buscar por nome, usuário ou contato' %}"
              class="input input-bordered w-full"
              data-associados-search-input
            />
            <button type="submit" class="btn btn-secondary shrink-0" aria-label="{% trans 'Buscar' %}">
              {% lucide 'search' class='h-4 w-4' aria_hidden='true' %}
            </button>
          </div>
        </form>
        <p
          class="text-sm text-[var(--text-secondary)]"
          data-associados-search-feedback
          id="associados-search-feedback"
          hidden
          role="status"
          aria-live="polite"
        ></p>
      </div>
    </details>

    <details class="card group" data-associados-section="sem-nucleo">
      <summary class="card-header flex items-center justify-between gap-4 cursor-pointer">
        <div class="flex items-start gap-3">
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-primary-500)]/10 text-[var(--color-primary-500)] shadow-lg shadow-[var(--color-primary-500)]/15">
            {% lucide 'user-round-minus' class='h-6 w-6' aria_hidden='true' %}
          </span>
          <div class="space-y-1">
            <p class="text-xl font-semibold">{% trans "Associados não nucleados" %}</p>
            <p class="text-sm text-[var(--text-secondary)]">
              {% blocktrans count count=associados_sem_nucleo_count %}
                {{ count }} associado no total
              {% plural %}
                {{ count }} associados no total
              {% endblocktrans %}
            </p>
          </div>
        </div>
        <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:-rotate-180">
          {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
        </span>
      </summary>
      <div class="card-body">
        {% include 'associados/_carousel.html' with page=associados_sem_nucleo_page section='sem_nucleo' empty_message=associados_section_empty_messages.sem_nucleo fetch_url=associados_fetch_url search_term=search_term %}
      </div>
    </details>

    <details class="card group" data-associados-section="nucleados">
      <summary class="card-header flex items-center justify-between gap-4 cursor-pointer">
        <div class="flex items-start gap-3">
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-success-500)]/10 text-[var(--color-success-500)] shadow-lg shadow-[var(--color-success-500)]/15">
            {% lucide 'user-round-plus' class='h-6 w-6' aria_hidden='true' %}
          </span>
          <div class="space-y-1">
            <p class="text-xl font-semibold">{% trans "Associados nucleados" %}</p>
            <p class="text-sm text-[var(--text-secondary)]">
              {% blocktrans count count=associados_nucleados_count %}
                {{ count }} associado no total
              {% plural %}
                {{ count }} associados no total
              {% endblocktrans %}
            </p>
          </div>
        </div>
        <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:-rotate-180">
          {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
        </span>
      </summary>
      <div class="card-body">
        {% include 'associados/_carousel.html' with page=associados_nucleados_page section='nucleados' empty_message=associados_section_empty_messages.nucleados fetch_url=associados_fetch_url search_term=search_term %}
      </div>
    </details>

    <details class="card group" data-associados-section="consultores">
      <summary class="card-header flex items-center justify-between gap-4 cursor-pointer">
        <div class="flex items-start gap-3">
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-warning-500)]/10 text-[var(--color-warning-600)] shadow-lg shadow-[var(--color-warning-500)]/20">
            {% lucide 'user-round-cog' class='h-6 w-6' aria_hidden='true' %}
          </span>
          <div class="space-y-1">
            <p class="text-xl font-semibold">{% trans "Consultores" %}</p>
            <p class="text-sm text-[var(--text-secondary)]">
              {% blocktrans count count=associados_consultores_count %}
                {{ count }} consultor no total
              {% plural %}
                {{ count }} consultores no total
              {% endblocktrans %}
            </p>
          </div>
        </div>
        <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:-rotate-180">
          {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
        </span>
      </summary>
      <div class="card-body">
        {% include 'associados/_carousel.html' with page=associados_consultores_page section='consultores' empty_message=associados_section_empty_messages.consultores fetch_url=associados_fetch_url search_term=search_term %}
      </div>
    </details>

    <details class="card group" data-associados-section="coordenadores">
      <summary class="card-header flex items-center justify-between gap-4 cursor-pointer">
        <div class="flex items-start gap-3">
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-[var(--color-info-500)]/10 text-[var(--color-info-600)] shadow-lg shadow-[var(--color-info-500)]/20">
            {% lucide 'shield-check' class='h-6 w-6' aria_hidden='true' %}
          </span>
          <div class="space-y-1">
            <p class="text-xl font-semibold">{% trans "Coordenadores" %}</p>
            <p class="text-sm text-[var(--text-secondary)]">
              {% blocktrans count count=associados_coordenadores_count %}
                {{ count }} coordenador no total
              {% plural %}
                {{ count }} coordenadores no total
              {% endblocktrans %}
            </p>
          </div>
        </div>
        <span class="text-[var(--text-secondary)] transition-transform duration-200 group-open:-rotate-180">
          {% lucide 'chevron-down' class='w-5 h-5' aria_hidden='true' %}
        </span>
      </summary>
      <div class="card-body">
        {% include 'associados/_carousel.html' with page=associados_coordenadores_page section='coordenadores' empty_message=associados_section_empty_messages.coordenadores fetch_url=associados_fetch_url search_term=search_term %}
      </div>
    </details>
  </div>

{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script>
    (function () {
      function formatTemplate(template, values) {
        return (template || '').replace(/__page__/g, values.page).replace(/__total__/g, values.total);
      }

      function initCarousel(root) {
        const track = root.querySelector('[data-carousel-track]');
        const prev = root.querySelector('[data-carousel-prev]');
        const next = root.querySelector('[data-carousel-next]');
        const status = root.querySelector('[data-carousel-status]');
        const pagination = root.querySelector('[data-carousel-pagination]');
        const fetchUrl = root.dataset.fetchUrl || '';
        const section = root.dataset.section || '';
        const searchTerm = root.dataset.searchTerm || '';
        const statusTemplate = root.dataset.statusTemplate || '';
        const paginationTemplate = root.dataset.paginationTemplate || '';

        if (!track) {
          return;
        }

        const cache = new Map();
        track.querySelectorAll('[data-carousel-page]').forEach((pageEl) => {
          const pageNumber = parseInt(pageEl.dataset.carouselPage || '1', 10);
          cache.set(pageNumber, pageEl);
        });

        let totalPages = Math.max(parseInt(root.dataset.totalPages || '1', 10), 1);
        let currentPage = Math.max(parseInt(root.dataset.currentPage || '1', 10), 1);
        let isLoading = false;

        function setTransform(page) {
          track.style.transform = `translateX(-${(page - 1) * 100}%)`;
        }

        function updateStatus() {
          if (!status) {
            return;
          }
          status.textContent = formatTemplate(statusTemplate, {
            page: currentPage,
            total: totalPages,
          });
        }

        function updateButtons() {
          if (prev) {
            prev.disabled = currentPage <= 1 || isLoading;
          }
          if (next) {
            next.disabled = currentPage >= totalPages || isLoading;
          }
        }

        function updatePagination() {
          if (!pagination) {
            return;
          }
          const dots = pagination.querySelectorAll('[data-carousel-page-target]');
          if (dots.length !== totalPages) {
            pagination.innerHTML = '';
            for (let index = 1; index <= totalPages; index += 1) {
              const button = document.createElement('button');
              button.type = 'button';
              button.dataset.carouselPageTarget = String(index);
              button.className =
                'h-2.5 w-2.5 rounded-full border border-[var(--color-primary-200)] transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[var(--color-primary-500)]';
              if (paginationTemplate) {
                button.setAttribute('aria-label', formatTemplate(paginationTemplate, {
                  page: index,
                  total: totalPages,
                }));
              }
              pagination.appendChild(button);
            }
          }

          pagination.querySelectorAll('[data-carousel-page-target]').forEach((btn) => {
            const pageNumber = parseInt(btn.dataset.carouselPageTarget || '1', 10);
            if (pageNumber === currentPage) {
              btn.classList.add('bg-[var(--color-primary-500)]', 'border-[var(--color-primary-500)]');
            } else {
              btn.classList.remove('bg-[var(--color-primary-500)]', 'border-[var(--color-primary-500)]');
            }
          });
        }

        async function ensurePage(page) {
          if (cache.has(page) || !fetchUrl) {
            return cache.get(page) || null;
          }
          isLoading = true;
          updateButtons();
          try {
            const url = new URL(fetchUrl, window.location.origin);
            url.searchParams.set('section', section);
            url.searchParams.set('page', String(page));
            if (searchTerm) {
              url.searchParams.set('q', searchTerm);
            }
            const response = await fetch(url.toString(), {
              headers: { 'X-Requested-With': 'XMLHttpRequest' },
            });
            if (!response.ok) {
              throw new Error('Request failed');
            }
            const payload = await response.json();
            totalPages = Math.max(parseInt(String(payload.total_pages || totalPages), 10) || totalPages, 1);
            root.dataset.totalPages = String(totalPages);

            const template = document.createElement('template');
            template.innerHTML = payload.html || '';
            const pageElement = template.content.firstElementChild;
            if (pageElement) {
              track.appendChild(pageElement);
              cache.set(page, pageElement);
              updatePagination();
            }
            return pageElement;
          } finally {
            isLoading = false;
            updateButtons();
          }
        }

        async function goTo(page) {
          const targetPage = Math.min(Math.max(page, 1), totalPages);
          if (targetPage === currentPage) {
            return;
          }
          let pageEl = null;
          try {
            pageEl = await ensurePage(targetPage);
          } catch (error) {
            console.error(error);
            return;
          }
          if (!pageEl && totalPages < targetPage) {
            return;
          }
          currentPage = targetPage;
          root.dataset.currentPage = String(currentPage);
          setTransform(currentPage);
          updateButtons();
          updatePagination();
          updateStatus();
        }

        if (prev) {
          prev.addEventListener('click', () => {
            if (!isLoading) {
              goTo(currentPage - 1);
            }
          });
        }

        if (next) {
          next.addEventListener('click', () => {
            if (!isLoading) {
              goTo(currentPage + 1);
            }
          });
        }

        if (pagination) {
          pagination.addEventListener('click', (event) => {
            const target = event.target.closest('[data-carousel-page-target]');
            if (!target || target.disabled) {
              return;
            }
            const pageNumber = parseInt(target.dataset.carouselPageTarget || '1', 10);
            if (!Number.isNaN(pageNumber)) {
              goTo(pageNumber);
            }
          });
        }

        setTransform(currentPage);
        updateButtons();
        updatePagination();
        updateStatus();
      }

      document.addEventListener('DOMContentLoaded', () => {
        document
          .querySelectorAll('[data-associados-carousel]')
          .forEach((element) => initCarousel(element));
      });
    })();
  </script>
{% endblock %}
