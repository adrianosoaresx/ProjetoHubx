{% extends "base.html" %}
{% load i18n lucide_icons %}

{% block hero %}
  {% include "_components/hero_portfolio.html" with title=hero_title subtitle=hero_subtitle counts=counts %}
{% endblock %}

{% block content %}
  <div class="space-y-6">
    <div class="card">
      <div class="card-header">
        <div>
          <h2 class="text-xl font-semibold text-[var(--text-primary)]">{% trans "Portfólio" %}</h2>
          <p class="text-sm text-[var(--text-secondary)]">{% trans "Gerencie suas imagens, vídeos e documentos" %}</p>
        </div>
      </div>
      <div class="card-body space-y-6">
        {% if show_form %}
          <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            {% if messages %}
              {% for message in messages %}
                {% if 'success' in message.tags %}
                  {% with alert_class='alert alert-success' alert_role='status' %}
                    <div class="{{ alert_class }}" role="{{ alert_role }}">{{ message }}</div>
                  {% endwith %}
                {% elif 'error' in message.tags or 'danger' in message.tags %}
                  {% with alert_class='alert alert-error' alert_role='alert' %}
                    <div class="{{ alert_class }}" role="{{ alert_role }}">{{ message }}</div>
                  {% endwith %}
                {% elif 'warning' in message.tags %}
                  {% with alert_class='alert alert-warning' alert_role='alert' %}
                    <div class="{{ alert_class }}" role="{{ alert_role }}">{{ message }}</div>
                  {% endwith %}
                {% else %}
                  {% with alert_class='alert alert-info' alert_role='status' %}
                    <div class="{{ alert_class }}" role="{{ alert_role }}">{{ message }}</div>
                  {% endwith %}
                {% endif %}
              {% endfor %}
            {% endif %}
            {% if form.non_field_errors %}
              <div class="alert alert-error" role="alert">
                {{ form.non_field_errors }}
              </div>
            {% endif %}
            {% for field in form %}
              {% include '_forms/field.html' with field=field %}
            {% endfor %}
            <div class="flex justify-end gap-2 pt-4 border-t border-[var(--border)]">
              <button type="submit" class="btn btn-primary">{% trans "Enviar" %}</button>
            </div>
          </form>
        {% else %}
          <div class="flex justify-end">
            <a href="{% url 'portfolio:index' %}?adicionar=1" class="btn btn-primary">
              {% trans "Adicionar" %}
            </a>
          </div>
          {% if filter_form %}
            <form method="get" class="space-y-4">
              {% include '_forms/field.html' with field=filter_form.q %}
            </form>
          {% endif %}
          <div class="card-grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-2">
            {% for media in medias %}
              <article class="card p-0">
                <div class="card-body relative space-y-5">
                  <div class="absolute right-4 top-4 z-10 flex gap-2">
                    <a href="{% url 'portfolio:edit' media.pk %}" class="btn btn-secondary btn-sm" aria-label="{% trans 'Editar' %}">
                      {% lucide 'pencil' class='w-4 h-4' aria_hidden='true' %}
                    </a>
                    <a
                      href="{% url 'portfolio:delete' media.pk %}"
                      class="btn btn-danger btn-sm"
                      aria-label="{% trans 'Excluir' %}"
                      hx-get="{% url 'portfolio:delete' media.pk %}"
                      hx-target="#modal"
                      hx-trigger="click"
                      hx-swap="innerHTML"
                      hx-on="htmx:beforeRequest: window.HubxModalTrigger = this;"
                    >
                      {% lucide 'trash' class='w-4 h-4' aria_hidden='true' %}
                    </a>
                  </div>
                  <header class="space-y-2 pr-16">
                    <p class="text-sm font-medium text-[var(--text-primary)]">{{ media.descricao }}</p>
                    <p class="text-xs text-[var(--text-secondary)]">{{ media.created_at|date:"SHORT_DATETIME_FORMAT" }}</p>
                  </header>
                  {% if media.media_type == 'pdf' %}
                    <div class="relative z-20 overflow-hidden rounded-xl border border-[var(--border)] bg-[var(--bg-tertiary)]">
                      <a href="{{ media.file.url }}" class="flex items-center justify-between gap-4 p-4 text-sm font-medium text-[var(--text-primary)] transition hover:text-[var(--accent)]" target="_blank" rel="noopener">
                        <span class="flex items-center gap-3">
                          <span class="flex h-12 w-12 items-center justify-center rounded-xl bg-[var(--bg-secondary)] text-[var(--primary)]">
                            {% lucide 'file-text' class='h-6 w-6' aria_hidden='true' %}
                          </span>
                          <span class="truncate">{% trans "Visualizar PDF" %}</span>
                        </span>
                        {% lucide 'external-link' class='h-5 w-5 flex-shrink-0 text-[var(--text-secondary)]' aria_hidden='true' %}
                      </a>
                    </div>
                  {% else %}
                    <a href="{% url 'portfolio:detail' media.pk %}" class="block">
                      {% if media.media_type == 'image' %}
                        <figure class="relative z-20 overflow-hidden rounded-xl border border-[var(--border)] bg-[var(--bg-tertiary)]">
                          <div class="relative flex max-h-[320px] w-full items-center justify-center overflow-hidden bg-[var(--bg-secondary)]">
                            <img src="{{ media.file.url }}" alt="{{ media.descricao }}" class="h-auto w-full max-h-[320px] object-contain" loading="lazy" />
                          </div>
                        </figure>
                      {% elif media.media_type == 'video' %}
                        <figure class="relative z-20 overflow-hidden rounded-xl border border-[var(--border)] bg-black">
                          <div class="feed-video-wrapper">
                            <div class="feed-video-frame">
                              <video src="{{ media.file.url }}" controls class="feed-video-player"></video>
                            </div>
                          </div>
                        </figure>
                      {% else %}
                        <div class="relative z-20 overflow-hidden rounded-xl border border-[var(--border)] bg-[var(--bg-tertiary)] p-4 text-sm text-[var(--text-primary)]">
                          {{ media.file.name }}
                        </div>
                      {% endif %}
                    </a>
                  {% endif %}
                  {% if media.tags.all %}
                    <div class="flex flex-wrap gap-2">
                      {% for tag in media.tags.all %}
                        <span class="rounded bg-[var(--bg-secondary)] px-2 py-0.5 text-xs text-[var(--text-secondary)]">{{ tag.nome }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              </article>
            {% empty %}
              <p class="text-sm text-[var(--text-secondary)]">{% trans "Nenhum arquivo enviado." %}</p>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div id="modal" role="presentation" aria-live="polite"></div>
{% endblock %}
