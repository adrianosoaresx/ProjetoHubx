name: Codex Setup

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - '.editorconfig'
  workflow_dispatch:

concurrency:
  group: codex-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      PYTHONUNBUFFERED: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      DJANGO_SETTINGS_MODULE: "config.settings" # ajuste se necessário

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python (com cache do pip)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Mostrar versões
        run: |
          python -V
          pip -V

      # === Sanity check de variáveis *antes* de instalar dependências ===
      - name: Validar variáveis de ambiente obrigatórias
        shell: bash
        run: |
          REQUIRED_VARS=(
            DJANGO_SECRET_KEY
            DJANGO_SETTINGS_MODULE
            ALLOWED_HOSTS
            CSRF_TRUSTED_ORIGINS
            DATABASE_URL
            REDIS_URL
          )
          missing=0
          echo "Verificando variáveis obrigatórias..."
          for var in "${REQUIRED_VARS[@]}"; do
            if [ -z "${!var:-}" ]; then
              echo "❌ Faltando: $var"
              missing=1
            else
              # Não expõe valores; apenas confirma presença
              echo "✅ $var definido"
            fi
          done
          if [ "$missing" -ne 0 ]; then
            echo "::error::Uma ou mais variáveis obrigatórias estão ausentes. Configure-as em Settings → Secrets and variables → Actions."
            exit 1
          fi

      - name: Aquecer instalador (pip/setuptools/wheel)
        run: |
          python -m pip install --upgrade pip setuptools wheel

      - name: Instalar dependências
        # Inclui pacotes de runtime e de desenvolvimento para os testes
        run: |
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Sanity check do Django (sem tocar DB)
        run: |
          python -c "import os, django; os.environ.setdefault('DJANGO_SETTINGS_MODULE', os.getenv('DJANGO_SETTINGS_MODULE')); django.setup(); print('✅ Django import OK')"
          python manage.py check --deploy --fail-level WARNING || true

      - name: Resumo de pacotes instalados
        run: |
          pip list --format=columns

      - name: Run tests with coverage
        run: pytest
